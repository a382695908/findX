var egret3d;(function(t){var e=function(){function t(){}return t}();t.DrawMode=e;var i=function(){function i(){}i.requstContext3D=function(a,r,s){console.log("requst GPU Config",a);if(!this.context3D||this.context3D&&!this.context3D.isLost){switch(a){case i.OpenGLES_2_0:var n=i.requestWEBGL(r);i.context3D=new t.Context3DChild_OpenGLES_2_0(n);var o=n.getExtension("WEBGL_compressed_texture_s3tc");var h=n.getExtension("OES_texture_float_linear");var u=n.getExtension("OES_texture_float");var l=n.getExtension("OES_texture_half_float");var f=n.getExtension("OES_texture_half_float_linear");var c=n.getExtension("OES_standard_derivatives");var d=n.getExtension("WEBGL_draw_buffers");var p=n.getExtension("WEBGL_depth_texture");i.BLEND=n.BLEND;e.TRIANGLES=n.TRIANGLES;e.POINTS=n.POINTS;e.LINES=n.LINES;e.LINE_STRIP=n.LINE_STRIP;i.FLOAT=n.FLOAT;i.VERTEX_SHADER=n.VERTEX_SHADER;i.FRAGMENT_SHADER=n.FRAGMENT_SHADER;i.canvasRectangle=r;i.FRONT=n.FRONT;i.BACK=n.BACK;i.DEPTH_BUFFER_BIT=n.DEPTH_BUFFER_BIT;i.ELEMENT_ARRAY_BUFFER=n.ELEMENT_ARRAY_BUFFER;i.UNSIGNED_SHORT=n.UNSIGNED_SHORT;i.NEAREST=n.NEAREST;i.REPEAT=n.REPEAT;i.ONE=n.ONE;i.ZERO=n.ZERO;i.SRC_ALPHA=n.SRC_ALPHA;i.ONE_MINUS_SRC_ALPHA=n.ONE_MINUS_SRC_ALPHA;i.SRC_COLOR=n.SRC_COLOR;i.ONE_MINUS_SRC_COLOR=n.ONE_MINUS_SRC_COLOR;i.ColorFormat_RGB565=n.RGB565;i.ColorFormat_RGBA5551=n.RGB5_A1;i.ColorFormat_RGBA4444=n.RGBA4;i.ColorFormat_RGBA8888=n.RGBA;i.DEPTH_TEST=n.DEPTH_TEST;i.CULL_FACE=n.CULL_FACE;i.BLEND=n.BLEND;if(o){i.ColorFormat_DXT1_RGB=o.COMPRESSED_RGB_S3TC_DXT1_EXT;i.ColorFormat_DXT1_RGBA=o.COMPRESSED_RGBA_S3TC_DXT1_EXT;i.ColorFormat_DXT3_RGBA=o.COMPRESSED_RGBA_S3TC_DXT3_EXT;i.ColorFormat_DXT5_RGBA=o.COMPRESSED_RGBA_S3TC_DXT5_EXT}t.ContextSamplerType.TEXTURE_0=n.TEXTURE0;t.ContextSamplerType.TEXTURE_1=n.TEXTURE1;t.ContextSamplerType.TEXTURE_2=n.TEXTURE2;t.ContextSamplerType.TEXTURE_3=n.TEXTURE3;t.ContextSamplerType.TEXTURE_4=n.TEXTURE4;t.ContextSamplerType.TEXTURE_5=n.TEXTURE5;t.ContextSamplerType.TEXTURE_6=n.TEXTURE6;t.ContextSamplerType.TEXTURE_7=n.TEXTURE7;t.ContextSamplerType.TEXTURE_8=n.TEXTURE8;break}}t.CheckerboardTexture.texture.upload(i.context3D);console.log("requst GPU Config",i.context3D);t.ShaderSystemTool.regist(s)};i.requestWEBGL=function(t,e){if(e===void 0){e=false}i.canvas=document.createElement("canvas");i.canvas.style.position="absolute";i.canvas.style.zIndex="0";i.canvas.style.left="0px";i.canvas.style.top="0px";if(document.getElementsByClassName("egret-player").length>0){document.getElementsByClassName("egret-player")[0].appendChild(this.canvas)}else{document.body.appendChild(this.canvas)}i.canvas.id="egret3D";i.canvas["x"]=t.x;i.canvas["y"]=t.y;i.canvas.width=t.width;i.canvas.height=t.height;i.clientRect=i.canvas.getBoundingClientRect();i.canvas.oncontextmenu=function(){return false};var a=this.canvas.getContext("experimental-webgl");if(!a)a=this.canvas.getContext("webgl");console.log("this.context3D ==>",this.context3D);if(!a)alert("你的手机不支持页面3D，快快去升级设备吧.");return a};i.requestFullScreen=function(){var t=document.documentElement;if(t.requestFullscreen){t.requestFullscreen()}else if(t.webkitRequestFullScreen){t.webkitRequestFullScreen()}};i.exitFullscreen=function(){var t=document;if(t.exitFullscreen){t.exitFullscreen()}else if(t.webkitCancelFullScreen){t.webkitCancelFullScreen()}};i.Direct3D_Opengl_Auto="Direct3D_Opengl_Auto";i.Direct3D_9_0="Direct3D_9_0";i.Direct3D_10_0="Direct3D_10_0";i.Direct3D_11_0="Direct3D_11_0";i.OpenGLES_2_0="OpenGLES_2_0";i.OpenGLES_3_0="OpenGLES_3_0";i.OpenGL="OpenGL";i.ColorFormat_DXT1_RGB=0;i.ColorFormat_DXT1_RGBA=0;i.ColorFormat_DXT3_RGBA=0;i.ColorFormat_DXT5_RGBA=0;return i}();t.Egret3DDrive=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e,i){this.data=t;this.width=e;this.height=i}return t}();t.MipmapData=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["PixelArray"]=0]="PixelArray";t[t["CompressData"]=1]="CompressData";t[t["ImageData"]=2]="ImageData"})(t.InternalFormat||(t.InternalFormat={}));var e=t.InternalFormat})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(t){this.buffer=t}return t}();t.IndexBuffer3D=e})(e=t.openGLES||(t.openGLES={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(t){this.vertextAttribActive=false;this.program=t}return t}();t.Program3D=e})(e=t.openGLES||(t.openGLES={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(t){this._shader=t}Object.defineProperty(t.prototype,"shader",{get:function(){return this._shader},enumerable:true,configurable:true});t.ID_COUNT=0;return t}();t.Shader=e})(e=t.openGLES||(t.openGLES={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(t,e){this.width=0;this.height=0;this.gpu_texture=t;this.context3D=e;this.mipmapDatas=new Array}return t}();t.Texture2D=e})(e=t.openGLES||(t.openGLES={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(t){this.gpu_texture=t}return t}();t.CubeTexture=e})(e=t.openGLES||(t.openGLES={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(t){this.buffer=t}return t}();t.VertexBuffer3D=e})(e=t.openGLES||(t.openGLES={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}return t}();t.FrameBuffer=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){this.gl=e;t.ContextSamplerType.LINEAR=this.gl.LINEAR;t.ContextSamplerType.NEAREST=this.gl.NEAREST;t.ContextSamplerType.REPEAT=this.gl.REPEAT}Object.defineProperty(e.prototype,"version",{get:function(){return""},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"isLost",{get:function(){return false},enumerable:true,configurable:true});e.prototype.viewPort=function(t,e,i,a){this.gl.viewport(t,e,i,a)};e.prototype.creatProgram=function(e,i){var a=this.gl.createProgram();this.gl.attachShader(a,e.shader);this.gl.attachShader(a,i.shader);this.gl.linkProgram(a);var r=this.gl.getProgramParameter(a,this.gl.LINK_STATUS);if(!r){alert("vsShader error"+this.gl.getShaderInfoLog(e.shader));alert("fsShader error"+this.gl.getShaderInfoLog(i.shader))}var s=new t.openGLES.Program3D(a);return s};e.prototype.creatIndexBuffer=function(e){var i=new Uint16Array(e);var a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW);return new t.openGLES.IndexBuffer3D(a)};e.prototype.creatVertexBuffer=function(e){var i=new Float32Array(e);var a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a);this.gl.bufferData(this.gl.ARRAY_BUFFER,i,this.gl.STATIC_DRAW);return new t.openGLES.VertexBuffer3D(a)};e.prototype.setTexture2DSamplerState=function(t,e,i,a){this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,t);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,e);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,i);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,a)};e.prototype.upLoadTextureData=function(e,i){this.gl.bindTexture(this.gl.TEXTURE_2D,i.gpu_texture);if(i.gpu_internalformat==t.InternalFormat.ImageData){this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i.image);this.gl.generateMipmap(this.gl.TEXTURE_2D)}else if(i.gpu_internalformat==t.InternalFormat.CompressData){this.upLoadCompressedTexture2D(e,i)}else if(i.gpu_internalformat==t.InternalFormat.PixelArray){this.gl.texImage2D(this.gl.TEXTURE_2D,e,i.gpu_colorformat,i.mipmapDatas[e].width,i.mipmapDatas[e].height,i.gpu_border,i.gpu_colorformat,this.gl.UNSIGNED_BYTE,i.mipmapDatas[e].data);this.gl.generateMipmap(this.gl.TEXTURE_2D)}this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT)};e.prototype.upLoadCompressedTexture2D=function(t,e){this.gl.bindTexture(this.gl.TEXTURE_2D,e.gpu_texture);this.gl.compressedTexImage2D(this.gl.TEXTURE_2D,t,e.gpu_colorformat,e.mipmapDatas[t].width,e.mipmapDatas[t].height,e.gpu_border,e.mipmapDatas[t].data)};e.prototype.creatTexture2D=function(){var e=new t.openGLES.Texture2D(this.gl.createTexture(),this);return e};e.prototype.creatCubeTexture=function(){return new t.openGLES.CubeTexture(this.gl.createTexture())};e.prototype.uploadCubetexture=function(t){this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,t.gpu_texture);this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_right.imageData);this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_left.imageData);this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_up.imageData);this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_down.imageData);this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_back.imageData);this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_front.imageData);this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE)};e.prototype.createFramebuffer=function(e,i,a){var r=this.gl.createFramebuffer();var s=this.creatTexture2D();var n=this.gl.createRenderbuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r);this.gl.bindTexture(this.gl.TEXTURE_2D,s.gpu_texture);var o=new Float32Array(32*32*4);for(var h=0;h<32*32;h++){o[h]=1;o[h+1]=1;o[h+2]=1;o[h+3]=1}switch(a){case t.FrameBufferFormat.UNSIGNED_BYTE_RGB:this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,e,i,0,this.gl.RGB,this.gl.UNSIGNED_BYTE,null);break;case t.FrameBufferFormat.UNSIGNED_BYTE_RGBA:this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,i,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null);break;case t.FrameBufferFormat.FLOAT_RGB:this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,e,i,0,this.gl.RGB,this.gl.FLOAT,o);break;case t.FrameBufferFormat.FLOAT_RGBA:this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,i,0,this.gl.RGBA,this.gl.FLOAT,o);break}this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,s.gpu_texture,0);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,n);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,e,i);s.width=e;s.height=i;s.frameBuffer=r;s.renderbuffer=n;this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null);return s};e.prototype.setRenderToTexture=function(t,e,i){if(e===void 0){e=false}if(i===void 0){i=0}if(e){}this.gl.viewport(0,0,t.width,t.height);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t.frameBuffer);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,t.gpu_texture,0);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,t.renderbuffer)};e.prototype.setRenderToBackBuffer=function(){this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null)};e.prototype.creatVertexShader=function(e){var i=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(i,e);this.gl.compileShader(i);var a=new t.openGLES.Shader(i);a.id=t.openGLES.Shader.ID_COUNT++;return a};e.prototype.creatFragmentShader=function(e){var i=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(i,e);this.gl.compileShader(i);var a=new t.openGLES.Shader(i);a.id=t.openGLES.Shader.ID_COUNT++;return a};e.prototype.clear=function(t,e,i,a){this.gl.clearColor(t,e,i,a);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)};e.prototype.clearDepth=function(t){this.gl.clearDepth(t);this.gl.clear(this.gl.DEPTH_BUFFER_BIT)};e.prototype.clearStencil=function(t){this.gl.clearStencil(t)};e.prototype.setProgram=function(t){this.gl.useProgram(t.program)};e.prototype.getUniformLocation=function(t,e){return this.gl.getUniformLocation(t.program,e)};e.prototype.uniform1f=function(t,e){this.gl.uniform1f(t,e)};e.prototype.uniform1fv=function(t,e){this.gl.uniform1fv(t,e)};e.prototype.uniform1i=function(t,e){this.gl.uniform1i(t,e)};e.prototype.uniform1iv=function(t,e){this.gl.uniform1iv(t,e)};e.prototype.uniform2f=function(t,e,i){this.gl.uniform2f(t,e,i)};e.prototype.uniform2fv=function(t,e){this.gl.uniform2fv(t,e)};e.prototype.uniform2i=function(t,e,i){this.gl.uniform2i(t,e,i)};e.prototype.uniform2iv=function(t,e){this.gl.uniform2iv(t,e)};e.prototype.uniform3f=function(t,e,i,a){this.gl.uniform3f(t,e,i,a)};e.prototype.uniform3fv=function(t,e){this.gl.uniform3fv(t,e)};e.prototype.uniform3i=function(t,e,i,a){this.gl.uniform3i(t,e,i,a)};e.prototype.uniform3iv=function(t,e){this.gl.uniform3iv(t,e)};e.prototype.uniform4f=function(t,e,i,a,r){this.gl.uniform4f(t,e,i,a,r)};e.prototype.uniform4fv=function(t,e){this.gl.uniform4fv(t,e)};e.prototype.uniform4i=function(t,e,i,a,r){this.gl.uniform4i(t,e,i,a,r)};e.prototype.uniform4iv=function(t,e){this.gl.uniform4iv(t,e)};e.prototype.uniformMatrix2fv=function(t,e,i){this.gl.uniformMatrix2fv(t,e,i)};e.prototype.uniformMatrix3fv=function(t,e,i){this.gl.uniformMatrix3fv(t,e,i)};e.prototype.uniformMatrix4fv=function(t,e,i){this.gl.uniformMatrix4fv(t,e,i)};e.prototype.setBlendFactors=function(t,e){this.gl.blendFunc(t,e)};e.prototype.setCulling=function(t){this.gl.cullFace(t)};e.prototype.enbable=function(t){this.gl.enable(t)};e.prototype.disable=function(t){this.gl.disable(t)};e.prototype.enableDepthTest=function(t,e){if(e===void 0){e=0}if(t)this.gl.enable(this.gl.DEPTH_TEST)};e.prototype.getShaderAttribLocation=function(t,e){return this.gl.getAttribLocation(t.program,e)};e.prototype.vertexAttribPointer=function(t,e,i,a,r,s,n){this.gl.vertexAttribPointer(e,i,a,r,s,n);this.gl.enableVertexAttribArray(e)};e.prototype.setVertexShaderConstData=function(t,e,i){this.gl.vertexAttrib4fv(e,t.subarray(e,i))};e.prototype.setFragmentShaderConstData=function(t,e,i){};e.prototype.setTexture2DAt=function(t,e,i,a){this.gl.activeTexture(t);this.gl.bindTexture(this.gl.TEXTURE_2D,a.gpu_texture);this.gl.uniform1i(e,i)};e.prototype.setCubeTextureAt=function(t,e,i,a){this.gl.activeTexture(t);this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,a.gpu_texture);this.gl.uniform1i(e,i)};e.prototype.setScissorRectangle=function(t){};e.prototype.setStencilReferenceValue=function(){};e.prototype.setStencilActions=function(t,e,i,a,r){};e.prototype.bindVertexBuffer=function(t){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t.buffer)};e.prototype.drawArrays=function(t,e,i){this.gl.drawArrays(t,e,i)};e.prototype.drawElement=function(t,e,i,a){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e.buffer);this.gl.drawElements(t,a,this.gl.UNSIGNED_SHORT,i)};e.prototype.flush=function(){this.gl.flush()};return e}();t.Context3DChild_OpenGLES_2_0=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["ALPHA"]=0]="ALPHA";t[t["LAYER"]=1]="LAYER";t[t["NORMAL"]=2]="NORMAL";t[t["MULTIPLY"]=3]="MULTIPLY";t[t["ADD"]=4]="ADD";t[t["SUB"]=5]="SUB";t[t["DIV"]=6]="DIV";t[t["SCREEN"]=7]="SCREEN"})(t.BlendMode||(t.BlendMode={}));var e=t.BlendMode;var i=function(){function t(){}return t}();t.ContextSamplerType=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e){if(t===void 0){t=0}if(e===void 0){e=0}this.u=0;this.v=0;this.u=t;this.v=e}return t}();t.UV=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e){if(t===void 0){t=0}if(e===void 0){e=0}this.x=t;this.y=e}Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:true,configurable:true});t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)};t.prototype.clone=function(){return new t(this.x,this.y)};t.prototype.copyFrom=function(t){this.x=t.x;this.y=t.y};t.prototype.equals=function(t){return this.x==t.x&&this.y==t.y};t.prototype.normalize=function(t){if(t===void 0){t=1}if(this.length!=0){var e=t/this.length;this.x*=e;this.y*=e;return}throw"Cannot divide by zero length."};t.prototype.offset=function(t,e){this.x+=t;this.y+=e};t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)};t.prototype.toString=function(){return"[Point] (x="+this.x+", y="+this.y+")"};t.distance=function(t,e){var i=e.x-t.x;var a=e.y-t.y;return Math.sqrt(i*i+a*a)};return t}();t.Point=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e,i,a){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(a===void 0){a=0}this.x=t;this.y=e;this.z=i;this.w=a}Object.defineProperty(t.prototype,"a",{get:function(){return this.w},set:function(t){this.w=t},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"r",{get:function(){return this.x},set:function(t){this.x=t},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"g",{get:function(){return this.y},set:function(t){this.y=t},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"b",{get:function(){return this.z},set:function(t){this.z=t},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.lengthSquared)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"lengthSquared",{get:function(){return this.x*this.x+this.y*this.y+this.z*this.z},enumerable:true,configurable:true});t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)};t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)};t.prototype.copyFrom=function(t){this.x=t.x;this.y=t.y;this.z=t.z;this.w=t.w};t.prototype.crossProduct=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x,1)};t.prototype.decrementBy=function(t){this.x-=t.x;this.y-=t.y;this.z-=t.z};t.distance=function(t,e){var i=t.x-e.x;var a=t.y-e.y;var r=t.z-e.z;return Math.sqrt(i*i+a*a+r*r)};t.prototype.dotProduct=function(t){return this.x*t.x+this.y*t.y+this.z*t.z};t.prototype.equals=function(t,e){if(e===void 0){e=false}return this.x==t.x&&this.y==t.y&&this.z==t.z&&(!e||this.w==t.w)};t.prototype.incrementBy=function(t){this.x+=t.x;this.y+=t.y;this.z+=t.z};t.prototype.negate=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z};t.prototype.normalize=function(t){if(t===void 0){t=1}if(this.length!=0){var e=t/this.length;this.x*=e;this.y*=e;this.z*=e;return}};t.prototype.scaleBy=function(t){this.x*=t;this.y*=t;this.z*=t};t.prototype.setTo=function(t,e,i){this.x=t;this.y=e;this.z=i};t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)};t.prototype.multiply=function(e){return new t(this.x*e.x,this.y*e.y,this.z*e.z)};t.prototype.lerp=function(t,e,i){var a=t.x,r=t.y,s=t.z,n=t.w;var o=e.x,h=e.y,u=e.z,l=e.w;this.x=(o-a)*i+a;this.y=(h-r)*i+r;this.z=(u-s)*i+s;this.w=(l-n)*i+n};t.prototype.toString=function(){return"<"+this.x+", "+this.y+", "+this.z+">"};t.prototype.parsing=function(t){var e=t.split(" ");if(e.length<3)return;this.x=parseFloat(e[0]);this.y=parseFloat(e[1]);this.z=parseFloat(e[2])};t.X_AXIS=new t(1,0,0);t.Y_AXIS=new t(0,1,0);t.Z_AXIS=new t(0,0,1);return t}();t.Vector3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e,i,a){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=32}if(a===void 0){a=32}this.x=0;this.y=0;this.width=0;this.height=0;this.x=t;this.y=e;this.width=i;this.height=a}return t}();t.Rectangle=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t,e,i,a){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(a===void 0){a=1}this.x=0;this.y=0;this.z=0;this.w=1;this.x=t;this.y=e;this.z=i;this.w=a}Object.defineProperty(e.prototype,"magnitude",{get:function(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:true,configurable:true});e.prototype.multiply=function(t,e){var i=t.w,a=t.x,r=t.y,s=t.z;var n=e.w,o=e.x,h=e.y,u=e.z;this.w=i*n-a*o-r*h-s*u;this.x=i*o+a*n+r*u-s*h;this.y=i*h-a*u+r*n+s*o;this.z=i*u+a*h-r*o+s*n};e.prototype.multiplyVector=function(t,i){if(i===void 0){i=null}if(i===null){i=new e}var a=t.x;var r=t.y;var s=t.z;i.w=-this.x*a-this.y*r-this.z*s;i.x=this.w*a+this.y*s-this.z*r;i.y=this.w*r-this.x*s+this.z*a;i.z=this.w*s+this.x*r-this.y*a;return i};e.prototype.fromAxisAngle=function(t,e){e*=Math.PI/180;var i=e*.5;var a=Math.sin(i);this.w=Math.cos(i);this.x=t.x*a;this.y=t.y*a;this.z=t.z*a;this.normalize()};e.prototype.toAxisAngle=function(t){var e=this.x*this.x+this.y*this.y+this.z*this.z;var i=0;if(e>0){i=2*Math.acos(this.w);e=1/Math.sqrt(e);t.x=this.x*e;t.y=this.y*e;t.z=this.z*e}else{i=0;t.x=1;t.y=0;t.z=0}i/=Math.PI/180;return i};e.prototype.slerp=function(t,e,i){var a=t.w,r=t.x,s=t.y,n=t.z;var o=e.w,h=e.x,u=e.y,l=e.z;var f=a*o+r*h+s*u+n*l;if(f<0){f=-f;o=-o;h=-h;u=-u;l=-l}if(f<.95){var c=Math.acos(f);var d=1/Math.sin(c);var p=Math.sin(c*(1-i))*d;var g=Math.sin(c*i)*d;this.w=a*p+o*g;this.x=r*p+h*g;this.y=s*p+u*g;this.z=n*p+l*g}else{this.w=a+i*(o-a);this.x=r+i*(h-r);this.y=s+i*(u-s);this.z=n+i*(l-n);var m=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=m;this.x*=m;this.y*=m;this.z*=m}};e.prototype.lerp=function(t,e,i){var a=t.w,r=t.x,s=t.y,n=t.z;var o=e.w,h=e.x,u=e.y,l=e.z;var f;if(a*o+r*h+s*u+n*l<0){o=-o;h=-h;u=-u;l=-l}this.w=a+i*(o-a);this.x=r+i*(h-r);this.y=s+i*(u-s);this.z=n+i*(l-n);f=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=f;this.x*=f;this.y*=f;this.z*=f};e.prototype.fromEulerAngles=function(e,i,a){e*=t.Matrix3DUtils.DEGREES_TO_RADIANS;i*=t.Matrix3DUtils.DEGREES_TO_RADIANS;a*=t.Matrix3DUtils.DEGREES_TO_RADIANS;var r=e*.5,s=i*.5,n=a*.5;var o=Math.cos(r),h=Math.sin(r);var u=Math.cos(s),l=Math.sin(s);var f=Math.cos(n),c=Math.sin(n);this.w=o*u*f+h*l*c;this.x=h*u*f-o*l*c;this.y=o*l*f+h*u*c;this.z=o*u*c-h*l*f;return this};e.prototype.toEulerAngles=function(e){if(e===void 0){e=null}if(e===null){e=new t.Vector3D}e.x=Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y));var i=2*(this.w*this.y-this.z*this.x);i=t.Matrix3DUtils.clampf(i,-1,1);e.y=Math.asin(i);e.z=Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z));e.x/=t.Matrix3DUtils.DEGREES_TO_RADIANS;e.y/=t.Matrix3DUtils.DEGREES_TO_RADIANS;e.z/=t.Matrix3DUtils.DEGREES_TO_RADIANS;return e};e.prototype.normalize=function(t){if(t===void 0){t=1}var e=t/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=e;this.y*=e;this.z*=e;this.w*=e};e.prototype.toString=function(){return"{x:"+this.x+" y:"+this.y+" z:"+this.z+" w:"+this.w+"}"};e.prototype.toMatrix3D=function(e){if(e===void 0){e=null}var i=t.Matrix3DUtils.RAW_DATA_CONTAINER;var a=2*this.x*this.y,r=2*this.x*this.z,s=2*this.x*this.w;var n=2*this.y*this.z,o=2*this.y*this.w,h=2*this.z*this.w;var u=this.x*this.x,l=this.y*this.y,f=this.z*this.z,c=this.w*this.w;i[0]=u-l-f+c;i[4]=a-h;i[8]=r+o;i[12]=0;i[1]=a+h;i[5]=-u+l-f+c;i[9]=n-s;i[13]=0;i[2]=r-o;i[6]=n+s;i[10]=-u-l+f+c;i[14]=0;i[3]=0;i[7]=0;i[11]=0;i[15]=1;if(!e)return new t.Matrix4_4(new Float32Array(i));e.copyRawDataFrom(i);return e};e.prototype.fromMatrix=function(e){var i=e.decompose(t.Orientation3D.QUATERNION)[1];this.x=i.x;this.y=i.y;this.z=i.z;this.w=i.w};e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)};e.prototype.rotatePoint=function(e,i){if(i===void 0){i=null}var a,r,s,n;var o=e.x,h=e.y,u=e.z;if(i===null){i=new t.Vector3D}n=-this.x*o-this.y*h-this.z*u;a=this.w*o+this.y*u-this.z*h;r=this.w*h-this.x*u+this.z*o;s=this.w*u+this.x*h-this.y*o;i.x=-n*this.x+a*this.w-r*this.z+s*this.y;i.y=-n*this.y+a*this.z+r*this.w-s*this.x;i.z=-n*this.z-a*this.y+r*this.x+s*this.w;return i};e.prototype.copyFrom=function(t){this.x=t.x;this.y=t.y;this.z=t.z;this.w=t.w};return e}();t.Quaternion=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.AXIS_ANGLE="axisAngle";t.EULER_ANGLES="eulerAngles";t.QUATERNION="quaternion";return t}();t.Orientation3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t,e,i,a){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(a===void 0){a=0}this.a=t;this.b=e;this.c=i;this.d=a}e.prototype.setTo=function(t,e,i,a){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(a===void 0){a=0}this.a=t;this.b=e;this.c=i;this.d=a};e.prototype.fromPoints=function(t,e,i){var a=e.x-t.x;var r=e.y-t.y;var s=e.z-t.z;var n=i.x-t.x;var o=i.y-t.y;var h=i.z-t.z;this.a=r*h-s*o;this.b=s*n-a*h;this.c=a*o-r*n;this.d=-(this.a*t.x+this.b*t.y+this.c*t.z)};e.prototype.fromNormalAndPoint=function(t,e){this.a=t.x;this.b=t.y;this.c=t.z;this.d=-(this.a*e.x+this.b*e.y+this.c*e.z)};e.prototype.normalize=function(){var t=Math.sqrt(this.a*this.a+this.b*this.b+this.c*this.c);if(t>0){var e=1/t;this.a*=e;this.b*=e;this.c*=e;this.d*=e}return t};e.prototype.distance=function(t){return this.a*t.x+this.b*t.y+this.c*t.z+this.d};e.prototype.classifyPoint=function(e,i){if(i===void 0){i=.01}var a=this.distance(e);if(a<-i){return t.PlaneClassification.BACK}else if(a>i){return t.PlaneClassification.FRONT}return t.PlaneClassification.INTERSECT};e.prototype.toString=function(){return"Plane3D [a:"+this.a+", b:"+this.b+", c:"+this.c+", d:"+this.d+"]"};e.ALIGN_ANY=0;e.ALIGN_XY_AXIS=1;e.ALIGN_YZ_AXIS=2;e.ALIGN_XZ_AXIS=3;return e}();t.Plane3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){if(e===void 0){e=new t.Vector3D}if(i===void 0){i=new t.Vector3D}this.min=new t.Vector3D;this.max=new t.Vector3D;this.vexData=new Array;this.indexData=new Array;this.width=0;this.heigth=0;this.depth=0;this.volume=0;this.center=new t.Vector3D;this.radius=0;this.matTransform=new t.Matrix4_4;this.min.copyFrom(e);this.max.copyFrom(i);this.calculateBox()}e.prototype.copyFrom=function(t){this.min.copyFrom(t.min);this.max.copyFrom(t.max);this.calculateBox()};e.prototype.fillBox=function(t,e){this.min.copyFrom(t);this.max.copyFrom(e);this.calculateBox()};e.prototype.inBox=function(t){if(t.x<=this.max.x&&t.x>=this.min.x&&t.y<=this.max.y&&t.y>=this.min.y&&t.z<=this.max.z&&t.z>=this.min.z){return true}return false};e.prototype.intersectAABBs=function(t,e){if(this.min.x>t.max.x){return false}if(this.max.x<t.min.x){return false}if(this.min.y>t.max.y){return false}if(this.max.y<t.min.y){return false}if(this.min.z>t.max.z){return false}if(this.max.z<t.min.z){return false}if(e!=null){e.min.x=Math.max(this.min.x,t.min.x);e.max.x=Math.min(this.max.x,t.max.x);e.min.y=Math.max(this.min.y,t.min.y);e.max.y=Math.min(this.max.y,t.max.y);e.min.z=Math.max(this.min.z,t.min.z);e.max.z=Math.min(this.max.z,t.max.z)}return true};Object.defineProperty(e.prototype,"Transform",{get:function(){return this.matTransform},set:function(t){this.matTransform.copyFrom(t)},enumerable:true,configurable:true});e.prototype.toString=function(){return"CubeBoxBound [min:("+this.min.x+", "+this.min.y+", "+this.min.z+") max:("+this.max.x+", "+this.max.y+", "+this.max.z+")]"};e.prototype.calculateBox=function(){this.vexData.length=0;this.indexData.length=0;var t=this.max.subtract(this.min);this.vexData.push(this.min.x);this.vexData.push(this.min.y);this.vexData.push(this.min.z);this.vexData.push(this.min.x);this.vexData.push(this.min.y);this.vexData.push(this.min.z+t.z);this.vexData.push(this.min.x+t.x);this.vexData.push(this.min.y);this.vexData.push(this.min.z+t.z);this.vexData.push(this.min.x+t.x);this.vexData.push(this.min.y);this.vexData.push(this.min.z);this.vexData.push(this.max.x-t.x);this.vexData.push(this.max.y);this.vexData.push(this.max.z-t.z);this.vexData.push(this.max.x-t.x);this.vexData.push(this.max.y);this.vexData.push(this.max.z);this.vexData.push(this.max.x);this.vexData.push(this.max.y);this.vexData.push(this.max.z);this.vexData.push(this.max.x);this.vexData.push(this.max.y);this.vexData.push(this.max.z-t.z);this.indexData.push(0,4,7,0,7,3,2,6,5,2,5,1,4,5,6,4,6,7,0,3,2,0,2,1,0,1,5,0,5,4,3,7,6,3,6,2);this.width=this.max.x-this.min.x;this.heigth=this.max.y-this.min.y;this.depth=this.max.z-this.min.z;this.volume=this.width*this.heigth*this.depth;var e=this.max.subtract(this.min);e.scaleBy(.5);this.radius=e.length;this.center.copyFrom(this.min);var i=this.center.add(e);this.center.copyFrom(i)};return e}();t.CubeBoxBound=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){if(t===void 0){t=null}this.oRawData=new Float32Array(16);if(t){this.rawData=t}else this.rawData=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}e.prototype.lookAt=function(t,e,i){var a=e.subtract(t);a.normalize();var r=i.crossProduct(a);r.normalize();var s=a.crossProduct(r);this.rawData[0]=r.x;this.rawData[1]=s.x;this.rawData[2]=a.x;this.rawData[3]=0;this.rawData[4]=r.y;this.rawData[5]=s.y;this.rawData[6]=a.y;this.rawData[7]=0;this.rawData[8]=r.z;this.rawData[9]=s.z;this.rawData[10]=a.z;this.rawData[11]=0;this.rawData[12]=-r.dotProduct(t);this.rawData[13]=-s.dotProduct(t);this.rawData[14]=-a.dotProduct(t);this.rawData[15]=1};e.prototype.perspective=function(t,e,i,a){var r=t*(Math.PI/180);var s=Math.tan((Math.PI-r)/2);var n=s/e;this.rawData[0]=n;this.rawData[1]=0;this.rawData[2]=0;this.rawData[3]=0;this.rawData[4]=0;this.rawData[5]=s;this.rawData[6]=0;this.rawData[7]=0;this.rawData[8]=0;this.rawData[9]=0;this.rawData[10]=a/(a-i);this.rawData[11]=1;this.rawData[12]=0;this.rawData[13]=0;this.rawData[14]=-i*a/(a-i);this.rawData[15]=0};e.prototype.ortho=function(t,e,i,a){this.rawData[0]=2/t;this.rawData[1]=0;this.rawData[2]=0;this.rawData[3]=0;this.rawData[4]=0;this.rawData[5]=2/e;this.rawData[6]=0;this.rawData[7]=0;this.rawData[8]=0;this.rawData[9]=0;this.rawData[10]=1/(a-i);this.rawData[11]=0;this.rawData[12]=0;this.rawData[13]=0;this.rawData[14]=i/(i-a);this.rawData[15]=1};e.prototype.orthoOffCenter=function(t,e,i,a,r,s){this.rawData[0]=2/(e-1);this.rawData[1]=0;this.rawData[2]=0;this.rawData[3]=0;this.rawData[4]=0;this.rawData[5]=2/(a-i);this.rawData[6]=0;this.rawData[7]=0;this.rawData[8]=0;this.rawData[9]=0;this.rawData[10]=1/(s-r);this.rawData[11]=0;this.rawData[12]=(1+e)/(1-e);this.rawData[13]=(a+i)/(i-a);this.rawData[14]=r/(r-s);this.rawData[15]=1};e.prototype.append=function(t){var e=this.rawData[0],i=this.rawData[4],a=this.rawData[8],r=this.rawData[12],s=this.rawData[1],n=this.rawData[5],o=this.rawData[9],h=this.rawData[13],u=this.rawData[2],l=this.rawData[6],f=this.rawData[10],c=this.rawData[14],d=this.rawData[3],p=this.rawData[7],g=this.rawData[11],m=this.rawData[15],_=t.rawData[0],v=t.rawData[4],D=t.rawData[8],y=t.rawData[12],x=t.rawData[1],w=t.rawData[5],b=t.rawData[9],T=t.rawData[13],A=t.rawData[2],E=t.rawData[6],L=t.rawData[10],S=t.rawData[14],M=t.rawData[3],P=t.rawData[7],R=t.rawData[11],C=t.rawData[15];this.rawData[0]=e*_+s*v+u*D+d*y;this.rawData[1]=e*x+s*w+u*b+d*T;this.rawData[2]=e*A+s*E+u*L+d*S;this.rawData[3]=e*M+s*P+u*R+d*C;this.rawData[4]=i*_+n*v+l*D+p*y;this.rawData[5]=i*x+n*w+l*b+p*T;
this.rawData[6]=i*A+n*E+l*L+p*S;this.rawData[7]=i*M+n*P+l*R+p*C;this.rawData[8]=a*_+o*v+f*D+g*y;this.rawData[9]=a*x+o*w+f*b+g*T;this.rawData[10]=a*A+o*E+f*L+g*S;this.rawData[11]=a*M+o*P+f*R+g*C;this.rawData[12]=r*_+h*v+c*D+m*y;this.rawData[13]=r*x+h*w+c*b+m*T;this.rawData[14]=r*A+h*E+c*L+m*S;this.rawData[15]=r*M+h*P+c*R+m*C};e.prototype.add=function(t){var e=this.rawData[0],i=this.rawData[4],a=this.rawData[8],r=this.rawData[12],s=this.rawData[1],n=this.rawData[5],o=this.rawData[9],h=this.rawData[13],u=this.rawData[2],l=this.rawData[6],f=this.rawData[10],c=this.rawData[14],d=this.rawData[3],p=this.rawData[7],g=this.rawData[11],m=this.rawData[15],_=t.rawData[0],v=t.rawData[4],D=t.rawData[8],y=t.rawData[12],x=t.rawData[1],w=t.rawData[5],b=t.rawData[9],T=t.rawData[13],A=t.rawData[2],E=t.rawData[6],L=t.rawData[10],S=t.rawData[14],M=t.rawData[3],P=t.rawData[7],R=t.rawData[11],C=t.rawData[15];this.rawData[0]=e+_;this.rawData[1]=s+x;this.rawData[2]=u+A;this.rawData[3]=d+M;this.rawData[4]=i+v;this.rawData[5]=n+w;this.rawData[6]=l+E;this.rawData[7]=p+P;this.rawData[8]=a+D;this.rawData[9]=o+b;this.rawData[10]=f+L;this.rawData[11]=g+R;this.rawData[12]=r+y;this.rawData[13]=h+T;this.rawData[14]=c+S;this.rawData[15]=m+C;return this};e.prototype.sub=function(t){var e=this.rawData[0],i=this.rawData[4],a=this.rawData[8],r=this.rawData[12],s=this.rawData[1],n=this.rawData[5],o=this.rawData[9],h=this.rawData[13],u=this.rawData[2],l=this.rawData[6],f=this.rawData[10],c=this.rawData[14],d=this.rawData[3],p=this.rawData[7],g=this.rawData[11],m=this.rawData[15],_=t.rawData[0],v=t.rawData[4],D=t.rawData[8],y=t.rawData[12],x=t.rawData[1],w=t.rawData[5],b=t.rawData[9],T=t.rawData[13],A=t.rawData[2],E=t.rawData[6],L=t.rawData[10],S=t.rawData[14],M=t.rawData[3],P=t.rawData[7],R=t.rawData[11],C=t.rawData[15];this.rawData[0]=e-_;this.rawData[1]=s-x;this.rawData[2]=u-A;this.rawData[3]=d-M;this.rawData[4]=i-v;this.rawData[5]=n-w;this.rawData[6]=l-E;this.rawData[7]=p-P;this.rawData[8]=a-D;this.rawData[9]=o-b;this.rawData[10]=f-L;this.rawData[11]=g-R;this.rawData[12]=r-y;this.rawData[13]=h-T;this.rawData[14]=c-S;this.rawData[15]=m-C;return this};e.prototype.mult=function(t){this.rawData[0]*=t;this.rawData[1]*=t;this.rawData[2]*=t;this.rawData[3]*=t;this.rawData[4]*=t;this.rawData[5]*=t;this.rawData[6]*=t;this.rawData[7]*=t;this.rawData[8]*=t;this.rawData[9]*=t;this.rawData[10]*=t;this.rawData[11]*=t;this.rawData[12]*=t;this.rawData[13]*=t;this.rawData[14]*=t;this.rawData[15]*=t;return this};e.prototype.rotation=function(e,i,a){this.appendRotation(e,t.Vector3D.X_AXIS);this.appendRotation(i,t.Vector3D.Y_AXIS);this.appendRotation(a,t.Vector3D.Z_AXIS)};e.prototype.appendRotation=function(i,a){var r=e.getAxisRotation(a.x,a.y,a.z,i);var s=new e;var n,o;var h=i*t.Matrix3DUtils.DEGREES_TO_RADIANS;n=Math.sin(h);o=Math.cos(h);if(a.x==1){s.rawData[0]=1;s.rawData[1]=0;s.rawData[2]=0;s.rawData[3]=0;s.rawData[4]=0;s.rawData[5]=o;s.rawData[6]=n;s.rawData[7]=0;s.rawData[8]=0;s.rawData[9]=-n;s.rawData[10]=o;s.rawData[7]=0;s.rawData[12]=0;s.rawData[13]=0;s.rawData[14]=0;s.rawData[15]=1}if(a.y==1){s.rawData[0]=o;s.rawData[1]=0;s.rawData[2]=-n;s.rawData[3]=0;s.rawData[4]=0;s.rawData[5]=1;s.rawData[6]=0;s.rawData[7]=0;s.rawData[8]=n;s.rawData[9]=0;s.rawData[10]=o;s.rawData[11]=0;s.rawData[12]=0;s.rawData[13]=0;s.rawData[14]=0;s.rawData[15]=1}if(a.z==1){s.rawData[0]=o;s.rawData[1]=n;s.rawData[2]=0;s.rawData[3]=0;s.rawData[4]=-n;s.rawData[5]=o;s.rawData[6]=0;s.rawData[7]=0;s.rawData[8]=0;s.rawData[9]=0;s.rawData[10]=1;s.rawData[11]=0;s.rawData[12]=0;s.rawData[13]=0;s.rawData[14]=0;s.rawData[15]=1}this.append(s)};e.prototype.appendScale=function(t,e,i){this.rawData[0]=t;this.rawData[1]=0;this.rawData[2]=0;this.rawData[4]=0;this.rawData[5]=e;this.rawData[6]=0;this.rawData[8]=0;this.rawData[9]=0;this.rawData[10]=i};e.prototype.appendTranslation=function(t,e,i){this.rawData[12]+=t;this.rawData[13]+=e;this.rawData[14]+=i};e.prototype.clone=function(){var t=new e;t.copyFrom(this);return t};e.prototype.copyColumnFrom=function(t,e){switch(t){case 0:this.rawData[0]=e.x;this.rawData[1]=e.y;this.rawData[2]=e.z;this.rawData[3]=e.w;break;case 1:this.rawData[4]=e.x;this.rawData[5]=e.y;this.rawData[6]=e.z;this.rawData[7]=e.w;break;case 2:this.rawData[8]=e.x;this.rawData[9]=e.y;this.rawData[10]=e.z;this.rawData[11]=e.w;break;case 3:this.rawData[12]=e.x;this.rawData[13]=e.y;this.rawData[14]=e.z;this.rawData[15]=e.w;break;default:}};e.prototype.copyRowTo=function(t,e){switch(t){case 0:e.x=this.rawData[0];e.y=this.rawData[1];e.z=this.rawData[2];e.w=this.rawData[3];break;case 1:e.x=this.rawData[4];e.y=this.rawData[5];e.z=this.rawData[6];e.w=this.rawData[7];break;case 2:e.x=this.rawData[8];e.y=this.rawData[9];e.z=this.rawData[10];e.w=this.rawData[11];break;case 3:e.x=this.rawData[12];e.y=this.rawData[13];e.z=this.rawData[14];e.w=this.rawData[15];break;default:}};e.prototype.copyFrom=function(t){var e=t.rawData.length;for(var i=0;i<e;i++)this.rawData[i]=t.rawData[i];return this};e.prototype.copyRawDataFrom=function(t,e,i){if(e===void 0){e=0}if(i===void 0){i=false}if(i)this.transpose();var a=t.length-e;for(var r=0;r<a;r++)this.rawData[r]=t[r+e];if(i)this.transpose()};e.prototype.copyRawDataTo=function(t,e,i){if(e===void 0){e=0}if(i===void 0){i=false}if(i)this.transpose();var a=this.rawData.length;for(var r=0;r<a;r++)t[r+e]=this.rawData[r];if(i)this.transpose()};e.prototype.copyColFrom=function(t,e){switch(t){case 0:this.rawData[0]=e.x;this.rawData[4]=e.y;this.rawData[8]=e.z;this.rawData[12]=e.w;break;case 1:this.rawData[1]=e.x;this.rawData[5]=e.y;this.rawData[9]=e.z;this.rawData[13]=e.w;break;case 2:this.rawData[2]=e.x;this.rawData[6]=e.y;this.rawData[10]=e.z;this.rawData[14]=e.w;break;case 3:this.rawData[3]=e.x;this.rawData[7]=e.y;this.rawData[11]=e.z;this.rawData[15]=e.w;break;default:new Error("no more raw!")}};e.prototype.copyColTo=function(t,e){switch(t){case 0:e.x=this.rawData[0];e.y=this.rawData[4];e.z=this.rawData[8];e.w=this.rawData[12];break;case 1:e.x=this.rawData[1];e.y=this.rawData[5];e.z=this.rawData[9];e.w=this.rawData[13];break;case 2:e.x=this.rawData[2];e.y=this.rawData[6];e.z=this.rawData[10];e.w=this.rawData[14];break;case 3:e.x=this.rawData[3];e.y=this.rawData[7];e.z=this.rawData[11];e.w=this.rawData[15];break;default:new Error("no more raw!")}};e.prototype.copyToMatrix3D=function(t){t.rawData=this.rawData.slice(0)};e.prototype.decompose=function(e){if(e===void 0){e="eulerAngles"}var i;var a=[];var r=this.clone();var s=r.rawData;var n=new t.Vector3D(s[12],s[13],s[14]);s[12]=0;s[13]=0;s[14]=0;var o=new t.Vector3D;o.x=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);o.y=Math.sqrt(s[4]*s[4]+s[5]*s[5]+s[6]*s[6]);o.z=Math.sqrt(s[8]*s[8]+s[9]*s[9]+s[10]*s[10]);if(s[0]*(s[5]*s[10]-s[6]*s[9])-s[1]*(s[4]*s[10]-s[6]*s[8])+s[2]*(s[4]*s[9]-s[5]*s[8])<0)o.z=-o.z;s[0]/=o.x;s[1]/=o.x;s[2]/=o.x;s[4]/=o.y;s[5]/=o.y;s[6]/=o.y;s[8]/=o.z;s[9]/=o.z;s[10]/=o.z;var h=new t.Vector3D;switch(e){case t.Orientation3D.AXIS_ANGLE:h.w=Math.acos((s[0]+s[5]+s[10]-1)/2);var u=Math.sqrt((s[6]-s[9])*(s[6]-s[9])+(s[8]-s[2])*(s[8]-s[2])+(s[1]-s[4])*(s[1]-s[4]));h.x=(s[6]-s[9])/u;h.y=(s[8]-s[2])/u;h.z=(s[1]-s[4])/u;break;case t.Orientation3D.QUATERNION:var l=s[0]+s[5]+s[10];if(l>0){h.w=Math.sqrt(1+l)/2;h.x=(s[6]-s[9])/(4*h.w);h.y=(s[8]-s[2])/(4*h.w);h.z=(s[1]-s[4])/(4*h.w)}else if(s[0]>s[5]&&s[0]>s[10]){h.x=Math.sqrt(1+s[0]-s[5]-s[10])/2;h.w=(s[6]-s[9])/(4*h.x);h.y=(s[1]+s[4])/(4*h.x);h.z=(s[8]+s[2])/(4*h.x)}else if(s[5]>s[10]){h.y=Math.sqrt(1+s[5]-s[0]-s[10])/2;h.x=(s[1]+s[4])/(4*h.y);h.w=(s[8]-s[2])/(4*h.y);h.z=(s[6]+s[9])/(4*h.y)}else{h.z=Math.sqrt(1+s[10]-s[0]-s[5])/2;h.x=(s[8]+s[2])/(4*h.z);h.y=(s[6]+s[9])/(4*h.z);h.w=(s[1]-s[4])/(4*h.z)}break;case t.Orientation3D.EULER_ANGLES:h.y=Math.asin(-s[2]);if(s[2]!=1&&s[2]!=-1){h.x=Math.atan2(s[6],s[10]);h.z=Math.atan2(s[1],s[0])}else{h.z=0;h.x=Math.atan2(s[4],s[5])}break}a.push(n);a.push(h);a.push(o);return a};e.prototype.deltaTransformVector=function(e){var i=e.x;var a=e.y;var r=e.z;return new t.Vector3D(i*this.rawData[0]+a*this.rawData[4]+r*this.rawData[8],i*this.rawData[1]+a*this.rawData[5]+r*this.rawData[9],i*this.rawData[2]+a*this.rawData[6]+r*this.rawData[10],i*this.rawData[3]+a*this.rawData[7]+r*this.rawData[11])};e.prototype.identity=function(){this.rawData[1]=0;this.rawData[2]=0;this.rawData[3]=0;this.rawData[4]=0;this.rawData[6]=0;this.rawData[7]=0;this.rawData[8]=0;this.rawData[9]=0;this.rawData[11]=0;this.rawData[12]=0;this.rawData[13]=0;this.rawData[14]=0;this.rawData[0]=1;this.rawData[5]=1;this.rawData[10]=1;this.rawData[15]=1};e.prototype.fill=function(t){this.rawData[1]=t;this.rawData[2]=t;this.rawData[3]=t;this.rawData[4]=t;this.rawData[6]=t;this.rawData[7]=t;this.rawData[8]=t;this.rawData[9]=t;this.rawData[11]=t;this.rawData[12]=t;this.rawData[13]=t;this.rawData[14]=t;this.rawData[0]=t;this.rawData[5]=t;this.rawData[10]=t;this.rawData[15]=t};e.prototype.invers33=function(){var t=this.rawData[5]*this.rawData[10]-this.rawData[9]*this.rawData[6];var e=this.rawData[8]*this.rawData[6]-this.rawData[4]*this.rawData[10];var i=this.rawData[4]*this.rawData[9]-this.rawData[8]*this.rawData[5];var a=this.rawData[9]*this.rawData[2]-this.rawData[1]*this.rawData[10];var r=this.rawData[0]*this.rawData[10]-this.rawData[8]*this.rawData[2];var s=this.rawData[8]*this.rawData[1]-this.rawData[0]*this.rawData[9];var n=this.rawData[1]*this.rawData[6]-this.rawData[5]*this.rawData[2];var o=this.rawData[4]*this.rawData[2]-this.rawData[0]*this.rawData[6];var h=this.rawData[0]*this.rawData[5]-this.rawData[4]*this.rawData[1];var u=this.rawData[0]*t+this.rawData[4]*a+this.rawData[8]*n;if(Math.abs(u)>1e-11){var l=1/u;this.rawData[0]=l*t;this.rawData[4]=l*e;this.rawData[8]=l*i;this.rawData[1]=l*a;this.rawData[5]=l*r;this.rawData[9]=l*s;this.rawData[2]=l*n;this.rawData[6]=l*o;this.rawData[10]=l*h}};e.prototype.invert=function(){var t=this.determinant;var e=Math.abs(t)>1e-11;if(e){t=1/t;var i=this.rawData[0];var a=this.rawData[4];var r=this.rawData[8];var s=this.rawData[12];var n=this.rawData[1];var o=this.rawData[5];var h=this.rawData[9];var u=this.rawData[13];var l=this.rawData[2];var f=this.rawData[6];var c=this.rawData[10];var d=this.rawData[14];var p=this.rawData[3];var g=this.rawData[7];var m=this.rawData[11];var _=this.rawData[15];this.rawData[0]=t*(o*(c*_-d*m)-h*(f*_-d*g)+u*(f*m-c*g));this.rawData[1]=-t*(n*(c*_-d*m)-h*(l*_-d*p)+u*(l*m-c*p));this.rawData[2]=t*(n*(f*_-d*g)-o*(l*_-d*p)+u*(l*g-f*p));this.rawData[3]=-t*(n*(f*m-c*g)-o*(l*m-c*p)+h*(l*g-f*p));this.rawData[4]=-t*(a*(c*_-d*m)-r*(f*_-d*g)+s*(f*m-c*g));this.rawData[5]=t*(i*(c*_-d*m)-r*(l*_-d*p)+s*(l*m-c*p));this.rawData[6]=-t*(i*(f*_-d*g)-a*(l*_-d*p)+s*(l*g-f*p));this.rawData[7]=t*(i*(f*m-c*g)-a*(l*m-c*p)+r*(l*g-f*p));this.rawData[8]=t*(a*(h*_-u*m)-r*(o*_-u*g)+s*(o*m-h*g));this.rawData[9]=-t*(i*(h*_-u*m)-r*(n*_-u*p)+s*(n*m-h*p));this.rawData[10]=t*(i*(o*_-u*g)-a*(n*_-u*p)+s*(n*g-o*p));this.rawData[11]=-t*(i*(o*m-h*g)-a*(n*m-h*p)+r*(n*g-o*p));this.rawData[12]=-t*(a*(h*d-u*c)-r*(o*d-u*f)+s*(o*c-h*f));this.rawData[13]=t*(i*(h*d-u*c)-r*(n*d-u*l)+s*(n*c-h*l));this.rawData[14]=-t*(i*(o*d-u*f)-a*(n*d-u*l)+s*(n*f-o*l));this.rawData[15]=t*(i*(o*c-h*f)-a*(n*c-h*l)+r*(n*f-o*l))}return e};e.prototype.makeTransform=function(e,i,a){a.toMatrix3D(t.Matrix3DUtils.CALCULATION_MATRIX);this.rawData[0]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[0]*i.x;this.rawData[1]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[1]*i.y;this.rawData[2]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[2]*i.z;this.rawData[3]=0;this.rawData[4]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[4]*i.x;this.rawData[5]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[5]*i.y;this.rawData[6]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[6]*i.z;this.rawData[7]=0;this.rawData[8]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[8]*i.x;this.rawData[9]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[9]*i.y;this.rawData[10]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[10]*i.z;this.rawData[11]=0;this.rawData[12]=e.x;this.rawData[13]=e.y;this.rawData[14]=e.z;this.rawData[15]=1};e.prototype.recompose=function(e){if(e.length<3)return false;this.identity();this.appendScale(e[2].x,e[2].y,e[2].z);var i;i=-e[1].x*t.Matrix3DUtils.DEGREES_TO_RADIANS;t.Matrix3DUtils.CALCULATION_MATRIX.copyRawDataFrom(new Float32Array([1,0,0,0,0,Math.cos(i),-Math.sin(i),0,0,Math.sin(i),Math.cos(i),0,0,0,0,0]));this.append(t.Matrix3DUtils.CALCULATION_MATRIX);i=-e[1].y*t.Matrix3DUtils.DEGREES_TO_RADIANS;t.Matrix3DUtils.CALCULATION_MATRIX.copyRawDataFrom(new Float32Array([Math.cos(i),0,Math.sin(i),0,0,1,0,0,-Math.sin(i),0,Math.cos(i),0,0,0,0,0]));this.append(t.Matrix3DUtils.CALCULATION_MATRIX);i=-e[1].z*t.Matrix3DUtils.DEGREES_TO_RADIANS;t.Matrix3DUtils.CALCULATION_MATRIX.copyRawDataFrom(new Float32Array([Math.cos(i),-Math.sin(i),0,0,Math.sin(i),Math.cos(i),0,0,0,0,1,0,0,0,0,0]));this.append(t.Matrix3DUtils.CALCULATION_MATRIX);this.rawData[12]=e[0].x;this.rawData[13]=e[0].y;this.rawData[14]=e[0].z;this.rawData[15]=1;return true};e.prototype.transformVector=function(e){if(e==null)return new t.Vector3D;var i=e.x;var a=e.y;var r=e.z;var s=new t.Vector3D;s.x=i*this.rawData[0]+a*this.rawData[4]+r*this.rawData[8]+this.rawData[12];s.y=i*this.rawData[1]+a*this.rawData[5]+r*this.rawData[9]+this.rawData[13];s.z=i*this.rawData[2]+a*this.rawData[6]+r*this.rawData[10]+this.rawData[14];s.w=i*this.rawData[3]+a*this.rawData[7]+r*this.rawData[11]+this.rawData[15];return s};e.prototype.transformPlane=function(i){var a=new e;a.copyFrom(this);a.invert();a.transpose();var r=new t.Vector3D(i.a,i.b,i.c,i.d);r.copyFrom(a.transformVector(r));var s=new t.Plane3D;s.a=r.x;s.b=r.y;s.c=r.z;s.d=r.w/Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);return s};e.prototype.transpose=function(){for(var t=0;t<this.oRawData.length;t++){this.oRawData[t]=this.rawData[t]}this.rawData[1]=this.oRawData[4];this.rawData[2]=this.oRawData[8];this.rawData[3]=this.oRawData[12];this.rawData[4]=this.oRawData[1];this.rawData[6]=this.oRawData[9];this.rawData[7]=this.oRawData[13];this.rawData[8]=this.oRawData[2];this.rawData[9]=this.oRawData[6];this.rawData[11]=this.oRawData[14];this.rawData[12]=this.oRawData[3];this.rawData[13]=this.oRawData[7];this.rawData[14]=this.oRawData[11]};e.getAxisRotation=function(t,i,a,r){var s=new e;var n=r*(Math.PI/180);var o=Math.cos(n);var h=Math.sin(n);var u=1-o;var l,f;s.rawData[0]=o+t*t*u;s.rawData[5]=o+i*i*u;s.rawData[10]=o+a*a*u;l=t*i*u;f=a*h;s.rawData[1]=l+f;s.rawData[4]=l-f;l=t*a*u;f=i*h;s.rawData[8]=l+f;s.rawData[2]=l-f;l=i*a*u;f=t*h;s.rawData[9]=l-f;s.rawData[6]=l+f;return s};Object.defineProperty(e.prototype,"determinant",{get:function(){return(this.rawData[0]*this.rawData[5]-this.rawData[4]*this.rawData[1])*(this.rawData[10]*this.rawData[15]-this.rawData[14]*this.rawData[11])-(this.rawData[0]*this.rawData[9]-this.rawData[8]*this.rawData[1])*(this.rawData[6]*this.rawData[15]-this.rawData[14]*this.rawData[7])+(this.rawData[0]*this.rawData[13]-this.rawData[12]*this.rawData[1])*(this.rawData[6]*this.rawData[11]-this.rawData[10]*this.rawData[7])+(this.rawData[4]*this.rawData[9]-this.rawData[8]*this.rawData[5])*(this.rawData[2]*this.rawData[15]-this.rawData[14]*this.rawData[3])-(this.rawData[4]*this.rawData[13]-this.rawData[12]*this.rawData[5])*(this.rawData[2]*this.rawData[11]-this.rawData[10]*this.rawData[3])+(this.rawData[8]*this.rawData[13]-this.rawData[12]*this.rawData[9])*(this.rawData[2]*this.rawData[7]-this.rawData[6]*this.rawData[3])},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"position",{get:function(){return new t.Vector3D(this.rawData[12],this.rawData[13],this.rawData[14])},set:function(t){this.rawData[12]=t.x;this.rawData[13]=t.y;this.rawData[14]=t.z},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"scale",{get:function(){return new t.Vector3D(this.rawData[0],this.rawData[5],this.rawData[10])},enumerable:true,configurable:true});e.prototype.toString=function(){return"matrix3d("+Math.round(this.rawData[0]*1e3)/1e3+","+Math.round(this.rawData[1]*1e3)/1e3+","+Math.round(this.rawData[2]*1e3)/1e3+","+Math.round(this.rawData[3]*1e3)/1e3+","+Math.round(this.rawData[4]*1e3)/1e3+","+Math.round(this.rawData[5]*1e3)/1e3+","+Math.round(this.rawData[6]*1e3)/1e3+","+Math.round(this.rawData[7]*1e3)/1e3+","+Math.round(this.rawData[8]*1e3)/1e3+","+Math.round(this.rawData[9]*1e3)/1e3+","+Math.round(this.rawData[10]*1e3)/1e3+","+Math.round(this.rawData[11]*1e3)/1e3+","+Math.round(this.rawData[12]*1e3)/1e3+","+Math.round(this.rawData[13]*1e3)/1e3+","+Math.round(this.rawData[14]*1e3)/1e3+","+Math.round(this.rawData[15]*1e3)/1e3+")"};e.prototype.lerp=function(t,e,i){this.copyFrom(e).sub(t).mult(i).add(t)};return e}();t.Matrix4_4=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.eyePosition=new t.Vector3D;this.eyeRotation=new t.Vector3D(0,1,0);this.eyeSpace=1;this.eyeFocalLength=180;this.leftPos=new t.Vector3D;this.rightPos=new t.Vector3D;this.targetPos=new t.Vector3D(0,0,this.eyeFocalLength);this.lookAtPos=new t.Vector3D;this.quaternion=new t.Quaternion;this.leftEyeMatrix=new t.Matrix4_4;this.rightEyeMatrix=new t.Matrix4_4}e.prototype.updte=function(t){this.targetPos.z=this.eyeFocalLength;this.eyePosition=t.position;this.quaternion.fromMatrix(t);this.leftEyeMatrix.copyRawDataFrom(t.rawData);this.rightEyeMatrix.copyRawDataFrom(t.rawData);this.leftEyeMatrix.appendTranslation(-this.eyeSpace*.5,0,0);this.rightEyeMatrix.appendTranslation(this.eyeSpace*.5,0,0)};return e}();t.EyesMatrix=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.BACK=0;t.FRONT=1;t.IN=0;t.OUT=1;t.INTERSECT=2;return t}();t.PlaneClassification=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.RADIANS_TO_DEGREES=180/Math.PI;t.DEGREES_TO_RADIANS=Math.PI/180;return t}();t.MathUtil=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.quaternion2matrix=function(i,a){if(a===void 0){a=null}var r=i.x;var s=i.y;var n=i.z;var o=i.w;var h=r*r;var u=r*s;var l=r*n;var f=r*o;var c=s*s;var d=s*n;var p=s*o;var g=n*n;var m=n*o;var _=e.RAW_DATA_CONTAINER;_[0]=1-2*(c+g);_[1]=2*(u+m);_[2]=2*(l-p);_[4]=2*(u-m);_[5]=1-2*(h+g);_[6]=2*(d+f);_[8]=2*(l+p);_[9]=2*(d-f);_[10]=1-2*(h+c);_[3]=_[7]=_[11]=_[12]=_[13]=_[14]=0;_[15]=1;if(a){a.copyRawDataFrom(_);return a}else return new t.Matrix4_4(new Float32Array(_))};e.getForward=function(e,i){if(i===void 0){i=null}if(i===null){i=new t.Vector3D(0,0,0)}e.copyRowTo(2,i);i.normalize();return i};e.getUp=function(e,i){if(i===void 0){i=null}if(i===null){i=new t.Vector3D(0,0,0)}e.copyRowTo(1,i);i.normalize();return i};e.getRight=function(e,i){if(i===void 0){i=null}if(i===null){i=new t.Vector3D(0,0,0)}e.copyRowTo(0,i);i.normalize();return i};e.compare=function(t,i){var a=e.RAW_DATA_CONTAINER;var r=i.rawData;t.copyRawDataTo(a);for(var s=0;s<16;++s){if(a[s]!=r[s])return false}return true};e.reflection=function(i,a){if(a===void 0){a=null}if(a===null)a=new t.Matrix4_4;var r=i.a,s=i.b,n=i.c,o=i.d;var h=e.RAW_DATA_CONTAINER;var u=-2*r*s;var l=-2*r*n;var f=-2*s*n;h[0]=1-2*r*r;h[4]=u;h[8]=l;h[12]=-2*r*o;h[1]=u;h[5]=1-2*s*s;h[9]=f;h[13]=-2*s*o;h[2]=l;h[6]=f;h[10]=1-2*n*n;h[14]=-2*n*o;h[3]=0;h[7]=0;h[11]=0;h[15]=1;a.copyRawDataFrom(h);return a};e.getTranslation=function(e,i){if(i===void 0){i=null}if(!i)i=new t.Vector3D;e.copyRowTo(3,i);return i};e.clampf=function(t,e,i){if(e>i){var a=e;e=i;i=a}return t<e?e:t<i?t:i};e.RADIANS_TO_DEGREES=180/Math.PI;e.DEGREES_TO_RADIANS=Math.PI/180;e.RAW_DATA_CONTAINER=new Float32Array(16);e.CALCULATION_MATRIX=new t.Matrix4_4;return e}();t.Matrix3DUtils=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){if(e===void 0){e=new t.Vector3D}if(i===void 0){i=new t.Vector3D}this.origin=new t.Vector3D;this.dir=new t.Vector3D;this.invViewMat=new t.Matrix4_4;this.origin.copyFrom(e);this.dir.copyFrom(i)}e.prototype.IntersectTriangle=function(t,e,i,a){if(a===void 0){a=null}var r=e.subtract(t);var s=i.subtract(t);var n=this.dir.crossProduct(s);var o=r.dotProduct(n);var h;if(o>0){h=this.origin.subtract(t)}else{h=t.subtract(this.origin);o=-o}if(o<1e-4){return false}var u=h.dotProduct(n);if(a!=null){a[1]=u}if(u<0||u>o){return false}var l=h.crossProduct(r);var f=this.dir.dotProduct(l);if(a!=null){a[2]=f}if(f<0||u+f>o){return false}var c=s.dotProduct(l);var d=1/o;c*=d;u*=d;f*=d;if(a!=null){a[0]=c;a[1]=u;a[2]=f}if(c<0){return false}return true};e.prototype.IntersectMeshEx=function(t,e,i){return this.IntersectMesh(t.geometry.verticesData,t.geometry.indexData,t.geometry.vertexAttLength,t.geometry.indexData.length/3,e,t.modelMatrix,i)};e.prototype.IntersectMesh=function(e,i,a,r,s,n,o){var h=new Array;h.push(new t.Vector3D);h.push(new t.Vector3D);h.push(new t.Vector3D);var u=new Array;u.push(new t.Vector3D);u.push(new t.Vector3D);u.push(new t.Vector3D);var l=new Array;var f=new t.Vector3D;var c=new t.Vector3D;var d=new t.Vector3D;l.push(f);l.push(c);l.push(d);var p=new t.Vector3D;var g=new t.Point;var m=new Array;m.push(0);m.push(0);m.push(0);var _=-1;var v=Number.MAX_VALUE;var D=0;var y=0;for(var x=0;x<r;++x){for(var w=0;w<3;++w){var b=i[3*x+w];p.setTo(e[a*b+0],e[a*b+1],e[a*b+2]);p.copyFrom(n.transformVector(p));l[w].x=p.x;l[w].y=p.y;l[w].z=p.z}if(this.IntersectTriangle(f,c,d,m)){if(m[0]<v){_=x;v=m[0];D=m[1];y=m[2]}}}if(_<r&&_>=0){for(var x=0;x<3;++x){var b=i[3*_+x];p.setTo(e[a*b+0],e[a*b+1],e[a*b+2]);h[x].copyFrom(p);if(s>0){g.x=e[a*b+0+s];g.y=e[a*b+1+s];u[x].x=g.x;u[x].y=g.y}p.copyFrom(n.transformVector(p));l[x].x=p.x;l[x].y=p.y;l[x].z=p.z}var T=c.subtract(f);T.scaleBy(D);var A=d.subtract(f);A.scaleBy(y);o.globalPosition.copyFrom(f.add(T.add(A)));T=h[1].subtract(h[0]);T.scaleBy(D);A=h[2].subtract(h[0]);A.scaleBy(y);o.localPosition.copyFrom(h[0].add(T.add(A)));if(s>0){T=u[1].subtract(u[0]);T.scaleBy(D);A=u[2].subtract(u[0]);A.scaleBy(y);o.uv.copyFrom(u[0].add(T.add(A)))}return true}return false};e.prototype.CalculateAndTransformRay=function(t,e,i,a,r,s){this.reset();this.dir.x=(2*r/t-1)/a.rawData[0];this.dir.y=(-2*s/e+1)/a.rawData[5];this.dir.z=1;this.invViewMat.copyFrom(i);this.origin.copyFrom(this.invViewMat.transformVector(this.origin));this.dir.copyFrom(this.invViewMat.deltaTransformVector(this.dir));this.dir.normalize()};e.prototype.reset=function(){this.origin.setTo(0,0,0);this.dir.setTo(0,0,0)};return e}();t.Ray=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t,e,i,a){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(a===void 0){a=255}this.a=255;this.r=255;this.g=255;this.b=255;this.a=a;this.r=t;this.g=e;this.b=i}e.white=function(){return new e(255,255,255,255)};e.black=function(){return new e(0,0,0,255)};e.red=function(){return new e(255,0,0,255)};e.green=function(){return new e(0,255,0,255)};e.blue=function(){return new e(0,0,255,255)};e.prototype.getColor=function(e){if(e===void 0){e=t.Egret3DDrive.ColorFormat_RGBA8888}if(e==t.Egret3DDrive.ColorFormat_RGB565)return 0;if(e==t.Egret3DDrive.ColorFormat_RGBA5551)return 0;if(e==t.Egret3DDrive.ColorFormat_RGBA4444)return 0;return this.r<<24|this.g<<16|this.b<<8|this.a};e.prototype.lerp=function(t,e,i){this.a=i*(e.a-t.a)+t.a;this.r=i*(e.r-t.r)+t.r;this.g=i*(e.g-t.g)+t.g;this.b=i*(e.b-t.b)+t.b};return e}();t.Color=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.localPosition=new t.Vector3D;this.globalPosition=new t.Vector3D;this.uv=new t.Vector3D}return e}();t.PickResult=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.listeners={}}t.prototype.dispatchEvent=function(t){var e;var i;if(t instanceof a){i=t.type;e=t}else{i=t;e=new a(i)}if(this.listeners[i]!=null){e.currentTarget=this;for(var r=0;r<this.listeners[i].length;r++){var s=this.listeners[i][r];try{s.handler(e)}catch(n){if(window.console){console.error(n.stack)}}}}};t.prototype.addEventListener=function(t,e,a){if(a===void 0){a=0}if(this.listeners[t]==null){this.listeners[t]=[]}this.listeners[t].push(new i(t,e,a));this.listeners[t].sort(function(t,e){return e.priolity-t.priolity})};t.prototype.removeEventListener=function(t,e){if(this.hasEventListener(t,e)){for(var i=0;i<this.listeners[t].length;i++){var a=this.listeners[t][i];if(a.equalCurrentListener(t,e)){a.handler=null;this.listeners[t].splice(i,1);return}}}};t.prototype.clearEventListener=function(){this.listeners={}};t.prototype.containEventListener=function(t){if(this.listeners[t]==null)return false;return this.listeners[t].length>0};t.prototype.hasEventListener=function(t,e){if(this.listeners[t]==null)return false;for(var i=0;i<this.listeners[t].length;i++){var a=this.listeners[t][i];if(a.equalCurrentListener(t,e)){return true}}return false};return t}();t.EventDispatcher=e;var i=function(){function t(t,e,i){if(t===void 0){t=null}if(e===void 0){e=null}if(i===void 0){i=0}this.type=t;this.handler=e;this.priolity=i}t.prototype.equalCurrentListener=function(t,e){if(this.type==t&&this.handler==e){return true}return false};return t}();var a=function(){function t(t,e){if(t===void 0){t=null}if(e===void 0){e=null}this._type=t;this._data=e}Object.defineProperty(t.prototype,"currentTarget",{get:function(){return this._currentTarget},set:function(t){this._currentTarget=t},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t},enumerable:true,configurable:true});t.EVENT_LOAD_COMPLETE="load_complete";t.EVENT_LOAD_PROGRESS="onLoadProgress";t.MOUSE_CLICK="onClick";t.MOUSE_DOWN="onMouseDown";t.MOUSE_UP="onMouseUp";t.MOUSE_MOVE="onMouseMove";t.TOUCH_MOVE="onTouchMove";t.TOUCH_START="onTouchStart";t.TOUCH_END="onTouchEnd";t.COMPLETE="complete";t.CHANGE_PROPERTY="changeProperty";return t}();t.Event3D=a})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){var i=this;this._camera=e;t.Input.instance.addListenerKeyClick(function(t){return i.onMouseClick(t)});t.Input.instance.addListenerKeyDown(function(t){return i.onMouseDown(t)});t.Input.instance.addListenerKeyUp(function(t){return i.onMouseUp(t)});t.Input.instance.addListenerMouseMove(function(t){return i.onMouseMove(t)});t.Input.instance.addTouchStartCallback(function(t){return i.onTouchStart(t)});t.Input.instance.addTouchEndCallback(function(t){return i.onTouchEnd(t)});t.Input.instance.addTouchMoveCallback(function(t){return i.onTouchMove(t)})}e.prototype.onTouchMove=function(e){if(!this._collect)return;var i=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList);var a;for(var r=0;r<i.length;r++){a=new t.Event3D(t.Event3D.TOUCH_MOVE);a.currentTarget=i[r];a.data=e;i[r].dispatchEvent(a)}};e.prototype.onTouchEnd=function(e){if(!this._collect)return;var i=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList);var a;for(var r=0;r<i.length;r++){a=new t.Event3D(t.Event3D.TOUCH_END);a.currentTarget=i[r];a.data=e;i[r].dispatchEvent(a)}};e.prototype.onTouchStart=function(e){if(!this._collect)return;var i=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList);var a;for(var r=0;r<i.length;r++){a=new t.Event3D(t.Event3D.TOUCH_START);a.currentTarget=i[r];a.data=e;i[r].dispatchEvent(a)}};e.prototype.onMouseClick=function(e){if(!this._collect)return;var i=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList);var a;for(var r=0;r<i.length;r++){a=new t.Event3D(t.Event3D.MOUSE_CLICK);a.data=e;a.currentTarget=i[r];i[r].dispatchEvent(a)}};e.prototype.onMouseDown=function(e){if(!this._collect)return;var i=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList);var a;for(var r=0;r<i.length;r++){a=new t.Event3D(t.Event3D.MOUSE_DOWN);a.currentTarget=i[r];a.data=e;i[r].dispatchEvent(a)}};e.prototype.onMouseUp=function(e){if(!this._collect)return;var i=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList);var a;for(var r=0;r<i.length;r++){a=new t.Event3D(t.Event3D.MOUSE_UP);a.currentTarget=i[r];a.data=e;i[r].dispatchEvent(a)}};e.prototype.onMouseMove=function(e){if(!this._collect)return;var i=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList);var a;for(var r=0;r<i.length;r++){a=new t.Event3D(t.Event3D.MOUSE_MOVE);a.currentTarget=i[r];a.data=e;i[r].dispatchEvent(a)}};e.prototype.update=function(t){this._collect=t};e.left_mouse_over="left_mouse_over";e.left_mouse_down="left_mouse_down";e.left_mouse_up="left_mouse_up";e.left_mouse_click="left_mouse_click";e.right_mouse_over="right_mouse_over";e.right_mouse_down="right_mouse_down";e.right_mouse_up="right_mouse_up";e.right_mouse_click="right_mouse_click";e.middle_mouse_over="middle_mouse_over";e.middle_mouse_down="middle_mouse_down";e.middle_mouse_up="middle_mouse_up";e.middle_mouse_click="middle_mouse_click";e.mouse_move="mouse_move";return e}();t.Mouse3DManager=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.border=0;this.useMipmap=true;this.imageData=null;this.colorFormat=t.Egret3DDrive.ColorFormat_RGBA8888;this.internalFormat=t.InternalFormat.PixelArray;this.mimapData=new Array}e.prototype.upload=function(t){if(!this.texture){this.texture=t.creatTexture2D();this.texture.gpu_internalformat=this.internalFormat;this.texture.gpu_colorformat=this.colorFormat;this.texture.mipmapDatas=this.mimapData;this.texture.image=this.imageData;this.texture.gpu_border=0;if(this.useMipmap){for(var e=0;e<this.mimapData.length;e++){t.upLoadTextureData(e,this.texture)}}else{t.upLoadTextureData(0,this.texture)}}};e.prototype.uploadForcing=function(t){this.texture=t.creatTexture2D();this.texture.gpu_internalformat=this.internalFormat;this.texture.gpu_colorformat=this.colorFormat;this.texture.mipmapDatas=this.mimapData;this.texture.image=this.imageData;this.texture.gpu_border=0;if(this.useMipmap){for(var e=0;e<this.mimapData.length;e++){t.upLoadTextureData(e,this.texture)}}else{t.upLoadTextureData(0,this.texture)}};Object.defineProperty(e.prototype,"width",{get:function(){if(this.imageData)return this.imageData.width;else if(this.mimapData.length>0)return this.mimapData[0].width;return 0},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"height",{get:function(){if(this.imageData)return this.imageData.height;else if(this.mimapData.length>0)return this.mimapData[0].height;return 0},enumerable:true,configurable:true});return e}();t.TextureBase=e})(egret3d||(egret3d={}));var __extends=this&&this.__extends||function(t,e){for(var i in e)if(e.hasOwnProperty(i))t[i]=e[i];function a(){this.constructor=t}t.prototype=e===null?Object.create(e):(a.prototype=e.prototype,new a)};var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e,i){var a=this;if(e===void 0){e=256}if(i===void 0){i=256}t.call(this);this.canUpdataTexture=false;this._width=e;this._height=i;this.tmpCanvas=document.createElement("canvas");this.tmpCanvas.width=e;this.tmpCanvas.height=i;this.context=this.tmpCanvas.getContext("2d");this.video=document.createElement("video");this.video.msZoom=true;this.video.width=e;this.video.height=i;this.video.videoWidth=e;this.video.videoHeight=i;this.video.controls=false;this.video.autoplay=true;this.video.addEventListener("canplaythrough",function(){return a.loadReady()},true);this.tmpCanvas.hidden=true}e.prototype.loadReady=function(){this.canUpdataTexture=true};Object.defineProperty(e.prototype,"source",{get:function(){return this.video.src},set:function(t){this.video.src=t},enumerable:true,configurable:true});e.prototype.play=function(){this.video.play()};e.prototype.pause=function(){this.video.pause()};e.prototype.upload=function(t){if(!this.texture){this.texture=t.creatTexture2D();this.texture.gpu_internalformat=this.internalFormat;this.texture.gpu_colorformat=this.colorFormat;this.texture.mipmapDatas=this.mimapData;this.texture.image=this.imageData;this.texture.gpu_border=0;t.gl.bindTexture(t.gl.TEXTURE_2D,this.texture.gpu_texture);t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.LINEAR);t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST);
}if(this.canUpdataTexture){this.context.drawImage(this.video,0,0,this._width,this._height);t.gl.pixelStorei(t.gl.UNPACK_ALIGNMENT,1);t.gl.bindTexture(t.gl.TEXTURE_2D,this.texture.gpu_texture);t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGB,t.gl.RGB,t.gl.UNSIGNED_BYTE,this.tmpCanvas)}};return e}(t.TextureBase);t.VideoTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e){t.call(this);this.useMipmap=false;this.texture=e}return e}(t.TextureBase);t.RenderTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e,i,a,r,s,n){t.call(this);t:HTMLImageElement;this.image_front=e;this.image_back=i;this.image_left=a;this.image_right=r;this.image_up=s;this.image_down=n}e.prototype.upload=function(t){if(!this.cubeTexture){this.cubeTexture=t.creatCubeTexture();this.cubeTexture.image_front=this.image_front;this.cubeTexture.image_back=this.image_back;this.cubeTexture.image_left=this.image_left;this.cubeTexture.image_right=this.image_right;this.cubeTexture.image_up=this.image_up;this.cubeTexture.image_down=this.image_down;t.uploadCubetexture(this.cubeTexture)}};return e}(t.TextureBase);t.SkyTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this);this.imageData=t}i.prototype.upload=function(e){if(!this.texture){this.texture=e.creatTexture2D();this.texture.gpu_internalformat=t.InternalFormat.ImageData;this.texture.gpu_colorformat=t.Egret3DDrive.ColorFormat_RGBA8888;this.texture.image=this.imageData;this.useMipmap=false;e.upLoadTextureData(0,this.texture)}};return i}(t.TextureBase);t.ImageTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._width=32;this._height=32;this.buildCheckerboard();this.mimapData=new Array;this.mimapData.push(new t.MipmapData(this._pixelArray,this._width,this._height))}i.prototype.upload=function(e){if(!this.texture){this.texture=e.creatTexture2D();this.texture.gpu_border=0;this.texture.gpu_internalformat=t.InternalFormat.PixelArray;this.texture.gpu_colorformat=t.Egret3DDrive.ColorFormat_RGBA8888;this.texture.mipmapDatas=this.mimapData;this.useMipmap=false;e.upLoadTextureData(0,this.texture)}};i.prototype.buildCheckerboard=function(){if(!this._pixelArray){this._pixelArray=new Uint8Array(this._width*this._height*4);var e=[t.Color.white(),t.Color.black()];var i=0;var a=4;for(var r=0;r<this._height;r++){for(var s=0;s<this._width;s++){if(s%a==0){i=(i+1)%2}if(r%a==0&&s==0){var n=e[0];e[0]=e[1];e[1]=n;i=0}this._pixelArray[r*(this._width*4)+s*4+0]=e[i].r;this._pixelArray[r*(this._width*4)+s*4+1]=e[i].g;this._pixelArray[r*(this._width*4)+s*4+2]=e[i].b;this._pixelArray[r*(this._width*4)+s*4+3]=e[i].a}}}};i.texture=new i;return i}(t.TextureBase);t.CheckerboardTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.getTextureData=function(t){var i=t.width;var a=t.height;e.canvas2D.width=i;e.canvas2D.height=a;e.context2D.clearRect(0,0,i,a);e.context2D.drawImage(t,0,0,i,a,0,0,i,a);return e.canvas2D};e.regist=function(){if(!e.canvas2D){e.canvas2D=document.getElementById("TextureCanvasUtil");if(!e.context2D){e.canvas2D=document.createElement("canvas");e.canvas2D.id="TextureCanvasUtil";e.canvas2D.hidden=true;document.body.appendChild(e.canvas2D);e.context2D=e.canvas2D.getContext("2d")}}};e.generateMipMaps=function(e){var i=1;var a=1;var r=Math.ceil(e.width/2);var s=Math.ceil(e.height/2);var n=new Array;n.push(e);var o;while(r>=i||s>=a){o=new t.MipmapData(h(e.data),r,s);r>>=1;s>>=1;e=o}function h(t){var e=new Uint8Array(Math.ceil(t.length/2));var i=0;for(var a=0;a<t.length;a++){if(a%2==0){e[i++]=t[a]}}return e}};return e}();t.TextureUtil=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.prototype.fillGeomtryData=function(t){};return t}();t.AnimNodeBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.nodes=new Array;this._vertexAttributes={};this.nodes=new Array}t.prototype.addNode=function(t){this.nodes.push(t)};t.prototype.removeNode=function(t){var e=this.nodes.indexOf(t);if(e!=-1)this.nodes.splice(e,1)};t.prototype.getNodes=function(){return this.nodes};t.prototype.getNodesVertexShaders=function(){var t=[];for(var e=0;e<this.nodes.length;e++){if(this.nodes[e].vertexShader!=""&&this.nodes[e].vertexShader!=undefined&&this.nodes[e].vertexShader!=null)t.push(this.nodes[e].vertexShader)}return t};t.prototype.getNodesFragmentShaders=function(){var t=[];for(var e=0;e<this.nodes.length;e++){if(this.nodes[e].fragmentShader!=""&&this.nodes[e].fragmentShader!=undefined&&this.nodes[e].fragmentShader!=null)t.push(this.nodes[e].fragmentShader)}return t};t.prototype.calculateNode=function(){var t=4+3+2;for(var e=0;e<this.nodes.length;e++){if(this.nodes[e].usageAttributeLen>0){this.nodes[e].offset=t;this.nodes[e].offsetBytes=t*Float32Array.BYTES_PER_ELEMENT;t+=this.nodes[e].usageAttributeLen}}this.numberOfVertices=t;this.vertexSizeInBytes=t*Float32Array.BYTES_PER_ELEMENT};return t}();t.AnimaNodeCollection=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){this.jointMatrixValid=false;this.worldMatrixValid=false;this.jointMatrix=new t.Matrix4_4;this.worldMatrix=new t.Matrix4_4;this.name=null;this.parent=null;this.parentIndex=-1;this.inverseBindPose=null;this.scale=null;this.orientation=null;this.translation=null;this.localMatrix=null;this.name=e}e.prototype.clone=function(){var i=new e(this.name);i.parent=this.parent;i.parentIndex=this.parentIndex;if(this.inverseBindPose){i.inverseBindPose=new t.Matrix4_4;i.inverseBindPose.copyFrom(this.inverseBindPose)}if(this.scale){i.scale=new t.Vector3D;i.scale.copyFrom(this.scale)}if(this.orientation){i.orientation=new t.Quaternion;i.orientation.copyFrom(this.orientation)}if(this.translation){i.translation=new t.Vector3D;i.translation.copyFrom(this.translation)}if(this.scale&&this.orientation&&this.translation){i.setLocalTransform(i.orientation,i.scale,i.translation)}return i};e.prototype.setInverseBindPose=function(e,i,a){if(!this.inverseBindPose){this.inverseBindPose=new t.Matrix4_4}this.inverseBindPose.recompose([e,i,a])};e.prototype.setLocalTransform=function(e,i,a){this.translation=a;this.orientation=e;this.scale=i;if(!this.localMatrix){this.localMatrix=new t.Matrix4_4}this.localMatrix.makeTransform(this.translation,this.scale,this.orientation)};return e}();t.Joint=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){if(e===void 0){e=null}this.frameTime=0;this.joints=[];this.skeletonMatrixValid=false;this._skeletonMatrix=null;this._initialSkeleton=null;this._temp_q0=new t.Quaternion;this._temp_q1=new t.Quaternion;this._temp_q2=new t.Quaternion;this._temp_v0=new t.Vector3D;this._temp_v1=new t.Vector3D;this._temp_v2=new t.Vector3D;if(e){this.initialSkeleton=e}}e.prototype.clone=function(){var t=new e(this.initialSkeleton);t.frameTime=this.frameTime;for(var i=0;i<this.joints.length;i++){t.joints.push(this.joints[i].clone())}return t};e.prototype.reset=function(){for(var t=0;t<this.joints.length;t++){this.joints[t].jointMatrix.identity();this.joints[t].jointMatrixValid=false;this.joints[t].worldMatrix.identity();this.joints[t].worldMatrixValid=false;this.joints[t].orientation.x=this.joints[t].orientation.y=this.joints[t].orientation.z=this.joints[t].orientation.w=0;this.joints[t].scale.x=this.joints[t].scale.y=this.joints[t].scale.z=this.joints[t].scale.w=0;this.joints[t].translation.x=this.joints[t].translation.y=this.joints[t].translation.z=this.joints[t].translation.w=0}};Object.defineProperty(e.prototype,"initialSkeleton",{get:function(){return this._initialSkeleton},set:function(t){this._initialSkeleton=t;if(!this._skeletonMatrix){this._skeletonMatrix=new Float32Array(this._initialSkeleton.numJoint*8);this.skeletonMatrixValid=false}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"skeletonMatrix",{get:function(){return this._skeletonMatrix},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"numJoint",{get:function(){return this.joints.length},enumerable:true,configurable:true});e.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++){if(this.joints[e].name==t)return this.joints[e]}return null};e.prototype.findJointIndex=function(t){for(var e=0;e<this.joints.length;e++){if(this.joints[e].name==t)return e}return-1};e.prototype.skeletonLerp=function(t,e,i){this.frameTime=i;var a=(i-t.frameTime)/Math.abs(e.frameTime-t.frameTime);this.lerp(t,e,a)};e.prototype.lerp=function(e,i,a){for(var r=0;r<e.joints.length;r++){if(r>=this.joints.length){this.joints.push(new t.Joint(null))}var s=this.joints[r];s.name=e.joints[r].name;s.worldMatrixValid=true;this._temp_q0.fromMatrix(e.joints[r].worldMatrix);this._temp_q1.fromMatrix(i.joints[r].worldMatrix);this._temp_q2.lerp(this._temp_q0,this._temp_q1,a);e.joints[r].worldMatrix.copyRowTo(3,this._temp_v0);i.joints[r].worldMatrix.copyRowTo(3,this._temp_v1);this._temp_v2.lerp(this._temp_v0,this._temp_v1,a);this._temp_q2.toMatrix3D(s.worldMatrix);s.worldMatrix.rawData[12]=this._temp_v2.x;s.worldMatrix.rawData[13]=this._temp_v2.y;s.worldMatrix.rawData[14]=this._temp_v2.z;s.jointMatrixValid=false;this.skeletonMatrixValid=false}};e.prototype.toMatrixData=function(t){if(t===void 0){t=null}var e=this._initialSkeleton.joints;if(!t){t=new Float32Array(this.joints.length*8)}for(var i=0;i<e.length;i++){for(var a=0;a<this.joints.length;a++){if(this.joints[a].name!=e[i].name)continue;this._temp_q0.fromMatrix(this.joints[a].jointMatrix);t[i*8+0]=this._temp_q0.x;t[i*8+1]=this._temp_q0.y;t[i*8+2]=this._temp_q0.z;t[i*8+3]=this._temp_q0.w;t[i*8+4]=this.joints[a].jointMatrix.rawData[12];t[i*8+5]=this.joints[a].jointMatrix.rawData[13];t[i*8+6]=this.joints[a].jointMatrix.rawData[14];t[i*8+7]=1;break}}return t};e.prototype.updateSkeletonMatrix=function(){if(this.skeletonMatrixValid){return}this.toMatrixData(this._skeletonMatrix);this.skeletonMatrixValid=true};e.prototype.calculateJointWorldMatrix=function(e){for(var i=0;i<this.joints.length;i++){var a=this.joints[i];this.calculateAbsoluteMatrix(this.joints,i,e)}for(var i=0;i<this.joints.length;i++){var a=this.joints[i];if(!a.jointMatrixValid){a.jointMatrix=new t.Matrix4_4;if(e.joints[i].inverseBindPose){a.jointMatrix.copyFrom(e.joints[i].inverseBindPose);a.jointMatrix.append(a.worldMatrix)}a.jointMatrixValid=true}}this.skeletonMatrixValid=false};e.prototype.calculateAbsoluteMatrix=function(t,e,i){var a=t[e];var r=i.joints[e].parentIndex;if(r>=0){this.calculateAbsoluteMatrix(t,r,i)}if(!a.worldMatrixValid){a.worldMatrix.copyFrom(a.localMatrix);if(r>=0){a.worldMatrix.append(t[r].worldMatrix)}a.worldMatrixValid=true}};return e}();t.Skeleton=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){this.frameCount=0;this._animName=null;this._sampling=1;this._loop=true;this._playing=true;this._enabled=true;this._weight=1;this._length=0;this._parent=null;this._poseArray=null;this._animName=t}Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"poseArray",{get:function(){return this._poseArray},set:function(t){this._poseArray=t;this._length=t[t.length-1].frameTime},enumerable:true,configurable:true});e.prototype.clone=function(){var t=new e(this.animationName);t.frameCount=this.frameCount;t.poseArray=this._poseArray;return t};e.prototype.hasEnded=function(){return this._timePosition>=this._length&&!this._loop};e.prototype.addTime=function(t){this.timePosition+=t};Object.defineProperty(e.prototype,"currentFrameIndex",{get:function(){var t=Math.floor(this._timePosition/80)%this._poseArray.length;return t},set:function(t){t=Math.abs(t)%this._poseArray.length;this.timePosition=t*80},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"nextFrameIndex",{get:function(){return(this.currentFrameIndex+1)%this._poseArray.length},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"animationName",{get:function(){return this._animName},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"length",{get:function(){return this._length},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"sampling",{get:function(){return this._sampling},set:function(t){this._sampling=Math.max(t,1)},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"play",{get:function(){return this._playing},set:function(t){this._playing=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"weight",{get:function(){return this._weight},set:function(t){this._weight=t;if(this._enabled){}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"timePosition",{get:function(){return this._timePosition},set:function(t){if(t!=this._timePosition){this._timePosition=t;if(this._loop){this._timePosition=t%this._length;if(this._timePosition<0){this._timePosition+=this._length}}else{if(this._timePosition<0){this._timePosition=0}else if(this._timePosition>this._length){this._timePosition=this._length;this._playing=false}}if(this.enabled){}}},enumerable:true,configurable:true});e.prototype.fillFrame=function(e){for(var i=0;i<this._poseArray.length;i++){this._poseArray[i].calculateJointWorldMatrix(e)}if(this.frameCount==this._poseArray.length-1)return;var a=new Array;var r=60;var s=1e3/r;a.push(this._poseArray[0]);for(var n=1;n<=this.frameCount;n++){var o=a[n-1];var h=this._poseArray[(Math.floor(n/this.sampling)+1)%this._poseArray.length];var u=new t.Skeleton;u.skeletonLerp(o,h,n*s);a.push(u)}this.poseArray=a};return e}();t.SkeletonAnimationClip=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this);this.smooth=false;this._initialSkeleton=null;this._animList=[];this._animationSkeleton=new t.Skeleton;this._bindList={};this._enabledSkeletonAnimationClips=[];this._eventCallbackList=[];this._skeletonAnimationClips={};this._blendSkeleton=null;this._useCache=true;this._playSpeed=1;this._playing=false;this._currentFrame=0;this._temp_smooth=new t.Skeleton;this._temp_quat=new t.Quaternion;this._temp_vec3=new t.Vector3D;this._initialSkeleton=i;this._skeletonMatrix=new Float32Array(this._initialSkeleton.numJoint*8)}Object.defineProperty(i.prototype,"skeletonAnimationController",{get:function(){return this},enumerable:true,configurable:true});i.prototype.initShader=function(t,e){t.maxBone=this.jointNumber*2};i.prototype.clone=function(){var t=new i(this._initialSkeleton);for(var e in this._skeletonAnimationClips){t._skeletonAnimationClips[e]=this._skeletonAnimationClips[e].clone()}t._animationSkeleton=this._animationSkeleton;t._animList=this._animList;t._blendSkeleton=this._blendSkeleton.clone();return t};Object.defineProperty(i.prototype,"currentSkeletonMatrixData",{get:function(){return this._skeletonMatrix},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"jointNumber",{get:function(){return this._initialSkeleton.numJoint},enumerable:true,configurable:true});i.prototype.addSkeletonAnimationClip=function(e){if(this._skeletonAnimationClips[e.animationName]){return this._skeletonAnimationClips[e.animationName]}if(this._animationSkeleton.numJoint<e.poseArray[0].joints.length&&this._animationSkeleton.numJoint!=e.poseArray[0].joints.length){this._animationSkeleton.joints=[];var i=e.poseArray[0].joints;for(var a=0;a<i.length;a++){var r=new t.Joint(i[a].name);r.parentIndex=e.poseArray[0].findJointIndex(i[a].parent);var s=this._initialSkeleton.findJoint(r.name);if(s){r.inverseBindPose=s.inverseBindPose}else{r.inverseBindPose=null}this._animationSkeleton.joints.push(r)}}e.fillFrame(this._animationSkeleton);e.parent=this;for(var a=0;a<e.poseArray.length;a++){e.poseArray[a].initialSkeleton=this._initialSkeleton}this._skeletonAnimationClips[e.animationName]=e;this._animList.push(e.animationName);if(!this._blendSkeleton){this._blendSkeleton=e.poseArray[0].clone()}return e};i.prototype.updata=function(t,e){if(this._enabledSkeletonAnimationClips.length<=0)return;var i=0;var a=null;var r=null;var s=null;var n=null;this._blendSkeleton.reset();var o=e/300*1;for(var h=0;h<this._enabledSkeletonAnimationClips.length;h++){r=this._enabledSkeletonAnimationClips[h];if(h!=this._enabledSkeletonAnimationClips.length-1){r.weight=Math.max(0,r.weight-o);if(r.weight<=0){this._enabledSkeletonAnimationClips.splice(h,1);h--;continue}}else{r.weight=Math.min(1,r.weight+o)}r.addTime(e*this._playSpeed*5)}if(this._enabledSkeletonAnimationClips.length>1){r=this._enabledSkeletonAnimationClips[0];a=r.poseArray[r.currentFrameIndex];if(!a.skeletonMatrixValid){a.calculateJointWorldMatrix(this._animationSkeleton)}n=this._enabledSkeletonAnimationClips[1];s=n.poseArray[n.currentFrameIndex];if(!s.skeletonMatrixValid){s.calculateJointWorldMatrix(this._animationSkeleton)}for(var h=0;h<this._blendSkeleton.numJoint;h++){this._blendSkeleton.joints[h].orientation.lerp(a.joints[h].orientation,s.joints[h].orientation,n.weight);this._blendSkeleton.joints[h].scale.lerp(a.joints[h].scale,s.joints[h].scale,n.weight);this._blendSkeleton.joints[h].translation.lerp(a.joints[h].translation,s.joints[h].translation,n.weight);this._blendSkeleton.joints[h].setLocalTransform(this._blendSkeleton.joints[h].orientation,this._blendSkeleton.joints[h].scale,this._blendSkeleton.joints[h].translation)}this._blendSkeleton.calculateJointWorldMatrix(this._animationSkeleton);this._blendSkeleton.toMatrixData(this._skeletonMatrix)}else{r=this._enabledSkeletonAnimationClips[0];a=r.poseArray[r.currentFrameIndex];if(!a.skeletonMatrixValid){a.calculateJointWorldMatrix(this._animationSkeleton)}a.toMatrixData(this._skeletonMatrix)}};i.prototype.play=function(t,e){if(t===void 0){t=null}if(e===void 0){e=1}if(!this._skeletonAnimationClips[t])return false;this._enabledSkeletonAnimationClips.push(this._skeletonAnimationClips[t]);this._enabledSkeletonAnimationClips[this._enabledSkeletonAnimationClips.length-1].weight=this._enabledSkeletonAnimationClips.length>1?0:1;this._enabledSkeletonAnimationClips[this._enabledSkeletonAnimationClips.length-1].play=true;this._enabledSkeletonAnimationClips[this._enabledSkeletonAnimationClips.length-1].timePosition=0;this._currentFrame=0;this._playSpeed=e;this._playing=true;return true};i.prototype.playOnce=function(t,e){if(t===void 0){t=null}if(e===void 0){e=1}if(this.currentAnim!=t){if(!this._skeletonAnimationClips[t])return false;this.currentAnim=t;this._enabledSkeletonAnimationClips=[];this._enabledSkeletonAnimationClips.push(this._skeletonAnimationClips[t])}this._currentFrame=0;this._enabledSkeletonAnimationClips[0].play=true;this._enabledSkeletonAnimationClips[0].timePosition=0;this._enabledSkeletonAnimationClips[0].loop=false;this._playSpeed=e;this._playing=true;return true};Object.defineProperty(i.prototype,"currentFrame",{get:function(){return this._currentFrame},set:function(t){if(this._enabledSkeletonAnimationClips.length<=0)return;this._enabledSkeletonAnimationClips[0].timePosition=t*160},enumerable:true,configurable:true});i.prototype.getTotalNumberOfFrame=function(t){if(t===void 0){t=null}t=t?t:this.currentAnim;var e=this._skeletonAnimationClips[t];if(!e)return 0;return e.poseArray.length};i.prototype.stop=function(){this._playing=false};i.prototype.isPlay=function(){if(false==this._enabledSkeletonAnimationClips[0].play){return false}return this._playing&&this._enabledSkeletonAnimationClips.length>0};i.prototype.setPlaySpeed=function(t){this._playSpeed=t};i.prototype.bindToJointPose=function(t,e){var i=this._animationSkeleton.findJointIndex(t);if(i<0)return false;var a=null;if(this._bindList[i]){a=this._bindList[i]}else{a=new Array;this._bindList[i]=a}a.push(e);return true};i.prototype.updateBindList=function(t){var e=null;var i=null;var a=null;for(var r in this._bindList){e=this._bindList[r];if(e.length<=0)continue;i=t.joints[r];if(!i)continue;for(var s=0;s<e.length;s++){a=e[s];this._temp_quat.fromMatrix(i.worldMatrix);this._temp_quat.toEulerAngles(this._temp_vec3);a.rotationX=this._temp_vec3.x;a.rotationY=this._temp_vec3.y;a.rotationZ=this._temp_vec3.z;a.x=i.worldMatrix.position.x;a.y=i.worldMatrix.position.y;a.z=i.worldMatrix.position.z}}};i.prototype.getAnimList=function(){return this._animList};i.prototype.getAnimNode=function(){return null};Object.defineProperty(i.prototype,"dirtyFrameNumber",{get:function(){return this._dirtyFrameNumber},enumerable:true,configurable:true});i.prototype.getAnimationState=function(t){return this._skeletonAnimationClips[t]};i.prototype.removeAnimationState=function(t){if(!this._skeletonAnimationClips[t]){console.log("animation named: "+t+"not exists. SkeletonAnimationClip::removeAnimationState")}delete this._skeletonAnimationClips[t]};i.prototype.removeAllAnimationStates=function(){this._skeletonAnimationClips={};this._enabledSkeletonAnimationClips=[]};i.EVENT_PLAY_COMPLETE="event_play_complete";i.EVENT_FRAME_CHANGE="event_frame_change";return i}(t.EventDispatcher);t.SkeletonAnimation=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){}t.attribute_position="attribute_position";t.attribute_normal="attribute_normal";t.attribute_tangent="attribute_tangent";t.attribute_vertexColor="attribute_vertexColor";t.attribute_uv0="attribute_uv0";t.attribute_uv1="attribute_uv1";t.varying_pos="varying_pos";t.varying_normal="varying_normal";t.varying_tangent="varying_tangent";t.varying_color="varying_color";t.varying_uv0="varying_uv0";t.varying_uv1="varying_uv1";t.varying_globalPos="varying_globalPos";t.varying_lightDir="varying_lightDir";t.varying_eye="varying_eye";t.uniform_floatv_0="uniform_floatv_0";t.uniform_floatv_1="uniform_floatv_1";t.uniform_floatv_2="uniform_floatv_2";t.uniform_iv_0="uniform_iv_0";t.uniform_iv_1="uniform_iv_1";t.uniform_iv_2="uniform_iv_2";t.uniform_bv_0="uniform_bv_0";t.uniform_bv_1="uniform_bv_1";t.uniform_bv_2="uniform_bv_2";t.uniform_vec2fv_0="uniform_vec2fv_0";t.uniform_vec2fv_1="uniform_vec2fv_1";t.uniform_vec2fv_2="uniform_vec2fv_2";t.uniform_vec3fv_0="uniform_vec3fv_0";t.uniform_vec3fv_1="uniform_vec3fv_1";t.uniform_vec3fv_2="uniform_vec3fv_2";t.uniform_vec4fv_0="uniform_vec4fv_0";t.uniform_vec4fv_1="uniform_vec4fv_1";t.uniform_vec4fv_2="uniform_vec4fv_2";t.uniform_vec2iv_0="uniform_vec2iv_0";t.uniform_vec2iv_1="uniform_vec2iv_1";t.uniform_vec2iv_2="uniform_vec2iv_2";t.uniform_vec3iv_0="uniform_vec3iv_0";t.uniform_vec3iv_1="uniform_vec3iv_1";t.uniform_vec3iv_2="uniform_vec3iv_2";t.uniform_vec4iv_0="uniform_vec4iv_0";t.uniform_vec4iv_1="uniform_vec4iv_1";t.uniform_vec4iv_2="uniform_vec4iv_2";t.uniform_vec2bv_0="uniform_vec2bv_0";t.uniform_vec2bv_1="uniform_vec2bv_1";t.uniform_vec2bv_2="uniform_vec2bv_2";t.uniform_vec3bv_0="uniform_vec3bv_0";t.uniform_vec3bv_1="uniform_vec3bv_1";t.uniform_vec3bv_2="uniform_vec3bv_2";t.uniform_vec4bv_0="uniform_vec4bv_0";t.uniform_vec4bv_1="uniform_vec4bv_1";t.uniform_vec4bv_2="uniform_vec4bv_2";t.uniform_modelMatrix="uniform_modelMatrix";t.uniform_projectionMatrix="uniform_projectionMatrix";t.uniform_normalMatrix="uniform_normalMatrix";t.uniform_eye="uniform_eye";t.uniform_lightDir="uniform_lightDir";t.texture2D_0="texture2D_0";t.texture2D_1="texture2D_1";t.texture2D_2="texture2D_2";t.texture2D_3="texture2D_3";t.texture2D_4="texture2D_4";return t}();t.VarConstName=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){}t.int="int";t.float="float";t.vec2="vec2";t.vec3="vec3";t.vec4="vec4";t.mat2="mat2";t.mat3="mat3";t.mat4="mat4";return t}();t.AttributeType=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){}t.bool="bool";t.int="int";t.float="float";t.vec2="vec2";t.vec3="vec3";t.vec4="vec4";t.bvec2="bvec2";t.bvec3="bvec3";t.bvec4="bvec4";t.ivec2="ivec2";t.ivec3="ivec3";t.ivec4="ivec4";t.mat2="mat2";t.mat3="mat3";t.mat4="mat4";t.sampler2D="sampler2D";t.sampleCube="sampleCube";return t}();t.UniformType=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){}t.bool="bool";t.int="int";t.float="float";t.vec2="vec2";t.vec3="vec3";t.vec4="vec4";t.bvec2="bvec2";t.bvec3="bvec3";t.bvec4="bvec4";t.ivec2="ivec2";t.ivec3="ivec3";t.ivec4="ivec4";t.mat2="mat2";t.mat3="mat3";t.mat4="mat4";t.sampler2D="sampler2D";t.sampleCube="sampleCube";return t}();t.VaryingType=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){this.valueType="";this.value="";this.activeTextureIndex=-1;this.index=-1}t.prototype.var=function(t){return this.level+" "+this.valueType+" "+name+"."+t};t.prototype.use=function(t){if(t===void 0){t=""}if(t!="")return this.name+"."+t;return this.name};t.prototype.clone=function(){var e=new t;e.name=this.name;e.valueType=this.valueType;e.level=this.level;e.varName=this.varName;e.value=this.value;return e};t.prototype.computeVarName=function(){var t=this.name.indexOf("[");if(t>=0){this.varName=this.name.substr(0,t)}else{this.varName=this.name}};return t}();t.VarRegister=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this);this.name=e;this.computeVarName();this.key="";this.valueType=i}return e}(t.VarRegister);t.TmpVar=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this);this.name=e;this.computeVarName();this.key="attribute";this.valueType=i}return e}(t.VarRegister);t.Attribute=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this);this.name=e;this.computeVarName();this.key="varying";this.valueType=i}return e}(t.VarRegister);t.Varying=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this);this.name=e;this.computeVarName();this.key="uniform";this.valueType=i}return e}(t.VarRegister);t.Uniform=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i,a){t.call(this);this.name=e;this.computeVarName();this.key="const";this.valueType=i;this.value=a}return e}(t.VarRegister);t.ConstVar=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e){t.call(this);this.name=e;this.computeVarName();this.key="sampler2D"}return e}(t.VarRegister);t.Sampler2D=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e){t.call(this);this.name=e;this.computeVarName();this.key="samplerCube"}return e}(t.VarRegister);t.Sampler3D=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(){function e(t,e){this.index=0;this.source="precision highp float;            	\n";this.shadersName=new Array;this.endShadername="";this.stateChange=false;this.maxBone=0;this.useage=e;this.materialData=t}e.prototype.addShader=function(t){this.shadersName.push(t)};e.prototype.addEnd=function(t){this.endShadername=t};e.prototype.activate=function(t,e,i,a){};e.prototype.updata=function(t,e,i,a){};e.prototype.getShaderSource=function(){if(this.endShadername!=""){var e=this.shadersName.indexOf(this.endShadername);if(e==-1){this.shadersName.push(this.endShadername)}}var i=t.ShaderSystemTool.instance.getShader(this.shadersName,this.useage);var a;for(var r in i.attributeList){this.connectAtt(i.attributeList[r])}for(var r in i.structDict){this.connectStruct(i.structDict[r])}for(a=0;a<i.varyingList.length;a++){this.connectVarying(i.varyingList[a])}for(a=0;a<i.tempList.length;a++){this.connectTemp(i.tempList[a])}for(a=0;a<i.constList.length;a++){if(i.constList[a].varName=="max_directLight"){i.constList[a].value=this.materialData.directLightList.length.toString()}if(i.constList[a].varName=="bonesNumber"){i.constList[a].value=this.maxBone}if(i.constList[a].varName=="max_sportLight"){i.constList[a].value=this.materialData.sportLightList.length.toString()}if(i.constList[a].varName=="max_pointLight"){i.constList[a].value=this.materialData.pointLightList.length.toString()}this.connectConst(i.constList[a])}for(a=0;a<i.uniformList.length;a++){this.connectUniform(i.uniformList[a])}for(a=0;a<i.sampler2DList.length;a++){var s=i.sampler2DList[a];s=s.clone();this.connectSampler(s);s.activeTextureIndex=this.getTexture2DIndex(a);s.index=a;this.useage.sampler2DList.push(s)}for(a=0;a<i.sampler3DList.length;a++){var n=i.sampler3DList[a];n=n.clone();this.connectSampler3D(n);n.activeTextureIndex=this.getTexture2DIndex(i.sampler2DList.length+a);n.index=i.sampler2DList.length+a;this.useage.sampler3DList.push(n)}for(a=0;a<i.funcList.length;a++){this.source+=i.funcList[a].func}return this.source};e.prototype.connectAtt=function(t){this.source+="attribute "+t.valueType+" "+t.name+"; \r\n"};e.prototype.connectTemp=function(t){this.source+=t.valueType+" "+t.name+"; \r\n"};e.prototype.connectStruct=function(t){this.source+=t+" \r\n"};e.prototype.connectConst=function(t){this.source+="const "+t.valueType+" "+t.name+" = "+t.value+"; \r\n"};e.prototype.connectVarying=function(t){this.source+="varying "+t.valueType+" "+t.name+"; \r\n"};e.prototype.connectUniform=function(t){this.source+="uniform "+t.valueType+" "+t.name+"; \r\n"};e.prototype.connectSampler=function(t){this.source+="uniform sampler2D "+t.name+"; \r\n"};e.prototype.connectSampler3D=function(t){this.source+="uniform samplerCube "+t.name+"; \r\n"};e.prototype.getTexture2DIndex=function(e){switch(e){case 0:return t.ContextSamplerType.TEXTURE_0;break;case 1:return t.ContextSamplerType.TEXTURE_1;break;case 2:return t.ContextSamplerType.TEXTURE_2;break;case 3:return t.ContextSamplerType.TEXTURE_3;break;case 4:return t.ContextSamplerType.TEXTURE_4;break;case 5:return t.ContextSamplerType.TEXTURE_5;break;case 6:return t.ContextSamplerType.TEXTURE_6;break;case 7:return t.ContextSamplerType.TEXTURE_7;break;case 8:return t.ContextSamplerType.TEXTURE_8;break}throw new Error("texture not big then 8");return-1};e.prototype.dispose=function(){this.materialData=null;this.useage=null;this.source="";this.source=null;this.shadersName.length=0;this.shadersName=null};return e}();e.ShaderBase=i})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){this.name="";this.func=""}return t}();t.FuncData=e;var i=function(){function t(){this.name="";this.funcDict={};this.structDict={};this.attributeList=new Array;this.varyingList=new Array;this.uniformList=new Array;this.constList=new Array;this.tempList=new Array;this.sampler2DList=new Array;this.sampler3DList=new Array;this.funcList=new Array}t.prototype.addVar=function(t){if(t.key=="attribute"){this.attributeList.push(t)}else if(t.key=="varying"){this.varyingList.push(t)}else if(t.key=="uniform"){this.uniformList.push(t)}else if(t.key=="const"){this.constList.push(t)}else if(t.key=="sampler2D"){this.sampler2DList.push(t)}else if(t.key=="samplerCube"){this.sampler3DList.push(t)}else{this.tempList.push(t)}};t.prototype.addFunc=function(t,i){if(this.funcDict[t]==undefined){this.funcDict[t]=i;var a=new e;a.name=t;a.func=i;if(t=="main"){this.funcList.push(a)}else{this.funcList.unshift(a)}}else{if(t=="main"){var r=this.mergeMainFunc(this.funcDict[t],i);this.funcDict[t]=r;var a=this.findFunc(t);if(a){
a.func=r}}else{console.log("<"+t+">"+"函数重复")}}};t.prototype.addStruct=function(t,e){if(this.structDict[t]==undefined){this.structDict[t]=e}else{console.log("<"+t+">"+"struct重复")}};t.prototype.addContent=function(t){for(var e in t.structDict){this.structDict[e]=t.structDict[e]}for(var e in t.funcDict){this.addFunc(e,t.funcDict[e])}for(var i=0;i<t.attributeList.length;++i){var a=true;for(var r=0;r<this.attributeList.length;++r){if(t.attributeList[i].name==this.attributeList[r].name){if(t.attributeList[i].valueType!=this.attributeList[r].valueType||t.attributeList[i].key!=this.attributeList[r].key){console.log("Error :addContent")}a=false;break}}if(a){this.attributeList.push(t.attributeList[i].clone())}}for(var i=0;i<t.varyingList.length;++i){var a=true;for(var r=0;r<this.varyingList.length;++r){if(t.varyingList[i].name==this.varyingList[r].name){if(t.varyingList[i].valueType!=this.varyingList[r].valueType||t.varyingList[i].key!=this.varyingList[r].key){console.log("Error :addContent")}a=false;break}}if(a){this.varyingList.push(t.varyingList[i].clone())}}for(var i=0;i<t.uniformList.length;++i){var a=true;for(var r=0;r<this.uniformList.length;++r){if(t.uniformList[i].name==this.uniformList[r].name){if(t.uniformList[i].valueType!=this.uniformList[r].valueType||t.uniformList[i].key!=this.uniformList[r].key){console.log("Error :addContent")}a=false;break}}if(a){this.uniformList.push(t.uniformList[i].clone())}}for(var i=0;i<t.constList.length;++i){var a=true;for(var r=0;r<this.constList.length;++r){if(t.constList[i].name==this.constList[r].name){if(t.constList[i].valueType!=this.constList[r].valueType||t.constList[i].key!=this.constList[r].key){console.log("Error :addContent")}a=false;break}}if(a){this.constList.push(t.constList[i].clone())}}for(var i=0;i<t.tempList.length;++i){var a=true;for(var r=0;r<this.tempList.length;++r){if(t.tempList[i].name==this.tempList[r].name){if(t.tempList[i].valueType!=this.tempList[r].valueType||t.tempList[i].key!=this.tempList[r].key){console.log("Error :addContent")}a=false;break}}if(a){this.tempList.push(t.tempList[i].clone())}}for(var i=0;i<t.sampler2DList.length;++i){var a=true;for(var r=0;r<this.sampler2DList.length;++r){if(t.sampler2DList[i].name==this.sampler2DList[r].name){if(t.sampler2DList[i].valueType!=this.sampler2DList[r].valueType||t.sampler2DList[i].key!=this.sampler2DList[r].key){console.log("Error :addContent")}a=false;break}}if(a){this.sampler2DList.push(t.sampler2DList[i].clone())}}for(var i=0;i<t.sampler3DList.length;++i){var a=true;for(var r=0;r<this.sampler3DList.length;++r){if(t.sampler3DList[i].name==this.sampler3DList[r].name){if(t.sampler2DList[i].valueType!=this.sampler3DList[r].valueType||t.sampler3DList[i].key!=this.sampler3DList[r].key){console.log("Error :addContent")}a=false;break}}if(a){this.sampler3DList.push(t.sampler3DList[i].clone())}}};t.prototype.mergeMainFunc=function(t,e){var i=t;var a="";var r=e.indexOf("{");var s=e.lastIndexOf("}");r++;a=e.slice(r,s);r=i.lastIndexOf("}");var n=i.substr(0,r);var o=i.substr(r,i.length-r);i=n;i+=a;var h="";var u="";var l=i;i+=u;i+=o;return i};t.prototype.findFunc=function(t){var e=null;for(var i=0;i<this.funcList.length;++i){if(this.funcList[i].name==t){e=this.funcList[i];break}}return e};return t}();t.ShaderContent=i})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.libs=["default_vertex","diffuseMap_fragment","diffuse_fragmentEnd","normalMap_fragment","specularMap_fragment","diffuseMethod_fragment","Color_fragment","directLight_fragment","spotLight_fragment","pointLight_fragment","skeleton_vertex","particle_vertex","particle_vertexEnd","Shadow_vertex_static","Shadow_vertex_sksleton","Shadow_fragment","ShadowMapping_vertex","shadowmapping_fragment","depthMethod_fragment","normalMethod_fragment","postCanvas_vertex","postCanvas_fragment","sky_fragment","sky_vertex","spheresky_vertex","spheresky_fragment","terrainRGBA_fragment","warpedImage_fragment","lightMap_fragment","EnvironmentMapping_fragment","SpecularEnvironmentMappingMethod","distanceFog_fragment","AOMap_fragment","wireframe_vertex","wireframe_fragment","FresnelReflection_fragment","PaintFresnelReflection_fragment","AlphaEnvironmentMapping_fragment","cubeDiffuseMap_fragment","particle_time","particle_position","particle_offset","particle_speed","particle_billboard","particle_acceleration","particle_lifeRotate","particle_acceleRotate","particle_scale","particle_acceleScale","BrightPassFilter","GaussianBlurHorizontal","GaussianBlurVertical","Composition","Tonemaping"];this._shaderLibs={};this._methodLibs={};this._loaderDict={};this._loadList=new Array;this._shaderContentDict={}}Object.defineProperty(e,"instance",{get:function(){if(!this._instance){this._instance=new e}return this._instance},enumerable:true,configurable:true});e.regist=function(t){this.instance._loadFunc=t;this.instance.load("")};e.prototype.load=function(e){var i=this;for(var a=0;a<this.libs.length;a++){this._loadList.push(this.libs[a])}for(var a=0;a<this.libs.length;a++){var r=e+"shader/"+this.libs[a]+".glsl";this._loaderDict[r]=this.libs[a];var s=t["glsldata"];if(s){this.setupShader(r,s[this.libs[a]])}else{var n=new t.URLLoader(r);n.onLoadComplete=function(t){return i.onCompleteShader(t)}}}if(s){setTimeout(function(){return i._loadFunc(i)},0)}};e.prototype.onCompleteShader=function(t){this.setupShader(t.url,t.data)};e.prototype.setupShader=function(t,e){var i=this.readShader(e);i.name=this._loaderDict[t];this._shaderLibs[i.name]=e;this._methodLibs[i.name]=i;this._shaderContentDict[i.name]=i;var a=-1;for(var r=0;r<this._loadList.length;++r){if(this._loadList[r]==i.name){a=r;break}}if(a>=0){this._loadList.splice(a,1)}if(this._loadList.length<=0){this._loadFunc(this)}};e.prototype.getShaderSource=function(t){return this._shaderLibs[t]=this._shaderLibs[t]||""};e.prototype.getShader=function(e,i){var a=0;var r="";var s=null;for(a=0;a<e.length;++a){if(r!=""){r+="/"}r+=e[a]}if(this._shaderContentDict[r]==undefined){s=new t.GLSL.ShaderContent;for(a=0;a<e.length;++a){var n=this._shaderContentDict[e[a]];s.addContent(n)}this._shaderContentDict[r]=s}else{s=this._shaderContentDict[r]}if(s==null){return null}for(a=0;a<s.attributeList.length;a++){r=s.attributeList[a].varName;i[r]=s.attributeList[a].clone()}for(a=0;a<s.varyingList.length;a++){r=s.varyingList[a].varName;if(!i[r]){i[r]=s.varyingList[a].clone()}}for(a=0;a<s.tempList.length;a++){r=s.tempList[a].varName;i[r]=s.tempList[a].clone()}for(a=0;a<s.uniformList.length;a++){r=s.uniformList[a].varName;i[r]=s.uniformList[a].clone()}for(a=0;a<s.constList.length;a++){r=s.constList[a].varName;i[r]=s.constList[a].clone()}for(a=0;a<s.sampler2DList.length;a++){r=s.sampler2DList[a].varName;i[r]=s.sampler2DList[a].clone()}for(a=0;a<s.sampler3DList.length;a++){r=s.sampler3DList[a].varName;i[r]=s.sampler3DList[a].clone()}return s};e.prototype.readShader=function(e){var i=new t.GLSL.ShaderContent;var a=t.StringUtil.processShaderFile(e);var r=t.StringUtil.parseContent(a);var s=r.concat();while(s.length>0){var n=s[0];s.shift();var o=this.getLineType(n);var h=-1;h=o.indexOf("struct");if(h!=-1){var u=o.split(" ");var l=n;i.addStruct(u[1],l);this.processStruct(u[1],l,i);continue}h=o.indexOf("function");if(h!=-1){var u=o.split(" ");var f=n;i.addFunc(u[1],f);continue}h=o.indexOf("unknown");if(h!=-1){var u=t.StringUtil.parseLines(n);var c=t.StringUtil.getVarKey(u);var d=t.StringUtil.getVarType(u);if(d=="sampler2D"){var p=this.getSampler2D(n);if(p)i.addVar(p)}else if(d=="samplerCube"){var g=this.getSampler3D(n);if(g)i.addVar(g)}else{if(c=="attribute"){var m=this.getAttribute(n);if(m)i.addVar(m)}else if(c=="varying"){var _=this.getVarying(n);if(_)i.addVar(_)}else if(c=="uniform"){var v=this.getUniform(n);if(v)i.addVar(v)}else if(c=="const"){var D=this.getConst(n);if(D)i.addVar(D)}else{i.addVar(this.getTemper(n))}}continue}}return i};e.prototype.getLineType=function(t){var e=t.indexOf("{");if(e>0){var i=t.substr(0,e);if(i.indexOf("struct")>=0){var a=i.lastIndexOf(" ");a++;var r=i.substr(a,i.length-a);return"struct "+r}if(i.indexOf("=")<0){var s=t.indexOf("(");var a=t.lastIndexOf(" ",s);a++;var n=t.substr(a,s-a);return"function "+n}}return"unknown"};e.prototype.getAttribute=function(e){var i=e;var a;var r;var s;var n=t.StringUtil.parseLines(i);a=t.StringUtil.getVarName(n);r=t.StringUtil.getVarType(n);s=new t.GLSL.Attribute(a,r);return s};e.prototype.getTemper=function(e){var i=e;var a;var r;var s;var n=t.StringUtil.parseLines(i);a=t.StringUtil.getVarName(n);r=t.StringUtil.getVarType(n);s=new t.GLSL.TmpVar(a,r);return s};e.prototype.getVarying=function(e){var i=e;var a;var r;var s;var n=t.StringUtil.parseLines(i);a=t.StringUtil.getVarName(n);r=t.StringUtil.getVarType(n);s=new t.GLSL.Varying(a,r);return s};e.prototype.getUniform=function(e){var i=e;var a;var r;var s;var n=t.StringUtil.parseLines(i);a=t.StringUtil.getVarName(n);r=t.StringUtil.getVarType(n);s=new t.GLSL.Uniform(a,r);return s};e.prototype.getConst=function(e){var i=e;var a;var r;var s;var n;var o=t.StringUtil.parseLines(i);a=t.StringUtil.getVarName(o);r=t.StringUtil.getVarType(o);s=t.StringUtil.getVarValue(o);n=new t.GLSL.ConstVar(a,r,s);return n};e.prototype.getSampler2D=function(e){var i=e;var a;var r;var s;var n=t.StringUtil.parseLines(i);a=t.StringUtil.getVarName(n);s=new t.GLSL.Sampler2D(a);return s};e.prototype.getSampler3D=function(e){var i=e;var a;var r;var s;var n=t.StringUtil.parseLines(i);a=t.StringUtil.getVarName(n);s=new t.GLSL.Sampler3D(a);return s};e.prototype.filterCharacter=function(t){var i=t;var a=i;for(var r=0;r<e._filterChar.length;++r){while(true){a=i.replace(e._filterChar[r],"");if(i==a){break}i=a}}return a};e.prototype.processStruct=function(e,i,a){var r=i.lastIndexOf("}");r++;var s=i.lastIndexOf(";");var n=i.substr(r,s-r);var o=t.StringUtil.parseLines(n);for(var h=0;h<o.length;++h){var u=this.getTemper(e+" "+o[h]+";");if(u)a.addVar(u)}};e._filterChar=[" ","  ",";","\n","\r","	","\n","\r","	"];return e}();t.ShaderSystemTool=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.passNeedReset=false;this.sampler2DList=new Array;this.sampler3DList=new Array;this.vsMethodList=new Array;this.fsMethodList=new Array;this.effectMethodList=new Array}t.prototype.dispose=function(){};return t}();t.MethodUsageData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.textureMethodTypes=[];this.diffusePassUsageData=new t.MethodUsageData;this.depthPassUsageData=new t.MethodUsageData;this.normalPassUsageData=new t.MethodUsageData;this.positionPassUsageData=new t.MethodUsageData;this.postPassUsageData=new t.MethodUsageData;this.lightPassUsageData=new t.MethodUsageData;this.shadowPassUsageData=new t.MethodUsageData;this.drawMode=t.DrawMode.TRIANGLES;this.normalTex=t.CheckerboardTexture.texture;this.specularTex=t.CheckerboardTexture.texture;this.lightMapTex=t.CheckerboardTexture.texture;this.aoMapTex=t.CheckerboardTexture.texture;this.environmentMapTex=t.CheckerboardTexture.texture;this.maskTex=t.CheckerboardTexture.texture;this.splat_0Tex=t.CheckerboardTexture.texture;this.splat_1Tex=t.CheckerboardTexture.texture;this.splat_2Tex=t.CheckerboardTexture.texture;this.splat_3Tex=t.CheckerboardTexture.texture;this.directLightList=new Array;this.sportLightList=new Array;this.pointLightList=new Array;this.layer=0;this.castShadow=false;this.acceptShadow=true;this.depthTest=true;this.smooth=true;this.blendMode=t.BlendMode.NORMAL;this.alphaBlending=false;this.ambientColor=16777215;this.diffuseColor=16777215;this.specularColor=16777215;this.shininess=8;this.cutAlpha=.7;this.repeat=false;this.bothside=false;this.alpha=1;this.specularPower=1;this.ambientPower=1;this.diffusePower=1;this.normalPower=1;this.materialDataNeedChange=true;this.textureChange=false;this.passChange=true;this.cullFrontOrBack=t.Egret3DDrive.BACK}e.prototype.clone=function(){var i=new e;i.diffusePassUsageData=this.diffusePassUsageData;i.depthPassUsageData=this.depthPassUsageData;i.normalPassUsageData=this.normalPassUsageData;i.positionPassUsageData=this.positionPassUsageData;i.postPassUsageData=this.positionPassUsageData;i.lightPassUsageData=this.positionPassUsageData;i.shadowPassUsageData=this.positionPassUsageData;i.diffuseTex=t.CheckerboardTexture.texture;i.textureChange=true;i.textureMethodTypes=this.textureMethodTypes;i.drawMode=this.drawMode;i.context3D=this.context3D;i.diffuseTex=this.diffuseTex;i.specularTex=this.specularTex;i.lightMapTex=this.lightMapTex;i.environmentMapTex=this.environmentMapTex;i.shadowMapTex=this.shadowMapTex;i.splat_0Tex=this.splat_0Tex;i.splat_1Tex=this.splat_1Tex;i.splat_2Tex=this.splat_2Tex;i.splat_3Tex=this.splat_3Tex;i.layer=this.layer;i.castShadow=this.castShadow;i.acceptShadow=this.acceptShadow;i.depthTest=this.depthTest;i.smooth=this.smooth;i.blendMode=this.blendMode;i.blend_src=this.blend_src;i.blend_dest=this.blend_dest;i.ambientColor=this.ambientColor;i.diffuseColor=this.diffuseColor;i.specularColor=this.specularColor;i.shininess=this.shininess;i.shininess=this.shininess;i.cutAlpha=this.cutAlpha;i.alpha=this.alpha;i.specularPower=this.specularPower;i.ambientPower=this.ambientPower;i.diffusePower=this.diffusePower;i.normalPower=this.normalPower;i.passChange=this.passChange;i.materialDataNeedChange=this.materialDataNeedChange;i.textureChange=true;i.cullFrontOrBack=this.cullFrontOrBack;return i};e.prototype.dispose=function(){if(this.diffusePassUsageData)this.diffusePassUsageData.dispose();if(this.depthPassUsageData)this.depthPassUsageData.dispose();if(this.normalPassUsageData)this.normalPassUsageData.dispose();if(this.normalPassUsageData)this.normalPassUsageData.dispose();if(this.positionPassUsageData)this.positionPassUsageData.dispose();if(this.postPassUsageData)this.postPassUsageData.dispose();if(this.lightPassUsageData)this.lightPassUsageData.dispose();if(this.shadowPassUsageData)this.shadowPassUsageData.dispose();if(this.directLightList.length>0){this.directLightList.length=0;this.directLightList=null}if(this.sportLightList.length>0){this.sportLightList.length=0;this.sportLightList=null}if(this.pointLightList.length>0){this.pointLightList.length=0;this.pointLightList=null}};return e}();t.MaterialData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.vsMethodName="";this.fsMethodName="";this.acceptShadow=false}t.prototype.setMaterialData=function(t,e){this.usage=e;this.materialData=t};Object.defineProperty(t.prototype,"vertexMethodName",{get:function(){return this.vsMethodName},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"fragMethodName",{get:function(){return this.fsMethodName},enumerable:true,configurable:true});t.prototype.activate=function(t,e,i,a,r,s){this.context3D=t};t.prototype.updata=function(t,e,i,a,r,s){};t.prototype.dispose=function(){};return t}();t.MethodBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i){e.call(this,t,i)}i.prototype.setVertexShader=function(e){var i;switch(e.geomtryType){case t.GeometryType.Static:i=new t.StaticVertexMethod;this.useage.vsMethodList.push(i);this.addShader(i.vertexMethodName);break;case t.GeometryType.Skin:i=new t.SkinVertexMethod;this.useage.vsMethodList.push(i);this.addShader(i.vertexMethodName);i.acceptShadow=this.materialData.acceptShadow;break;case t.GeometryType.Particle:i=new t.ParticleVertexMethod;this.useage.vsMethodList.push(i);this.addShader(i.vertexMethodName);this.addEnd("particle_vertexEnd");break;default:break}i.acceptShadow=this.materialData.acceptShadow;if(this.materialData.acceptShadow){this.addShader("Shadow_vertex_static")}};i.prototype.getShaderSource=function(){var t=e.prototype.getShaderSource.call(this);var i=t.lastIndexOf("}");var a=t.substr(i,t.length-i);t=t.substr(0,i);t+="   gl_Position = temp_p; \r\n";t+=a;return t};i.prototype.build=function(){for(this.index=0;this.index<this.useage.vsMethodList.length;this.index++){this.useage.vsMethodList[this.index].setMaterialData(this.materialData,this.useage)}};i.prototype.addMethod=function(t){this.stateChange=true;this.useage.vsMethodList.push(t)};return i}(t.GLSL.ShaderBase);t.VertexShader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this,e,i);this.useage=i;this.materialData=e}e.prototype.addMethod=function(t){this.stateChange=true;this.useage.fsMethodList.push(t)};e.prototype.addEffectMethod=function(t){this.stateChange=true;this.useage.effectMethodList.push(t)};e.prototype.getShaderSource=function(){var e=t.prototype.getShaderSource.call(this);var i=e.lastIndexOf("}");var a=e.substr(i,e.length-i);e=e.substr(0,i);e+="   gl_FragColor = diffuse;\r\n";e+=a;return e};e.prototype.build=function(){this.stateChange=false;for(this.index=0;this.index<this.useage.fsMethodList.length;this.index++){this.useage.fsMethodList[this.index].setMaterialData(this.materialData,this.useage)}this.stateChange=false;for(this.index=0;this.index<this.useage.effectMethodList.length;this.index++){this.useage.effectMethodList[this.index].setMaterialData(this.materialData,this.useage)}};return e}(t.GLSL.ShaderBase);t.PixelShader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.normalMatrix=new t.Matrix4_4;this.vsMethodName="default_vertex"}i.prototype.activate=function(t,e,i,a,r){r.sharedVertexBuffer=t.creatVertexBuffer(r.verticesData);r.numberOfVertices=r.verticesData.length/r.vertexAttLength;r.vertexSizeInBytes=r.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT;r.sharedIndexBuffer=t.creatIndexBuffer(r.indexData);t.bindVertexBuffer(r.sharedVertexBuffer);this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_position.name);this.usage.attribute_normal.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_normal.name);this.usage.attribute_tangent.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_tangent.name);this.usage.attribute_color.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_color.name);this.usage.attribute_uv0.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv0.name);this.usage.attribute_uv1.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv1.name);this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ModelMatrix.name);this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ProjectionMatrix.name);this.usage.uniform_normalMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_normalMatrix.name);this.usage.uniform_eyepos.uniformIndex=t.getUniformLocation(e,this.usage.uniform_eyepos.name);if(this.acceptShadow&&this.usage.uniform_shadowMatrix)this.usage.uniform_shadowMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_shadowMatrix.name)};i.prototype.updata=function(e,i,a,r,s){e.bindVertexBuffer(s.sharedVertexBuffer);e.vertexAttribPointer(i,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,0);e.vertexAttribPointer(i,this.usage.attribute_normal.uniformIndex,3,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,12);e.vertexAttribPointer(i,this.usage.attribute_tangent.uniformIndex,3,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,24);e.vertexAttribPointer(i,this.usage.attribute_color.uniformIndex,4,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,36);e.vertexAttribPointer(i,this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,52);e.vertexAttribPointer(i,this.usage.attribute_uv1.uniformIndex,2,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,60);this.normalMatrix.copyFrom(a);this.normalMatrix.invert();this.normalMatrix.transpose();e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,false,a.rawData);e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,false,r.viewProjectionMatrix.rawData);e.uniformMatrix4fv(this.usage.uniform_normalMatrix.uniformIndex,false,this.normalMatrix.rawData);e.uniform3f(this.usage.uniform_eyepos.uniformIndex,r.x,r.y,r.z);if(this.acceptShadow&&this.usage.uniform_shadowMatrix)e.uniformMatrix4fv(this.usage.uniform_shadowMatrix.uniformIndex,false,t.ShadowRender.shadowCamera3D.viewProjectionMatrix.rawData)};return i}(t.MethodBase);t.StaticVertexMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.vsMethodName="Shadow_vertex_static"}i.prototype.activate=function(t,e,i,a,r){r.sharedVertexBuffer=t.creatVertexBuffer(r.verticesData);r.numberOfVertices=r.verticesData.length/r.vertexAttLength;r.vertexSizeInBytes=r.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT;r.sharedIndexBuffer=t.creatIndexBuffer(r.indexData);t.bindVertexBuffer(r.sharedVertexBuffer);this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_position.name);this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ModelMatrix.name);this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ProjectionMatrix.name)};i.prototype.updata=function(e,i,a,r,s){e.bindVertexBuffer(s.sharedVertexBuffer);e.vertexAttribPointer(i,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,0);e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,false,a.rawData);e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,false,r.viewProjectionMatrix.rawData)};return i}(t.MethodBase);t.ShadowVertexMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.normalMatrix=new t.Matrix4_4;this.vsMethodName="skeleton_vertex"}i.prototype.activate=function(t,e,i,a,r,s){r.sharedVertexBuffer=t.creatVertexBuffer(r.verticesData);r.numberOfVertices=r.verticesData.length/r.vertexAttLength;r.vertexSizeInBytes=r.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT;r.sharedIndexBuffer=t.creatIndexBuffer(r.indexData);t.bindVertexBuffer(r.sharedVertexBuffer);this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_position.varName);this.usage.attribute_normal.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_normal.varName);this.usage.attribute_tangent.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_tangent.varName);this.usage.attribute_color.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_color.varName);this.usage.attribute_uv0.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv0.varName);this.usage.attribute_uv1.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv1.varName);this.usage.attribute_boneIndex.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_boneIndex.varName);this.usage.attribute_boneWeight.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_boneWeight.varName);this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ModelMatrix.varName);this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ProjectionMatrix.varName);this.usage.uniform_normalMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_normalMatrix.varName);this.usage.uniform_eyepos.uniformIndex=t.getUniformLocation(e,this.usage.uniform_eyepos.varName);this.usage.uniform_PoseMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_PoseMatrix.varName)};i.prototype.updata=function(e,i,a,r,s,n){e.bindVertexBuffer(s.sharedVertexBuffer);e.gl.vertexAttribPointer(this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,0);e.gl.enableVertexAttribArray(this.usage.attribute_position.uniformIndex);e.gl.vertexAttribPointer(this.usage.attribute_normal.uniformIndex,3,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,12);e.gl.enableVertexAttribArray(this.usage.attribute_normal.uniformIndex);e.gl.vertexAttribPointer(this.usage.attribute_tangent.uniformIndex,3,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,24);e.gl.enableVertexAttribArray(this.usage.attribute_tangent.uniformIndex);e.gl.vertexAttribPointer(this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,52);e.gl.enableVertexAttribArray(this.usage.attribute_uv0.uniformIndex);e.gl.vertexAttribPointer(this.usage.attribute_boneIndex.uniformIndex,4,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,68);e.gl.enableVertexAttribArray(this.usage.attribute_boneIndex.uniformIndex);e.gl.vertexAttribPointer(this.usage.attribute_boneWeight.uniformIndex,4,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,84);e.gl.enableVertexAttribArray(this.usage.attribute_boneWeight.uniformIndex);this.normalMatrix.copyFrom(a);this.normalMatrix.invert();this.normalMatrix.transpose();e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,false,a.rawData);e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,false,r.viewProjectionMatrix.rawData);e.uniformMatrix4fv(this.usage.uniform_normalMatrix.uniformIndex,false,this.normalMatrix.rawData);e.uniform3f(this.usage.uniform_eyepos.uniformIndex,r.x,r.y,r.z);e.uniform4fv(this.usage.uniform_PoseMatrix.uniformIndex,n.currentSkeletonMatrixData)};return i}(t.MethodBase);t.SkinVertexMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.index=0;this.time=0;this.normalMatrix=new t.Matrix4_4;this.vsMethodName="particle_vertex"}i.prototype.activate=function(t,e,i,a,r,s){r.sharedVertexBuffer=t.creatVertexBuffer(r.verticesData);r.numberOfVertices=s.animaNodeCollection.numberOfVertices;r.vertexSizeInBytes=s.animaNodeCollection.vertexSizeInBytes;r.sharedIndexBuffer=t.creatIndexBuffer(r.indexData);t.bindVertexBuffer(r.sharedVertexBuffer);this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_position.name);this.usage.attribute_offset.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_offset.name);this.usage.attribute_uv0.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv0.name);for(this.index=0;this.index<s.animaNodeCollection.nodes.length;this.index++){if(s.animaNodeCollection.nodes[this.index].usageAttributeLen>0)s.animaNodeCollection.nodes[this.index].uniformIndex=t.getShaderAttribLocation(e,s.animaNodeCollection.nodes[this.index].usageAttribute)}this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ModelMatrix.name);this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ProjectionMatrix.name);this.usage.uniform_eyepos.uniformIndex=t.getUniformLocation(e,this.usage.uniform_eyepos.name);this.usage.uniform_time.uniformIndex=t.getUniformLocation(e,this.usage.uniform_time.name);this.usage.uniform_cameraMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_cameraMatrix.name)};i.prototype.updata=function(e,i,a,r,s,n){e.bindVertexBuffer(s.sharedVertexBuffer);e.vertexAttribPointer(i,this.usage.attribute_position.uniformIndex,4,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,0);e.vertexAttribPointer(i,this.usage.attribute_offset.uniformIndex,3,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,16);e.vertexAttribPointer(i,this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,28);var o;for(this.index=0;this.index<n.animaNodeCollection.nodes.length;this.index++){if(n.animaNodeCollection.nodes[this.index].usageAttributeLen>0){o=n.animaNodeCollection.nodes[this.index];e.vertexAttribPointer(i,o.uniformIndex,o.usageAttributeLen,t.Egret3DDrive.FLOAT,false,s.vertexSizeInBytes,o.offsetBytes)}}e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,false,a.rawData);e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,false,r.viewProjectionMatrix.rawData);e.uniformMatrix4fv(this.usage.uniform_cameraMatrix.uniformIndex,false,r.modelMatrix.rawData);e.uniform3f(this.usage.uniform_eyepos.uniformIndex,r.x,r.y,r.z);e.uniform1f(this.usage.uniform_time.uniformIndex,n.time)};return i}(t.MethodBase);t.ParticleVertexMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this);this.fsMethodName="Shadow_fragment"}e.prototype.activate=function(e,i,a,r,s,n){t.prototype.activate.call(this,e,i,a,r,s,n)};e.prototype.updata=function(t,e,i,a,r,s){};return e}(t.MethodBase);t.ShadowMapMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this);this.uvData=new Float32Array(8);this.fsMethodName="diffuseMethod_fragment";this.uvData[0]=1;this.uvData[1]=1;this.uvData[2]=1;this.uvData[3]=1;this.uvData[4]=1;this.uvData[5]=1;this.uvData[6]=1;this.uvData[7]=1}e.prototype.setUVTitling=function(t,e,i){this.uvData[t*2]=e;this.uvData[t*2+1]=i};e.prototype.activate=function(e,i,a,r,s,n){t.prototype.activate.call(this,e,i,a,r,s,n);this.usage.uniform_materialSource.uniformIndex=e.getUniformLocation(i,this.usage.uniform_materialSource.varName);this.uvIndex=e.getUniformLocation(i,"uvs");if(this.materialData.directLightList.length>0){this.usage.uniform_directLightSource.uniformIndex=e.getUniformLocation(i,this.usage.uniform_directLightSource.varName)}if(this.materialData.sportLightList.length>0){this.usage.uniform_sportLightSource.uniformIndex=e.getUniformLocation(i,this.usage.uniform_sportLightSource.varName)}if(this.materialData.pointLightList.length>0){this.usage.uniform_pointLightSource.uniformIndex=e.getUniformLocation(i,this.usage.uniform_pointLightSource.varName)}};e.prototype.updata=function(t,e,i,a,r,s){if(this.materialData.materialDataNeedChange){this.materialData.materialDataNeedChange=false;this.materialData.diffusePassUsageData.materialSourceData[0]=this.materialData.diffuseColor>>24&255/255;this.materialData.diffusePassUsageData.materialSourceData[1]=this.materialData.diffuseColor>>16&255/255;this.materialData.diffusePassUsageData.materialSourceData[2]=this.materialData.diffuseColor>>8&255/255;this.materialData.diffusePassUsageData.materialSourceData[3]=this.materialData.ambientColor>>24&255/255;this.materialData.diffusePassUsageData.materialSourceData[4]=this.materialData.ambientColor>>16&255/255;this.materialData.diffusePassUsageData.materialSourceData[5]=this.materialData.ambientColor>>8&255/255;this.materialData.diffusePassUsageData.materialSourceData[6]=this.materialData.specularColor>>24&255/255;this.materialData.diffusePassUsageData.materialSourceData[7]=this.materialData.specularColor>>16&255/255;this.materialData.diffusePassUsageData.materialSourceData[8]=this.materialData.specularColor>>8&255/255;this.materialData.diffusePassUsageData.materialSourceData[9]=this.materialData.alpha;this.materialData.diffusePassUsageData.materialSourceData[10]=this.materialData.cutAlpha;this.materialData.diffusePassUsageData.materialSourceData[11]=this.materialData.shininess}t.gl.uniform1fv(this.usage.uniform_materialSource.uniformIndex,this.materialData.diffusePassUsageData.materialSourceData);t.gl.uniform1fv(this.uvIndex,this.uvData);if(this.materialData.directLightList.length>0){t.gl.uniform1fv(this.usage.uniform_directLightSource.uniformIndex,this.usage.directLightData)}if(this.materialData.sportLightList.length>0){t.gl.uniform1fv(this.usage.uniform_sportLightSource.uniformIndex,this.usage.sportLightData)}if(this.materialData.pointLightList.length>0){t.gl.uniform1fv(this.usage.uniform_pointLightSource.uniformIndex,this.usage.pointLightData)}};e.prototype.dispose=function(){};return e}(t.MethodBase);t.TerrainMethod=e;
})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this);this.fsMethodName="normalMethod_fragment"}e.prototype.activate=function(e,i,a,r,s,n){t.prototype.activate.call(this,e,i,a,r,s,n)};e.prototype.updata=function(t,e,i,a,r,s){};e.prototype.dispose=function(){};return e}(t.MethodBase);t.NormalMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this);this.fsMethodName=""}e.prototype.activate=function(t,e,i,a,r,s){};e.prototype.updata=function(t,e,i,a,r,s){};e.prototype.dispose=function(){};return e}(t.MethodBase);t.DepthMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this);this.fsMethodName="diffuseMethod_fragment"}e.prototype.activate=function(e,i,a,r,s,n){t.prototype.activate.call(this,e,i,a,r,s,n)};e.prototype.updata=function(t,e,i,a,r,s){};e.prototype.dispose=function(){};return e}(t.MethodBase);t.DiffuseMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.bias=.002;this.shdowColorR=.3;this.shdowColorG=.3;this.shdowColorB=.5;this.vsMethodName="ShadowMapping_vertex";this.fsMethodName="shadowmapping_fragment"}i.prototype.setMaterialData=function(e,i){this.usage=i;this.materialData=e;this.materialData.shadowMapTex=t.ShadowRender.frameBuffer.texture};i.prototype.activate=function(t,i,a,r,s,n){e.prototype.activate.call(this,t,i,a,r,s,n);i["shadowParameterUniformIndex"]=t.getUniformLocation(i,"shadowParameter")};i.prototype.updata=function(t,e,i,a,r,s){t.uniform4f(e["shadowParameterUniformIndex"],this.shdowColorR,this.shdowColorG,this.shdowColorB,this.bias)};return i}(t.MethodBase);t.ShadowMapingMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.vsMethodName="";this.fsMethodName=""}t.prototype.setMaterialData=function(t,e){this.usage=e;this.materialData=t};Object.defineProperty(t.prototype,"vertexMethodName",{get:function(){return this.vsMethodName},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"fragMethodName",{get:function(){return this.fsMethodName},enumerable:true,configurable:true});t.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t};t.prototype.updataEffect=function(t,e,i,a,r,s,n){};t.prototype.dispose=function(){};return t}();t.EffectMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this);this._aoPower=1;this.fsMethodName="AOMap_fragment";this.aoTexture=t}Object.defineProperty(i.prototype,"aoPower",{get:function(){return this._aoPower},set:function(t){this._aoPower=t},enumerable:true,configurable:true});i.prototype.setMaterialData=function(e,i){this.usage=i;this.materialData=e;if(this.texture)this.materialData.aoMapTex=this.texture;else this.materialData.aoMapTex=t.CheckerboardTexture.texture};Object.defineProperty(i.prototype,"aoTexture",{set:function(t){this.texture=t;if(t){if(this.materialData){this.materialData.aoMapTex=t;this.materialData.textureChange=true}}},enumerable:true,configurable:true});i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t;e["aoPower"]=t.getUniformLocation(e.program3D,"aoPower")};i.prototype.updataEffect=function(t,e,i,a,r,s,n){t.gl.uniform1f(e["aoPower"],this._aoPower)};i.prototype.dispose=function(){};return i}(t.EffectMethod);t.AOMapMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this);this.fsMethodName="lightMap_fragment";this.lightTexture=t}i.prototype.setMaterialData=function(e,i){this.usage=i;this.materialData=e;if(this.texture)this.materialData.lightMapTex=this.texture;else this.materialData.lightMapTex=t.CheckerboardTexture.texture};Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t;if(t){if(this.materialData){this.materialData.lightMapTex=t;this.materialData.textureChange=true}}},enumerable:true,configurable:true});i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t};i.prototype.updataEffect=function(t,e,i,a,r,s,n){};i.prototype.dispose=function(){};return i}(t.EffectMethod);t.LightMapMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this);this.reflectValue=1;this.fsMethodName="EnvironmentMapping_fragment";this.lightTexture=t}Object.defineProperty(i.prototype,"reflect",{get:function(){return this.reflectValue},set:function(t){this.reflectValue=t},enumerable:true,configurable:true});i.prototype.setMaterialData=function(e,i){this.usage=i;this.materialData=e;if(this.texture)this.materialData.environmentMapTex=this.texture;else this.materialData.environmentMapTex=t.CheckerboardTexture.texture};Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t;if(t){if(this.materialData){this.materialData.environmentMapTex=t;this.materialData.textureChange=true}}},enumerable:true,configurable:true});i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t;e["reflectValue"]=t.getUniformLocation(e.program3D,"reflectValue")};i.prototype.updataEffect=function(t,e,i,a,r,s,n){t.gl.uniform1f(e["reflectValue"],this.reflectValue)};i.prototype.dispose=function(){};return i}(t.EffectMethod);t.EnvironmentMappingMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i){e.call(this);this._rimPower=.9;this._envLightPower=.5;this._maskColor=16777215;this._maskColorR=1;this._maskColorG=0;this._maskColorB=0;this.fsMethodName="PaintFresnelReflection_fragment";this.envtexture=t;this.randomTexture=i}Object.defineProperty(i.prototype,"rimPower",{get:function(){return this._rimPower},set:function(t){this._rimPower=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"envLightPower",{get:function(){return this._envLightPower},set:function(t){this._envLightPower=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"maskColor",{get:function(){return this._maskColor},set:function(t){this._maskColor=t;this._maskColorR=(t>>16&255)/255;this._maskColorG=(t>>8&255)/255;this._maskColorB=(t&255)/255},enumerable:true,configurable:true});i.prototype.setMaterialData=function(e,i){this.usage=i;this.materialData=e;if(this._envtexture)this.materialData.environmentMapTex=this._envtexture;else this.materialData.environmentMapTex=t.CheckerboardTexture.texture;if(this._randomTexture)this.materialData.maskTex=this._randomTexture;else this.materialData.maskTex=t.CheckerboardTexture.texture};Object.defineProperty(i.prototype,"envtexture",{set:function(t){this._envtexture=t;if(t){if(this.materialData){this.materialData.environmentMapTex=t;this.materialData.textureChange=true}}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"randomTexture",{set:function(t){this._randomTexture=t;if(t){if(this.materialData){this.materialData.maskTex=t;this.materialData.textureChange=true}}},enumerable:true,configurable:true});i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t;e["maskColor"]=t.getUniformLocation(e.program3D,"maskColor");e["rimPower"]=t.getUniformLocation(e.program3D,"rimPower");e["envLightPower"]=t.getUniformLocation(e.program3D,"envLightPower")};i.prototype.updataEffect=function(t,e,i,a,r,s,n){t.gl.uniform3f(e["maskColor"],this._maskColorR,this._maskColorG,this._maskColorB);t.gl.uniform1f(e["rimPower"],this._rimPower);t.gl.uniform1f(e["envLightPower"],this._envLightPower)};i.prototype.dispose=function(){};return i}(t.EffectMethod);t.PaintFresnelReflectionMappingMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this);this.reflectValue=1;this.fsMethodName="SpecularEnvironmentMappingMethod";this.lightTexture=t}Object.defineProperty(i.prototype,"reflect",{get:function(){return this.reflectValue},set:function(t){this.reflectValue=t},enumerable:true,configurable:true});i.prototype.setMaterialData=function(e,i){this.usage=i;this.materialData=e;if(this.texture)this.materialData.environmentMapTex=this.texture;else this.materialData.environmentMapTex=t.CheckerboardTexture.texture};Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t;if(t){if(this.materialData){this.materialData.environmentMapTex=t;this.materialData.textureChange=true}}},enumerable:true,configurable:true});i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t};i.prototype.updataEffect=function(t,e,i,a,r,s,n){};i.prototype.dispose=function(){};return i}(t.EffectMethod);t.SpecularEnvironmentMappingMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this);this.reflectValue=1;this.fsMethodName="AlphaEnvironmentMapping_fragment";this.lightTexture=t}i.prototype.setMaterialData=function(e,i){this.usage=i;this.materialData=e;if(this.texture)this.materialData.environmentMapTex=this.texture;else this.materialData.environmentMapTex=t.CheckerboardTexture.texture};Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t;if(t){if(this.materialData){this.materialData.environmentMapTex=t;this.materialData.textureChange=true}}},enumerable:true,configurable:true});i.prototype.dispose=function(){};return i}(t.EffectMethod);t.AlphaEnvironmentMappingMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this);this._fogColor=4294967295;this._globalDensity=1;this._startDistance=500;this._distanceScale=.1;this._height=500;this._heightScale=.1;this.fsMethodName="distanceFog_fragment";this._data=new Float32Array(8);this.fogColor=this._fogColor;this.globalDensity=this._globalDensity}Object.defineProperty(e.prototype,"fogColor",{get:function(){return this._fogColor},set:function(t){this._fogColor=t;this._data[0]=(t>>16&255)/255;this._data[1]=(t>>8&255)/255;this._data[2]=(t&255)/255},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(t){this._globalDensity=t;this._data[3]=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"startDistance",{get:function(){return this._startDistance},set:function(t){this._startDistance=t;this._data[4]=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"distanceScale",{get:function(){return this._distanceScale},set:function(t){this._distanceScale=t;this._data[5]=t},enumerable:true,configurable:true});e.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t;e["uniform_globalFog"]=t.getUniformLocation(e.program3D,"uniform_globalFog")};e.prototype.updataEffect=function(t,e,i,a,r,s,n){t.gl.uniform1fv(e["uniform_globalFog"],this._data)};e.prototype.dispose=function(){};return e}(t.EffectMethod);t.DistanceFog=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t){if(t===void 0){t=null}this.shaderChange=false;this.context3DChange=false;this.materialData=t}t.prototype.addMethod=function(t){this.methodList=this.methodList||new Array;this.methodList.push(t);this.shaderChange=true};t.prototype.removeMethod=function(t){var e=this.methodList.indexOf(t);this.methodList.splice(e,1);t.dispose()};t.prototype.addEffectMethod=function(t){this.effectMethodList=this.effectMethodList||new Array;this.effectMethodList.push(t);this.shaderChange=true};t.prototype.removeEffectMethod=function(t){var e=this.effectMethodList.indexOf(t);this.effectMethodList.splice(e,1);t.dispose()};t.prototype.initShader=function(t,e,i){this.animation=i};t.prototype.resetTexture=function(){};t.prototype.buildShader=function(t){};t.prototype.activate=function(t,e,i,a,r){};t.prototype.draw=function(t,e,i,a,r){var s=0;if(this.materialData.depthTest){t.gl.enable(t.gl.DEPTH_TEST);t.gl.depthFunc(t.gl.LEQUAL)}else{t.gl.disable(t.gl.DEPTH_TEST);t.gl.depthFunc(t.gl.LEQUAL)}t.gl.cullFace(this.materialData.cullFrontOrBack);if(this.materialData.bothside){t.gl.disable(t.gl.CULL_FACE)}else t.gl.enable(t.gl.CULL_FACE);t.gl.enable(t.gl.BLEND);t.setBlendFactors(this.materialData.blend_src,this.materialData.blend_dest);if(this.materialData.alphaBlending)t.gl.depthMask(false)};t.prototype.unActive=function(t,e){};return t}();t.MaterialPassBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this,t);this.index=0}i.prototype.initUseMethod=function(){var e=0;this.materialData.diffusePassUsageData.directLightData=new Float32Array(this.materialData.directLightList.length*t.DirectLight.stride);this.materialData.diffusePassUsageData.sportLightData=new Float32Array(this.materialData.sportLightList.length*t.SpotLight.stride);this.materialData.diffusePassUsageData.pointLightData=new Float32Array(this.materialData.pointLightList.length*t.PointLight.stride);this.diffuseMethod=new t.DiffuseMethod;this.pixelShader.addMethod(this.diffuseMethod);this.pixelShader.addShader(this.diffuseMethod.fragMethodName);if(this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.DIFFUSE)!=-1){this.pixelShader.addShader("diffuseMap_fragment")}if(this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.NORMAL)!=-1){this.pixelShader.addShader("normalMap_fragment")}if(this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.SPECULAR)!=-1){this.pixelShader.addShader("specularMap_fragment")}for(e=0;e<this.materialData.directLightList.length;e++){this.pixelShader.addShader("directLight_fragment")}for(e=0;e<this.materialData.sportLightList.length;e++){this.pixelShader.addShader("spotLight_fragment")}for(e=0;e<this.materialData.pointLightList.length;e++){this.pixelShader.addShader("pointLight_fragment")}if(this.animation){if(this.animation.animaNodeCollection){var i=this.animation.animaNodeCollection.getNodesVertexShaders();var a=this.animation.animaNodeCollection.getNodesFragmentShaders();for(e=0;e<i.length;e++){this.vertexShader.addShader(i[e])}for(e=0;e<a.length;e++){this.pixelShader.addShader(a[e])}}}if(this.materialData.acceptShadow&&this.shadowMaping){this.pixelShader.addMethod(this.shadowMaping);this.vertexShader.addShader(this.shadowMaping.vertexMethodName);this.pixelShader.addShader(this.shadowMaping.fragMethodName)}this.pixelShader.addShader("diffuse_fragmentEnd");if(this.effectMethodList){for(var e=0;e<this.effectMethodList.length;e++){this.pixelShader.addEffectMethod(this.effectMethodList[e]);this.pixelShader.addShader(this.effectMethodList[e].fragMethodName)}}};i.prototype.initShader=function(i,a,r){e.prototype.initShader.call(this,i,a,r);this.vertexShader=new t.VertexShader(this.materialData,this.materialData.diffusePassUsageData);this.pixelShader=new t.PixelShader(this.materialData,this.materialData.diffusePassUsageData);this.materialData.context3D=i;this.vertexShader.setVertexShader(a);this.initUseMethod();if(r){r.initShader(this.vertexShader,this.pixelShader)}this.vertexShader.build();this.pixelShader.build();var s=this.vertexShader.getShaderSource();var n=this.pixelShader.getShaderSource();var o=i.creatVertexShader(s);var h=i.creatFragmentShader(n);this.materialData.diffusePassUsageData.program3D=i.creatProgram(o,h);this.context3DChange=true};i.prototype.resetTexture=function(){var t;for(var e in this.materialData.diffusePassUsageData.sampler2DList){t=this.materialData.diffusePassUsageData.sampler2DList[e];if(this.materialData[t.varName]){t.texture=this.materialData[t.varName]}}var i;for(var e in this.materialData.diffusePassUsageData.sampler3DList){i=this.materialData.diffusePassUsageData.sampler3DList[e];if(this.materialData[i.varName]){i.texture=this.materialData[i.varName]}}this.materialData.textureChange=false};i.prototype.activate=function(t,e,i,a,r){this.materialData.diffusePassUsageData.uniform_materialSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_materialSource.varName);if(this.materialData.directLightList.length>0){this.materialData.diffusePassUsageData.uniform_directLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_directLightSource.varName)}if(this.materialData.sportLightList.length>0){this.materialData.diffusePassUsageData.uniform_sportLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_sportLightSource.varName)}if(this.materialData.pointLightList.length>0){this.materialData.diffusePassUsageData.uniform_pointLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_pointLightSource.varName)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++){this.materialData.diffusePassUsageData.vsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++){this.materialData.diffusePassUsageData.fsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.effectMethodList.length;this.index++){this.materialData.diffusePassUsageData.effectMethodList[this.index].activateEffect(t,this.materialData.diffusePassUsageData,this.materialData,e,i,a,r)}this.resetTexture();var s;for(var n in this.materialData.diffusePassUsageData.sampler2DList){s=this.materialData.diffusePassUsageData.sampler2DList[n];s.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,s.varName)}var o;for(var n in this.materialData.diffusePassUsageData.sampler3DList){o=this.materialData.diffusePassUsageData.sampler3DList[n];o.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,o.varName)}};i.prototype.draw=function(i,a,r,s,n){i.gl.useProgram(this.materialData.diffusePassUsageData.program3D.program);e.prototype.draw.call(this,i,a,r,s,n);var o=0;if(this.materialData.materialDataNeedChange){this.materialData.diffusePassUsageData.materialSourceData[0]=(this.materialData.diffuseColor>>16&255)/255;this.materialData.diffusePassUsageData.materialSourceData[1]=(this.materialData.diffuseColor>>8&255)/255;this.materialData.diffusePassUsageData.materialSourceData[2]=(this.materialData.diffuseColor&255)/255;this.materialData.diffusePassUsageData.materialSourceData[3]=(this.materialData.ambientColor>>16&255)/255;this.materialData.diffusePassUsageData.materialSourceData[4]=(this.materialData.ambientColor>>8&255)/255;this.materialData.diffusePassUsageData.materialSourceData[5]=(this.materialData.ambientColor&255)/255;this.materialData.diffusePassUsageData.materialSourceData[6]=(this.materialData.specularColor>>16&255)/255;this.materialData.diffusePassUsageData.materialSourceData[7]=(this.materialData.specularColor>>8&255)/255;this.materialData.diffusePassUsageData.materialSourceData[8]=(this.materialData.specularColor&255)/255;this.materialData.diffusePassUsageData.materialSourceData[9]=this.materialData.alpha;this.materialData.diffusePassUsageData.materialSourceData[10]=this.materialData.cutAlpha;this.materialData.diffusePassUsageData.materialSourceData[11]=this.materialData.shininess;this.materialData.diffusePassUsageData.materialSourceData[12]=this.materialData.diffusePower;this.materialData.diffusePassUsageData.materialSourceData[13]=this.materialData.specularPower;this.materialData.diffusePassUsageData.materialSourceData[14]=this.materialData.ambientPower;this.materialData.diffusePassUsageData.materialSourceData[15]=this.materialData.normalPower}i.gl.uniform1fv(this.materialData.diffusePassUsageData.uniform_materialSource.uniformIndex,this.materialData.diffusePassUsageData.materialSourceData);var h;for(var u in this.materialData.diffusePassUsageData.sampler2DList){h=this.materialData.diffusePassUsageData.sampler2DList[u];h.texture.upload(i);i.setTexture2DAt(h.activeTextureIndex,h.uniformIndex,h.index,h.texture.texture);if(this.materialData.materialDataNeedChange){var l=this.materialData.smooth?i.gl.LINEAR_MIPMAP_LINEAR:i.gl.LINEAR;var f=this.materialData.smooth?i.gl.LINEAR:i.gl.LINEAR;var c=this.materialData.repeat?i.gl.REPEAT:i.gl.CLAMP_TO_EDGE;var d=this.materialData.repeat?i.gl.REPEAT:i.gl.CLAMP_TO_EDGE;i.setTexture2DSamplerState(l,f,c,d);this.materialData.materialDataNeedChange=false}}var p;for(var u in this.materialData.diffusePassUsageData.sampler3DList){p=this.materialData.diffusePassUsageData.sampler3DList[u];p.texture.upload(i);i.setCubeTextureAt(p.activeTextureIndex,p.uniformIndex,p.index,p.texture.cubeTexture)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++){this.materialData.diffusePassUsageData.vsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n)}if(this.materialData.diffusePassUsageData.uniform_directLightSource){for(o=0;o<this.materialData.directLightList.length;o++){this.materialData.directLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.directLightData)}i.gl.uniform1fv(this.materialData.diffusePassUsageData.uniform_directLightSource.uniformIndex,this.materialData.diffusePassUsageData.directLightData)}if(this.materialData.diffusePassUsageData.uniform_sportLightSource){for(o=0;o<this.materialData.sportLightList.length;o++){this.materialData.sportLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.sportLightData)}i.gl.uniform1fv(this.materialData.diffusePassUsageData.uniform_sportLightSource.uniformIndex,this.materialData.diffusePassUsageData.sportLightData)}if(this.materialData.diffusePassUsageData.uniform_pointLightSource){for(o=0;o<this.materialData.pointLightList.length;o++){this.materialData.pointLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.pointLightData)}i.gl.uniform1fv(this.materialData.diffusePassUsageData.uniform_pointLightSource.uniformIndex,this.materialData.diffusePassUsageData.pointLightData)}if(this.context3DChange){this.activate(i,a,r,s,n);this.context3DChange=false}for(this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++){this.materialData.diffusePassUsageData.vsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++){this.materialData.diffusePassUsageData.fsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.effectMethodList.length;this.index++){this.materialData.diffusePassUsageData.effectMethodList[this.index].updataEffect(i,this.materialData.diffusePassUsageData,this.materialData,a,r,s,n)}i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer);i.gl.drawElements(this.materialData.drawMode,s.numItems,t.Egret3DDrive.UNSIGNED_SHORT,0);if(this.materialData.alphaBlending)i.gl.depthMask(true);for(var u in this.materialData.diffusePassUsageData.sampler2DList){i.gl.bindTexture(i.gl.TEXTURE_2D,null)}};return i}(t.MaterialPassBase);t.DiffuseMapPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this,t);this.index=0}i.prototype.initUseMethod=function(){var e=0;this.materialData.diffusePassUsageData.directLightData=new Float32Array(this.materialData.directLightList.length*t.DirectLight.stride);this.materialData.diffusePassUsageData.sportLightData=new Float32Array(this.materialData.sportLightList.length*t.SpotLight.stride);this.materialData.diffusePassUsageData.pointLightData=new Float32Array(this.materialData.pointLightList.length*t.PointLight.stride);this.diffuseMethod=new t.DiffuseMethod;this.pixelShader.addMethod(this.diffuseMethod);this.pixelShader.addShader(this.diffuseMethod.fragMethodName);if(this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.DIFFUSE)!=-1){this.pixelShader.addShader("cubeDiffuseMap_fragment")}if(this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.NORMAL)!=-1){this.pixelShader.addShader("normalMap_fragment")}if(this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.SPECULAR)!=-1){this.pixelShader.addShader("specularMap_fragment")}for(e=0;e<this.materialData.directLightList.length;e++){this.pixelShader.addShader("directLight_fragment")}for(e=0;e<this.materialData.sportLightList.length;e++){this.pixelShader.addShader("sportLight_fragment")}for(e=0;e<this.materialData.pointLightList.length;e++){this.pixelShader.addShader("pointLight_fragment")}if(this.animation){if(this.animation.animaNodeCollection){var i=this.animation.animaNodeCollection.getNodesVertexShaders();var a=this.animation.animaNodeCollection.getNodesFragmentShaders();for(e=0;e<i.length;e++){this.vertexShader.addShader(i[e])}for(e=0;e<a.length;e++){this.pixelShader.addShader(a[e])}}}if(this.materialData.acceptShadow&&this.shadowMaping){this.pixelShader.addMethod(this.shadowMaping);this.vertexShader.addShader(this.shadowMaping.vertexMethodName);this.pixelShader.addShader(this.shadowMaping.fragMethodName)}this.pixelShader.addShader("diffuse_fragmentEnd");if(this.effectMethodList){for(var e=0;e<this.effectMethodList.length;e++){this.pixelShader.addEffectMethod(this.effectMethodList[e]);this.pixelShader.addShader(this.effectMethodList[e].fragMethodName)}}};i.prototype.initShader=function(t,i,a){e.prototype.initShader.call(this,t,i,a)};i.prototype.resetTexture=function(){var t;for(var e in this.materialData.diffusePassUsageData.sampler2DList){t=this.materialData.diffusePassUsageData.sampler2DList[e];if(this.materialData[t.varName]){t.texture=this.materialData[t.varName]}}var i;for(var e in this.materialData.diffusePassUsageData.sampler3DList){i=this.materialData.diffusePassUsageData.sampler3DList[e];if(this.materialData[i.varName]){i.texture=this.materialData[i.varName]}}this.materialData.textureChange=false};i.prototype.activate=function(t,e,i,a,r){this.materialData.diffusePassUsageData.uniform_materialSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_materialSource.varName);if(this.materialData.directLightList.length>0){this.materialData.diffusePassUsageData.uniform_directLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_directLightSource.varName)}if(this.materialData.sportLightList.length>0){this.materialData.diffusePassUsageData.uniform_sportLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_sportLightSource.varName)}if(this.materialData.pointLightList.length>0){this.materialData.diffusePassUsageData.uniform_pointLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_pointLightSource.varName)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++){this.materialData.diffusePassUsageData.vsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++){this.materialData.diffusePassUsageData.fsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.effectMethodList.length;this.index++){this.materialData.diffusePassUsageData.effectMethodList[this.index].activateEffect(t,this.materialData.diffusePassUsageData,this.materialData,e,i,a,r)}this.resetTexture();var s;for(var n in this.materialData.diffusePassUsageData.sampler2DList){s=this.materialData.diffusePassUsageData.sampler2DList[n];s.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,s.varName)}var o;for(var n in this.materialData.diffusePassUsageData.sampler3DList){o=this.materialData.diffusePassUsageData.sampler3DList[n];o.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,o.varName)}};i.prototype.draw=function(t,i,a,r,s){e.prototype.draw.call(this,t,i,a,r,s)};return i}(t.DiffuseMapPass);t.CubeDiffuseMapPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i);this.diffuseMethod=new t.TerrainMethod}i.prototype.initUseMethod=function(){var e=0;this.materialData.diffusePassUsageData.directLightData=new Float32Array(this.materialData.directLightList.length*t.DirectLight.stride);this.materialData.diffusePassUsageData.sportLightData=new Float32Array(this.materialData.sportLightList.length*t.SpotLight.stride);this.materialData.diffusePassUsageData.pointLightData=new Float32Array(this.materialData.pointLightList.length*t.PointLight.stride);this.pixelShader.addMethod(this.diffuseMethod);this.pixelShader.addShader(this.diffuseMethod.fragMethodName);if(this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.DIFFUSE)!=-1){this.pixelShader.addShader("diffuseMap_fragment")}if(this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.NORMAL)!=-1){this.pixelShader.addShader("normalMap_fragment")}if(this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.SPECULAR)!=-1){this.pixelShader.addShader("specularMap_fragment")}this.pixelShader.addShader("terrainRGBA_fragment");for(e=0;e<this.materialData.directLightList.length;e++){this.pixelShader.addShader("directLight_fragment")}for(e=0;e<this.materialData.sportLightList.length;e++){this.pixelShader.addShader("spotLight_fragment")}for(e=0;e<this.materialData.pointLightList.length;e++){this.pixelShader.addShader("pointLight_fragment")}if(this.animation){if(this.animation.animaNodeCollection){var i=this.animation.animaNodeCollection.getNodesVertexShaders();var a=this.animation.animaNodeCollection.getNodesFragmentShaders();for(e=0;e<i.length;e++){this.vertexShader.addShader(i[e])}for(e=0;e<a.length;e++){this.pixelShader.addShader(a[e])}}}this.pixelShader.addShader("diffuse_fragmentEnd");if(this.effectMethodList){for(var e=0;e<this.effectMethodList.length;e++){this.pixelShader.addEffectMethod(this.effectMethodList[e]);this.pixelShader.addShader(this.effectMethodList[e].fragMethodName)}}if(this.materialData.acceptShadow){var r=new t.ShadowMapingMethod;this.pixelShader.addMethod(r);this.vertexShader.addShader(r.vertexMethodName);this.pixelShader.addShader(r.fragMethodName)}};return i}(t.DiffuseMapPass);t.TerrainMapPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this,t);this.index=0}i.prototype.initUseMethod=function(){this.pixelShader.addShader("depthMethod_fragment")};i.prototype.initShader=function(e,i,a){this.vertexShader=new t.VertexShader(this.materialData,this.materialData.depthPassUsageData);this.pixelShader=new t.PixelShader(this.materialData,this.materialData.depthPassUsageData);this.materialData.context3D=e;this.vertexShader.setVertexShader(i);this.initUseMethod();this.vertexShader.build();this.pixelShader.build();if(a){this.vertexShader.maxBone=a.jointNumber*2}var r=this.vertexShader.getShaderSource();var s=this.pixelShader.getShaderSource();var n=e.creatVertexShader(r);var o=e.creatFragmentShader(s);this.materialData.depthPassUsageData.program3D=e.creatProgram(n,o);this.context3DChange=true};i.prototype.activate=function(t,e,i,a,r){for(this.index=0;this.index<this.materialData.depthPassUsageData.vsMethodList.length;this.index++){this.materialData.depthPassUsageData.vsMethodList[this.index].activate(t,this.materialData.depthPassUsageData.program3D,e,i,a,r)}for(this.index=0;this.index<this.materialData.depthPassUsageData.fsMethodList.length;this.index++){this.materialData.depthPassUsageData.fsMethodList[this.index].activate(t,this.materialData.depthPassUsageData.program3D,e,i,a,r);
}};i.prototype.draw=function(i,a,r,s,n){e.prototype.draw.call(this,i,a,r,s,n);var o=0;if(this.context3DChange){this.activate(i,a,r,s,n);this.context3DChange=false}for(this.index=0;this.index<this.materialData.depthPassUsageData.vsMethodList.length;this.index++){this.materialData.depthPassUsageData.vsMethodList[this.index].updata(i,this.materialData.depthPassUsageData.program3D,a,r,s,n)}for(this.index=0;this.index<this.materialData.depthPassUsageData.fsMethodList.length;this.index++){this.materialData.depthPassUsageData.fsMethodList[this.index].updata(i,this.materialData.depthPassUsageData.program3D,a,r,s,n)}i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer);i.gl.drawElements(this.materialData.drawMode,s.numItems,t.Egret3DDrive.UNSIGNED_SHORT,0)};return i}(t.MaterialPassBase);t.DepthMapPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this,t);this.index=0}i.prototype.initUseMethod=function(){var e=0;this.normalMethod=new t.NormalMethod;this.pixelShader.addMethod(this.normalMethod);this.pixelShader.addShader(this.normalMethod.fragMethodName);if(this.animation){var i=this.animation.animaNodeCollection.getNodesVertexShaders();var a=this.animation.animaNodeCollection.getNodesFragmentShaders();for(e=0;e<i.length;e++){this.vertexShader.addShader(i[e])}for(e=0;e<i.length;e++){this.pixelShader.addShader(a[e])}}};i.prototype.initShader=function(e,i,a){this.vertexShader=new t.VertexShader(this.materialData,this.materialData.normalPassUsageData);this.pixelShader=new t.PixelShader(this.materialData,this.materialData.normalPassUsageData);this.materialData.context3D=e;this.vertexShader.setVertexShader(i);this.initUseMethod();this.vertexShader.build();this.pixelShader.build();if(a){this.vertexShader.maxBone=a.jointNumber*2}var r=this.vertexShader.getShaderSource();var s=this.pixelShader.getShaderSource();var n=e.creatVertexShader(r);var o=e.creatFragmentShader(s);this.materialData.normalPassUsageData.program3D=e.creatProgram(n,o);this.context3DChange=true};i.prototype.activate=function(t,e,i,a,r){for(this.index=0;this.index<this.materialData.normalPassUsageData.vsMethodList.length;this.index++){this.materialData.normalPassUsageData.vsMethodList[this.index].activate(t,this.materialData.normalPassUsageData.program3D,e,i,a,r)}for(this.index=0;this.index<this.materialData.normalPassUsageData.fsMethodList.length;this.index++){this.materialData.normalPassUsageData.fsMethodList[this.index].activate(t,this.materialData.normalPassUsageData.program3D,e,i,a,r)}};i.prototype.draw=function(i,a,r,s,n){i.setProgram(this.materialData.normalPassUsageData.program3D);e.prototype.draw.call(this,i,a,r,s,n);var o=0;if(this.context3DChange){this.activate(i,a,r,s,n);this.context3DChange=false}for(this.index=0;this.index<this.materialData.normalPassUsageData.vsMethodList.length;this.index++){this.materialData.normalPassUsageData.vsMethodList[this.index].updata(i,this.materialData.normalPassUsageData.program3D,a,r,s,n)}for(this.index=0;this.index<this.materialData.normalPassUsageData.fsMethodList.length;this.index++){this.materialData.normalPassUsageData.fsMethodList[this.index].updata(i,this.materialData.normalPassUsageData.program3D,a,r,s,n)}i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer);i.gl.drawElements(this.materialData.drawMode,s.numItems,t.Egret3DDrive.UNSIGNED_SHORT,0)};return i}(t.MaterialPassBase);t.NormalMapPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this,t);this.index=0}i.prototype.initUseMethod=function(){this.materialData.diffusePassUsageData.directLightData=new Float32Array(this.materialData.directLightList.length*t.DirectLight.stride);this.materialData.diffusePassUsageData.sportLightData=new Float32Array(this.materialData.sportLightList.length*t.SpotLight.stride);this.materialData.diffusePassUsageData.pointLightData=new Float32Array(this.materialData.pointLightList.length*t.PointLight.stride);this.diffuseMethod=new t.DiffuseMethod;this.pixelShader.addMethod(this.diffuseMethod);this.pixelShader.addShader(this.diffuseMethod.fragMethodName)};i.prototype.initShader=function(e,i,a){this.vertexShader=new t.VertexShader(this.materialData,this.materialData.diffusePassUsageData);this.pixelShader=new t.PixelShader(this.materialData,this.materialData.diffusePassUsageData);this.materialData.context3D=e;this.vertexShader.setVertexShader(i);this.initUseMethod();this.vertexShader.build();this.pixelShader.build();if(a){this.vertexShader.maxBone=a.jointNumber*2}var r=this.vertexShader.getShaderSource();var s=this.pixelShader.getShaderSource();var n=e.creatVertexShader(r);var o=e.creatFragmentShader(s);this.materialData.diffusePassUsageData.program3D=e.creatProgram(n,o);this.context3DChange=true};i.prototype.activate=function(t,e,i,a,r){for(this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++){this.materialData.diffusePassUsageData.vsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++){this.materialData.diffusePassUsageData.fsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r)}};i.prototype.updata=function(i,a,r,s,n){e.prototype.draw.call(this,i,a,r,s,n);var o;for(o=0;o<this.materialData.directLightList.length;o++){this.materialData.directLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.directLightData)}for(o=0;o<this.materialData.sportLightList.length;o++){this.materialData.sportLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.sportLightData)}for(o=0;o<this.materialData.pointLightList.length;o++){this.materialData.pointLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.pointLightData)}if(this.context3DChange){this.activate(i,a,r,s,n);this.context3DChange=false}for(this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++){this.materialData.diffusePassUsageData.vsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n)}for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++){this.materialData.diffusePassUsageData.fsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n)}i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer);i.drawElement(this.materialData.drawMode,s.sharedIndexBuffer,0,s.numItems)};return i}(t.MaterialPassBase);t.ColorMapPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){e.call(this,t)}i.prototype.initUseMethod=function(){var t=0;if(this.animation){if(this.animation.animaNodeCollection){var e=this.animation.animaNodeCollection.getNodesVertexShaders();var i=this.animation.animaNodeCollection.getNodesFragmentShaders();for(t=0;t<e.length;t++){this.vertexShader.addShader(e[t])}for(t=0;t<i.length;t++){this.pixelShader.addShader(i[t])}}}this.pixelShader.addShader("Shadow_fragment")};i.prototype.initShader=function(i,a,r){e.prototype.initShader.call(this,i,a,r);this.vertexShader=new t.VertexShader(this.materialData,this.materialData.shadowPassUsageData);this.pixelShader=new t.PixelShader(this.materialData,this.materialData.shadowPassUsageData);this.materialData.context3D=i;this.vertexShader.setVertexShader(a);this.initUseMethod();if(r){r.initShader(this.vertexShader,this.pixelShader)}this.vertexShader.build();this.pixelShader.build();var s=this.vertexShader.getShaderSource();var n=this.pixelShader.getShaderSource();var o=i.creatVertexShader(s);var h=i.creatFragmentShader(n);this.materialData.shadowPassUsageData.program3D=i.creatProgram(o,h);this.context3DChange=true};i.prototype.activate=function(t,e,i,a,r){for(this.index=0;this.index<this.materialData.shadowPassUsageData.vsMethodList.length;this.index++){this.materialData.shadowPassUsageData.vsMethodList[this.index].activate(t,this.materialData.shadowPassUsageData.program3D,e,i,a,r)}for(this.index=0;this.index<this.materialData.shadowPassUsageData.fsMethodList.length;this.index++){this.materialData.shadowPassUsageData.fsMethodList[this.index].activate(t,this.materialData.shadowPassUsageData.program3D,e,i,a,r)}var s;for(var n in this.materialData.shadowPassUsageData.sampler2DList){s=this.materialData.shadowPassUsageData.sampler2DList[n];s.uniformIndex=t.getUniformLocation(this.materialData.shadowPassUsageData.program3D,s.varName)}var o;for(var n in this.materialData.shadowPassUsageData.sampler3DList){o=this.materialData.shadowPassUsageData.sampler3DList[n];o.uniformIndex=t.getUniformLocation(this.materialData.shadowPassUsageData.program3D,o.varName)}};i.prototype.draw=function(i,a,r,s,n){if(this.context3DChange){this.activate(i,a,r,s,n);this.context3DChange=false}i.gl.useProgram(this.materialData.shadowPassUsageData.program3D.program);e.prototype.draw.call(this,i,a,r,s,n);var o=0;var h;for(var u in this.materialData.shadowPassUsageData.sampler2DList){h=this.materialData.shadowPassUsageData.sampler2DList[u];h.texture=this.materialData[h.varName];h.texture.upload(i);i.setTexture2DAt(h.activeTextureIndex,h.uniformIndex,h.index,h.texture.texture)}var l;for(var u in this.materialData.shadowPassUsageData.sampler3DList){l=this.materialData.shadowPassUsageData.sampler3DList[u];l.texture=this.materialData[l.varName];l.texture.upload(i);i.setCubeTextureAt(l.activeTextureIndex,l.uniformIndex,l.index,l.texture.cubeTexture)}for(this.index=0;this.index<this.materialData.shadowPassUsageData.vsMethodList.length;this.index++){this.materialData.shadowPassUsageData.vsMethodList[this.index].updata(i,this.materialData.shadowPassUsageData.program3D,a,r,s,n)}for(this.index=0;this.index<this.materialData.shadowPassUsageData.fsMethodList.length;this.index++){this.materialData.shadowPassUsageData.fsMethodList[this.index].updata(i,this.materialData.shadowPassUsageData.program3D,a,r,s,n)}i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer);i.gl.drawElements(this.materialData.drawMode,s.numItems,t.Egret3DDrive.UNSIGNED_SHORT,0);for(var u in this.materialData.shadowPassUsageData.sampler2DList){i.gl.bindTexture(i.gl.TEXTURE_2D,null)}};return i}(t.MaterialPassBase);t.ShadowMapPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["DIFFUSE"]=0]="DIFFUSE";t[t["NORMAL"]=1]="NORMAL";t[t["SPECULAR"]=2]="SPECULAR";t[t["RGBATERRAIN"]=3]="RGBATERRAIN"})(t.TextureMethodType||(t.TextureMethodType={}));var e=t.TextureMethodType;var i=function(){function i(e){if(e===void 0){e=null}if(e==null){this.materialData=new t.MaterialData;this.materialData.diffusePassUsageData.materialSourceData=new Float32Array(16)}else{this.materialData=e}this.setData(this.materialData)}i.prototype.initMatPass=function(){throw new Error("cant't constructor parent")};i.prototype.setData=function(t){if(this.materialData){this.materialData.dispose()}this.materialData=t;this.ambientColor=this.materialData.ambientColor;this.ambientPower=this.materialData.ambientPower;this.normalPower=this.materialData.normalPower;this.specularColor=this.materialData.specularColor;this.specularPower=this.materialData.specularPower;this.blendMode=this.materialData.blendMode};i.prototype.getData=function(){return this.materialData};i.prototype.addDiffusePassMothod=function(t){this.diffusePass.addMethod(t)};i.prototype.addDiffusePassEffectMothod=function(t){this.diffusePass.addEffectMethod(t)};Object.defineProperty(i.prototype,"shadowMapingMethod",{get:function(){return this.diffusePass.shadowMaping},set:function(t){this.diffusePass.shadowMaping=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"diffuseColor",{set:function(t){this.materialData.materialDataNeedChange=true;this.materialData.diffuseColor=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"ambientColor",{set:function(t){this.materialData.materialDataNeedChange=true;this.materialData.ambientColor=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"specularColor",{set:function(t){this.materialData.materialDataNeedChange=true;this.materialData.specularColor=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){if(this.materialData.alpha!=t){this.materialData.alpha=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"shininess",{get:function(){return this.materialData.shininess},set:function(t){if(this.materialData.shininess!=t){this.materialData.shininess=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"specularPower",{get:function(){return this.materialData.specularPower},set:function(t){if(this.materialData.specularPower!=t){this.materialData.specularPower=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"ambientPower",{get:function(){return this.materialData.ambientPower},set:function(t){if(this.materialData.ambientPower!=t){this.materialData.ambientPower=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"diffusePower",{get:function(){return this.materialData.diffusePower},set:function(t){if(this.materialData.diffusePower!=t){this.materialData.diffusePower=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"normalPower",{get:function(){return this.materialData.normalPower},set:function(t){if(this.materialData.normalPower!=t){this.materialData.normalPower=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"castShadow",{get:function(){return this.materialData.castShadow},set:function(e){this.materialData.castShadow=e;if(e){if(!t.ShadowRender.frameBuffer){alert("要使用shadow view3D.useShadow = true ")}else{if(!this.shadowPass)this.shadowPass=new t.ShadowMapPass(this.materialData)}}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"acceptShadow",{get:function(){return this.materialData.acceptShadow},set:function(t){this.materialData.acceptShadow=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"smooth",{get:function(){return this.materialData.smooth},set:function(t){this.materialData.smooth=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"repeat",{get:function(){return this.materialData.repeat},set:function(t){this.materialData.repeat=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"bothside",{get:function(){return this.materialData.bothside},set:function(t){this.materialData.bothside=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"cullMode",{get:function(){return this.materialData.cullFrontOrBack},set:function(t){this.materialData.cullFrontOrBack=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"blendMode",{get:function(){return this.materialData.blendMode},set:function(e){this.materialData.blendMode=e;switch(e){case t.BlendMode.NORMAL:this.materialData.blend_src=t.Egret3DDrive.ONE;this.materialData.blend_dest=t.Egret3DDrive.ZERO;break;case t.BlendMode.LAYER:this.materialData.blend_src=t.Egret3DDrive.SRC_ALPHA;this.materialData.blend_dest=t.Egret3DDrive.ZERO;this.materialData.alphaBlending=true;break;case t.BlendMode.MULTIPLY:this.materialData.blend_src=t.Egret3DDrive.ZERO;this.materialData.blend_dest=t.Egret3DDrive.SRC_COLOR;this.materialData.alphaBlending=true;break;case t.BlendMode.ADD:this.materialData.blend_src=t.Egret3DDrive.SRC_ALPHA;this.materialData.blend_dest=t.Egret3DDrive.ONE;this.materialData.alphaBlending=true;break;case t.BlendMode.ALPHA:this.materialData.blend_src=t.Egret3DDrive.SRC_ALPHA;this.materialData.blend_dest=t.Egret3DDrive.ONE_MINUS_SRC_ALPHA;this.materialData.alphaBlending=true;break;case t.BlendMode.SCREEN:this.materialData.blend_src=t.Egret3DDrive.ONE;this.materialData.blend_dest=t.Egret3DDrive.ONE_MINUS_SRC_COLOR;break}},enumerable:true,configurable:true});i.prototype.setOutlineStyler=function(t,e){if(!this.outLinePass){}};Object.defineProperty(i.prototype,"depthTest",{get:function(){return this.materialData.depthTest},set:function(t){this.materialData.depthTest=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"lightGroup",{set:function(t){this.materialData.directLightList=t.directLightList;this.materialData.sportLightList=t.spotLightList;this.materialData.pointLightList=t.pointLightList},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"diffuseTexture",{get:function(){return this.materialData.diffuseTex},set:function(t){if(t){this.materialData.diffuseTex=t;this.materialData.textureChange=true;if(this.materialData.textureMethodTypes.indexOf(e.DIFFUSE)==-1){this.materialData.textureMethodTypes.push(e.DIFFUSE)}}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"normalTexture",{set:function(t){if(t){this.materialData.normalTex=t;this.materialData.textureChange=true;if(this.materialData.textureMethodTypes.indexOf(e.NORMAL)==-1){this.materialData.textureMethodTypes.push(e.NORMAL);this.materialData.passChange=true}}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"specularTexture",{set:function(t){if(t){this.materialData.specularTex=t;this.materialData.textureChange=true;if(this.materialData.textureMethodTypes.indexOf(e.SPECULAR)==-1){this.materialData.textureMethodTypes.push(e.SPECULAR);this.materialData.passChange=true}}},enumerable:true,configurable:true});i.prototype.clone=function(){var t=new i(this.materialData.clone());return t};i.prototype.activateDiffusePass=function(t,e,i,a,r){if(this.outLinePass){this.outLinePass.initShader(t,a,r);this.outLinePass.activate(t,i,e,a,r)}this.diffusePass.initShader(t,a,r);this.diffusePass.activate(t,i,e,a,r)};i.prototype.rendenDiffusePass=function(t,e,i,a,r){if(this.outLinePass){this.outLinePass.draw(t,i,e,a,r)}if(!this.materialData.passChange){this.diffusePass.draw(t,i,e,a,r)}else{this.activateDiffusePass(t,e,i,a,r);this.materialData.passChange=false}};i.prototype.activateShadowPass=function(t,e,i,a,r){this.shadowPass.initShader(t,a,r);this.shadowPass.activate(t,i,e,a,r)};i.prototype.rendenShadowPass=function(t,e,i,a,r){if(!this.materialData.passChange){this.shadowPass.draw(t,i,e,a,r)}else{this.activateShadowPass(t,e,i,a,r)}};i.prototype.activateNormalPass=function(t,e,i,a,r){this.normalPass.initShader(t,a,r);this.normalPass.activate(t,i,e,a,r)};i.prototype.rendenNormalPass=function(t,e,i,a,r){};i.prototype.activateDepthPass=function(t,e,i,a,r){this.depthPass.initShader(t,a,r);this.depthPass.activate(t,i,e,a,r)};i.prototype.rendenDepthPass=function(t,e,i,a,r){};i.prototype.dispose=function(){};return i}();t.MaterialBase=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,a,r,s,n,o,h){if(h===void 0){h=null}e.call(this);this.materialData.diffuseTex=i;this.materialData.maskTex=a;this.materialData.splat_0Tex=r;this.materialData.splat_1Tex=s;this.materialData.splat_2Tex=n;this.materialData.splat_3Tex=o;if(!h)this.materialData.lightMapTex=t.CheckerboardTexture.texture;else this.materialData.lightMapTex=h;this.initMatPass()}i.prototype.initMatPass=function(){this.diffusePass=new t.TerrainMapPass(this.materialData)};i.prototype.setUVTitling=function(t,e,i){this.diffusePass.diffuseMethod.setUVTitling(t,e,i)};return i}(t.MaterialBase);t.TerrainMaterial=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,a){if(i===void 0){i=null}if(a===void 0){a=null}e.call(this,a);if(!i){this.diffuseTexture=t.CheckerboardTexture.texture}else{this.diffuseTexture=i}this.initMatPass()}i.prototype.initMatPass=function(){if(this.diffuseTexture instanceof t.SkyTexture){this.diffusePass=new t.CubeDiffuseMapPass(this.materialData)}else{this.diffusePass=new t.DiffuseMapPass(this.materialData)}};i.prototype.clone=function(){var t=new i(this.diffuseTexture,this.materialData.clone());return t};return i}(t.MaterialBase);t.TextureMaterial=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this._vtxNum=8;this._planeNum=6;this._vertex=new Array;for(var e=0;e<this._vtxNum;++e){this._vertex.push(new t.Vector3D)}this._pos=new t.Vector3D;this._plane=new Array;for(var e=0;e<6;++e){this._plane.push(new t.Plane3D)}this.box=new t.CubeBoxBound(new t.Vector3D,new t.Vector3D);this.center=new t.Vector3D}e.prototype.makeFrustum=function(t,e,i,a){var r=Math.tan(t/2*(Math.PI/180));var s=i*r;var n=s*e;var o=a*r;var h=o*e;this._vertex[0].x=n;this._vertex[0].y=s;this._vertex[0].z=i;this._vertex[1].x=-n;this._vertex[1].y=s;this._vertex[1].z=i;this._vertex[2].x=-n;this._vertex[2].y=-s;this._vertex[2].z=i;this._vertex[3].x=n;this._vertex[3].y=-s;this._vertex[3].z=i;this._vertex[4].x=h;this._vertex[4].y=o;this._vertex[4].z=a;this._vertex[5].x=-h;this._vertex[5].y=o;this._vertex[5].z=a;this._vertex[6].x=-h;this._vertex[6].y=-o;this._vertex[6].z=a;this._vertex[7].x=h;this._vertex[7].y=-o;this._vertex[7].z=a};e.prototype.update=function(e){this.makeFrustum(e.fieldOfView,e.aspectRatio,e.near,e.far);var i=new Array;var a=new t.Matrix4_4;a.copyFrom(e.modelMatrix);this._curVer=i;for(var r=0;r<this._vtxNum;++r){i.push(a.transformVector(this._vertex[r]))}for(var r=0;r<i.length;++r){if(this.box.max.x<i[r].x){this.box.max.x=i[r].x}if(this.box.max.y<i[r].y){this.box.max.y=i[r].y}if(this.box.max.z<i[r].z){this.box.max.z=i[r].z}if(this.box.min.x>i[r].x){this.box.min.x=i[r].x}if(this.box.min.y>i[r].y){this.box.min.y=i[r].y}if(this.box.min.z>i[r].z){this.box.min.z=i[r].z}}this.box.calculateBox();this._plane[0].fromPoints(i[4],i[5],i[6]);this._plane[1].fromPoints(i[1],i[6],i[5]);this._plane[2].fromPoints(i[0],i[4],i[7]);this._plane[3].fromPoints(i[1],i[0],i[3]);this._plane[4].fromPoints(i[1],i[5],i[4]);this._plane[5].fromPoints(i[3],i[7],i[6]);for(var r=0;r<this._planeNum;r++){this._plane[r].normalize()}var s=new t.Vector3D;s.copyFrom(i[0].subtract(i[2]));s.scaleBy(.5);s.copyFrom(i[2].add(s));var n=new t.Vector3D;n.copyFrom(i[4].subtract(i[6]));n.scaleBy(.5);n.copyFrom(i[6].add(n));this.center.copyFrom(n.subtract(s));this.center.scaleBy(.5);this.center.copyFrom(s.add(this.center))};e.prototype.inPoint=function(t){var e=0;for(var i=0;i<this._plane.length;++i){e=this._plane[i].distance(t);if(e>0){return false}}return true};e.prototype.inSphere=function(t,e){var i=0;for(var a=0;a<this._plane.length;++a){i=this._plane[a].distance(t);if(i>e){return false}}return true};e.prototype.inBox=function(e){var i=new Array;var a=0;var r=new t.Vector3D;for(var s=0;s<this._plane.length;++s){var n=e.vexData.length/3;for(var o=0;o<e.vexData.length;o+=3){r.setTo(e.vexData[o],e.vexData[o+1],e.vexData[o+2]);r.copyFrom(e.Transform.transformVector(r));a=this._plane[s].distance(r);if(a>0){n--}}if(n<=0){return false}}return true};return e}();t.Frustum=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["BoundPick"]=0]="BoundPick";t[t["PositionPick"]=1]="PositionPick";t[t["UVPick"]=2]="UVPick"})(t.PickType||(t.PickType={}));var e=t.PickType;var i=function(i){__extends(a,i);function a(){i.call(this);this._modeMatrix3D=new t.Matrix4_4;this._transformChange=true;this._pos=new t.Vector3D;this._rot=new t.Vector3D;this._sca=new t.Vector3D(1,1,1);this._orientation=new t.Quaternion;this._axis=new t.Vector3D;this._angle=0;this._globalPos=new t.Vector3D;this._globalRot=new t.Vector3D;this._globalSca=new t.Vector3D(1,1,1);this._globalOrientation=new t.Quaternion;this._qut=new t.Quaternion;this._active=false;this._mat=new t.Matrix4_4;this.layer=0;this.mouseEnable=false;this.enableCut=true;this.parent=null;this.childs=new Array;this.animation=null;this.geometry=null;this.material=null;this.box=new t.CubeBoxBound;this.pickerData=new t.PickResult;this.isController=true;this.isVisible=true;this.isDisable=false;this.pickType=e.BoundPick;this.id=++a.s_id}Object.defineProperty(a.prototype,"position",{get:function(){return this._pos},set:function(t){this.updateTransformChange(true);this._pos.copyFrom(t)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rot},set:function(t){this._rot.x=t.x;this._rot.y=t.y;this._rot.z=t.z;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"orientation",{get:function(){return this._orientation},set:function(t){this._orientation.copyFrom(t);this._orientation.toEulerAngles(this._rot);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"scale",{get:function(){return this._sca},set:function(t){this.updateTransformChange(true);this._sca=t},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"x",{get:function(){return this._pos.x},set:function(t){this.updateTransformChange(true);if(this._pos.x==t)return;this._pos.x=t},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"y",{get:function(){return this._pos.y},set:function(t){this.updateTransformChange(true);if(this._pos.y==t)return;this._pos.y=t},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"z",{get:function(){return this._pos.z},set:function(t){this.updateTransformChange(true);if(this._pos.z==t)return;this._pos.z=t},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"rotationX",{get:function(){return this._rot.x},set:function(t){this.updateTransformChange(true);if(this._rot.x==t)return;this._rot.x=t;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this._angle=this._orientation.toAxisAngle(this._axis)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"rotationY",{get:function(){return this._rot.y},set:function(t){this.updateTransformChange(true);if(this._rot.y==t)return;this._rot.y=t;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this._angle=this._orientation.toAxisAngle(this._axis)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"rotationZ",{get:function(){return this._rot.z},set:function(t){this.updateTransformChange(true);if(this._rot.z==t)return;this._rot.z=t;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this._angle=this._orientation.toAxisAngle(this._axis)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"scaleX",{get:function(){return this._sca.x},set:function(t){this.updateTransformChange(true);if(this._sca.x==t)return;this._sca.x=t},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"scaleY",{get:function(){return this._sca.y},set:function(t){this.updateTransformChange(true);if(this._sca.y==t)return;this._sca.y=t},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"scaleZ",{get:function(){return this._sca.z},set:function(t){this.updateTransformChange(true);if(this._sca.z==t)return;this._sca.z=t},enumerable:true,configurable:true});a.prototype.setRotationFromAxisAngle=function(t,e){t.normalize();this.updateTransformChange(true);this._orientation.fromAxisAngle(t,e);this._orientation.toEulerAngles(this._rot);this._axis.copyFrom(t);this._angle=e};Object.defineProperty(a.prototype,"modelMatrix",{get:function(){if(this._transformChange){this.updateModleMatrix()}return this._modeMatrix3D},enumerable:true,configurable:true});a.prototype.updateModleMatrix=function(){if(this.parent!=null){var t=this.parent.globalOrientation;this._globalOrientation.multiply(t,this._orientation);this._globalOrientation.toEulerAngles(this._globalRot);var e=this.parent.globalScale;this._globalSca.copyFrom(e.multiply(this._sca));t.rotatePoint(e.multiply(this._pos),this._globalPos);this._globalPos.copyFrom(this._globalPos.add(this.parent.globalPosition))}else{this._globalOrientation.copyFrom(this._orientation);this._globalPos.copyFrom(this._pos);this._globalSca.copyFrom(this._sca);this._globalRot.copyFrom(this._rot)}this._modeMatrix3D.makeTransform(this._globalPos,this._globalSca,this._globalOrientation);this.box.Transform=this._modeMatrix3D;this._transformChange=false;this.onUpdateTransform()};a.prototype.onUpdateTransform=function(){};Object.defineProperty(a.prototype,"globalPosition",{get:function(){if(this._transformChange){this.modelMatrix}return this._globalPos},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalRotation",{get:function(){if(this._transformChange){this.modelMatrix}return this._globalRot},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalScale",{get:function(){if(this._transformChange){this.modelMatrix}return this._globalSca},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalOrientation",{get:function(){if(this._transformChange){this.modelMatrix}return this._globalOrientation},enumerable:true,configurable:true});a.prototype.addChild=function(t){this.childs.push(t);a.renderListChange=true;t.parent=this;t.updateTransformChange(true);return t};a.prototype.addChildAt=function(t,e){if(e<0){this.childs.splice(0,0,t)}else if(e>=this.childs.length){this.childs.push(t)}else{this.childs.splice(e,0,t)}t.parent=this;t.updateTransformChange(true);return t};a.prototype.getChildAt=function(t){if(t<0||t>=this.childs.length)return null;return this.childs[t]};a.prototype.getChildIndex=function(t){for(var e=0;e<this.childs.length;++e){if(this.childs[e]!=t){continue}return e}return-1};a.prototype.removeChild=function(t){for(var e=0;e<this.childs.length;++e){if(this.childs[e]!=t){continue}t.parent=null;this.childs.splice(e,1);return t}t.updateTransformChange(true);return null};a.prototype.removeChildAt=function(t){if(t<0||t>=this.childs.length)return null;var e=this.childs[t];e.parent=null;this.childs.splice(t,1);e.updateTransformChange(true);return e};a.prototype.setChildIndex=function(t,e){for(var i=0;i<this.childs.length;++i){if(this.childs[i]!=t){continue}if(i==e){return}else if(e>i){for(var a=i;a>e;--a){this.childs[a]=this.childs[a-1]}}else if(e<i){for(var a=i;a<e;++a){this.childs[a]=this.childs[a+1]}}this.childs[e]=t;return}};a.prototype.swapChildren=function(t,e){var i=0,a=0;for(;i<this.childs.length;++i){if(this.childs[i]!=t){continue}for(;a<this.childs.length;++a){if(this.childs[a]!=e){continue}var r=this.childs[i];this.childs[i]=this.childs[a];this.childs[a]=r;break}return}};a.prototype.swapChildrenAt=function(t,e){if(t<0||t>=this.childs.length)return;if(e<0||e>=this.childs.length)return;var i=this.childs[t];this.childs[t]=this.childs[e];this.childs[e]=i};a.prototype.lookAt=function(e,i,a){if(a===void 0){a=t.Vector3D.Y_AXIS}};Object.defineProperty(a.prototype,"lookAtPosition",{get:function(){return new t.Vector3D},enumerable:true,configurable:true});a.prototype.updateTransformChange=function(t){this._transformChange=t;for(var e=0;e<this.childs.length;++e){this.childs[e].updateTransformChange(t)}};a.prototype.update=function(t,e,i){};a.prototype.getScreenPosition=function(t){this._mat.copyFrom(t.viewProjectionMatrix);this._mat.append(this.modelMatrix);return this._mat.transformVector(this.globalPosition)};a.prototype.dispose=function(){if(this.parent)this.parent.removeChild(this);if(this.geometry){this.geometry.dispose();this.geometry=null}if(this.material){this.material.dispose();this.material=null}for(var t=0;t<this.childs.length;t++){this.childs[t].dispose()}};a.renderListChange=true;a.s_id=0;return a}(t.EventDispatcher);t.Object3D=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,a,r){if(a===void 0){a=100}if(r===void 0){
r=100}e.call(this);this.material=i;this.geometry=new t.PlaneGeometry(a,r);this.box.fillBox(this.geometry.minPos,this.geometry.maxPos)}i.prototype.update=function(t,e,i){this._qut.fromEulerAngles(-90,0,0);this._qut.multiply(t.orientation,this._qut);this.orientation=this._qut};return i}(t.Object3D);t.Billboard=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){this.normalMatrix=new t.Matrix4_4;this.px=0;this.py=0;this.pz=0;this.offest=new t.Vector3D;this.skyTexture=e;this.usage=new t.MethodUsageData;this.vsShader=new t.GLSL.ShaderBase(null,this.usage);this.fsShader=new t.GLSL.ShaderBase(null,this.usage);this.setShader("spheresky_vertex","spheresky_fragment");this.skyMatrix=new t.Matrix4_4}e.prototype.setShader=function(t,e){this.vsShader.addShader(t);this.fsShader.addShader(e);this.vsShaderSource=this.vsShader.getShaderSource();this.fsShaderSource=this.fsShader.getShaderSource()};e.prototype.rebuild=function(e){var i=e.creatVertexShader(this.vsShaderSource);var a=e.creatFragmentShader(this.fsShaderSource);this.usage.program3D=e.creatProgram(i,a);if(this.usage.program3D){e.setProgram(this.usage.program3D)}this.sphereGeometry=this.sphereGeometry||new t.SphereGeometry(25);if(!this.sphereGeometry.sharedVertexBuffer){this.sphereGeometry.sharedVertexBuffer=e.creatVertexBuffer(this.sphereGeometry.verticesData);this.sphereGeometry.numberOfVertices=this.sphereGeometry.verticesData.length/this.sphereGeometry.vertexAttLength;this.sphereGeometry.vertexSizeInBytes=this.sphereGeometry.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT;this.sphereGeometry.sharedIndexBuffer=e.creatIndexBuffer(this.sphereGeometry.indexData)}this.usage.attribute_position.uniformIndex=e.getShaderAttribLocation(this.usage.program3D,"attribute_position");this.usage.attribute_normal.uniformIndex=e.getShaderAttribLocation(this.usage.program3D,"attribute_normal");this.usage.attribute_uv0.uniformIndex=e.getShaderAttribLocation(this.usage.program3D,"attribute_uv0");this.usage.uniform_ProjectionMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_ProjectionMatrix");this.usage.uniform_ModelMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_ModelMatrix");this.usage.uniform_normalMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_normalMatrix");var r;for(var s in this.usage.sampler2DList){r=this.usage.sampler2DList[s];if(r.varName=="sky_texture")r.texture=this.skyTexture;r.uniformIndex=e.getUniformLocation(this.usage.program3D,r.varName)}};e.prototype.draw=function(e,i){if(!this.usage.program3D)this.rebuild(e);e.setProgram(this.usage.program3D);e.gl.enable(t.Egret3DDrive.CULL_FACE);e.gl.cullFace(t.Egret3DDrive.FRONT);e.gl.enable(t.Egret3DDrive.BLEND);e.gl.blendFunc(t.Egret3DDrive.ONE,t.Egret3DDrive.ZERO);e.bindVertexBuffer(this.sphereGeometry.sharedVertexBuffer);e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,false,this.sphereGeometry.vertexSizeInBytes,0);e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,false,this.sphereGeometry.vertexSizeInBytes,52);this.skyMatrix.identity();this.skyMatrix.appendTranslation(i.x,i.y,i.z);e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,false,i.viewProjectionMatrix.rawData);e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,false,this.skyMatrix.rawData);var a;for(var r in this.usage.sampler2DList){a=this.usage.sampler2DList[r];a.texture.upload(e);e.setTexture2DAt(a.activeTextureIndex,a.uniformIndex,a.index,a.texture.texture)}e.drawElement(t.DrawMode.TRIANGLES,this.sphereGeometry.sharedIndexBuffer,0,this.sphereGeometry.numItems)};return e}();t.SphereSky=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){this.px=0;this.py=0;this.pz=0;this.offest=new t.Vector3D;this.skyTexture=e;this.usage=new t.MethodUsageData;this.vsShader=new t.GLSL.ShaderBase(null,this.usage);this.fsShader=new t.GLSL.ShaderBase(null,this.usage);this.setShader("sky_vertex","sky_fragment");this.skyMatrix=new t.Matrix4_4;this.modelMatrix=new t.Matrix4_4}e.prototype.setShader=function(t,e){this.vsShader.addShader(t);this.fsShader.addShader(e);this.vsShaderSource=this.vsShader.getShaderSource();this.fsShaderSource=this.fsShader.getShaderSource()};e.prototype.rebuild=function(e){var i=e.creatVertexShader(this.vsShaderSource);var a=e.creatFragmentShader(this.fsShaderSource);this.usage.program3D=e.creatProgram(i,a);if(this.usage.program3D){e.setProgram(this.usage.program3D)}this.cubeGeometry=this.cubeGeometry||new t.CubeGeometry;if(!this.cubeGeometry.sharedVertexBuffer){this.cubeGeometry.sharedVertexBuffer=e.creatVertexBuffer(this.cubeGeometry.verticesData);this.cubeGeometry.numberOfVertices=this.cubeGeometry.verticesData.length/this.cubeGeometry.vertexAttLength;this.cubeGeometry.vertexSizeInBytes=this.cubeGeometry.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT;this.cubeGeometry.sharedIndexBuffer=e.creatIndexBuffer(this.cubeGeometry.indexData)}this.usage.attribute_position.uniformIndex=e.getShaderAttribLocation(this.usage.program3D,"attribute_position");this.usage.uniform_ProjectionMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_ProjectionMatrix");this.usage.uniform_ModelMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_ModelMatrix");var r;for(var s in this.usage.sampler3DList){r=this.usage.sampler3DList[s];r.uniformIndex=e.getUniformLocation(this.usage.program3D,r.varName);if(r.varName=="sky_texture"){r.texture=this.skyTexture}}};e.prototype.draw=function(e,i){if(!this.usage.program3D)this.rebuild(e);e.setProgram(this.usage.program3D);e.gl.enable(t.Egret3DDrive.CULL_FACE);e.gl.cullFace(t.Egret3DDrive.FRONT);e.bindVertexBuffer(this.cubeGeometry.sharedVertexBuffer);e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,false,this.cubeGeometry.vertexSizeInBytes,0);this.skyMatrix.identity();this.skyMatrix.appendTranslation(i.x,i.y,i.z);e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,false,i.viewProjectionMatrix.rawData);e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,false,this.skyMatrix.rawData);var a;for(var r in this.usage.sampler3DList){a=this.usage.sampler3DList[r];a.texture.upload(e);e.setCubeTextureAt(a.activeTextureIndex,a.uniformIndex,a.index,a.texture.cubeTexture)}e.drawElement(t.DrawMode.TRIANGLES,this.cubeGeometry.sharedIndexBuffer,0,this.cubeGeometry.numItems)};return e}();t.Sky=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this)}return e}(t.Object3D);t.Entity=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["perspective"]=0]="perspective";t[t["orthogonal"]=1]="orthogonal";t[t["VR"]=2]="VR"})(t.CameraType||(t.CameraType={}));var e=t.CameraType;(function(t){t[t["left"]=0]="left";t[t["right"]=1]="right"})(t.VRType||(t.VRType={}));var i=t.VRType;var a=function(a){__extends(r,a);function r(i){if(i===void 0){i=e.perspective}a.call(this);this.projectMatrix=new t.Matrix4_4;this.frustum=new t.Frustum;this._viewPort=new t.Rectangle;this._scissorRect=new t.Rectangle;this._aspectRatio=1;this._fovY=45;this._near=1;this._far=1e4;this.temp=new t.Matrix4_4;this._lookAtPosition=new t.Vector3D;this._up=new t.Vector3D(0,1,0);this._cameraType=0;this._cameraMatrixChange=false;this._viewMatrix=new t.Matrix4_4;this._tempQuat=new t.Quaternion;this.cameraType=i}Object.defineProperty(r.prototype,"cameraType",{set:function(i){this._cameraType=i;switch(i){case e.orthogonal:this.cameraMatrix=this.modelMatrix;this.updataOrth();break;case e.perspective:this.cameraMatrix=this.modelMatrix;this.projectMatrix.perspective(this._fovY,this._aspectRatio,this._near,this._far);break;case e.VR:this.cameraMatrix=this.modelMatrix;this.projectMatrix.perspective(this._fovY,1,this._near,this._far);this.eyeMatrix=this.eyeMatrix||new t.EyesMatrix;break}},enumerable:true,configurable:true});r.prototype.tap=function(t,a){if(a===void 0){a=null}if(t==e.VR){this.eyeMatrix.updte(this.modelMatrix);if(a==i.left){this.cameraMatrix=this.eyeMatrix.leftEyeMatrix}else if(a==i.right){this.cameraMatrix=this.eyeMatrix.rightEyeMatrix}}else{this.cameraMatrix=this.modelMatrix}};Object.defineProperty(r.prototype,"aspectRatio",{get:function(){return this._aspectRatio},set:function(t){if(this._aspectRatio!=t){this._aspectRatio=t;this.cameraType=this._cameraType}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"fieldOfView",{get:function(){return this._fovY},set:function(t){if(this._fovY!=t){this._fovY=t;this.cameraType=this._cameraType}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"near",{get:function(){return this._near},set:function(t){if(this._near!=t){this._near=t;this.cameraType=this._cameraType}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"far",{get:function(){return this._far},set:function(t){if(this._far!=t){this._far=t;this.cameraType=this._cameraType}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"viewProjectionMatrix",{get:function(){this.cameraMatrix=this.modelMatrix;this.temp.copyFrom(this.cameraMatrix);this.temp.invert();this.temp.append(this.projectMatrix);return this.temp},enumerable:true,configurable:true});r.prototype.updateScissorRect=function(t,e,i,a){this._scissorRect.x=t;this._scissorRect.y=e;this._scissorRect.width=i;this._scissorRect.height=a};r.prototype.updateViewport=function(t,e,i,a){this._viewPort.x=t;this._viewPort.y=e;this._viewPort.width=i;this._viewPort.height=a};r.prototype.lookAt=function(e,i,a){if(a===void 0){a=t.Vector3D.Y_AXIS}this.position=e;this._lookAtPosition.copyFrom(i);this._up.copyFrom(a);this._viewMatrix.lookAt(this._pos,this._lookAtPosition,this._up);this._viewMatrix.invert();var r=this._viewMatrix.decompose(t.Orientation3D.QUATERNION);this._tempQuat.x=r[1].x;this._tempQuat.y=r[1].y;this._tempQuat.z=r[1].z;this._tempQuat.w=r[1].w;this.orientation=this._tempQuat};r.prototype.onUpdateTransform=function(){this._viewMatrix.copyFrom(this._modeMatrix3D);this._viewMatrix.invert()};Object.defineProperty(r.prototype,"viewMatrix",{get:function(){return this._viewMatrix},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},enumerable:true,configurable:true});r.prototype.updataOrth=function(){var t=800;var e=new Float32Array(16);var i=t*.5;var a=i*this._aspectRatio;var r,s,n,o;if(this._scissorRect.x==0&&this._scissorRect.y==0&&this._scissorRect.width==this._viewPort.width&&this._scissorRect.height==this._viewPort.height){r=-a;s=a;n=-i;o=i;e[0]=2/(t*this._aspectRatio);e[5]=2/t;e[10]=1/(this._far-this._near);e[14]=this._near/(this._near-this._far);e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=0;e[15]=1}else{var h=a*(this._viewPort.width/this._scissorRect.width);var u=i*(this._viewPort.height/this._scissorRect.height);var l=a*(this._scissorRect.x*2-this._viewPort.width)/this._scissorRect.width+a;var f=-i*(this._scissorRect.y*2-this._viewPort.height)/this._scissorRect.height-i;r=l-h;s=l+h;n=f-u;o=f+u;e[0]=2*1/(s-r);e[5]=-2*1/(n-o);e[10]=1/(this._far-this._near);e[12]=(s+r)/(s-r);e[13]=(o+n)/(o-n);e[14]=this._near/(this.near-this.far);e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=0;e[15]=1}this.projectMatrix.copyRawDataFrom(e)};r.prototype.isVisibleToCamera=function(t){if(this.frustum.inBox(t.box)){return true}return false};return r}(t.Entity);t.Camera3D=a})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._lightType=-1;this._ambient=new t.Vector3D(1,1,1);this._diffuse=new t.Vector3D(1,1,1);this._halfColor=new t.Vector3D(1,1,1);this._specular=new t.Vector3D(1,1,1);this._halfVector=new t.Vector3D(1,1,1);this._intensity=1;this._halfIntensity=.5;this._spotExponent=1.1;this._spotCutoff=.7;this._spotCosCutoff=.1;this._constantAttenuation=.1;this._linearAttenuation=.1;this._quadraticAttenuation=.1;this._lightIndex=-1;this.len=25;this._change=true}Object.defineProperty(i.prototype,"intensity",{get:function(){return this._intensity},set:function(t){if(this._intensity!=t){this._intensity=t;this._change=false}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"halfIntensity",{get:function(){return this._halfIntensity},set:function(t){if(this._halfIntensity!=t){this._halfIntensity=t;this._change=false}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"ambient",{get:function(){return 0},set:function(t){this._ambient.w=(t>>24&255)/255;this._ambient.x=(t>>16&255)/255;this._ambient.y=(t>>8&255)/255;this._ambient.z=(t&255)/255;this._change=false},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"diffuse",{get:function(){return 0},set:function(t){this._diffuse.w=(t>>24&255)/255;this._diffuse.x=(t>>16&255)/255;this._diffuse.y=(t>>8&255)/255;this._diffuse.z=(t&255)/255;this._change=false},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"specular",{get:function(){return 0},set:function(t){this._specular.w=(t>>24&255)/255;this._specular.x=(t>>16&255)/255;this._specular.y=(t>>8&255)/255;this._specular.z=(t&255)/255;this._change=false},enumerable:true,configurable:true});i.prototype.init=function(){};i.prototype.updateLightData=function(t,e){};return i}(t.Object3D);t.LightBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e){t.call(this);e.normalize();this._lightType=0;this._rot.x=e.x;this._rot.y=e.y;this._rot.z=e.z}Object.defineProperty(e.prototype,"halfColor",{set:function(t){this._halfColor.w=(t>>24&255)/255;this._halfColor.x=(t>>16&255)/255;this._halfColor.y=(t>>8&255)/255;this._halfColor.z=(t&255)/255;this._change=false},enumerable:true,configurable:true});e.prototype.updateLightData=function(t,i){i[t*e.stride+0]=this._rot.x;i[t*e.stride+1]=this._rot.y;i[t*e.stride+2]=this._rot.z;i[t*e.stride+3]=this._diffuse.x;i[t*e.stride+4]=this._diffuse.y;i[t*e.stride+5]=this._diffuse.z;i[t*e.stride+6]=this._halfColor.x;i[t*e.stride+7]=this._halfColor.y;i[t*e.stride+8]=this._halfColor.z;i[t*e.stride+9]=this._intensity;i[t*e.stride+10]=this._halfIntensity};e.stride=11;return e}(t.LightBase);t.DirectLight=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e){t.call(this);this._lightType=1;this.diffuse=e}e.prototype.updateLightData=function(t,i){i[t*e.stride]=this.x;i[t*e.stride+1]=this.y;i[t*e.stride+2]=this.z;i[t*e.stride+3]=this._diffuse.x;i[t*e.stride+4]=this._diffuse.y;i[t*e.stride+5]=this._diffuse.z;i[t*e.stride+6]=this._intensity};e.stride=7;return e}(t.LightBase);t.PointLight=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e){t.call(this);this._diffuse=e;this._lightType=2}Object.defineProperty(e.prototype,"spotCosCutoff",{get:function(){return this._spotCosCutoff},set:function(t){this._spotCosCutoff=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"spotExponent",{get:function(){return this._spotExponent},set:function(t){this._spotExponent=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"constantAttenuation",{get:function(){return this._constantAttenuation},set:function(t){this._constantAttenuation=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"linearAttenuation",{get:function(){return this._linearAttenuation},set:function(t){this._linearAttenuation=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"quadraticAttenuation",{get:function(){return this._quadraticAttenuation},set:function(t){this._quadraticAttenuation=t},enumerable:true,configurable:true});e.prototype.updateLightData=function(t,i){i[t*e.stride]=this.x;i[t*e.stride+1]=this.y;i[t*e.stride+2]=this.z;i[t*e.stride+3]=this._rot.x;i[t*e.stride+4]=this._rot.y;i[t*e.stride+5]=this._rot.z;i[t*e.stride+6]=this._diffuse.x;i[t*e.stride+7]=this._diffuse.y;i[t*e.stride+8]=this._diffuse.z;i[t*e.stride+9]=this._spotExponent;i[t*e.stride+10]=this._spotCosCutoff;i[t*e.stride+11]=this._constantAttenuation;i[t*e.stride+12]=this._linearAttenuation;i[t*e.stride+13]=this._quadraticAttenuation};e.stride=14;return e}(t.LightBase);t.SpotLight=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.lightNum=0;this.directLightList=new Array;this.spotLightList=new Array;this.pointLightList=new Array}t.prototype.addDirectLight=function(t){this.directLightList.push(t);this.lightNum++};t.prototype.addSpotLight=function(t){this.spotLightList.push(t);this.lightNum++};t.prototype.addPointLight=function(t){this.pointLightList.push(t);this.lightNum++};return t}();t.LightGroup=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this._renderIndex=0;this._numEntity=0}t.prototype.draw=function(t,e,i,a,r,s){};return t}();t.RenderBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this)}e.prototype.draw=function(t,e,i,a,r,s){this._renderList=a.renderList;this._numEntity=this._renderList.length;for(this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++){this._renderList[this._renderIndex].update(r,t,e);if(!this._renderList[this._renderIndex].isVisible){continue}if(this._renderList[this._renderIndex].tag&&this._renderList[this._renderIndex].tag.clearDepth&&this._renderList[this._renderIndex].tag.cleanState){this._renderList[this._renderIndex].tag.cleanState=false;i.clearDepth(1)}if(this._renderList[this._renderIndex].material!=null){if(this._renderList[this._renderIndex].material.alpha!=0){this._renderList[this._renderIndex].material.rendenDiffusePass(i,r,this._renderList[this._renderIndex].modelMatrix,this._renderList[this._renderIndex].geometry,this._renderList[this._renderIndex].animation)}}}};return e}(t.RenderBase);t.DefaultRender=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this)}e.prototype.update=function(t,e,i,a,r,s){this._renderList=a.renderList;this._numEntity=this._renderList.length;for(this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++){this._renderList[this._renderIndex].update(r,t,e);if(!this._renderList[this._renderIndex].isVisible){continue}if(this._renderList[this._renderIndex].material!=null){}}};return e}(t.RenderBase);t.PositionRender=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this)}e.prototype.draw=function(t,e,i,a,r,s){this._renderList=a.renderList;this._numEntity=this._renderList.length;for(this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++){this._renderList[this._renderIndex].update(r,t,e);if(!this._renderList[this._renderIndex].isVisible){continue}if(this._renderList[this._renderIndex].material!=null){this._renderList[this._renderIndex].material.rendenNormalPass(i,r,this._renderList[this._renderIndex].modelMatrix,this._renderList[this._renderIndex].geometry,this._renderList[this._renderIndex].animation)}}};return e}(t.RenderBase);t.NormalRender=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this)}e.prototype.draw=function(t,e,i,a,r,s){this._renderList=a.renderList;this._numEntity=this._renderList.length;for(this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++){this._renderList[this._renderIndex].update(r,t,e);if(!this._renderList[this._renderIndex].isVisible){continue}if(this._renderList[this._renderIndex].material!=null){this._renderList[this._renderIndex].material.rendenDepthPass(i,r,this._renderList[this._renderIndex].modelMatrix,this._renderList[this._renderIndex].geometry,this._renderList[this._renderIndex].animation)}}};return e}(t.RenderBase);t.DepthRender=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.shadowTexture_width=1024;this.shadowTexture_height=1024;this.cameraTarget=new t.Vector3D;this.cameraPos=new t.Vector3D;this.distance=0;i.shadowCamera3D=new t.Camera3D(t.CameraType.orthogonal);i.frameBuffer=t.RttManager.creatFrameBuffer(t.FrameBufferType.shadowFrameBufrfer,t.Egret3DDrive.context3D,this.shadowTexture_width,this.shadowTexture_height,t.FrameBufferFormat.UNSIGNED_BYTE_RGBA)}i.prototype.draw=function(e,a,r,s,n,o){if(i.castShadowLight){this.offsetPos(new t.Vector3D);this._renderList=s.renderList;this._numEntity=this._renderList.length;for(this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++){if(this._renderList[this._renderIndex].material.castShadow){this._renderList[this._renderIndex].update(n,e,a);if(!this._renderList[this._renderIndex].isVisible){continue}this._renderList[this._renderIndex].material.rendenShadowPass(r,i.shadowCamera3D,this._renderList[this._renderIndex].modelMatrix,this._renderList[this._renderIndex].geometry,this._renderList[this._renderIndex].animation)}}}};i.prototype.offsetPos=function(t){this.cameraPos.x=i.castShadowLight.rotationX;this.cameraPos.y=i.castShadowLight.rotationY;this.cameraPos.z=i.castShadowLight.rotationZ;this.cameraPos.normalize();this.cameraPos.scaleBy(1*500);this.cameraPos.x=this.cameraPos.x+t.x;this.cameraPos.y=this.cameraPos.y+t.y;this.cameraPos.z=this.cameraPos.z+t.z;i.shadowCamera3D.lookAt(this.cameraPos,t)};return i}(t.RenderBase);t.ShadowRender=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["defaultRender"]=0]="defaultRender";t[t["positionRender"]=1]="positionRender";t[t["normalRender"]=2]="normalRender";t[t["specularRender"]=3]="specularRender";t[t["shadowRender"]=4]="shadowRender"})(t.RenderType||(t.RenderType={}));var e=t.RenderType;var i=function(){function i(){}i.getRender=function(t){if(this.renders[t])return this.renders[t];return this.creatSystemRender(t)};i.creatSystemRender=function(i){var a;switch(i){case e.defaultRender:a=new t.DefaultRender;break;case e.positionRender:a=new t.PositionRender;break;case e.normalRender:a=new t.NormalRender;break;case e.specularRender:break;case e.shadowRender:a=new t.ShadowRender;break}this.renders[i]=a;return a};i.renders=new Object;return i}();t.RenderManager=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t){this._num=0;this._objDict={};this.renderList=new Array;this.mousePickList=new Array;this._nodes=new Array;this._rootNode=t}t.prototype.update=function(t){this.renderList=this._nodes;this.renderList.length=0;t.frustum.update(t)};t.prototype.findRenderObject=function(t){for(var e=0;e<this.renderList.length;++e){if(this.renderList[e]===t){return e}}return-1};return t}();t.CollectBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.objects=new Array;this.alphaObjects=new Array}return t}();t.Layer=e;var i=function(){function t(){this.layers=new Array;this.clearDepth=false;this.cleanState=true}return t}();t.Tag=i;var a=function(a){__extends(r,a);function r(t){a.call(this,t);this._tags=new Array;this._layers=new Array;this._tagsName=new Array;this.addTag("default");this.addTag("terrain");this.addTag("terrain_texture");this.addTag("shadow");this.addTag("character");this.addTag("modle_effect");this.addTag("particle");this.addTag("transparent");this.addTag("wireframe",true);var e={typeName:"",cleanDepth:false};this.addLayer("layer_0");this.addLayer("layer_1");this.addLayer("layer_2");this.addLayer("layer_3");this.addLayer("layer_4")}Object.defineProperty(r.prototype,"tags",{get:function(){return this._tags},enumerable:true,configurable:true});r.prototype.setTags=function(t,e){var i=this._tagsName.indexOf(t);if(i!=-1){var a=this._tags[i];this.removeTag(t);this._tagsName.splice(e,0,t);this._tags.splice(e,0,a)}else{this.insertTag(t,e)}};r.prototype.setTagsItem=function(t,e){this.removeLayer(t);this.insetLayer(t,e)};r.prototype.getTagLayer=function(t,e){if(t===void 0){t="default"}if(e===void 0){e="layer_0"}var i=this._tagsName.indexOf(t);var a=this._layers.indexOf(e);return i<<24|a};r.prototype.getTag=function(t){if(t===void 0){t="default"}var e=this._tagsName.indexOf(t);if(e!=-1){return this.tags[e]}return null};r.prototype.addTag=function(t,a){if(a===void 0){a=false}if(this._tagsName.indexOf(t)!=-1){return}this._tagsName.push(t);var r=new i;r.clearDepth=a;this._tags.push(r);for(var s=0;s<this._layers.length;++s){var n=new e;r.layers.push(n)}};r.prototype.insertTag=function(t,a){if(this._tagsName.indexOf(t)!=-1){return}this._tagsName.splice(a,0,t);var r=new i;this._tags.splice(a,0,r);for(var s=0;s<this._layers.length;++s){var n=new e;r.layers.push(n)}};r.prototype.removeTag=function(t){var e=this._tagsName.indexOf(t);if(e==-1){return}this._tagsName.splice(e,1);this._tags.splice(e,1)};r.prototype.addLayer=function(t){if(this._layers.indexOf(t)!=-1){return}this._layers.push(t);for(var i=0;i<this._tags.length;++i){var a=new e;this._tags[i].layers.push(a)}};r.prototype.insetLayer=function(t,i){if(this._layers.indexOf(t)!=-1){return}this._layers.splice(i,0,t);for(var a=0;a<this._tags.length;++a){var r=new e;this._tags[a].layers.splice(i,0,r)}};r.prototype.removeLayer=function(t){var e=this._layers.indexOf(t);if(e==-1){return}this._layers.splice(e,1);for(var i=0;i<this._tags.length;++i){this._tags[i].layers.splice(e,1)}};r.prototype.applyRender=function(t,e){this.addRenderList(t,e);for(var i=0;i<t.childs.length;i++){this.applyRender(t.childs[i],e)}};r.prototype.addRenderList=function(t,e){if(!t.material)return;if(t.enableCut){if(!e.isVisibleToCamera(t)){return}}if(t.mouseEnable){this.mousePickList.push(t)}var i=this.findLayer(t);var a=this.findTag(t);if(t.material!=null&&t.material.materialData.alphaBlending){i.alphaObjects.push(t)}else{i.objects.push(t)}};r.prototype.update=function(t){var e=this;a.prototype.update.call(this,t);this.renderList.length=0;this.mousePickList.length=0;this.clearLayerList();this.applyRender(this._rootNode,t);for(var i=0;i<this._tags.length;++i){this._tags[i].clearDepth=true;for(var r=0;r<this._tags[i].layers.length;++r){for(var s=0;s<this._tags[i].layers[r].objects.length;++s){this.renderList.push(this._tags[i].layers[r].objects[s])}this._tags[i].layers[r].alphaObjects.sort(function(i,a){return e.sort(i,a,t)});for(var s=0;s<this._tags[i].layers[r].alphaObjects.length;++s){this.renderList.push(this._tags[i].layers[r].alphaObjects[s])}}}};r.prototype.findLayer=function(t){var e=t.layer>>24;var i=t.layer&16777215;if(e<this._tags.length&&e>=0){if(i<this._tags[e].layers.length&&i>=0){return this._tags[e].layers[i]}}return this._tags[0].layers[0]};r.prototype.findTag=function(t){var e=t.layer>>24;if(e<this._tags.length&&e>=0){return this._tags[e]}return this._tags[0]};r.prototype.clearLayerList=function(){for(var t=0;t<this._tags.length;++t){for(var e=0;e<this._tags[t].layers.length;++e){this._tags[t].layers[e].objects.length=0;this._tags[t].layers[e].alphaObjects.length=0}}};r.prototype.sort=function(e,i,a){var r=t.Vector3D.distance(e.globalPosition,a.position);var s=t.Vector3D.distance(i.globalPosition,a.position);if(r>s){return-1}else if(r<s){return 1}return 0};return r}(t.CollectBase);t.EntityCollect=a})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.collect=new t.EntityCollect(this)}return i}(t.Object3D);t.Scene3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["shadowFrameBufrfer"]=0]="shadowFrameBufrfer";t[t["defaultFrameBuffer"]=1]="defaultFrameBuffer";t[t["positionFrameBuffer"]=2]="positionFrameBuffer";t[t["normalFrameBuffer"]=3]="normalFrameBuffer";t[t["specularFrameBuffer"]=4]="specularFrameBuffer";t[t["leftEyeFrameBuffer"]=5]="leftEyeFrameBuffer";t[t["rightEyeFrameBuffer"]=6]="rightEyeFrameBuffer";t[t["nextFrameBuffer"]=7]="nextFrameBuffer"})(t.FrameBufferType||(t.FrameBufferType={}));var e=t.FrameBufferType;(function(t){t[t["FLOAT_RGB"]=0]="FLOAT_RGB";t[t["FLOAT_RGBA"]=1]="FLOAT_RGBA";t[t["UNSIGNED_BYTE_RGB"]=2]="UNSIGNED_BYTE_RGB";t[t["UNSIGNED_BYTE_RGBA"]=3]="UNSIGNED_BYTE_RGBA"})(t.FrameBufferFormat||(t.FrameBufferFormat={}));var i=t.FrameBufferFormat;var a=function(){function e(){this.shadowFrameBufrfer=new t.FrameBuffer;this.defaultFrameBuffer=new t.FrameBuffer;this.positionFrameBuffer=new t.FrameBuffer;this.normalFrameBuffer=new t.FrameBuffer;this.specularFrameBuffer=new t.FrameBuffer;this.leftEyeFrameBuffer=new t.FrameBuffer;this.rightFrameBuffer=new t.FrameBuffer;this.nextFrameBuffer=new t.FrameBuffer;if(e.instance)new Error("can't new RttManager instance!")}e.creatFrameBuffer=function(i,a,r,s,n){var o=new t.FrameBuffer;o.frameBufferName=i;o.width=r;o.height=s;o.texture=new t.RenderTexture(a.createFramebuffer(r,s,n));e.instance[i]=o;return e.instance[i]};e.prototype.drawFrameBuffersToTexture=function(t,e,i,a,r,s){};e.drawToTexture=function(t,e,i,a,r,s,n,o){a.viewPort(o.x,o.y,o.width,o.height);a.setRenderToTexture(i,true,0);r.draw(t,e,a,s,n,o);a.setRenderToBackBuffer()};e.drawToTextureStart=function(t,e,i){e.viewPort(i.x,i.y,i.width,i.height);e.setRenderToTexture(t,true,0)};e.drawToTextureEnd=function(t){t.setRenderToBackBuffer()};e.instance=new e;return e}();t.RttManager=a})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.vertexAttLength=17;this.source_indexData=new Array;this.source_vertexData=new Array;this.source_vertexColorData=new Array;this.source_normalData=new Array;this.source_tangtData=new Array;this.source_uvData=new Array;this.source_uv2Data=new Array;this.source_faceData=new Array;this.source_skinData=new Array;this.vertexIndex=0;this.indices=new Array;this.vertices=new Array;this.normals=new Array;this.tangts=new Array;this.verticesColor=new Array;this.uvs=new Array;this.uv2s=new Array;this.skinMesh=new Array;this.faceNormals=new Array;this.faceWeights=new Array}e.build=function(i){if(null==i.source_faceData||i.source_faceData.length<=0||null==i.source_vertexData||i.source_vertexData.length<=0)return null;var a=new e;a.indices=[];a.vertexDatas=[];a.vertexAttLength=i.vertexAttLength;var r=null;var s=null;var n=new t.Vector3D(1,1,1);var o=new t.Vector3D(1,1,1,1);var h=new t.UV(1,0);var u=new t.UV(1,0);for(var l=0;l<i.source_faceData.length;l++){r=i.source_faceData[l];a.indices.push(l*3+0,l*3+2,l*3+1);for(var f=0;f<3;f++){s=i.source_vertexData[r.vertexIndices[f]-1];if(r.normalIndices&&i.source_normalData&&i.source_normalData.length>0)n=i.source_normalData[r.normalIndices[f]-1];if(r.colorIndices&&i.source_vertexColorData&&i.source_vertexColorData.length>0)o=i.source_vertexColorData[r.colorIndices[f]-1];if(r.uvIndices&&i.source_uvData&&i.source_uvData.length>0)h=i.source_uvData[r.uvIndices[f]-1];if(r.uv2Indices&&i.source_uv2Data&&i.source_uv2Data.length>0)u=i.source_uv2Data[r.uv2Indices[f]-1];a.vertexDatas.push(s.x,s.y,s.z,n.x,n.y,n.z,0,0,0,o.r,o.g,o.b,o.a,h.u,h.v,u.u,u.v);if(i.source_skinData!=null&&i.source_skinData.length>0){a.vertexDatas.push(i.source_skinData[(r.vertexIndices[f]-1)*8+0],i.source_skinData[(r.vertexIndices[f]-1)*8+2],i.source_skinData[(r.vertexIndices[f]-1)*8+4],i.source_skinData[(r.vertexIndices[f]-1)*8+6],i.source_skinData[(r.vertexIndices[f]-1)*8+1],i.source_skinData[(r.vertexIndices[f]-1)*8+3],i.source_skinData[(r.vertexIndices[f]-1)*8+5],i.source_skinData[(r.vertexIndices[f]-1)*8+7])}}}e.buildFaceTangents(a);return a};e.translateMaterialGroup=function(t){var i=t.source_faceData;var a;var r=i.length;var s;var n=new e;n.vertexAttLength=t.vertexAttLength;var o;for(var h=0;h<r;++h){a=i[h];s=a.indexIds.length-1;for(o=1;o<s;++o){this.translateVertexData(a,o,t,n);this.translateVertexData(a,0,t,n);this.translateVertexData(a,o+1,t,n)}}if(n.vertices.length>0){
n.vertLen=n.vertices.length/3*t.vertexAttLength;n.vertexDatas=new Array(n.vertLen);this.updateFaceTangents(n);this.combinGeomtryData(n)}return n};e.translateVertexData=function(t,e,i,a){var r;var s;var n;var o;var h;if(!a.indices[t.indexIds[e]]){r=a.vertexIndex;a.indices[t.indexIds[e]]=++a.vertexIndex;s=i.source_vertexData[t.vertexIndices[e]-1];a.vertices.push(s.x,s.y,s.z);if(i.source_vertexColorData!=null&&i.source_vertexColorData.length>0){n=i.source_vertexColorData[t.vertexIndices[e]-1];a.verticesColor.push(n.r,n.g,n.b,n.a)}if(i.source_skinData!=null&&i.source_skinData.length>0){a.skinMesh.push(i.source_skinData[(t.vertexIndices[e]-1)*8+0],i.source_skinData[(t.vertexIndices[e]-1)*8+2],i.source_skinData[(t.vertexIndices[e]-1)*8+4],i.source_skinData[(t.vertexIndices[e]-1)*8+6],i.source_skinData[(t.vertexIndices[e]-1)*8+1],i.source_skinData[(t.vertexIndices[e]-1)*8+3],i.source_skinData[(t.vertexIndices[e]-1)*8+5],i.source_skinData[(t.vertexIndices[e]-1)*8+7])}if(t.normalIndices.length>0){o=i.source_normalData[t.normalIndices[e]-1];a.normals.push(o.x,o.y,o.z)}if(t.uvIndices.length>0){try{h=i.source_uvData[t.uvIndices[e]-1];a.uvs.push(h.u,h.v);if(i.source_uv2Data.length>0){h=i.source_uv2Data[t.uv2Indices[e]-1];a.uv2s.push(h.u,h.v)}}catch(u){switch(e){case 0:a.uvs.push(0,1);break;case 1:a.uvs.push(.5,0);break;case 2:a.uvs.push(1,1)}}}}else r=a.indices[t.indexIds[e]]-1;a.indices.push(r)};e.combinGeomtryData=function(t,e){if(e===void 0){e=true}var i=0;var a=0;var r=0;var s=0;var n=0;var o=0;var h=0;var u=0;var l=t.vertexDatas;while(i<t.vertLen){l[i++]=t.vertices[a++];l[i++]=t.vertices[a++];l[i++]=t.vertices[a++];if(t.normals&&t.normals.length){l[i++]=t.normals[r++];l[i++]=t.normals[r++];l[i++]=t.normals[r++]}else{l[i++]=0;l[i++]=0;l[i++]=0}if(t.tangts){i++;i++;i++}else{l[i++]=0;l[i++]=0;l[i++]=0}if(t.source_vertexColorData&&t.source_vertexColorData.length){l[i++]=t.verticesColor[h++];l[i++]=t.verticesColor[h++];l[i++]=t.verticesColor[h++];l[i++]=t.verticesColor[h++]}else{l[i++]=1;l[i++]=1;l[i++]=1;l[i++]=1}if(t.uvs&&t.uvs.length){l[i++]=t.uvs[n++];l[i++]=t.uvs[n++];if(t.uv2s&&t.uv2s.length){l[i++]=t.uv2s[o++];l[i++]=t.uv2s[o++]}else{l[i++]=t.uvs[o++];l[i++]=t.uvs[o++]}}else{l[i++]=0;l[i++]=0;l[i++]=0;l[i++]=0}if(t.skinMesh&&t.skinMesh.length){l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++]}}};e.updateFaceNormals=function(t){var e=0,i=0,a=0;var r;var s=t.indices.length;var n,o,h;var u,l,f;var c,d,p;var g,m,_;var v,D,y;var x,w,b;var T;var A=t.vertexDatas;var E=17;var L=3;while(e<s){r=L+t.indices[e++]*E;n=A[r];u=A[r+1];c=A[r+2];r=L+t.indices[e++]*E;o=A[r];l=A[r+1];d=A[r+2];r=L+t.indices[e++]*E;h=A[r];f=A[r+1];p=A[r+2];g=h-n;m=f-u;_=p-c;v=o-n;D=l-u;y=d-c;x=_*D-m*y;w=g*y-_*v;b=m*v-g*D;T=Math.sqrt(x*x+w*w+b*b);if(true){var S=T*1e4;if(S<1)S=1;t.faceWeights[a++]=S}T=1/T;t.faceNormals[i++]=x*T;t.faceNormals[i++]=w*T;t.faceNormals[i++]=b*T}};e.updateVertexNormals=function(t){this.updateFaceNormals(t);var e;var i=0,a=1,r=2;var s=t.vertexDatas.length;var n=17;var o=3;var h=0,u=0;var l=t.indices.length;var f;var c;while(h<l){c=t.faceWeights[u++];f=o+t.indices[h++]*n;t.vertexDatas[f]+=t.faceNormals[i]*c;t.vertexDatas[f++]+=t.faceNormals[a]*c;t.vertexDatas[f++]+=t.faceNormals[r]*c;f=o+t.indices[h++]*n;t.vertexDatas[f]+=t.faceNormals[i]*c;t.vertexDatas[f++]+=t.faceNormals[a]*c;t.vertexDatas[f++]+=t.faceNormals[r]*c;f=o+t.indices[h++]*n;t.vertexDatas[f]+=t.faceNormals[i]*c;t.vertexDatas[f++]+=t.faceNormals[a]*c;t.vertexDatas[f++]+=t.faceNormals[r]*c;i+=3;a+=3;r+=3}};e.buildFaceTangents=function(t){var i=0;for(var a=0;a<t.indices.length;a++){t.vertices.push(t.vertexDatas[a*t.vertexAttLength],t.vertexDatas[a*t.vertexAttLength+1],t.vertexDatas[a*t.vertexAttLength+2]);t.uvs.push(t.vertexDatas[a*t.vertexAttLength+13],t.vertexDatas[a*t.vertexAttLength+14])}e.updateFaceTangents(t)};e.updateFaceTangents=function(t){var e=0;var i,a,r;var s=t.indices.length;var n,o;var h;var u,l;var f;var c,d,p;var g,m,_;var v,D,y;var x,w,b;var T=t.vertices;var A=t.uvs;var E=3;var L=0;var S=2;var M=0;while(e<s){i=t.indices[e];a=t.indices[e+1];r=t.indices[e+2];n=i*2;h=A[n+1];n=a*2;u=A[n+1]-h;n=r*2;l=A[n+1]-h;o=i*3;c=T[o];d=T[o+1];p=T[o+2];o=a*3;g=T[o]-c;m=T[o+1]-d;_=T[o+2]-p;o=r*3;v=T[o]-c;D=T[o+1]-d;y=T[o+2]-p;x=l*g-u*v;w=l*m-u*D;b=l*_-u*y;f=1/Math.sqrt(x*x+w*w+b*b);t.tangts[e++]=f*x;t.tangts[e++]=f*w;t.tangts[e++]=f*b}var e;var P=t.vertexDatas.length;var R=t.vertexAttLength;var C=6;var F=t.vertexDatas;e=C;while(e<P){F[e]=0;F[e+1]=0;F[e+2]=0;e+=R}var I;var U=s;var O;var B;var k=0,N=1,V=2;e=0;while(e<U){B=1;O=C+t.indices[e++]*R;F[O++]+=-t.tangts[k]*B;F[O++]+=t.tangts[N]*B;F[O]+=t.tangts[V]*B;O=C+t.indices[e++]*R;F[O++]+=-t.tangts[k]*B;F[O++]+=t.tangts[N]*B;F[O]+=t.tangts[V]*B;O=C+t.indices[e++]*R;F[O++]+=-t.tangts[k]*B;F[O++]+=t.tangts[N]*B;F[O]+=t.tangts[V]*B;k+=3;N+=3;V+=3}e=C;while(e<P){var G=F[e];var z=F[e+1];var j=F[e+2];var K=1/Math.sqrt(G*G+z*z+j*j);F[e]=G*K;F[e+1]=z*K;F[e+2]=j*K;e+=R}};return e}();t.GeometryData=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["Static"]=0]="Static";t[t["Skin"]=1]="Skin";t[t["Particle"]=2]="Particle";t[t["Billbord"]=3]="Billbord";t[t["VertexAnim"]=4]="VertexAnim";t[t["Grass"]=5]="Grass";t[t["Ribbon"]=6]="Ribbon";t[t["wrieFrame"]=7]="wrieFrame";t[t["Shadow"]=8]="Shadow"})(t.GeometryType||(t.GeometryType={}));var e=t.GeometryType;var i=function(){function e(){this.geomtryType=0;this.vertexAttLength=17;this.positionSize=3;this.normalSize=3;this.tangentSize=3;this.colorSize=4;this.uvSize=2;this.uv2Size=2;this.numItems=0;this.minPos=new t.Vector3D;this.maxPos=new t.Vector3D;this.textureFile="";this.textureSpecular="";this.textureBump=""}e.prototype.buildGeomtry=function(){};e.prototype.updata=function(t,e){};e.prototype.buildBoundBox=function(){this.minPos.copyFrom(new t.Vector3D(99999,99999,99999));this.maxPos.copyFrom(new t.Vector3D(-99999,-99999,-99999));for(var e=0;e<this.verticesData.length;e+=this.vertexAttLength){if(this.maxPos.x<this.verticesData[e]){this.maxPos.x=this.verticesData[e]}if(this.maxPos.y<this.verticesData[e+1]){this.maxPos.y=this.verticesData[e+1]}if(this.maxPos.z<this.verticesData[e+2]){this.maxPos.z=this.verticesData[e+2]}if(this.minPos.x>this.verticesData[e]){this.minPos.x=this.verticesData[e]}if(this.minPos.y>this.verticesData[e+1]){this.minPos.y=this.verticesData[e+1]}if(this.minPos.z>this.verticesData[e+2]){this.minPos.z=this.verticesData[e+2]}}};e.prototype.rotationGeomtry=function(e){this.rotationQ=new t.Quaternion;this.rotationQ.fromEulerAngles(e.x*t.Matrix3DUtils.RADIANS_TO_DEGREES,e.y*t.Matrix3DUtils.RADIANS_TO_DEGREES,e.z*t.Matrix3DUtils.RADIANS_TO_DEGREES);var i=new t.Vector3D;for(var a=0;a<this.verticesData.length/this.vertexAttLength;a++){i.x=this.verticesData[this.vertexAttLength*a+0];i.y=this.verticesData[this.vertexAttLength*a+1];i.z=this.verticesData[this.vertexAttLength*a+2];this.rotationQ.rotatePoint(i,i);this.verticesData[this.vertexAttLength*a+0]=i.x;this.verticesData[this.vertexAttLength*a+1]=i.y;this.verticesData[this.vertexAttLength*a+2]=i.z}};e.prototype.dispose=function(){};return e}();t.GeometryBase=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this)}e.prototype.setGeomtryData=function(t,e){this.indexData=t;this.verticesData=e;this.numItems=t.length};return e}(t.GeometryBase);t.SubGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i,a){if(t===void 0){t=80}if(i===void 0){i=80}if(a===void 0){a=80}e.call(this);this.width=80;this.height=80;this.depth=80;this.width=t;this.height=i;this.depth=a;this.buildGeomtry()}i.prototype.buildGeomtry=function(){var t=new Array;t.push(-this.width*.5,-this.height*.5,-this.depth*.5,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,-this.width*.5,this.height*.5,-this.depth*.5,0,0,-10,1,0,0,1,1,1,1,1,1,0,0,this.width*.5,this.height*.5,-this.depth*.5,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,this.width*.5,this.height*.5,-this.depth*.5,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,this.width*.5,-this.height*.5,-this.depth*.5,0,0,-10,1,0,0,1,1,1,1,0,0,0,0,-this.width*.5,-this.height*.5,-this.depth*.5,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,-this.width*.5,-this.height*.5,this.depth*.5,0,0,10,1,0,0,1,1,1,1,0,0,0,0,this.width*.5,-this.height*.5,this.depth*.5,0,0,10,1,0,0,1,1,1,1,1,0,0,0,this.width*.5,this.height*.5,this.depth*.5,0,0,10,1,0,0,1,1,1,1,1,1,0,0,this.width*.5,this.height*.5,this.depth*.5,0,0,10,1,0,0,1,1,1,1,1,1,0,0,-this.width*.5,this.height*.5,this.depth*.5,0,0,10,1,0,0,1,1,1,1,0,1,0,0,-this.width*.5,-this.height*.5,this.depth*.5,0,0,10,1,0,0,1,1,1,1,0,0,0,0,-this.width*.5,-this.height*.5,-this.depth*.5,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,this.width*.5,-this.height*.5,-this.depth*.5,0,-10,0,1,0,0,1,1,1,1,1,0,0,0,this.width*.5,-this.height*.5,this.depth*.5,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,this.width*.5,-this.height*.5,this.depth*.5,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,-this.width*.5,-this.height*.5,this.depth*.5,0,-10,0,1,0,0,1,1,1,1,0,1,0,0,-this.width*.5,-this.height*.5,-this.depth*.5,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,this.width*.5,-this.height*.5,-this.depth*.5,10,0,0,1,0,0,1,1,1,1,0,0,0,0,this.width*.5,this.height*.5,-this.depth*.5,10,0,0,1,0,0,1,1,1,1,1,0,0,0,this.width*.5,this.height*.5,this.depth*.5,10,0,0,1,0,0,1,1,1,1,1,1,0,0,this.width*.5,this.height*.5,this.depth*.5,10,0,0,1,0,0,1,1,1,1,1,1,0,0,this.width*.5,-this.height*.5,this.depth*.5,10,0,0,1,0,0,1,1,1,1,0,1,0,0,this.width*.5,-this.height*.5,-this.depth*.5,10,0,0,1,0,0,1,1,1,1,0,0,0,0,this.width*.5,this.height*.5,-this.depth*.5,0,10,0,1,0,0,1,1,1,1,0,0,0,0,-this.width*.5,this.height*.5,-this.depth*.5,0,10,0,1,0,0,1,1,1,1,1,0,0,0,-this.width*.5,this.height*.5,this.depth*.5,0,10,0,1,0,0,1,1,1,1,1,1,0,0,-this.width*.5,this.height*.5,this.depth*.5,0,10,0,1,0,0,1,1,1,1,1,1,0,0,this.width*.5,this.height*.5,this.depth*.5,0,10,0,1,0,0,1,1,1,1,0,1,0,0,this.width*.5,this.height*.5,-this.depth*.5,0,10,0,1,0,0,1,1,1,1,0,0,0,0,-this.width*.5,this.height*.5,-this.depth*.5,-10,0,0,1,0,0,1,1,1,1,0,0,0,0,-this.width*.5,-this.height*.5,-this.depth*.5,-10,0,0,1,0,0,1,1,1,1,1,0,0,0,-this.width*.5,-this.height*.5,this.depth*.5,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,-this.width*.5,-this.height*.5,this.depth*.5,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,-this.width*.5,this.height*.5,this.depth*.5,-10,0,0,1,0,0,1,1,1,1,0,1,0,0,-this.width*.5,this.height*.5,-this.depth*.5,-10,0,0,1,0,0,1,1,1,1,0,0,0,0);var e=new Array;e.push(0,2,1,3,5,4,6,8,7,9,11,10,12,14,13,15,17,16,18,20,19,21,23,22,24,26,25,27,29,28,30,32,31,33,35,34);this.setGeomtryData(e,t);this.buildBoundBox()};i.prototype.transfromVertex=function(e){if(this.sharedVertexBuffer){t.Egret3DDrive.context3D.gl.deleteBuffer(this.sharedVertexBuffer);this.sharedVertexBuffer=null}var i=17;var a=this.verticesData.length/i;for(var r=0;r<a;r++){this.verticesData[i*r+0]+=e.x;this.verticesData[i*r+1]+=e.y;this.verticesData[i*r+2]+=e.z}};return i}(t.SubGeometry);t.CubeGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e,i,a){if(e===void 0){e=100}if(i===void 0){i=15}if(a===void 0){a=15}t.call(this);this._segmentsW=50;this._segmentsH=50;this._radius=100;this._radius=e;this._segmentsW=i;this._segmentsH=a;this.buildSphere()}e.prototype.buildSphere=function(){var t;var e;var i=0,a=0,r=0;var s=(this._segmentsH+1)*(this._segmentsW+1);var n=this.vertexAttLength;var o=n-9;t=new Array(s*n);e=new Array((this._segmentsH-1)*this._segmentsW*6);var h=0;var u=0;var l=0,f=0,c=0,d=0;for(a=0;a<=this._segmentsH;++a){h=u;var p=Math.PI*a/this._segmentsH;var g=-this._radius*Math.cos(p);var m=this._radius*Math.sin(p);for(i=0;i<=this._segmentsW;++i){var _=2*Math.PI*i/this._segmentsW;var v=m*Math.cos(_);var D=m*Math.sin(_);var y=1/Math.sqrt(v*v+D*D+g*g);var x=Math.sqrt(D*D+v*v);c=0;d=x>.007?v/x:0;l=-g;f=D;if(i==this._segmentsW){t[u++]=t[h];t[u++]=t[h+1];t[u++]=t[h+2];t[u++]=v*y;t[u++]=l*y;t[u++]=f*y;t[u++]=x>.007?-D/x:1;t[u++]=c;t[u++]=d;t[u+0]=1;t[u+1]=1;t[u+2]=1;t[u+3]=1}else{t[u++]=v;t[u++]=l;t[u++]=f;t[u++]=v*y;t[u++]=l*y;t[u++]=f*y;t[u++]=x>.007?-D/x:1;t[u++]=c;t[u++]=d;t[u]=1;t[u+1]=1;t[u+2]=1;t[u+3]=1}if(i>0&&a>0){var w=(this._segmentsW+1)*a+i;var b=(this._segmentsW+1)*a+i-1;var T=(this._segmentsW+1)*(a-1)+i-1;var A=(this._segmentsW+1)*(a-1)+i;if(a==this._segmentsH){t[u-9]=t[h];t[u-8]=t[h+1];t[u-7]=t[h+2];e[r++]=w;e[r++]=A;e[r++]=T}else if(a==1){e[r++]=w;e[r++]=T;e[r++]=b}else{e[r++]=w;e[r++]=A;e[r++]=T;e[r++]=w;e[r++]=T;e[r++]=b}}u+=o}}var n=17;var E=(this._segmentsH+1)*(this._segmentsW+1)*n;var L;var o=n-2;var u=13;for(a=0;a<=this._segmentsH;++a){for(i=0;i<=this._segmentsW;++i){t[u++]=i/this._segmentsW;t[u++]=a/this._segmentsH;u+=o}}this.setGeomtryData(e,t)};return e}(t.SubGeometry);t.SphereGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i,a,r,s,n){if(t===void 0){t=500}if(i===void 0){i=500}if(a===void 0){a=1}if(r===void 0){r=1}if(s===void 0){s=1}if(n===void 0){n=1}e.call(this);this._segmentsW=1;this._segmentsH=1;this._width=500;this._height=500;this._scaleU=1;this._scaleV=1;this._width=t;this._height=i;this._segmentsW=a;this._segmentsH=r;this._scaleU=s;this._scaleV=n;this.buildGeometry()}i.prototype.buildGeometry=function(){var e;var i;var a,r;var s;var n;var o=this._segmentsW+1;var h=(this._segmentsH+1)*o;var u=this.vertexAttLength;var l=u-15;s=this._segmentsH*this._segmentsW*6;e=new Array(h*u);i=new Array(s);s=0;var f=new t.Vector3D;var c=0;for(var d=0;d<=this._segmentsH;++d){for(var p=0;p<=this._segmentsW;++p){a=(p/this._segmentsW-.5)*this._width;r=(d/this._segmentsH-.5)*this._height;e[c++]=a;e[c++]=0;e[c++]=r;e[c++]=0;e[c++]=1;e[c++]=0;e[c++]=1;e[c++]=0;e[c++]=0;e[c++]=1;e[c++]=1;e[c++]=1;e[c++]=1;e[c++]=p/this._segmentsW*this._scaleU;e[c++]=(1-d/this._segmentsH)*this._scaleV;c+=l;if(p!=this._segmentsW&&d!=this._segmentsH){n=p+d*o;var g=1;i[s++]=n*g;i[s++]=(n+o+1)*g;i[s++]=(n+o)*g;i[s++]=n*g;i[s++]=(n+1)*g;i[s++]=(n+o+1)*g}}}this.setGeomtryData(i,e);this.buildBoundBox()};return i}(t.SubGeometry);t.PlaneGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this);this.buildGeomtry()}e.prototype.buildGeomtry=function(){var t=new Array;var e=new Array;var i=10;var a=10;var r=60;var s=10;var n=2*Math.PI/i;var o=1/i;for(s=0;s<=i;s++){var h=a*Math.sin(s*n);var u=a*Math.cos(s*n);t.push(h,0+r/2,u,h,0,u,1,1,1,1,1,0,0,0,h,0-r/2,u,h,0,u,1,1,1,1,1,0,0,0)}t.push(0,0+r/2,0,0,1,0,1,1,1,1,1,0,0,0);for(s=0;s<=i;s++){var h=a*Math.sin(s*n);var u=a*Math.cos(s*n);t.push(h,0+r/2,u,0,1,0,1,1,1,1,1,0,0,0)}t.push(0,0-r/2,0,0,-1,0,1,1,1,1,1,0,0,0);for(s=i;s>=0;s--){var h=a*Math.sin(s*n);var u=a*Math.cos(s*n);t.push(h,0-r/2,u,0,-1,0,1,1,1,1,1,0,0,0)}this.setGeomtryData(e,t)};return e}(t.SubGeometry);t.CylinderGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.vertexIndices=new Array;this.uvIndices=new Array;this.uv2Indices=new Array;this.normalIndices=new Array;this.colorIndices=new Array;this.indexIds=new Array}return t}();t.FaceData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.geomtryType=t.GeometryType.Skin}i.prototype.setGeomtryData=function(t,e,i){this.indexData=t;this.verticesData=e;this.numItems=t.length;this.initialSkeleton=i};return i}(t.GeometryBase);t.SkinGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e,i,a,r,s,n,o,h){if(i===void 0){i=1e3}if(a===void 0){a=100}if(r===void 0){r=1e3}if(s===void 0){s=30}if(n===void 0){n=30}if(o===void 0){o=255}if(h===void 0){h=0}t.call(this);this._scaleU=1;this._scaleV=1;this._segmentsW=s;this._segmentsH=n;this._width=i;this._height=a;this._depth=r;this._minElevation=h;this._maxElevation=o;this.heightmap=e;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.canvas.width=e.width;this.canvas.height=e.height;this.ctx.drawImage(e.imageData,0,0,e.width,e.height);document.body.appendChild(this.canvas);this.canvas.hidden=true;this.imageData=this.ctx.getImageData(0,0,this.heightmap.imageData.width,this.heightmap.imageData.height);this.buildElevationGeometry()}e.prototype.getPixel=function(t,e){var i=e*(this.heightmap.imageData.width*4)+t*4;var a=this.imageData.data[i+3]<<24|this.imageData.data[i+0]<<16|this.imageData.data[i+1]<<8|this.imageData.data[i+2];return a};e.prototype.getHeightBypos=function(t,e){var i=this.getPixel(t,e);return i>this._maxElevation?this._maxElevation/255*this._height:i<this._minElevation?this._minElevation/255*this._height:i/255*this._height};e.prototype.buildElevationGeometry=function(){var t;var e;var i,a;var r;var s;var n=this._segmentsW+1;var o=(this._segmentsH+1)*n;var h=(this.heightmap.width-1)/this._segmentsW;var u=(this.heightmap.height-1)/this._segmentsH;var l,f;var c;t=new Array(o*3);e=new Array(this._segmentsH*this._segmentsW*6);o=0;r=0;var d;for(var p=0;p<=this._segmentsH;++p){for(var g=0;g<=this._segmentsW;++g){i=(g/this._segmentsW-.5)*this._width;a=(p/this._segmentsH-.5)*this._depth;l=Math.floor(g*h);f=Math.floor((this._segmentsH-p)*u);d=this.getPixel(l,f)&255;c=d>this._maxElevation?this._maxElevation/255*this._height:d<this._minElevation?this._minElevation/255*this._height:d/255*this._height;t[o++]=i;t[o++]=c;t[o++]=a;t[o++]=1;t[o++]=1;t[o++]=1;t[o++]=-1;t[o++]=0;t[o++]=0;t[o++]=1;t[o++]=1;t[o++]=1;t[o++]=1;t[o++]=g/this._segmentsW*this._scaleU;t[o++]=p/this._segmentsH*this._scaleV;t[o++]=g/this._segmentsW;t[o++]=p/this._segmentsH;if(g!=this._segmentsW&&p!=this._segmentsH){s=g+p*n;e[r++]=s;e[r++]=s+n+1;e[r++]=s+n;e[r++]=s;e[r++]=s+1;e[r++]=s+n+1}}}this.indexData=e;this.verticesData=t;this.numItems=e.length};e.prototype.updateFaceNormals=function(){var t=0,e=0,i=0;var a;var r=this.indexData.length;var s,n,o;var h,u,l;var f,c,d;var p,g,m;var _,v,D;var y,x,w;var b;var T=this.verticesData;var A=17;var E=0;while(t<r){a=E+this.indexData[t++]*A;s=T[a];h=T[a+1];f=T[a+2];a=E+this.indexData[t++]*A;n=T[a];u=T[a+1];c=T[a+2];a=E+this.indexData[t++]*A;o=T[a];l=T[a+1];d=T[a+2];p=o-s;g=l-h;m=d-f;_=n-s;v=u-h;D=c-f;y=m*v-g*D;x=p*D-m*_;w=g*_-p*v;b=Math.sqrt(y*y+x*x+w*w);b=1/b;T[e*A+3]=y*b;T[e*A+4]=x*b;T[e*A+5]=w*b;e++}};return e}(t.GeometryBase);t.ElevationGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.packageGeometry=function(e,i,a){a.numberOfVertices=a.verticesData.length/a.vertexAttLength;var r=new t.SubGeometry;var s=a.vertexAttLength;var n=a.numberOfVertices*i;var o=new Array(n*e);var h=new Array(e*a.indexData.length);for(var u=0;u<e;u++){for(var l=0;l<a.numberOfVertices;l++){o[l*i+0+u*n]=a.verticesData[l*s+0];o[l*i+1+u*n]=a.verticesData[l*s+1];o[l*i+2+u*n]=a.verticesData[l*s+2];o[l*i+3+u*n]=u;o[l*i+4+u*n]=0;o[l*i+5+u*n]=0;o[l*i+6+u*n]=0;o[l*i+7+u*n]=a.verticesData[l*s+13];o[l*i+8+u*n]=a.verticesData[l*s+14]}}for(var u=0;u<e;u++){for(var l=0;l<a.indexData.length;l++){h[l+u*a.indexData.length]=a.indexData[l]+u*a.numberOfVertices}}r.setGeomtryData(h,o);r.geometryNum=e;r.vertexAttLength=i;r.numberOfVertices=r.verticesData.length/r.vertexAttLength;return r};return e}();t.GeometryUtil=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e,i,a){if(a===void 0){a=null}t.call(this);this.geometry=e;this.material=i;this.animation=a;this.box.fillBox(this.geometry.minPos,this.geometry.maxPos)}e.prototype.clone=function(){return new e(this.geometry,this.material,this.animation?this.animation.clone():null)};e.prototype.update=function(t,e,i){if(this.isDisable)return;if(this.animation){this.animation.updata(e,i)}};return e}(t.Object3D);t.Mesh=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["LOADER_MODEL_TYPE"]=0]="LOADER_MODEL_TYPE";t[t["LOADER_SCENE_TYPE"]=1]="LOADER_SCENE_TYPE";t[t["LOADER_TEXTURE_TYPE"]=2]="LOADER_TEXTURE_TYPE"})(t.LoaderType||(t.LoaderType={}));var e=t.LoaderType;var i=function(t){__extends(e,t);function e(e,i){if(i===void 0){i=null}t.call(this);this.type=e;this.url=i}e.prototype.load=function(t){if(t===void 0){t=null}if(t!=null){this.url=t}if(null==this.url)return;this.onLoad()};e.prototype.onLoad=function(){};return e}(t.EventDispatcher);t.BaseLoader=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=null}e.call(this,t.LoaderType.LOADER_TEXTURE_TYPE,i)}Object.defineProperty(i.prototype,"texture",{get:function(){return this._texture},enumerable:true,configurable:true});i.prototype.onLoad=function(){var e=this;var i=new t.URLLoader;i.onLoadComplete=function(t){return e.onEMFileLoadComplete(t)};i.load(this.url)};i.prototype.onEMFileLoadComplete=function(e){this._texture=e.data;this.dispatchEvent(new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE,this))};return i}(t.BaseLoader);t.TextureLoader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,a,r){if(i===void 0){i=null}if(a===void 0){a=null}if(r===void 0){r=null}e.call(this,t.LoaderType.LOADER_MODEL_TYPE,i);this.url=i;this._esmFile=a;this._eamFiles=r}Object.defineProperty(i.prototype,"esmFile",{get:function(){return this._esmFile},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"mesh",{get:function(){return this._mesh},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"geomtry",{get:function(){return this._geomtry},enumerable:true,configurable:true});i.prototype.onLoad=function(){var e=this;this._mesh=null;this._geomtry=null;var i=new t.URLLoader;i.onLoadComplete=function(t){return e.onESMLoadComplete(e.url,t,e._eamFiles)};i.load(this.url+this._esmFile)};i.prototype.onESMLoadComplete=function(e,i,a){this._geomtry=i.data;var r=this._geomtry.textureFile&&this._geomtry.textureFile.length>0;var s=this._geomtry.textureBump&&this._geomtry.textureBump.length>0;var n=this._geomtry.textureSpecular&&this._geomtry.textureSpecular.length>0;var o=new t.TextureMaterial(null);if(this._geomtry.textureFile.length>0){var h=new t.AsyncLoadingTexturematerial(o);h.loadTexture(r?e+this._geomtry.textureFile:null,s?e+this._geomtry.textureBump:null,n?e+this._geomtry.textureSpecular:null)}if(this._geomtry.geomtryType==t.GeometryType.Skin){var u=this._geomtry;this._mesh=new t.Mesh(this._geomtry,o,new t.SkeletonAnimation(u.initialSkeleton))}else{this._mesh=new t.Mesh(this._geomtry,o)}if(a&&a.length>0){this.loadEAMFile(e,0,a)}else{var l=new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE);l.data=this;this.dispatchEvent(l)}};i.prototype.loadEAMFile=function(e,i,a){var r=this;if(i>=a.length){var s=new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE);s.data=this;this.dispatchEvent(s);return}var n=new t.URLLoader;n.onLoadComplete=function(t){return r.onEAMLoadComplete(e,t.data,i,a)};n.load(e+a[i])};i.prototype.onEAMLoadComplete=function(t,e,i,a){this._mesh.animation.addSkeletonAnimationClip(e);this.loadEAMFile(t,i+1,a)};return i}(t.BaseLoader);t.ModeLoader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=null}e.call(this,t.LoaderType.LOADER_SCENE_TYPE,i);this._meshList=[];this._totalNumber=0}Object.defineProperty(i.prototype,"meshList",{get:function(){return this._meshList},enumerable:true,configurable:true});i.prototype.onLoad=function(){var e=this;this._meshList=[];var i=new t.URLLoader;i.onLoadComplete=function(t){return e.onEMFileLoadComplete(e.url,t)};i.load(this.url+"/config.em")};i.prototype.onEMFileLoadComplete=function(e,i){var a=this.parsingXML(i.data);var r=a.getElementsByTagName("mesh");this._totalNumber=r.length;for(var s=0;s<r.length;s++){var n=e;n+="/"+r[s].attributes.getNamedItem("link").value;var o=new t.Vector3D;o.parsing(r[s].attributes.getNamedItem("rotation").value);var h=new t.Vector3D;h.parsing(r[s].attributes.getNamedItem("scaling").value);var u=new t.Vector3D;u.parsing(r[s].attributes.getNamedItem("translation").value);this.loadChild(n,o,h,u,e+"/")}};i.prototype.loadChild=function(e,i,a,r,s){var n=this;var o=new t.URLLoader;o.onLoadComplete=function(t){return n.onLoadComplete(t,i,a,r,s)};o.load(e)};i.prototype.onLoadComplete=function(e,i,a,r,s){var n=e.data;var o=new t.TextureMaterial;var h=new t.AsyncLoadingTexturematerial(o);h.loadTexture(n.textureFile.length>0?s+n.textureFile:null,n.textureBump.length>0?s+n.textureBump:null,n.textureSpecular.length>0?s+n.textureSpecular:null);var u=new t.Mesh(e.data,o);u.scaleX=a.x;u.scaleY=a.y;u.scaleZ=a.z;u.rotationX=i.x;u.rotationY=i.y;u.rotationZ=i.z;u.x=r.x;u.y=r.y;u.z=r.z;this._meshList.push(u);if(this._meshList.length>=this._totalNumber){this.dispatchEvent(new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE,this))}};i.prototype.parsingXML=function(t){var e=null;if(!window["DOMParser"]&&window["ActiveXObject"]){var i=["MSXML.2.DOMDocument.6.0","MSXML.2.DOMDocument.3.0","Microsoft.XMLDOM"];for(var a=0;a<i.length;a++){try{e=new ActiveXObject(i[a]);e.async=false;e.loadXML(t);break}catch(r){}}}else if(window["DOMParser"]&&document.implementation&&document.implementation.createDocument){try{var s=new DOMParser;e=s.parseFromString(t,"text/xml")}catch(r){}}else{return null}return e};return i}(t.BaseLoader);t.SceneLoader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t,e){if(t===void 0){t=null}if(e===void 0){e=null}this._url="";this._data=null;this._dataformat=null;this.onLoadComplete=null;this.onLoadError=null;this.onLoadProgress=null;if(t){if(e){this.dataformat=e}this.load(t)}}e.prototype.load=function(t){var i=this;this._data=null;this._url=t;if(null==this._dataformat){this._dataformat=e.DATAFORMAT_TEXT;if(this._url.length>=4)switch(this._url.substr(this._url.length-4,4).toLowerCase()){case".dds":this._dataformat=e.DATAFORMAT_DDS;break;case".tga":this._dataformat=e.DATAFORMAT_TGA;break;case".bmp":this._dataformat=e.DATAFORMAT_BITMAP;break;case".png":this._dataformat=e.DATAFORMAT_BITMAP;break;case".jpg":this._dataformat=e.DATAFORMAT_BITMAP;break;case"glsl":this._dataformat=e.DATAFORMAT_TEXT;break;case".pvr":this._dataformat=e.DATAFORMAT_PVR;break;case".esm":this._dataformat=e.DATAFORMAT_ESM;break;case".eam":this._dataformat=e.DATAFORMAT_EAM;break;case".eca":this._dataformat=e.DATAFORMAT_ECA;break}}if(this._xhr==null){this._xhr=this.getXHR()}if(this._xhr==null){alert("Your browser does not support XMLHTTP.");return}if(this._xhr.readyState>0){this._xhr.abort()}this._xhr.open("GET",this._url,true);this._xhr.addEventListener("progress",function(t){return i.onProgress(t)},false);this._xhr.addEventListener("readystatechange",function(t){return i.onReadyStateChange(t)},false);this._xhr.addEventListener("error",function(t){return i.onError(t)},false);if(this.dataformat==e.DATAFORMAT_BITMAP){this._xhr.responseType="blob"}else if(this.dataformat!=e.DATAFORMAT_TEXT){this._xhr.responseType="arraybuffer"}this._xhr.send()};Object.defineProperty(e.prototype,"dataformat",{get:function(){return this._dataformat},set:function(t){this._dataformat=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"url",{get:function(){return this._url},enumerable:true,configurable:true});e.prototype.onReadyStateChange=function(t){if(this._xhr.readyState==4){if(this._xhr.status>=400||this._xhr.status==0){console.log(this._url,"load fail")}else{this.loadComplete()}}};e.prototype.loadComplete=function(){switch(this.dataformat){case e.DATAFORMAT_BINARY:this._data=new t.ByteArray(this._xhr.response);break;case e.DATAFORMAT_SOUND:this._data=this._xhr.responseBody;break;case e.DATAFORMAT_TEXT:this._data=this._xhr.responseText;break;case e.DATAFORMAT_BITMAP:var i=document.createElement("img");if(window["createObjectURL"]!=undefined){i.src=window["createObjectURL"](this._xhr.response)}else if(window["URL"]!=undefined){i.src=window["URL"].createObjectURL(this._xhr.response)}else if(window["webkitURL"]!=undefined){i.src=window["webkitURL"].createObjectURL(this._xhr.response)}var a=this;i.onload=function(){a._data=new t.ImageTexture(i);if(a.onLoadComplete){a.onLoadComplete(a)}};return;case e.DATAFORMAT_DDS:this._data=t.DDSParser.parse(this._xhr.response);break;case e.DATAFORMAT_TGA:this._data=t.TGAParser.parse(this._xhr.response);break;case e.DATAFORMAT_ESM:var r=t.ESMParser.parse(this._xhr.response);this._data=r;break;case e.DATAFORMAT_EAM:var s=t.EAMParser.parse(this._xhr.response);this._data=s;break;case e.DATAFORMAT_ECA:var n=t.ECAParser.parse(this._xhr.response);this._data=n;break;case e.DATAFORMAT_PVR:var o=t.PVRParser.parse(this._xhr.response);this._data=o;break;default:this._data=this._xhr.responseText}if(this.onLoadComplete){this.onLoadComplete(this)}};e.prototype.onProgress=function(t){};e.prototype.onError=function(e){if(this.onLoadError){this.onLoadError()}t.Debug.instance.trace("loaderror, url: ",this._url);console.log("load error",e)};e.prototype.getXHR=function(){var t=null;if(window["XMLHttpRequest"]){t=new window["XMLHttpRequest"]}else{t=new ActiveXObject("MSXML2.XMLHTTP")}return t};e.DATAFORMAT_BINARY="binary";e.DATAFORMAT_TEXT="text";e.DATAFORMAT_SOUND="sound";e.DATAFORMAT_BITMAP="bitmap";e.DATAFORMAT_DDS="dds";e.DATAFORMAT_TGA="tga";e.DATAFORMAT_ESM="esm";e.DATAFORMAT_EAM="eam";e.DATAFORMAT_ECA="eca";e.DATAFORMAT_PVR="pvr";return e}();t.URLLoader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){this._mat=t}e.prototype.loadTexture=function(e,i,a){var r=this;if(i===void 0){i=null}if(a===void 0){a=null}if(e){var s=new t.URLLoader;s.onLoadComplete=function(t){return r.__textureComplete(t)};s.load(e)}if(i){var n=new t.URLLoader;n.onLoadComplete=function(t){return r.__bumpComplete(t)};n.load(i)}if(a){var o=new t.URLLoader;o.onLoadComplete=function(t){return r.__specComplete(t)};o.load(a)}};e.prototype.__specComplete=function(e){e.data.upload(t.Egret3DDrive.context3D);this._mat.specularTexture=e.data};e.prototype.__textureComplete=function(e){e.data.upload(t.Egret3DDrive.context3D);this._mat.diffuseTexture=e.data};e.prototype.__bumpComplete=function(e){e.data.upload(t.Egret3DDrive.context3D);this._mat.normalTexture=e.data};return e}();t.AsyncLoadingTexturematerial=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["RGB_S3TC_DXT1_FORMAT"]=2001]="RGB_S3TC_DXT1_FORMAT";t[t["RGBA_S3TC_DXT1_FORMAT"]=2002]="RGBA_S3TC_DXT1_FORMAT";t[t["RGBA_S3TC_DXT3_FORMAT"]=2003]="RGBA_S3TC_DXT3_FORMAT";t[t["RGBA_S3TC_DXT5_FORMAT"]=2003]="RGBA_S3TC_DXT5_FORMAT"})(t.DDSFormat||(t.DDSFormat={}));var e=t.DDSFormat;var i=function(){function i(){}i.parse=function(r,s){if(s===void 0){s=true}var n=new a;var o=31;var h=0;var u=542327876;var l=1,f=2,c=4,d=8,p=4096,g=131072,m=524288,_=8388608;var v=8,D=4194304,y=4096;var x=512,w=1024,b=2048,T=4096,A=8192,E=16384,L=32768,S=2097152;var M=1,P=2,R=4,C=64,F=512,I=131072;var U=i.fourCCToInt32("DXT1");var O=i.fourCCToInt32("DXT3");var B=i.fourCCToInt32("DXT5");var k=1021;var h=0;var N=1;var V=2;var G=3;var z=4;var j=7;var K=20;var X=21;var Y=22;var H=23;var W=24;var q=25;var Z=26;var Q=27;var J=28;var $=29;var tt=30;var et=new Int32Array(r,0,o);if(et[h]!==u){console.error("DDSParser.parse: Invalid magic number in DDS header.");return null}if(!(et[K]&R)){console.error("DDSParser.parse: Unsupported format, must contain a FourCC code.");return null}var it;var at=et[X];var rt=false;switch(at){case U:it=8;n.format=e.RGB_S3TC_DXT1_FORMAT;break;case O:it=16;n.format=e.RGBA_S3TC_DXT3_FORMAT;break;case B:it=16;n.format=e.RGBA_S3TC_DXT5_FORMAT;break;default:if(et[Y]==32&&et[H]&16711680&&et[W]&65280&&et[q]&255&&et[Z]&4278190080){rt=true;it=64;n.format=k}else{console.error("DDSParser.parse: Unsupported FourCC code ",i.int32ToFourCC(at));return null}}n.mipmapCount=1;if(et[V]&g&&s!==false){n.mipmapCount=Math.max(1,et[j])}n.isCubemap=et[J]&x?true:false;n.width=et[z];n.height=et[G];var st=et[N]+4;var nt=n.width;var ot=n.height;var ht=n.isCubemap?6:1;var ut=false;if(n.format==e.RGB_S3TC_DXT1_FORMAT&&t.Egret3DDrive.ColorFormat_DXT1_RGB==0)ut=true;else if(n.format==e.RGBA_S3TC_DXT3_FORMAT&&t.Egret3DDrive.ColorFormat_DXT3_RGBA==0)ut=true;else if(n.format==e.RGBA_S3TC_DXT5_FORMAT&&t.Egret3DDrive.ColorFormat_DXT5_RGBA==0)ut=true;
for(var lt=0;lt<ht;lt++){for(var ft=0;ft<n.mipmapCount;ft++){var ct;if(rt){ct=i.loadARGBMip(r,st,nt,ot);var dt=ct.length}else{var dt=Math.max(4,nt)/4*Math.max(4,ot)/4*it;ct=new Uint8Array(r,st,dt);if(ut){ct=i.softSolutionDXT(nt,ot,n.format,ct)}}var pt=new t.MipmapData(ct,nt,ot);n.mipmaps.push(pt);st+=dt;nt=Math.max(nt*.5,1);ot=Math.max(ot*.5,1)}nt=n.width;ot=n.height}var gt=new t.TextureBase;if(ut){gt.internalFormat=t.InternalFormat.PixelArray;gt.colorFormat=t.Egret3DDrive.ColorFormat_RGBA8888}else{gt.internalFormat=t.InternalFormat.CompressData;if(U==at)gt.colorFormat=t.Egret3DDrive.ColorFormat_DXT1_RGB;else if(O==at)gt.colorFormat=t.Egret3DDrive.ColorFormat_DXT3_RGBA;else if(B==at)gt.colorFormat=t.Egret3DDrive.ColorFormat_DXT5_RGBA}gt.mimapData=n.mipmaps;return gt};i.loadARGBMip=function(t,e,i,a){var r=i*a*4;var s=new Uint8Array(t,e,r);var n=new Uint8Array(r);var o=0;var h=0;for(var u=0;u<a;u++){for(var l=0;l<i;l++){var f=s[h];h++;var c=s[h];h++;var d=s[h];h++;var p=s[h];h++;n[o]=d;o++;n[o]=c;o++;n[o]=f;o++;n[o]=p;o++}}return n};i.fourCCToInt32=function(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)};i.int32ToFourCC=function(t){return String.fromCharCode(t&255,t>>8&255,t>>16&255,t>>24&65385)};i.softSolutionDXT=function(i,a,r,s){var n;var o=new Uint8Array(i*a*4);var h=[new t.Color,new t.Color,new t.Color,new t.Color];var u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];switch(r){case e.RGB_S3TC_DXT1_FORMAT:case e.RGBA_S3TC_DXT1_FORMAT:{n=s.length/8;for(var l=0;l<n;l++){var f=s[l*8+0]|s[l*8+1]<<8;var c=s[l*8+2]|s[l*8+3]<<8;h[0].r=f>>11&31;h[0].g=f>>5&63;h[0].b=f&31;h[0].a=255;h[1].r=c>>11&31;h[1].g=c>>5&63;h[1].b=c&31;h[1].a=255;if(f>c){h[2].lerp(h[0],h[1],.33);h[3].lerp(h[0],h[1],.66)}else{h[2].lerp(h[0],h[1],.5)}for(var d=0;d<4;d++){u[d*4+0]=s[l*8+4+d]&3;u[d*4+1]=s[l*8+4+d]>>2&3;u[d*4+2]=s[l*8+4+d]>>4&3;u[d*4+3]=s[l*8+4+d]>>6&3}for(var p=0;p<h.length;p++){h[p].r=h[p].r*8;h[p].g=h[p].g*4;h[p].b=h[p].b*8}var g=l%(i/4)*4;var m=Math.floor(l/(i/4))*4;if(m+0<a){if(g+0<i){o[(m+0)*(i*4)+(g+0)*4+0]=h[u[0]].r;o[(m+0)*(i*4)+(g+0)*4+1]=h[u[0]].g;o[(m+0)*(i*4)+(g+0)*4+2]=h[u[0]].b;o[(m+0)*(i*4)+(g+0)*4+3]=h[u[0]].a}if(g+1<i){o[(m+0)*(i*4)+(g+1)*4+0]=h[u[1]].r;o[(m+0)*(i*4)+(g+1)*4+1]=h[u[1]].g;o[(m+0)*(i*4)+(g+1)*4+2]=h[u[1]].b;o[(m+0)*(i*4)+(g+1)*4+3]=h[u[1]].a}if(g+2<i){o[(m+0)*(i*4)+(g+2)*4+0]=h[u[2]].r;o[(m+0)*(i*4)+(g+2)*4+1]=h[u[2]].g;o[(m+0)*(i*4)+(g+2)*4+2]=h[u[2]].b;o[(m+0)*(i*4)+(g+2)*4+3]=h[u[2]].a}if(g+3<i){o[(m+0)*(i*4)+(g+3)*4+0]=h[u[3]].r;o[(m+0)*(i*4)+(g+3)*4+1]=h[u[3]].g;o[(m+0)*(i*4)+(g+3)*4+2]=h[u[3]].b;o[(m+0)*(i*4)+(g+3)*4+3]=h[u[3]].a}}if(m+1<a){if(g+0<i){o[(m+1)*(i*4)+(g+0)*4+0]=h[u[4]].r;o[(m+1)*(i*4)+(g+0)*4+1]=h[u[4]].g;o[(m+1)*(i*4)+(g+0)*4+2]=h[u[4]].b;o[(m+1)*(i*4)+(g+0)*4+3]=h[u[4]].a}if(g+1<i){o[(m+1)*(i*4)+(g+1)*4+0]=h[u[5]].r;o[(m+1)*(i*4)+(g+1)*4+1]=h[u[5]].g;o[(m+1)*(i*4)+(g+1)*4+2]=h[u[5]].b;o[(m+1)*(i*4)+(g+1)*4+3]=h[u[5]].a}if(g+2<i){o[(m+1)*(i*4)+(g+2)*4+0]=h[u[6]].r;o[(m+1)*(i*4)+(g+2)*4+1]=h[u[6]].g;o[(m+1)*(i*4)+(g+2)*4+2]=h[u[6]].b;o[(m+1)*(i*4)+(g+2)*4+3]=h[u[6]].a}if(g+3<i){o[(m+1)*(i*4)+(g+3)*4+0]=h[u[7]].r;o[(m+1)*(i*4)+(g+3)*4+1]=h[u[7]].g;o[(m+1)*(i*4)+(g+3)*4+2]=h[u[7]].b;o[(m+1)*(i*4)+(g+3)*4+3]=h[u[7]].a}}if(m+2<a){if(g+0<i){o[(m+2)*(i*4)+(g+0)*4+0]=h[u[8]].r;o[(m+2)*(i*4)+(g+0)*4+1]=h[u[8]].g;o[(m+2)*(i*4)+(g+0)*4+2]=h[u[8]].b;o[(m+2)*(i*4)+(g+0)*4+3]=h[u[8]].a}if(g+1<i){o[(m+2)*(i*4)+(g+1)*4+0]=h[u[9]].r;o[(m+2)*(i*4)+(g+1)*4+1]=h[u[9]].g;o[(m+2)*(i*4)+(g+1)*4+2]=h[u[9]].b;o[(m+2)*(i*4)+(g+1)*4+3]=h[u[9]].a}if(g+2<i){o[(m+2)*(i*4)+(g+2)*4+0]=h[u[10]].r;o[(m+2)*(i*4)+(g+2)*4+1]=h[u[10]].g;o[(m+2)*(i*4)+(g+2)*4+2]=h[u[10]].b;o[(m+2)*(i*4)+(g+2)*4+3]=h[u[10]].a}if(g+3<i){o[(m+2)*(i*4)+(g+3)*4+0]=h[u[11]].r;o[(m+2)*(i*4)+(g+3)*4+1]=h[u[11]].g;o[(m+2)*(i*4)+(g+3)*4+2]=h[u[11]].b;o[(m+2)*(i*4)+(g+3)*4+3]=h[u[11]].a}}if(m+3<a){if(g+0<i){o[(m+3)*(i*4)+(g+0)*4+0]=h[u[12]].r;o[(m+3)*(i*4)+(g+0)*4+1]=h[u[12]].g;o[(m+3)*(i*4)+(g+0)*4+2]=h[u[12]].b;o[(m+3)*(i*4)+(g+0)*4+3]=h[u[12]].a}if(g+1<i){o[(m+3)*(i*4)+(g+1)*4+0]=h[u[13]].r;o[(m+3)*(i*4)+(g+1)*4+1]=h[u[13]].g;o[(m+3)*(i*4)+(g+1)*4+2]=h[u[13]].b;o[(m+3)*(i*4)+(g+1)*4+3]=h[u[13]].a}if(g+2<i){o[(m+3)*(i*4)+(g+2)*4+0]=h[u[14]].r;o[(m+3)*(i*4)+(g+2)*4+1]=h[u[14]].g;o[(m+3)*(i*4)+(g+2)*4+2]=h[u[14]].b;o[(m+3)*(i*4)+(g+2)*4+3]=h[u[14]].a}if(g+3<i){o[(m+3)*(i*4)+(g+3)*4+0]=h[u[15]].r;o[(m+3)*(i*4)+(g+3)*4+1]=h[u[15]].g;o[(m+3)*(i*4)+(g+3)*4+2]=h[u[15]].b;o[(m+3)*(i*4)+(g+3)*4+3]=h[u[15]].a}}}}break;case e.RGBA_S3TC_DXT3_FORMAT:{n=s.length/16;for(var l=0;l<n;l++){var f=s[l*16+8]|s[l*16+9]<<8;var c=s[l*16+10]|s[l*16+11]<<8;h[0].r=f>>11&31;h[0].g=f>>5&63;h[0].b=f&31;h[0].a=255;h[1].r=c>>11&31;h[1].g=c>>5&63;h[1].b=c&31;h[1].a=255;if(f>c){h[2].lerp(h[0],h[1],.33);h[3].lerp(h[0],h[1],.66)}else{h[2].lerp(h[0],h[1],.5);h[3].a=0}for(var d=0;d<4;d++){u[d*4+0]=s[l*16+12+d]&3;u[d*4+1]=s[l*16+12+d]>>2&3;u[d*4+2]=s[l*16+12+d]>>4&3;u[d*4+3]=s[l*16+12+d]>>6&3}for(var p=0;p<h.length;p++){h[p].r=h[p].r*8;h[p].g=h[p].g*4;h[p].b=h[p].b*8}var g=l%(i/4)*4;var m=Math.floor(l/(i/4))*4;if(m+0<a){if(g+0<i){o[(m+0)*(i*4)+(g+0)*4+0]=h[u[0]].r;o[(m+0)*(i*4)+(g+0)*4+1]=h[u[0]].g;o[(m+0)*(i*4)+(g+0)*4+2]=h[u[0]].b;o[(m+0)*(i*4)+(g+0)*4+3]=(s[l*16+0]&15)*17}if(g+1<i){o[(m+0)*(i*4)+(g+1)*4+0]=h[u[1]].r;o[(m+0)*(i*4)+(g+1)*4+1]=h[u[1]].g;o[(m+0)*(i*4)+(g+1)*4+2]=h[u[1]].b;o[(m+0)*(i*4)+(g+1)*4+3]=(s[l*16+0]>>4&15)*17}if(g+2<i){o[(m+0)*(i*4)+(g+2)*4+0]=h[u[2]].r;o[(m+0)*(i*4)+(g+2)*4+1]=h[u[2]].g;o[(m+0)*(i*4)+(g+2)*4+2]=h[u[2]].b;o[(m+0)*(i*4)+(g+2)*4+3]=(s[l*16+1]&15)*17}if(g+3<i){o[(m+0)*(i*4)+(g+3)*4+0]=h[u[3]].r;o[(m+0)*(i*4)+(g+3)*4+1]=h[u[3]].g;o[(m+0)*(i*4)+(g+3)*4+2]=h[u[3]].b;o[(m+0)*(i*4)+(g+3)*4+3]=(s[l*16+1]>>4&15)*17}}if(m+1<a){if(g+0<i){o[(m+1)*(i*4)+(g+0)*4+0]=h[u[4]].r;o[(m+1)*(i*4)+(g+0)*4+1]=h[u[4]].g;o[(m+1)*(i*4)+(g+0)*4+2]=h[u[4]].b;o[(m+1)*(i*4)+(g+0)*4+3]=(s[l*16+2]&15)*17}if(g+1<i){o[(m+1)*(i*4)+(g+1)*4+0]=h[u[5]].r;o[(m+1)*(i*4)+(g+1)*4+1]=h[u[5]].g;o[(m+1)*(i*4)+(g+1)*4+2]=h[u[5]].b;o[(m+1)*(i*4)+(g+1)*4+3]=(s[l*16+2]>>4&15)*17}if(g+2<i){o[(m+1)*(i*4)+(g+2)*4+0]=h[u[6]].r;o[(m+1)*(i*4)+(g+2)*4+1]=h[u[6]].g;o[(m+1)*(i*4)+(g+2)*4+2]=h[u[6]].b;o[(m+1)*(i*4)+(g+2)*4+3]=(s[l*16+3]&15)*17}if(g+3<i){o[(m+1)*(i*4)+(g+3)*4+0]=h[u[7]].r;o[(m+1)*(i*4)+(g+3)*4+1]=h[u[7]].g;o[(m+1)*(i*4)+(g+3)*4+2]=h[u[7]].b;o[(m+1)*(i*4)+(g+3)*4+3]=(s[l*16+3]>>4&15)*17}}if(m+2<a){if(g+0<i){o[(m+2)*(i*4)+(g+0)*4+0]=h[u[8]].r;o[(m+2)*(i*4)+(g+0)*4+1]=h[u[8]].g;o[(m+2)*(i*4)+(g+0)*4+2]=h[u[8]].b;o[(m+2)*(i*4)+(g+0)*4+3]=(s[l*16+4]&15)*17}if(g+1<i){o[(m+2)*(i*4)+(g+1)*4+0]=h[u[9]].r;o[(m+2)*(i*4)+(g+1)*4+1]=h[u[9]].g;o[(m+2)*(i*4)+(g+1)*4+2]=h[u[9]].b;o[(m+2)*(i*4)+(g+1)*4+3]=(s[l*16+4]>>4&15)*17}if(g+2<i){o[(m+2)*(i*4)+(g+2)*4+0]=h[u[10]].r;o[(m+2)*(i*4)+(g+2)*4+1]=h[u[10]].g;o[(m+2)*(i*4)+(g+2)*4+2]=h[u[10]].b;o[(m+2)*(i*4)+(g+2)*4+3]=(s[l*16+5]&15)*17}if(g+3<i){o[(m+2)*(i*4)+(g+3)*4+0]=h[u[11]].r;o[(m+2)*(i*4)+(g+3)*4+1]=h[u[11]].g;o[(m+2)*(i*4)+(g+3)*4+2]=h[u[11]].b;o[(m+2)*(i*4)+(g+3)*4+3]=(s[l*16+5]>>4&15)*17}}if(m+3<a){if(g+0<i){o[(m+3)*(i*4)+(g+0)*4+0]=h[u[12]].r;o[(m+3)*(i*4)+(g+0)*4+1]=h[u[12]].g;o[(m+3)*(i*4)+(g+0)*4+2]=h[u[12]].b;o[(m+3)*(i*4)+(g+0)*4+3]=(s[l*16+6]&15)*17}if(g+1<i){o[(m+3)*(i*4)+(g+1)*4+0]=h[u[13]].r;o[(m+3)*(i*4)+(g+1)*4+1]=h[u[13]].g;o[(m+3)*(i*4)+(g+1)*4+2]=h[u[13]].b;o[(m+3)*(i*4)+(g+1)*4+3]=(s[l*16+6]>>4&15)*17}if(g+2<i){o[(m+3)*(i*4)+(g+2)*4+0]=h[u[14]].r;o[(m+3)*(i*4)+(g+2)*4+1]=h[u[14]].g;o[(m+3)*(i*4)+(g+2)*4+2]=h[u[14]].b;o[(m+3)*(i*4)+(g+2)*4+3]=(s[l*16+7]&15)*17}if(g+3<i){o[(m+3)*(i*4)+(g+3)*4+0]=h[u[15]].r;o[(m+3)*(i*4)+(g+3)*4+1]=h[u[15]].g;o[(m+3)*(i*4)+(g+3)*4+2]=h[u[15]].b;o[(m+3)*(i*4)+(g+3)*4+3]=(s[l*16+7]>>4&15)*17}}}}break;case e.RGBA_S3TC_DXT5_FORMAT:break}return o};return i}();t.DDSParser=i;var a=function(){function t(){this.mipmaps=new Array;this.width=0;this.height=0;this.format=null;this.mipmapCount=1}return t}()})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e){var i=0,a=1,r=2,s=3,n=9,o=10,h=11,u=48,l=4,f=0,c=1,d=2,p=3;if(e.byteLength<19){console.error("TGAParser.parse: Not enough data to contain header.")}var g=new Uint8Array(e),m=0,_={id_length:g[m++],colormap_type:g[m++],image_type:g[m++],colormap_index:g[m++]|g[m++]<<8,colormap_length:g[m++]|g[m++]<<8,colormap_size:g[m++],origin:[g[m++]|g[m++]<<8,g[m++]|g[m++]<<8],width:g[m++]|g[m++]<<8,height:g[m++]|g[m++]<<8,pixel_size:g[m++],flags:g[m++]};function v(t){switch(t.image_type){case a:case n:if(t.colormap_length>256||t.colormap_size!==24||t.colormap_type!==1){console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for indexed type")}break;case r:case s:case o:case h:if(t.colormap_type){console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for colormap type")}break;case i:console.error("TGAParser.parse.tgaCheckHeader: No data");break;default:console.error('TGAParser.parse.tgaCheckHeader: Invalid type " '+t.image_type+'"')}if(t.width<=0||t.height<=0){console.error("TGAParser.parse.tgaCheckHeader: Invalid image size")}if(t.pixel_size!==8&&t.pixel_size!==16&&t.pixel_size!==24&&t.pixel_size!==32){console.error('TGAParser.parse.tgaCheckHeader: Invalid pixel size "'+t.pixel_size+'"')}}v(_);if(_.id_length+m>e.byteLength){console.error("TGAParser.parse: No data")}m+=_.id_length;var D=false,y=false,x=false;switch(_.image_type){case n:D=true;y=true;break;case a:y=true;break;case o:D=true;break;case r:break;case h:D=true;x=true;break;case s:x=true;break}function w(t,e,i,a,r){var s,n,o,h;n=i.pixel_size>>3;o=i.width*i.height*n;if(e){h=r.subarray(a,a+=i.colormap_length*(i.colormap_size>>3))}if(t){s=new Uint8Array(o);var u,l,f;var c=0;var d=new Uint8Array(n);while(c<o){u=r[a++];l=(u&127)+1;if(u&128){for(f=0;f<n;++f){d[f]=r[a++]}for(f=0;f<l;++f){s.set(d,c+f*n)}c+=n*l}else{l*=n;for(f=0;f<l;++f){s[c+f]=r[a++]}c+=l}}}else{s=r.subarray(a,a+=e?i.width*i.height:o)}return{pixel_data:s,palettes:h}}function b(t,e,i,a,r,s,n,o,h){var u=h;var l,f=0,c,d;var p=_.width;for(d=e;d!==a;d+=i){for(c=r;c!==n;c+=s,f++){l=o[f];t[(c+p*d)*4+3]=255;t[(c+p*d)*4+2]=u[l*3+0];t[(c+p*d)*4+1]=u[l*3+1];t[(c+p*d)*4+0]=u[l*3+2]}}return t}function T(t,e,i,a,r,s,n,o){var h,u=0,l,f;var c=_.width;for(f=e;f!==a;f+=i){for(l=r;l!==n;l+=s,u+=2){h=o[u+0]+(o[u+1]<<8);t[(l+c*f)*4+0]=(h&31744)>>7;t[(l+c*f)*4+1]=(h&992)>>2;t[(l+c*f)*4+2]=(h&31)>>3;t[(l+c*f)*4+3]=h&32768?0:255}}return t}function A(t,e,i,a,r,s,n,o){var h=0,u,l;var f=_.width;for(l=e;l!==a;l+=i){for(u=r;u!==n;u+=s,h+=3){t[(u+f*l)*4+3]=255;t[(u+f*l)*4+2]=o[h+0];t[(u+f*l)*4+1]=o[h+1];t[(u+f*l)*4+0]=o[h+2]}}return t}function E(t,e,i,a,r,s,n,o){var h=0,u,l;var f=_.width;for(l=e;l!==a;l+=i){for(u=r;u!==n;u+=s,h+=4){t[(u+f*l)*4+2]=o[h+0];t[(u+f*l)*4+1]=o[h+1];t[(u+f*l)*4+0]=o[h+2];t[(u+f*l)*4+3]=o[h+3]}}return t}function L(t,e,i,a,r,s,n,o){var h,u=0,l,f;var c=_.width;for(f=e;f!==a;f+=i){for(l=r;l!==n;l+=s,u++){h=o[u];t[(l+c*f)*4+0]=h;t[(l+c*f)*4+1]=h;t[(l+c*f)*4+2]=h;t[(l+c*f)*4+3]=255}}return t}function S(t,e,i,a,r,s,n,o){var h=0,u,l;var f=_.width;for(l=e;l!==a;l+=i){for(u=r;u!==n;u+=s,h+=2){t[(u+f*l)*4+0]=o[h+0];t[(u+f*l)*4+1]=o[h+0];t[(u+f*l)*4+2]=o[h+0];t[(u+f*l)*4+3]=o[h+1]}}return t}function M(t,e,i,a){var r,s,n,o,h,g,m=new Uint8Array(t*e*4);switch((_.flags&u)>>l){default:case d:r=0;n=1;h=t;s=0;o=1;g=e;break;case f:r=0;n=1;h=t;s=e-1;o=-1;g=-1;break;case p:r=t-1;n=-1;h=-1;s=0;o=1;g=e;break;case c:r=t-1;n=-1;h=-1;s=e-1;o=-1;g=-1;break}if(x){switch(_.pixel_size){case 8:L(m,s,o,g,r,n,h,i);break;case 16:S(m,s,o,g,r,n,h,i);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format");break}}else{switch(_.pixel_size){case 8:b(m,s,o,g,r,n,h,i,a);break;case 16:T(m,s,o,g,r,n,h,i);break;case 24:A(m,s,o,g,r,n,h,i);break;case 32:E(m,s,o,g,r,n,h,i);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format");break}}return m}var P=w(D,y,_,m,g);var R=M(_.width,_.height,P.pixel_data,P.palettes);var C=new t.TextureBase;C.internalFormat=t.InternalFormat.PixelArray;C.colorFormat=t.Egret3DDrive.ColorFormat_RGBA8888;C.mimapData.push(new t.MipmapData(R,_.width,_.height));return C};return e}();t.TGAParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["DATA_FORMAT_STATIC_MODEL"]=1]="DATA_FORMAT_STATIC_MODEL";t[t["DATA_FORMAT_SKELETAL_ANIM_MODEL"]=2]="DATA_FORMAT_SKELETAL_ANIM_MODEL";t[t["DATA_FORMAT_EXPORT_MESH"]=4]="DATA_FORMAT_EXPORT_MESH";t[t["DATA_FORMAT_EXIST_VERTEX_POS"]=8]="DATA_FORMAT_EXIST_VERTEX_POS";t[t["DATA_FORMAT_EXIST_VERTEX_NORMAL"]=16]="DATA_FORMAT_EXIST_VERTEX_NORMAL";t[t["DATA_FORMAT_EXIST_VERTEX_TANGENT"]=32]="DATA_FORMAT_EXIST_VERTEX_TANGENT";t[t["DATA_FORMAT_EXIST_VERTEX_COLOR"]=64]="DATA_FORMAT_EXIST_VERTEX_COLOR";t[t["DATA_FORMAT_EXIST_VERTEX_UV1"]=128]="DATA_FORMAT_EXIST_VERTEX_UV1";t[t["DATA_FORMAT_EXIST_VERTEX_UV2"]=256]="DATA_FORMAT_EXIST_VERTEX_UV2";t[t["DATA_FORMAT_EXIST_SKELETAL_DATA"]=512]="DATA_FORMAT_EXIST_SKELETAL_DATA";t[t["DATA_FORMAT_EXIST_WEIGHTS_DATA"]=1024]="DATA_FORMAT_EXIST_WEIGHTS_DATA"})(t.ESMDataFormat||(t.ESMDataFormat={}));var e=t.ESMDataFormat;var i=function(){function i(){}i.parse=function(e){var a=new t.ByteArray(e);var r=new t.GeometryData;var s=a.readUnsignedInt();var n=s>>28&15;var o=a.readUTF();var h="";var u="";if(n>0){h=a.readUTF();u=a.readUTF()}i.readMeshInfo(a,r,s,n);var l=new t.Skeleton;i.readBoneSkinInfo(a,r,l,n);var f;if(r.source_skinData.length>0){var c=new t.SkinGeometry;c.vertexAttLength=r.vertexAttLength=17+8;r=t.GeometryData.build(r);c.setGeomtryData(r.indices,r.vertexDatas,l);f=c}else{r=t.GeometryData.build(r);var d=new t.SubGeometry;d.setGeomtryData(r.indices,r.vertexDatas);f=d}f.buildBoundBox();f.textureFile=o;f.textureSpecular=h;f.textureBump=u;return f};i.readMeshInfo=function(t,a,r,s){if(r&e.DATA_FORMAT_EXIST_VERTEX_POS){i.readVertexInfo(t,a,s)}if(r&e.DATA_FORMAT_EXIST_VERTEX_NORMAL){i.readVertexNormalsInfo(t,a,s)}if(r&e.DATA_FORMAT_EXIST_VERTEX_COLOR){i.readVertexColorsInfo(t,a,s)}if(r&e.DATA_FORMAT_EXIST_VERTEX_UV1){i.readVertexUVInfo(t,a.source_uvData,s)}if(r&e.DATA_FORMAT_EXIST_VERTEX_UV2){i.readVertexUVInfo(t,a.source_uv2Data,s)}i.readVertexIndexInfo(t,a,r,s)};i.readVertexInfo=function(e,i,a){var r=e.readInt();for(var s=0;s<r;s++){i.source_vertexData.push(new t.Vector3D(e.readFloat(),e.readFloat(),e.readFloat()))}};i.readVertexNormalsInfo=function(e,i,a){var r=e.readInt();for(var s=0;s<r;s++){i.source_normalData.push(new t.Vector3D(e.readFloat(),e.readFloat(),e.readFloat()))}};i.readVertexColorsInfo=function(e,i,a){var r=e.readInt();for(var s=0;s<r;s++){i.source_vertexColorData.push(new t.Vector3D(e.readFloat(),e.readFloat(),e.readFloat(),e.readFloat()))}};i.readVertexUVInfo=function(e,i,a){var r=e.readInt();for(var s=0;s<r;s++){i.push(new t.UV(e.readFloat(),e.readFloat()))}};i.readVertexIndexInfo=function(i,a,r,s){var n,o,h;var u,l,f;var c=i.readInt();var d=1;var p=1;for(var g=0;g<c;g++){var m=new t.FaceData;n=i.readUnsignedInt();o=i.readUnsignedInt();h=i.readUnsignedInt();m.vertexIndices.push(n+1,o+1,h+1);if(r&e.DATA_FORMAT_EXIST_VERTEX_NORMAL){m.normalIndices.push(i.readUnsignedInt()+1,i.readUnsignedInt()+1,i.readUnsignedInt()+1)}if(r&e.DATA_FORMAT_EXIST_VERTEX_COLOR){m.colorIndices.push(i.readUnsignedInt()+1,i.readUnsignedInt()+1,i.readUnsignedInt()+1)}if(r&e.DATA_FORMAT_EXIST_VERTEX_UV1){if(s>=2){m.uvIndices.push(i.readUnsignedInt()+1,i.readUnsignedInt()+1,i.readUnsignedInt()+1)}else{m.uvIndices.push(d++,d++,d++)}}if(r&e.DATA_FORMAT_EXIST_VERTEX_UV2){if(s>=2){m.uv2Indices.push(i.readUnsignedInt()+1,i.readUnsignedInt()+1,i.readUnsignedInt()+1)}else{m.uv2Indices.push(p++,p++,p++)}}m.indexIds.push(String(n+1)+"/"+String(u+1)+"/"+String(n+1));m.indexIds.push(String(o+1)+"/"+String(l+1)+"/"+String(o+1));m.indexIds.push(String(h+1)+"/"+String(f+1)+"/"+String(h+1));a.source_faceData.push(m)}};i.readBoneSkinInfo=function(t,e,a,r){i.readBoneInfo(t,a,r);i.readSkinInfo(t,e,r)};i.readBoneInfo=function(e,i,a){var r=e.readUnsignedByte();var s=new t.Quaternion;var n=new t.Vector3D;var o=new t.Vector3D;var h=new t.Vector3D;for(var u=0;u<r;u++){var l=new t.Joint(null);e.readInt();l.parentIndex=e.readInt();l.name=e.readUTF();n.x=e.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES;n.y=e.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES;n.z=e.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES;o.x=e.readFloat();o.y=e.readFloat();o.z=e.readFloat();h.x=e.readFloat();h.y=e.readFloat();h.z=e.readFloat();l.setInverseBindPose(h,n,o);i.joints.push(l)}};i.readSkinInfo=function(t,e,i){var a=t.readInt();var r=0;var s=0;for(var n=0;n<a;n++){var o=t.readUnsignedByte();for(var h=0;h<o;h++){r=t.readUnsignedByte();s=t.readFloat();e.source_skinData.push(r,s)}for(var h=o;h<4;h++){r=0;s=0;e.source_skinData.push(r,s)}}};return i}();t.ESMParser=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e){var i=new t.ByteArray(e);var a=i.readUnsignedByte();var r=i.readUTF();var s=i.readUnsignedByte();if(a<=0)return new t.SkeletonAnimationClip(r);var n=new Array;var o=new Array;for(var h=0;h<a;h++){n.push(i.readUTF());o.push(i.readUTF())}var u=i.readInt();var l=new Array;var f=i.readInt();for(var h=0;h<f;h++){var c=new t.Skeleton;c.frameTime=i.readInt();for(var d=0;d<a;d++){var p=new t.Joint(n[d]);p.parent=o[d];p.setLocalTransform((new t.Quaternion).fromEulerAngles(i.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES,i.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES,i.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES),new t.Vector3D(i.readFloat(),i.readFloat(),i.readFloat()),new t.Vector3D(i.readFloat(),i.readFloat(),i.readFloat()));c.joints.push(p)}if(h>0){var g=new t.Skeleton;g.frameTime=c.frameTime-160/2;var m=l[l.length-1];for(var d=0;d<a;d++){var p=new t.Joint(m.joints[d].name);p.parent=m.joints[d].parent;p.orientation=new t.Quaternion;p.orientation.lerp(m.joints[d].orientation,c.joints[d].orientation,.5);p.scale=new t.Vector3D;p.scale.lerp(m.joints[d].scale,c.joints[d].scale,.5);p.translation=new t.Vector3D;p.translation.lerp(m.joints[d].translation,c.joints[d].translation,.5);p.setLocalTransform(p.orientation,p.scale,p.translation);g.joints.push(p)}l.push(g)}l.push(c)}var _=new t.SkeletonAnimationClip(r);_.sampling=s;_.frameCount=u*2;_.poseArray=l;return _};return e}();t.EAMParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e){var i=new t.ByteArray(e);var a=new t.CameraAnimationController;var r=i.readUnsignedInt();var s=null;var n=new t.Vector3D(1,1,1,1);while(r--){s=new t.CameraAnimationFrame;s.time=i.readInt();s.fov=i.readFloat();s.rotation=new t.Vector3D(i.readFloat(),i.readFloat(),i.readFloat());s.translation=new t.Vector3D(i.readFloat(),i.readFloat(),i.readFloat());s.matrix=new t.Matrix4_4;s.matrix.recompose([s.translation,s.rotation,n]);a.cameraAnimationFrames.push(s)}return a};return e}();t.ECAParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}return t}();t.PVR=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["RGB_PVRTC_4BPPV1_Format"]=2100]="RGB_PVRTC_4BPPV1_Format";t[t["RGB_PVRTC_2BPPV1_Format"]=2101]="RGB_PVRTC_2BPPV1_Format";t[t["RGBA_PVRTC_4BPPV1_Format"]=2102]="RGBA_PVRTC_4BPPV1_Format";t[t["RGBA_PVRTC_2BPPV1_Format"]=2103]="RGBA_PVRTC_2BPPV1_Format"})(t.PVRFormat||(t.PVRFormat={}));var e=t.PVRFormat;var i=function(){function i(){}i.parse=function(e){var a=new t.PVR;var r=13;var s=new Uint32Array(e,0,r);var n={buffer:e,header:s};if(s[0]===55727696){a=i._parseV3(n)}else if(s[11]===559044176){a=i._parseV2(n)}else{console.log("PVRParser unknow pvr format. PVRParser::parse")}return a};i._parseV2=function(t){var a=t.header;var r=a[0],s=a[1],n=a[2],o=a[3],h=a[4],u=a[5],l=a[6],f=a[7],c=a[8],d=a[9],p=a[10],g=a[11],m=a[12];var _=255;var v=24,D=25;var y=h&_;var l,x;var w=p>0;if(y===D){x=w?e.RGBA_PVRTC_4BPPV1_Format:e.RGB_PVRTC_4BPPV1_Format;l=4}else if(y===v){x=w?e.RGBA_PVRTC_2BPPV1_Format:e.RGB_PVRTC_2BPPV1_Format;l=2}else throw new Error("pvrtc - unknown format "+y);t.dataPtr=r;t.bpp=l;t.format=x;t.width=n;t.height=s;t.numSurfaces=m;t.numMipmaps=o+1;t.isCubemap=m===6;return i._extract(t)};i._parseV3=function(t){var a=t.header;var r,s;var n=a[12],o=a[2],h=a[6],u=a[7],l=a[9],f=a[10],c=a[11];switch(o){case 0:r=2;s=e.RGB_PVRTC_2BPPV1_Format;break;case 1:r=2;s=e.RGBA_PVRTC_2BPPV1_Format;break;case 2:r=4;s=e.RGB_PVRTC_4BPPV1_Format;break;case 3:r=4;s=e.RGBA_PVRTC_4BPPV1_Format;break;default:throw new Error("pvrtc - unsupported PVR format "+o)}t.dataPtr=52+n;t.bpp=r;t.format=s;t.width=u;t.height=h;t.numSurfaces=f;t.numMipmaps=c;t.isCubemap=f===6;return i._extract(t)};i._extract=function(e){var i=new t.PVR;var a=e.buffer;var r=e.dataPtr,s=e.bpp,n=e.numSurfaces,o=0,h=0,u=0,l=0,f=0,c=0;if(s===2){u=8;l=4}else{u=4;l=4}h=u*l*s/8;i.mipmaps.length=e.numMipmaps*n;var d=0;while(d<e.numMipmaps){var p=e.width>>d;var g=e.height>>d;f=p/u;c=g/l;if(f<2){f=2}if(c<2){c=2}o=f*c*h;for(var m=0;m<n;m++){var _=new Uint8Array(a,r,o);var v={data:_,width:p,height:g};i.mipmaps[m*e.numMipmaps+d]=v;r+=o}d++}return i};return i}();t.PVRParser=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.loadList=[];this.completeCount=0;this.assets={};this.assetsModel={};this.assetsScene={};this.assetsTexture={};this.rootURL=""}i.getInstance=function(){return i._instance};Object.defineProperty(i.prototype,"loadCompleteNumber",{get:function(){return this.completeCount},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"loadTotalNumber",{get:function(){return this.loadList.length},enumerable:true,configurable:true});i.prototype.setRootURL=function(t){this.rootURL=t};i.prototype.findAssets=function(t){return this.assets[this.rootURL+t]};i.prototype.findModel=function(t){return this.assetsModel[this.rootURL+t]};i.prototype.findAnimModel=function(t){return this.assetsModel[this.rootURL+t]};i.prototype.findScene=function(t){return this.assetsScene[this.rootURL+t]};i.prototype.findTexture=function(t){return this.assetsTexture[this.rootURL+t]};i.prototype.startLoad=function(){var e=this;for(var i=0;i<this.loadList.length;i++){var a=this.loadList[i];a.addEventListener(t.Event3D.EVENT_LOAD_COMPLETE,function(t){return e.checkComplete(t)});a.load()}};i.prototype.addLoadModel=function(e,i){var a=new t.ModeLoader(this.rootURL+e,i);this.loadList.push(a)};i.prototype.addLoadAnimModel=function(e,i,a){var r=new t.ModeLoader(this.rootURL+e,i,a);this.loadList.push(r)};i.prototype.addLoadScene=function(e){var i=new t.SceneLoader(this.rootURL+e);this.loadList.push(i)};i.prototype.addLoadTexture=function(e){var i=new t.TextureLoader(this.rootURL+e);this.loadList.push(i)};i.prototype.checkComplete=function(e){var i=e.data;switch(i.type){case t.LoaderType.LOADER_MODEL_TYPE:var a=i;this.assets[a.url+a.esmFile]=a.mesh;this.assetsModel[a.url+a.esmFile]=a.mesh;break;case t.LoaderType.LOADER_SCENE_TYPE:this.assets[i.url]=i.meshList;this.assetsScene[i.url]=i.meshList;break;case t.LoaderType.LOADER_TEXTURE_TYPE:this.assets[i.url]=i.texture;this.assetsTexture[i.url]=i.texture;break}this.completeCount++;this.dispatchEvent(new t.Event3D(t.Event3D.EVENT_LOAD_PROGRESS,this));if(this.completeCount>=this.loadList.length){this.dispatchEvent(new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE,this))}};i._instance=new i;return i}(t.EventDispatcher);t.AssetsManager=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.pickObject3DList=function(e,i){var a=new Array;var r=this.ray;r.CalculateAndTransformRay(t.Egret3DDrive.canvasRectangle.width,t.Egret3DDrive.canvasRectangle.height,e.modelMatrix,e.projectMatrix,t.Input.instance.mouseX,t.Input.instance.mouseY);for(var s=0;s<i.length;++s){var n=i[s];var o=new t.Vector3D;switch(n.pickType){case t.PickType.BoundPick:if(n.box!=null){if(r.IntersectMesh(n.box.vexData,n.box.indexData,3,n.box.indexData.length/3,0,n.modelMatrix,n.pickerData)){var h=new t.PickResult;a.push(i[s])}}break;case t.PickType.PositionPick:if(r.IntersectMeshEx(n,13,n.pickerData)){var h=new t.PickResult;a.push(i[s])}break;case t.PickType.UVPick:if(r.IntersectMeshEx(n,13,n.pickerData)){var h=new t.PickResult;a.push(i[s])}break}}return a};e.ray=new t.Ray;return e}();t.Picker=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){if(e===void 0){e=null}if(i===void 0){i=null}this._autoUpdate=true;this._origin=new t.Vector3D(0,0,0);this._target=e;this._lookAtObject=i}Object.defineProperty(e.prototype,"target",{get:function(){return this._target},set:function(t){if(this._target==t)return;this._target=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"autoUpdate",{get:function(){return this._autoUpdate},set:function(t){if(this._autoUpdate==t)return;this._autoUpdate=t},enumerable:true,configurable:true});e.prototype.notifyUpdate=function(){};e.prototype.update=function(){};return e}();t.ControllerBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,a){var r=this;if(i===void 0){i=null}if(a===void 0){a=null}e.call(this,i);this._origin=new t.Vector3D(0,0,0);this._lookAtPosition=new t.Vector3D;this._eyesPos=new t.Vector3D;this._up=t.Vector3D.Y_AXIS;this._eyesLength=0;this._rotaEyesLine=new t.Vector3D(0,0,1);this._rotaAngle=new t.Vector3D;this._matRot=new t.Matrix4_4;this._quaRot=new t.Quaternion;this._tempVec=new t.Vector3D;this._matTemp=new t.Matrix4_4;this._mouseDown=false;this._mouseRightDown=false;this._screenMoveStartDetail=new t.Point;this._screenMoveDelay=new t.Point;this._isUpdate=false;this._elapsed=0;this._speed=3;this._xAngle=0;this._keyArray=new Array;this.lookAtOffset=new t.Vector3D(0,0,0);this.firstCamera=false;this._keyArray.push(false);this._keyArray.push(false);this._keyArray.push(false);this._keyArray.push(false);if(a)this.lookAtObject=a;else this.lookAtPosition=new t.Vector3D;this._eyesPos.copyFrom(i.position);this._lookAtPosition.copyFrom(a.position.add(this.lookAtOffset));this._target.lookAt(this._eyesPos,this._lookAtPosition);t.Input.instance.addListenerMouseWheel(function(){return r.mouseWheel()});t.Input.instance.addListenerMouseMove(function(){return r.mouseMove()});t.Input.instance.addListenerKeyUp(function(t){return r.keyUp(t)});t.Input.instance.addListenerKeyDown(function(t){return r.keyDown(t)});t.Input.instance.addListenerSwipe(function(){return r.mouseMove()})}i.prototype.mouseWheel=function(){this.setEyesLength(this._eyesLength-t.Input.instance.wheelDelta*.1)};i.prototype.mouseMove=function(){if(this._mouseDown){this._rotaAngle.y+=t.Input.instance.mouseOffsetX;this._rotaAngle.y%=360}};Object.defineProperty(i.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){if(this._lookAtObject)this._lookAtObject=null;this._lookAtPosition.copyFrom(t.add(this.lookAtOffset));this.notifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"eyesPosition",{set:function(t){this._eyesPos.copyFrom(t);this.notifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"lookAtObject",{get:function(){return this._lookAtObject},set:function(t){if(this._lookAtObject==t)return;this._lookAtObject=t;this._lookAtPosition.copyFrom(this._lookAtObject.position.add(this.lookAtOffset));this.notifyUpdate()},enumerable:true,configurable:true});i.prototype.setEyesLength=function(t){this._eyesLength=t;if(this._eyesLength<1){this._eyesLength=1}};Object.defineProperty(i.prototype,"rotationX",{set:function(t){this._rotaAngle.x=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationY",{set:function(t){this._rotaAngle.y=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationZ",{set:function(t){this._rotaAngle.z=t},enumerable:true,configurable:true});i.prototype.update=function(){if(this._target){if(this._target.isController==false){return}if(this._keyArray[0]){this._tempVec.copyFrom(this._rotaEyesLine);this._tempVec.y=0;this._tempVec.normalize();this._tempVec.scaleBy(this._speed);this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec));this._lookAtObject.position=this._tempVec}if(this._keyArray[1]){this._tempVec.copyFrom(this._rotaEyesLine);this._matTemp.identity();this._matTemp.appendRotation(90,t.Vector3D.Y_AXIS);this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec));this._tempVec.y=0;this._tempVec.normalize();this._tempVec.scaleBy(this._speed);this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec));this._lookAtObject.position=this._tempVec}if(this._keyArray[2]){this._tempVec.copyFrom(this._rotaEyesLine);this._tempVec.y=0;this._tempVec.normalize();this._tempVec.scaleBy(this._speed);this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec));this._lookAtObject.position=this._tempVec}if(this._keyArray[3]){this._tempVec.copyFrom(this._rotaEyesLine);this._matTemp.identity();this._matTemp.appendRotation(90,t.Vector3D.Y_AXIS);this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec));this._tempVec.y=0;this._tempVec.normalize();this._tempVec.scaleBy(this._speed);this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec));this._lookAtObject.position=this._tempVec}this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0);this._rotaEyesLine.copyFrom(this._quaRot.rotatePoint(t.Vector3D.Z_AXIS));this._rotaEyesLine.normalize();this._tempVec.copyFrom(this._rotaEyesLine);this._tempVec.scaleBy(this._eyesLength);this._eyesPos.copyFrom(this._lookAtPosition.subtract(this._tempVec));if(this._lookAtObject){this._lookAtPosition.copyFrom(this._lookAtObject.position.add(this.lookAtOffset))}this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,this._rotaAngle.z);this._tempVec.copyFrom(this._up);this._tempVec.copyFrom(this._quaRot.rotatePoint(this._tempVec));this._tempVec.normalize();if(this.firstCamera){this._lookAtObject.rotationY=this._rotaAngle.y;this._lookAtObject.rotationX=this._rotaAngle.x}this._target.lookAt(this._eyesPos,this._lookAtPosition,this._tempVec)}};i.prototype.keyDown=function(e){switch(e){case t.KeyCode.Key_W:this._keyArray[0]=true;break;case t.KeyCode.Key_A:this._keyArray[1]=true;break;case t.KeyCode.Key_S:this._keyArray[2]=true;break;case t.KeyCode.Key_D:this._keyArray[3]=true;break;case t.KeyCode.Key_Mouse_Left:this._mouseDown=true;break;case t.KeyCode.Key_Mouse_Right:this._mouseRightDown=true;break}};i.prototype.keyUp=function(e){switch(e){case t.KeyCode.Key_W:this._keyArray[0]=false;break;case t.KeyCode.Key_A:this._keyArray[1]=false;break;case t.KeyCode.Key_S:this._keyArray[2]=false;break;case t.KeyCode.Key_D:this._keyArray[3]=false;break;case t.KeyCode.Key_Mouse_Left:this._mouseDown=false;break;case t.KeyCode.Key_Mouse_Right:this._mouseRightDown=false;break}};return i}(t.ControllerBase);t.LookAtController=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,a,r,s,n,o,h,u,l,f,c,d){var p=this;if(i===void 0){i=null}if(a===void 0){a=null}if(r===void 0){r=0}if(s===void 0){s=90}if(n===void 0){n=100}if(o===void 0){o=-90}if(h===void 0){h=90}if(u===void 0){u=NaN}if(l===void 0){l=NaN}if(f===void 0){f=8}if(c===void 0){c=2}if(d===void 0){d=false}e.call(this,i,a);this._currentPanAngle=0;this._currentTiltAngle=90;this._panAngle=0;this._tiltAngle=90;this._distance=1e3;this._minPanAngle=-Infinity;this._maxPanAngle=Infinity;this._minTiltAngle=-90;this._maxTiltAngle=90;this._maxDistance=5e3;this._minDistance=-5e3;this._steps=8;this._yFactor=2;this._wrapPanAngle=false;this._lookAtPosition=new t.Vector3D(0,0,0);this._mouseDown=false;this._mouseRightDown=false;this._keyArray=new Array;this.distance=n;this.panAngle=r;this.tiltAngle=s;this.minPanAngle=u||-Infinity;this.maxPanAngle=l||Infinity;this.minTiltAngle=o;this.maxTiltAngle=h;this.steps=f;this.yFactor=c;this.wrapPanAngle=d;this._currentPanAngle=this._panAngle;this._currentTiltAngle=this._tiltAngle;t.Input.instance.addListenerMouseMove(function(){return p.mouseMove()});t.Input.instance.addListenerKeyUp(function(t){return p.keyUp(t)});t.Input.instance.addListenerKeyDown(function(t){
return p.keyDown(t)});t.Input.instance.addListenerMouseWheel(function(){return p.mouseWheel()});t.Input.instance.addListenerSwipe(function(){return p.mouseMove()})}i.prototype.mouseWheel=function(){this._distance-=t.Input.instance.wheelDelta*.1;this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance))};i.prototype.keyDown=function(e){switch(e){case t.KeyCode.Key_W:this._keyArray[0]=true;break;case t.KeyCode.Key_A:this._keyArray[1]=true;break;case t.KeyCode.Key_S:this._keyArray[2]=true;break;case t.KeyCode.Key_D:this._keyArray[3]=true;break;case t.KeyCode.Key_Mouse_Left:this._mouseDown=true;break;case t.KeyCode.Key_Mouse_Right:this._mouseRightDown=true;break}};i.prototype.keyUp=function(e){switch(e){case t.KeyCode.Key_W:this._keyArray[0]=false;break;case t.KeyCode.Key_A:this._keyArray[1]=false;break;case t.KeyCode.Key_S:this._keyArray[2]=false;break;case t.KeyCode.Key_D:this._keyArray[3]=false;break;case t.KeyCode.Key_Mouse_Left:this._mouseDown=false;break;case t.KeyCode.Key_Mouse_Right:this._mouseRightDown=false;break}};i.prototype.mouseMove=function(){if(this._mouseDown){this._tiltAngle+=t.Input.instance.mouseOffsetY*.1;this._tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle));this._panAngle+=t.Input.instance.mouseOffsetX*.1;this._panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle))}};Object.defineProperty(i.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){this._lookAtPosition=t;this.notifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"steps",{get:function(){return this._steps},set:function(t){t=t<1?1:t;if(this._steps==t)return;this._steps=t;this.notifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"panAngle",{get:function(){return this._panAngle},set:function(t){t=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,t));if(this._panAngle==t)return;this._panAngle=t;this.notifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(t){t=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,t));if(this._tiltAngle==t)return;this._tiltAngle=t;this.notifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"distance",{get:function(){return this._distance},set:function(t){if(this._distance==t)return;this._distance=this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,t));this.notifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"minPanAngle",{get:function(){return this._minPanAngle},set:function(t){if(this._minPanAngle==t)return;this._minPanAngle=t;this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"maxPanAngle",{get:function(){return this._maxPanAngle},set:function(t){if(this._maxPanAngle==t)return;this._maxPanAngle=t;this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"minTiltAngle",{get:function(){return this._minTiltAngle},set:function(t){if(this._minTiltAngle==t)return;this._minTiltAngle=t;this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"maxTiltAngle",{get:function(){return this._maxTiltAngle},set:function(t){if(this._maxTiltAngle==t)return;this._maxTiltAngle=t;this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){if(this._maxDistance==t)return;this._maxDistance=t;this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"minDistance",{get:function(){return this._maxDistance},set:function(t){if(this._minDistance==t)return;this._minDistance=t;this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"yFactor",{get:function(){return this._yFactor},set:function(t){if(this._yFactor==t)return;this._yFactor=t;this.notifyUpdate()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"wrapPanAngle",{get:function(){return this._wrapPanAngle},set:function(t){if(this._wrapPanAngle==t)return;this._wrapPanAngle=t;this.notifyUpdate()},enumerable:true,configurable:true});i.prototype.update=function(e){if(e===void 0){e=true}if(this._tiltAngle!=this._currentTiltAngle||this._panAngle!=this._currentPanAngle){this.notifyUpdate();if(this._wrapPanAngle){if(this._panAngle<0)this._panAngle=this._panAngle%360+360;else this._panAngle=this._panAngle%360;if(this._panAngle-this._currentPanAngle<-180)this._currentPanAngle-=360;else if(this._panAngle-this._currentPanAngle>180)this._currentPanAngle+=360}if(e){this._currentTiltAngle+=(this._tiltAngle-this._currentTiltAngle)/(this.steps+1);this._currentPanAngle+=(this._panAngle-this._currentPanAngle)/(this.steps+1)}else{this._currentPanAngle=this._panAngle;this._currentTiltAngle=this._tiltAngle}if(Math.abs(this._tiltAngle-this._currentTiltAngle)<.01&&Math.abs(this._panAngle-this._currentPanAngle)<.01){this._currentTiltAngle=this._tiltAngle;this._currentPanAngle=this._panAngle}}var i=this._lookAtObject?this._lookAtObject.position:this._lookAtPosition?this._lookAtPosition:this._origin;var a=new t.Vector3D;a.x=i.x+this.distance*Math.sin(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS);a.z=i.z+this.distance*Math.cos(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS);a.y=i.y+this.distance*Math.sin(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS)*this.yFactor;if(this._target){if(this._lookAtPosition)this._target.lookAt(a,this._lookAtPosition)}};return i}(t.ControllerBase);t.HoverController=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){if(e===void 0){e=null}this.cameraAnimationFrames=[];this._playing=false;this._playTime=0;this._currentFrameIndex=0;this._loop=true;this._smooth=false;this._cameraAnimationFrame=new i;this._camera=e;this._cameraAnimationFrame.fov=45;this._cameraAnimationFrame.rotation=new t.Vector3D;this._cameraAnimationFrame.translation=new t.Vector3D}e.prototype.bindCamera=function(t){this._camera=t};e.prototype.play=function(t){if(this.cameraAnimationFrames.length<=0)return;this._loop=t;this._playTime=0;this._camera.isController=false;this._playing=true};e.prototype.update=function(e,i){if(!this._playing)return;this._playTime+=i*10;var a=this._playTime%(this.cameraAnimationFrames[this.cameraAnimationFrames.length-1].time-this.cameraAnimationFrames[0].time+160);var r=Math.floor(a/160)%this.cameraAnimationFrames.length;if(!this._loop&&this._currentFrameIndex>r){this._playing=false;this._camera.isController=true}this._currentFrameIndex=r;var s=this.cameraAnimationFrames[r];if(this._smooth){var n=(r+1)%this.cameraAnimationFrames.length;var o=this.cameraAnimationFrames[n];var h=(a-s.time)/Math.abs(o.time-s.time);this._cameraAnimationFrame.fov=(o.fov-s.fov)*h+s.fov;this._cameraAnimationFrame.rotation.copyFrom(s.rotation);this._cameraAnimationFrame.translation.lerp(s.translation,o.translation,h)}else{this._cameraAnimationFrame.fov=s.fov;this._cameraAnimationFrame.rotation.copyFrom(s.rotation);this._cameraAnimationFrame.translation.copyFrom(s.translation)}this._camera.fieldOfView=this._cameraAnimationFrame.fov;this._camera.rotationX=this._cameraAnimationFrame.rotation.x*t.Matrix3DUtils.RADIANS_TO_DEGREES+90;this._camera.rotationY=this._cameraAnimationFrame.rotation.y*t.Matrix3DUtils.RADIANS_TO_DEGREES;this._camera.rotationZ=this._cameraAnimationFrame.rotation.z*t.Matrix3DUtils.RADIANS_TO_DEGREES;this._camera.position=this._cameraAnimationFrame.translation};return e}();t.CameraAnimationController=e;var i=function(){function t(){}return t}();t.CameraAnimationFrame=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this._animation={}}e.prototype.play=function(e,i,a){var r=this;if(this._animation[e]!=undefined){this._animation[e].bindCamera(i);this._animation[e].play(a)}else{var s=new t.URLLoader;s.onLoadComplete=function(t){return r.onCallback(t,e,i,a)};s.load(e)}};e.prototype.update=function(t,e){for(var i in this._animation){this._animation[i].update(t,e)}};e.prototype.onCallback=function(t,e,i,a){this._animation[e]=t.data;this._animation[e].bindCamera(i);this._animation[e].play(a)};return e}();t.CameraAnimationManager=e})(egret3d||(egret3d={}));var DeviceUtil=function(){function t(){}t.getDeviceInfo=function(){return null};Object.defineProperty(t,"getGPUMode",{get:function(){if(true){return egret3d.Egret3DDrive.OpenGLES_2_0}return""},enumerable:true,configurable:true});return t}();var egret3d;(function(t){var e=function(){function t(){}t.LITTLE_ENDIAN="littleEndian";t.BIG_ENDIAN="bigEndian";return t}();t.Endian=e;var i=function(){function t(t){this.BUFFER_EXT_SIZE=0;this.EOF_byte=-1;this.EOF_code_point=-1;this._setArrayBuffer(t||new ArrayBuffer(this.BUFFER_EXT_SIZE));this.endian=e.BIG_ENDIAN}t.prototype._setArrayBuffer=function(t){this.write_position=t.byteLength;this.data=new DataView(t);this._position=0};Object.defineProperty(t.prototype,"buffer",{get:function(){return this.data.buffer},set:function(t){this.data=new DataView(t)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"dataView",{get:function(){return this.data},set:function(t){this.data=t;this.write_position=t.byteLength},enumerable:true,configurable:true});t.prototype.uncompress=function(t){if(t===void 0){t="7z"}};Object.defineProperty(t.prototype,"bufferOffset",{get:function(){return this.data.byteOffset},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position<t){if(!this.validate(t-this._position)){return}}this._position=t;this.write_position=t>this.write_position?t:this.write_position},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"length",{get:function(){return this.write_position},set:function(t){this.validateBuffer(t,true)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"bytesAvailable",{get:function(){return this.data.byteLength-this._position},enumerable:true,configurable:true});t.prototype.clear=function(){this._setArrayBuffer(new ArrayBuffer(this.BUFFER_EXT_SIZE))};t.prototype.readBoolean=function(){if(!this.validate(t.SIZE_OF_BOOLEAN))return null;return this.data.getUint8(this.position++)!=0};t.prototype.readByte=function(){if(!this.validate(t.SIZE_OF_INT8))return null;return this.data.getInt8(this.position++)};t.prototype.readBytes=function(e,i,a){if(i===void 0){i=0}if(a===void 0){a=0}if(a==0){a=this.bytesAvailable}else if(!this.validate(a)){return null}if(e){e.validateBuffer(a)}else{e=new t(new ArrayBuffer(a))}for(var r=0;r<a;r++){e.data.setUint8(r+i,this.data.getUint8(this.position++))}};t.prototype.readDouble=function(){if(!this.validate(t.SIZE_OF_FLOAT64))return null;var i=this.data.getFloat64(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_FLOAT64;return i};t.prototype.readFloat=function(){if(!this.validate(t.SIZE_OF_FLOAT32))return null;var i=this.data.getFloat32(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_FLOAT32;return i};t.prototype.readInt=function(){if(!this.validate(t.SIZE_OF_INT32))return null;var i=this.data.getInt32(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_INT32;return i};t.prototype.readShort=function(){if(!this.validate(t.SIZE_OF_INT16))return null;var i=this.data.getInt16(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_INT16;return i};t.prototype.readUnsignedByte=function(){if(!this.validate(t.SIZE_OF_UINT8))return null;return this.data.getUint8(this.position++)};t.prototype.readUnsignedInt=function(){if(!this.validate(t.SIZE_OF_UINT32))return null;var i=this.data.getUint32(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT32;return i};t.prototype.readUnsignedShort=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT16;return i};t.prototype.readUTF=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT16;if(i>0){return this.readUTFBytes(i)}else{return""}};t.prototype.readUTFBytes=function(t){if(!this.validate(t))return null;var e=new Uint8Array(this.buffer,this.bufferOffset+this.position,t);this.position+=t;return this.decodeUTF8(e)};t.prototype.writeBoolean=function(e){this.validateBuffer(t.SIZE_OF_BOOLEAN);this.data.setUint8(this.position++,e?1:0)};t.prototype.writeByte=function(e){this.validateBuffer(t.SIZE_OF_INT8);this.data.setInt8(this.position++,e)};t.prototype.writeBytes=function(t,e,i){if(e===void 0){e=0}if(i===void 0){i=0}var a;if(e<0){return}if(i<0){return}else if(i==0){a=t.length-e}else{a=Math.min(t.length-e,i)}if(a>0){this.validateBuffer(a);var r=new DataView(t.buffer);for(var s=e;s<a+e;s++){this.data.setUint8(this.position++,r.getUint8(s))}}};t.prototype.writeDouble=function(i){this.validateBuffer(t.SIZE_OF_FLOAT64);this.data.setFloat64(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_FLOAT64};t.prototype.writeFloat=function(i){this.validateBuffer(t.SIZE_OF_FLOAT32);this.data.setFloat32(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_FLOAT32};t.prototype.writeInt=function(i){this.validateBuffer(t.SIZE_OF_INT32);this.data.setInt32(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_INT32};t.prototype.writeShort=function(i){this.validateBuffer(t.SIZE_OF_INT16);this.data.setInt16(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_INT16};t.prototype.writeUnsignedInt=function(i){this.validateBuffer(t.SIZE_OF_UINT32);this.data.setUint32(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT32};t.prototype.writeUTF=function(i){var a=this.encodeUTF8(i);var r=a.length;this.validateBuffer(t.SIZE_OF_UINT16+r);this.data.setUint16(this.position,r,this.endian===e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT16;this._writeUint8Array(a,false)};t.prototype.writeUTFBytes=function(t){this._writeUint8Array(this.encodeUTF8(t))};t.prototype.toString=function(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable};t.prototype._writeUint8Array=function(t,e){if(e===void 0){e=true}if(e){this.validateBuffer(this.position+t.length)}for(var i=0;i<t.length;i++){this.data.setUint8(this.position++,t[i])}};t.prototype.validate=function(t){if(this.data.byteLength>0&&this._position+t<=this.data.byteLength){return true}else{}};t.prototype.validateBuffer=function(t,e){if(e===void 0){e=false}this.write_position=t>this.write_position?t:this.write_position;t+=this._position;if(this.data.byteLength<t||e){var i=new Uint8Array(new ArrayBuffer(t+this.BUFFER_EXT_SIZE));var a=Math.min(this.data.buffer.byteLength,t+this.BUFFER_EXT_SIZE);i.set(new Uint8Array(this.data.buffer,0,a));this.buffer=i.buffer}};t.prototype.encodeUTF8=function(t){var e=0;var i=this.stringToCodePoints(t);var a=[];while(i.length>e){var r=i[e++];if(this.inRange(r,55296,57343)){this.encoderError(r)}else if(this.inRange(r,0,127)){a.push(r)}else{var s,n;if(this.inRange(r,128,2047)){s=1;n=192}else if(this.inRange(r,2048,65535)){s=2;n=224}else if(this.inRange(r,65536,1114111)){s=3;n=240}a.push(this.div(r,Math.pow(64,s))+n);while(s>0){var o=this.div(r,Math.pow(64,s-1));a.push(128+o%64);s-=1}}}return new Uint8Array(a)};t.prototype.decodeUTF8=function(t){var e=false;var i=0;var a="";var r;var s=0;var n=0;var o=0;var h=0;while(t.length>i){var u=t[i++];if(u===this.EOF_byte){if(n!==0){r=this.decoderError(e)}else{r=this.EOF_code_point}}else{if(n===0){if(this.inRange(u,0,127)){r=u}else{if(this.inRange(u,194,223)){n=1;h=128;s=u-192}else if(this.inRange(u,224,239)){n=2;h=2048;s=u-224}else if(this.inRange(u,240,244)){n=3;h=65536;s=u-240}else{this.decoderError(e)}s=s*Math.pow(64,n);r=null}}else if(!this.inRange(u,128,191)){s=0;n=0;o=0;h=0;i--;r=this.decoderError(e,u)}else{o+=1;s=s+(u-128)*Math.pow(64,n-o);if(o!==n){r=null}else{var l=s;var f=h;s=0;n=0;o=0;h=0;if(this.inRange(l,f,1114111)&&!this.inRange(l,55296,57343)){r=l}else{r=this.decoderError(e,u)}}}}if(r!==null&&r!==this.EOF_code_point){if(r<=65535){if(r>0)a+=String.fromCharCode(r)}else{r-=65536;a+=String.fromCharCode(55296+(r>>10&1023));a+=String.fromCharCode(56320+(r&1023))}}}return a};t.prototype.encoderError=function(t){};t.prototype.decoderError=function(t,e){if(t){}return e||65533};t.prototype.inRange=function(t,e,i){return e<=t&&t<=i};t.prototype.div=function(t,e){return Math.floor(t/e)};t.prototype.stringToCodePoints=function(t){var e=[];var i=0,a=t.length;while(i<t.length){var r=t.charCodeAt(i);if(!this.inRange(r,55296,57343)){e.push(r)}else if(this.inRange(r,56320,57343)){e.push(65533)}else{if(i===a-1){e.push(65533)}else{var s=t.charCodeAt(i+1);if(this.inRange(s,56320,57343)){var n=r&1023;var o=s&1023;i+=1;e.push(65536+(n<<10)+o)}else{e.push(65533)}}}i+=1}return e};t.SIZE_OF_BOOLEAN=1;t.SIZE_OF_INT8=1;t.SIZE_OF_INT16=2;t.SIZE_OF_INT32=4;t.SIZE_OF_UINT8=1;t.SIZE_OF_UINT16=2;t.SIZE_OF_UINT32=4;t.SIZE_OF_FLOAT32=4;t.SIZE_OF_FLOAT64=8;return t}();t.ByteArray=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.parseContent=function(t){var e=new Array;var i="";var a=";";var r=-1;for(var s=0;s<t.length;++s){if(t.charAt(s)=="{"){r=i.indexOf("=");if(r<0){a="}"}}if(i==""){if(t.charAt(s)==" "||t.charAt(s)=="    "){continue}}i+=t.charAt(s);if(a==t.charAt(s)){if(a=="}"){var n=0;var o=0;for(var h=0;h<i.length;++h){if(i.charAt(h)=="{"){n++}else if(i.charAt(h)=="}"){o++}}if(n!=o){continue}if(i.indexOf("struct")>=0){a=";";continue}}if(i.length>0){e.push(i)}i="";a=";"}}return e};t.parseLines=function(t){var e=new Array;var i="";for(var a=0;a<t.length;++a){if(t.charAt(a)!=" "&&t.charAt(a)!="	"&&t.charAt(a)!=","&&t.charAt(a)!="\r"&&t.charAt(a)!="\n"){if(t.charAt(a)==";"){if(i.length>0){e.push(i);i=""}e.push(";");break}else if(t.charAt(a)=="="){if(i.length>0){e.push(i);i=""}e.push("=");continue}i+=t.charAt(a);if(a==t.length-1&&t!=""){e.push(i);i=""}}else{if(i!=""){e.push(i);i=""}}}return e};t.hasString=function(t,e){for(var i=0;i<t.length;++i){if(t[i]==e){return true}}return false};t.getVarName=function(t){var e=this.hasString(t,"=");if(e){if(t.length-4>=0&&t.length-4<t.length){return t[t.length-4]}return""}if(t.length-2>=0&&t.length-2<t.length){return t[t.length-2]}return""};t.getVarValue=function(t){var e=this.hasString(t,"=");if(e){if(t.length-2>=0&&t.length-2<t.length){return t[t.length-2]}}return""};t.getVarType=function(t){var e=this.hasString(t,"=");if(e){if(t.length-5>=0&&t.length-5<t.length){return t[t.length-5]}return""}if(t.length-3>=0&&t.length-3<t.length){return t[t.length-3]}return""};t.getVarKey=function(t){var e=this.hasString(t,"=");if(e){if(t.length>5){return t[0]}else{return""}}if(t.length>3){return t[0]}return""};t.processShaderFile=function(t){var e=["\n","\r"];e=[];var i=t;var a=i;while(true){var r=i.indexOf("//");if(r<0){break}var s=i.indexOf("\r\n",r);if(s==-1){s=i.indexOf("\n",r)}var n=i.slice(r,s);i=i.replace(n,"");if(i==a){break}a=i}for(var o=0;o<e.length;++o){while(true){a=i.replace(e[o],"");if(i==a){break}i=a}}return i};t.colorRgb=function(t){var e=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;var i=t.toLowerCase();if(i&&e.test(i)){if(i.length===4){var a="#";for(var r=1;r<4;r+=1){a+=i.slice(r,r+1).concat(i.slice(r,r+1))}i=a}var s=[];for(var r=1;r<7;r+=2){s.push(parseInt("0x"+i.slice(r,r+2)))}return"RGB("+s.join(",")+")"}else{return i}};return t}();t.StringUtil=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.isDebug=false;this._console=document.createElement("console");document.body.appendChild(this._console);this._console.style.color="red";this._console.style.zIndex="1000";this._console.style.position="absolute";this._console.style.top="10px";this._console.style.left="10px"}t.prototype.trace=function(){var t=[];for(var e=0;e<arguments.length;e++){t[e-0]=arguments[e]}if(this.isDebug){this.reset();var i=t.length;for(var a=0;a<i;a++){this._console.innerHTML+=t[a]+"</br>"}}};t.prototype.reset=function(){this._console.innerHTML=""};Object.defineProperty(t,"instance",{get:function(){if(this._instance==null){this._instance=new t}return this._instance},enumerable:true,configurable:true});t._instance=null;return t}();t.Debug=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.vertexData=[.5,0,0,-.5,0,0];this.vertexCount=2;this.vertexLength=3;this.vertexBytes=12;this.isDrawLine=true;this.isDrawPoint=true;this.pointSize=1;this.pointColor=new t.Vector3D(1,1,1,1);this.lineColor=new t.Vector3D(1,1,1,1);this.usage=new t.MethodUsageData;this.vsShader=new t.GLSL.ShaderBase(null,this.usage);this.fsShader=new t.GLSL.ShaderBase(null,this.usage);this.setShader("wireframe_vertex","wireframe_fragment")}i.prototype.createFromGeometry=function(t){};i.prototype.createFromData=function(t){};i.prototype.createFromArray=function(t){};i.prototype.setVertexPos=function(t,e){var i=t*this.vertexLength;if(i+2>=this.vertexData.length){return}this.vertexData[i]=e.x;this.vertexData[i+1]=e.y;this.vertexData[i+2]=e.z};i.prototype.setShader=function(t,e){this.vsShader.addShader(t);this.fsShader.addShader(e);this.vsShaderSource=this.vsShader.getShaderSource();this.fsShaderSource=this.fsShader.getShaderSource()};i.prototype.draw=function(e,i){if(!this.usage.program3D)this.rebuild(e);e.enbable(e.gl.DEPTH_TEST);e.setBlendFactors(t.Egret3DDrive.ONE,t.Egret3DDrive.ZERO);e.setProgram(this.usage.program3D);e.bindVertexBuffer(this.vertexBuffer3D);e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,false,this.vertexBytes,0);e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,false,this.modelMatrix.rawData);e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,false,i.viewProjectionMatrix.rawData);if(this.isDrawLine){e.uniform4fv(this.uniform_color,[this.lineColor.x,this.lineColor.y,this.lineColor.z,this.lineColor.w]);e.drawArrays(t.DrawMode.LINES,0,this.vertexCount)}if(this.isDrawPoint){e.uniform4fv(this.uniform_color,[this.pointColor.x,this.pointColor.y,this.pointColor.z,this.pointColor.w]);e.uniform1f(this.uniform_pointSize,this.pointSize);e.drawArrays(t.DrawMode.POINTS,0,this.vertexCount)}};i.prototype.rebuild=function(t){var e=t.creatVertexShader(this.vsShaderSource);var i=t.creatFragmentShader(this.fsShaderSource);this.usage.program3D=t.creatProgram(e,i);if(this.usage.program3D){t.setProgram(this.usage.program3D)}if(!this.vertexBuffer3D){this.vertexBuffer3D=t.creatVertexBuffer(this.vertexData)}this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(this.usage.program3D,"attribute_position");this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(this.usage.program3D,"uniform_ModelMatrix");this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(this.usage.program3D,"uniform_ProjectionMatrix");this.uniform_color=t.getUniformLocation(this.usage.program3D,"uniform_color");this.uniform_pointSize=t.getUniformLocation(this.usage.program3D,"uniform_pointSize")};return i}(t.Object3D);t.WireframeBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this)}e.prototype.createFromData=function(t){if(t.length%3!=0){console.log("error: vertexData.length % 3 != 0");return}this.vertexData=[];this.vertexCount=0;this.vertexData=t.slice(0,t.length);this.vertexCount=this.vertexData.length/3};e.prototype.createFromArray=function(t){if(t.length%3!=0){console.log("error: vertexData.length % 3 != 0");return}this.vertexData=[];this.vertexCount=0;for(var e=0;e<t.length;++e){this.vertexData.push(t[e].x);this.vertexData.push(t[e].y);this.vertexData.push(t[e].z)}this.vertexCount=this.vertexData.length};return e}(t.WireframeBase);t.WireframeLine=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this)}i.prototype.createByMesh=function(t){this.createFromGeometry(t.geometry);t.addChild(this)};i.prototype.createFromGeometry=function(e){this.vertexData=[];this.vertexCount=0;var i=new t.Vector3D;var a=new t.Vector3D;var r=new t.Vector3D;for(var s=0;s<e.indexData.length/3;++s){var n=e.indexData[s*3+0];var o=e.indexData[s*3+1];var h=e.indexData[s*3+2];i.x=e.verticesData[n*e.vertexAttLength];i.y=e.verticesData[n*e.vertexAttLength+1];i.z=e.verticesData[n*e.vertexAttLength+2];a.x=e.verticesData[o*e.vertexAttLength];a.y=e.verticesData[o*e.vertexAttLength+1];a.z=e.verticesData[o*e.vertexAttLength+2];r.x=e.verticesData[h*e.vertexAttLength];r.y=e.verticesData[h*e.vertexAttLength+1];r.z=e.verticesData[h*e.vertexAttLength+2];this.vertexData.push(i.x,i.y,i.z,a.x,a.y,a.z,a.x,a.y,a.z,r.x,r.y,r.z,r.x,r.y,r.z,i.x,i.y,i.z);this.vertexCount+=6}};return i}(t.WireframeBase);t.WireframeMesh=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){if(e===void 0){e="postCanvas_vertex"}if(i===void 0){i="postCanvas_fragment"}this.rectangle=new t.Rectangle(0,0,0,0);this.distortion=false;this.distortionK1=.5;this.uniformDistortionK=new t.Vector3D;this.transformChange=true;this.position=new t.Vector3D;this.rotation=new t.Vector3D;this.scale=new t.Vector3D(1,1,1);this.px=0;this.py=0;this._viewMatrix=new t.Matrix4_4;this.setShader(e,i)}Object.defineProperty(e.prototype,"x",{get:function(){return this.rectangle.x},set:function(t){if(this.rectangle.x!=t){this.rectangle.x=t;this.transformChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"y",{get:function(){return this.rectangle.y},set:function(t){if(this.rectangle.y!=t){this.rectangle.y=t;this.transformChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"width",{get:function(){return this.rectangle.width},set:function(t){if(this.rectangle.width!=t){this.rectangle.width=t;this.transformChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"height",{get:function(){return this.rectangle.height},set:function(t){if(this.rectangle.height!=t){this.rectangle.height=t;this.transformChange=true}},enumerable:true,configurable:true});e.prototype.startWarped=function(){this.distortion=true;var t=0;var e=0;var i=Math.sqrt(this.viewPort.height/2*(this.viewPort.height/2)+this.viewPort.width/2*(this.viewPort.width/2));var a=this.viewPort.height/2/i;e=a/(a+this.distortionK1*a*a*a);var r=this.viewPort.width/2/i;t=r/(r+this.distortionK1*r*r*r);this.uniformDistortionK.x=this.distortionK1;this.uniformDistortionK.y=t;this.uniformDistortionK.z=e};e.prototype.setShader=function(e,i){this.usage=new t.MethodUsageData;this.vsShader=new t.GLSL.ShaderBase(null,this.usage);this.fsShader=new t.GLSL.ShaderBase(null,this.usage);this.vsShader.addShader(e);this.fsShader.addShader(i);this.vsShaderSource=this.vsShader.getShaderSource();this.fsShaderSource=this.fsShader.getShaderSource()};e.prototype.rebuild=function(t){var i=t.creatVertexShader(this.vsShaderSource);var a=t.creatFragmentShader(this.fsShaderSource);this.usage.program3D=t.creatProgram(i,a);if(this.usage.program3D){t.setProgram(this.usage.program3D)}if(!this.vertexBuffer3D){this.vertexBuffer3D=t.creatVertexBuffer(e.singleQuadData);this.indexBuffer3D=t.creatIndexBuffer(e.singleQuadIndex)}this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(this.usage.program3D,"attribute_position");this.usage.attribute_uv0.uniformIndex=t.getShaderAttribLocation(this.usage.program3D,"attribute_uv0");this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(this.usage.program3D,"uniform_ProjectionMatrix");if(this.distortion){this.distortionK1Register=t.getUniformLocation(this.usage.program3D,"_K")}if(this.usage.uniform_sceneWidth){this.usage.uniform_sceneWidth.uniformIndex=t.getUniformLocation(this.usage.program3D,this.usage.uniform_sceneWidth.varName)}if(this.usage.uniform_sceneHeight){this.usage.uniform_sceneHeight.uniformIndex=t.getUniformLocation(this.usage.program3D,this.usage.uniform_sceneHeight.varName)}var r;for(var s in this.usage.sampler2DList){r=this.usage.sampler2DList[s];r.uniformIndex=t.getUniformLocation(this.usage.program3D,r.varName)}var n;for(var s in this.usage.sampler3DList){n=this.usage.sampler3DList[s];n.uniformIndex=t.getUniformLocation(this.usage.program3D,n.varName)}};e.prototype.draw=function(e,i){this.viewPort=i;if(this.transformChange)this.notifyUpdate();if(!this.usage.program3D)this.rebuild(e);e.viewPort(i.x,i.y,i.width,i.height);e.disable(e.gl.DEPTH_TEST);e.disable(e.gl.BLEND);e.setProgram(this.usage.program3D);e.bindVertexBuffer(this.vertexBuffer3D);e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,false,20,0);e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,false,20,12);e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,false,this._viewMatrix.rawData);if(this.distortion){e.uniform3f(this.distortionK1Register,this.uniformDistortionK.x,this.uniformDistortionK.y,this.uniformDistortionK.z)}if(this.usage.uniform_sceneWidth){e.uniform1f(this.usage.uniform_sceneWidth.uniformIndex,this.viewPort.width)}if(this.usage.uniform_sceneHeight){e.uniform1f(this.usage.uniform_sceneHeight.uniformIndex,this.viewPort.height)}var a;for(var r in this.usage.sampler2DList){a=this.usage.sampler2DList[r];if(a.varName=="texture2D_1"){e.setTexture2DAt(a.activeTextureIndex,a.uniformIndex,a.index,this.texture.texture)}else if(a.varName=="texture2D_2"){e.setTexture2DAt(a.activeTextureIndex,a.uniformIndex,a.index,this.texture2.texture)}}e.drawElement(t.DrawMode.TRIANGLES,this.indexBuffer3D,0,6)};e.prototype.notifyUpdate=function(){this.transformChange=false;this._viewMatrix.identity();this.position.x=-1;this.position.y=1;this.scale.x=this.rectangle.width/this.viewPort.width*2;this.scale.y=this.rectangle.height/this.viewPort.height*2;this._viewMatrix.recompose([this.position,this.rotation,this.scale])};e.singleQuadData=[0,-1,0,0,0,1,-1,0,1,0,1,0,0,1,1,0,0,0,0,1];e.singleQuadIndex=[0,1,2,0,2,3];return e}();t.PostCanvas=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.rectangle=new t.Rectangle(0,0,0,0);this.anchor=new t.Vector3D(.5,.5);this.rotation=new t.Vector3D;this.r=1;this.g=1;this.b=1;this.a=1;this.uvRectangle=new t.Rectangle(0,0,1,1);this.rectangle.x=0;this.rectangle.y=0;this.rectangle.width=100;this.rectangle.height=100;this._viewMatrix=new t.Matrix4_4;this.quadShader=new i}Object.defineProperty(e.prototype,"x",{get:function(){return this.rectangle.x},set:function(t){this.rectangle.x=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"y",{get:function(){return this.rectangle.y},set:function(t){this.rectangle.y=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"width",{get:function(){return this.rectangle.width},set:function(t){this.rectangle.width=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"height",{get:function(){return this.rectangle.height},set:function(t){this.rectangle.height=t},enumerable:true,configurable:true});e.prototype.rebuild=function(t){var i=t.creatVertexShader(this.quadShader.vertexShaderSource);var a=t.creatFragmentShader(this.quadShader.fragmentShaderSource);this.shaderProgram=t.creatProgram(i,a);if(this.shaderProgram){
t.setProgram(this.shaderProgram)}if(!this.vertexBuffer3D){this.vertexBuffer3D=t.creatVertexBuffer(e.singleQuadData);this.indexBuffer3D=t.creatIndexBuffer(e.singleQuadIndex)}this.posAtt=t.getShaderAttribLocation(this.shaderProgram,"aVertexPosition");this.uvAtt=t.getShaderAttribLocation(this.shaderProgram,"aTextureCoord");this.viewMatIndex=t.getUniformLocation(this.shaderProgram,"viewProjectionMatrix");this.uiDataIndex=t.getUniformLocation(this.shaderProgram,"uiDatas");this.textureIndex=t.getUniformLocation(this.shaderProgram,"diffuseTexture");this.materialDataIndex=t.getUniformLocation(this.shaderProgram,"materialData")};e.prototype.draw=function(e){if(!this.shaderProgram)this.rebuild(e);this.viewPort=t.Egret3DDrive.canvasRectangle;this._viewMatrix.identity();var i=new t.Matrix4_4;this._viewMatrix.appendRotation(this.rotation.z,t.Vector3D.Z_AXIS);i.appendScale(this.rectangle.width/this.viewPort.width*2,this.rectangle.height/this.viewPort.height*2,1);this._viewMatrix.append(i);var a=(this.viewPort.width-(this.rectangle.x+this.rectangle.width/2)*2)*(1/this.viewPort.width);var r=(this.viewPort.height-(this.rectangle.y+this.rectangle.height/2)*2)*(1/this.viewPort.height);this._viewMatrix.appendTranslation(-a,r,0);e.setProgram(this.shaderProgram);e.bindVertexBuffer(this.vertexBuffer3D);e.vertexAttribPointer(this.shaderProgram,this.posAtt,3,t.Egret3DDrive.FLOAT,false,20,0);e.vertexAttribPointer(this.shaderProgram,this.uvAtt,2,t.Egret3DDrive.FLOAT,false,20,12);e.uniformMatrix4fv(this.viewMatIndex,false,this._viewMatrix.rawData);this.texture.upload(e);e.setTexture2DAt(t.ContextSamplerType.TEXTURE_0,this.textureIndex,0,this.texture.texture);e.uniform4fv(this.materialDataIndex,[this.r,this.g,this.b,this.a]);e.enbable(t.Egret3DDrive.BLEND);e.setBlendFactors(t.Egret3DDrive.SRC_ALPHA,t.Egret3DDrive.ONE_MINUS_SRC_ALPHA);e.drawElement(t.DrawMode.TRIANGLES,this.indexBuffer3D,0,6);e.gl.clear(t.Egret3DDrive.DEPTH_BUFFER_BIT)};e.singleQuadData=[-.5,-.5,0,0,1,.5,-.5,0,1,1,.5,.5,0,1,0,-.5,.5,0,0,0];e.singleQuadIndex=[0,1,2,0,2,3];return e}();t.HUD=e;var i=function(){function t(){this.vertexShaderSource="";this.fragmentShaderSource="";this.vertexShaderSource="precision mediump float; \n";this.vertexShaderSource+=" attribute vec3 aVertexPosition;                                                                       \n ";this.vertexShaderSource+=" attribute vec2 aTextureCoord;                                                                         \n ";this.vertexShaderSource+="                                                                                                       \n ";this.vertexShaderSource+=" varying  vec2 vTextureCoord;                                                                      \n ";this.vertexShaderSource+=" uniform  mat4 viewProjectionMatrix;                                                                      \n ";this.vertexShaderSource+=" uniform  vec4 uiDatas[116];                                                                      \n ";this.vertexShaderSource+="  void main(void) {                                                                                      \n ";this.vertexShaderSource+="     vec4 pos = vec4(aVertexPosition.xyz, 1.0) ;                                    \n ";this.vertexShaderSource+="     gl_Position = viewProjectionMatrix * pos;                                    \n ";this.vertexShaderSource+="     vTextureCoord = aTextureCoord ;                                                                       \n ";this.vertexShaderSource+=" }                                                                                                     \n ";this.fragmentShaderSource=" precision mediump float; \n";this.fragmentShaderSource+=" varying  vec2 vTextureCoord;                                                                      \n ";this.fragmentShaderSource+=" uniform sampler2D diffuseTexture;                                                                      \n ";this.fragmentShaderSource+=" uniform vec4 materialData;                                                                      \n ";this.fragmentShaderSource+="  void main(void) {                                                                                      \n ";this.fragmentShaderSource+="      vec4 color  = texture2D(diffuseTexture,vTextureCoord) * materialData ;                                    \n ";this.fragmentShaderSource+="      gl_FragColor  = color;                                    \n ";this.fragmentShaderSource+="}                        \n "}return t}()})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.rec=new t.Rectangle}e.prototype.init=function(e,i,a){this.nextFrameBuffer=t.RttManager.creatFrameBuffer(t.FrameBufferType.defaultFrameBuffer,e,i,a,t.FrameBufferFormat.UNSIGNED_BYTE_RGB);this.rec.width=i;this.rec.height=a};e.prototype.drawToTarget=function(t,e,i,a){};return e}();t.PostEffectBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.postCanvas=new t.PostCanvas("postCanvas_vertex","BrightPassFilter")}i.prototype.drawToTarget=function(t,e,i,a){i.setRenderToTexture(this.nextFrameBuffer.texture.texture,true,0);this.postCanvas.width=this.rec.width;this.postCanvas.height=this.rec.height;this.postCanvas.texture=e.texture;this.postCanvas.draw(i,this.rec)};return i}(t.PostEffectBase);t.BrightPost=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.postCanvas=new t.PostCanvas("postCanvas_vertex","GaussianBlurHorizontal")}i.prototype.drawToTarget=function(t,e,i,a){i.setRenderToTexture(this.nextFrameBuffer.texture.texture,true,0);this.postCanvas.width=this.rec.width;this.postCanvas.height=this.rec.height;this.postCanvas.texture=e.texture;this.postCanvas.draw(i,this.rec)};return i}(t.PostEffectBase);t.GaussianBlurHorizontalPost=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.postCanvas=new t.PostCanvas("postCanvas_vertex","GaussianBlurVertical")}i.prototype.drawToTarget=function(t,e,i,a){i.setRenderToTexture(this.nextFrameBuffer.texture.texture,true,0);this.postCanvas.width=this.rec.width;this.postCanvas.height=this.rec.height;this.postCanvas.texture=e.texture;this.postCanvas.draw(i,this.rec)};return i}(t.PostEffectBase);t.GaussianBlurVerticalPost=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.postCanvas=new t.PostCanvas("postCanvas_vertex","Composition")}i.prototype.drawToTarget=function(t,e,i,a){i.setRenderToTexture(this.nextFrameBuffer.texture.texture,true,0);this.postCanvas.width=this.rec.width;this.postCanvas.height=this.rec.height;this.postCanvas.texture=e.texture;this.postCanvas.texture2=t.texture;this.postCanvas.draw(i,this.rec)};return i}(t.PostEffectBase);t.Composition=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.postCanvas=new t.PostCanvas("postCanvas_vertex","Tonemaping")}i.prototype.drawToTarget=function(t,e,i,a){this.postCanvas.width=this.rec.width;this.postCanvas.height=this.rec.height;this.postCanvas.texture=t.texture;this.postCanvas.texture2=e.texture;this.postCanvas.draw(i,this.rec)};return i}(t.PostEffectBase);t.Tonemaping=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.lumAdapt=0;this.lum=1;this.brightPost=new t.BrightPost;this.gaussianBlurHorizontalPost=new t.GaussianBlurHorizontalPost;this.gaussianBlurVerticalPost=new t.GaussianBlurVerticalPost;this.composition=new t.Composition;this.toneMap=new t.Tonemaping}i.prototype.init=function(t,e,i){this.brightPost.init(t,e,i);this.gaussianBlurHorizontalPost.init(t,e,i);this.gaussianBlurVerticalPost.init(t,e,i);this.composition.init(t,e,i);this.toneMap.init(t,e,i)};i.prototype.drawToTarget=function(t,e,i,a){this.lumAdapt+=(this.lum-this.lumAdapt)*(1-Math.pow(.98,30*16));var r=t;this.brightPost.drawToTarget(t,r,i,a);r=this.brightPost.nextFrameBuffer;this.nextFrameBuffer=this.brightPost.nextFrameBuffer;this.gaussianBlurHorizontalPost.drawToTarget(t,r,i,a);r=this.gaussianBlurHorizontalPost.nextFrameBuffer;this.gaussianBlurVerticalPost.drawToTarget(t,r,i,a);r=this.gaussianBlurVerticalPost.nextFrameBuffer;this.nextFrameBuffer=r;this.composition.drawToTarget(t,r,i,a);this.nextFrameBuffer=this.composition.nextFrameBuffer;i.setRenderToBackBuffer()};return i}(t.PostEffectBase);t.HDR=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){if(i===void 0){i=null}this._width=0;this._height=0;this._x=0;this._y=0;this._localPos=new t.Point;this._globalPos=new t.Point;this._aspectRatio=1;this._scissorRectDirty=true;this._viewportDirty=true;this._viewPortMatrix=new t.Matrix4_4;this._useShadow=false;this._isDeferred=false;this._resizeFuncs=new Array;this._wireframeList=new Array;this._hudList=new Array;this._context3D=t.Egret3DDrive.context3D;this._camera=i||new t.Camera3D(t.CameraType.perspective);this._scissorRect=new t.Rectangle;this._viewPort=e;this._scene=new t.Scene3D;this._render=t.RenderManager.getRender(t.RenderType.defaultRender);this.x=e.x;this.y=e.y;this.width=e.width;this.height=e.height;this._mouseEventManager=new t.Mouse3DManager(this._camera)}Object.defineProperty(e.prototype,"root",{get:function(){return this._scene},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t},enumerable:true,configurable:true});e.prototype.resize=function(e,i,a,r){this.x=this.viewPort.x=e;this.y=this.viewPort.y=i;this.width=this.viewPort.width=a;this.height=this.viewPort.height=r;t.Egret3DDrive.canvas.width=this.viewPort.width;t.Egret3DDrive.canvas.height=this.viewPort.height;t.Egret3DDrive.canvasRectangle.x=this.x;t.Egret3DDrive.canvasRectangle.y=this.y;t.Egret3DDrive.canvasRectangle.width=this.width;t.Egret3DDrive.canvasRectangle.height=this.height;if(this._backImg){this._backImg.x=e;this._backImg.y=i;this._backImg.width=a;this._backImg.height=r}this.updateViewSizeData()};Object.defineProperty(e.prototype,"render",{set:function(t){this._render=t;if(typeof t==="GBufferRender"){this._isDeferred=true}else{this._isDeferred=false}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"useShadow",{get:function(){return this._useShadow},set:function(e){this._useShadow=e;if(e){this._shadowRender=new t.ShadowRender}},enumerable:true,configurable:true});e.prototype.requestFrameBuffer=function(){if(this._isDeferred){}else{this._postCanvas=new t.PostCanvas}};e.prototype.addListenerResize=function(t){this._resizeFuncs.push(t)};Object.defineProperty(e.prototype,"viewPort",{get:function(){return this._viewPort},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"sky",{get:function(){return this._sky},set:function(t){this._sky=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"sphereSky",{set:function(t){this._sphereSky=t},enumerable:true,configurable:true});e.prototype.addHUD=function(t){if(this._hudList.indexOf(t)==-1)this._hudList.push(t)};e.prototype.delHUD=function(t){var e=this._hudList.indexOf(t);if(e>=0)this._hudList.splice(e,1)};e.prototype.hasHUD=function(t){return this._hudList.indexOf(t)>=0};e.prototype.addWireframe=function(t){this._wireframeList.push(t)};e.prototype.delWireframe=function(t){var e=this._wireframeList.indexOf(t);this._wireframeList.splice(e,1)};Object.defineProperty(e.prototype,"backImageTexture",{set:function(e){if(!this._backImg){this._backImg=new t.HUD;this._backImg.x=0;this._backImg.y=0;this._backImg.width=this.width;this._backImg.height=this.height}e.upload(this._context3D);this._backImg.texture=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"postEffect",{set:function(e){if(e){this._postCanvas=this._postCanvas||new t.PostCanvas;this._postList=e;for(var i=0;i<this._postList.length;i++){this._postList[i].init(this._context3D,512,512)}this._sourceFrameBuffer=this._sourceFrameBuffer||t.RttManager.creatFrameBuffer(t.FrameBufferType.defaultFrameBuffer,this._context3D,512,512,t.FrameBufferFormat.UNSIGNED_BYTE_RGB)}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"camera3D",{get:function(){return this._camera},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"context3D",{get:function(){return this._context3D},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t;this._aspectRatio=this._width/this._height;this._camera.aspectRatio=this._aspectRatio;this._scissorRect.width=t;this._scissorRectDirty=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t;this._aspectRatio=this._width/this._height;this._camera.aspectRatio=this._aspectRatio;this._scissorRect.height=t;this._scissorRectDirty=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(t){if(this._x==t)return;this._localPos.x=this._x=t;this._globalPos.x=t;this._globalPosDirty=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(t){if(this._y==t)return;this._localPos.y=t;this._globalPos.y=t;this._globalPosDirty=true},enumerable:true,configurable:true});e.prototype.addChild3D=function(t){this._scene.addChild(t)};e.prototype.delChild3D=function(t){this._scene.removeChild(t)};e.prototype.hasChild3D=function(t){return this._scene.childs.indexOf(t)>=0};e.prototype.update=function(e,i){this.updateViewSizeData();this._scene.collect.update(this._camera);this._mouseEventManager.update(this._scene.collect);this._context3D.gl.enable(t.Egret3DDrive.BLEND);this._context3D.gl.enable(t.Egret3DDrive.CULL_FACE);this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);this._context3D.clear(0,0,0,1);if(this._backImg)this._backImg.draw(this._context3D);this._context3D.clearDepth(1);this._context3D.clearStencil(0);if(!this._isDeferred){if(this._postList){if(this._useShadow){t.RttManager.drawToTexture(e,i,t.ShadowRender.frameBuffer.texture.texture,this._context3D,this._shadowRender,this._scene.collect,this._camera,this.viewPort)}if(this._sky){this._sky.draw(this._context3D,this.camera3D)}else if(this._sphereSky){this._sphereSky.draw(this._context3D,this.camera3D)}t.RttManager.drawToTexture(e,i,this._sourceFrameBuffer.texture.texture,this._context3D,this._render,this._scene.collect,this._camera,this.viewPort);this._context3D.clearDepth(1);var a=this._sourceFrameBuffer;for(var r=0;r<this._postList.length;r++){this._postList[r].drawToTarget(this._sourceFrameBuffer,a,this._context3D,this._viewPort);a=this._postList[r].nextFrameBuffer}this._postCanvas.width=this._viewPort.width;this._postCanvas.height=this._viewPort.height;this._postCanvas.texture=a.texture;this._postCanvas.draw(this._context3D,this._viewPort)}else{if(this._sky){this._sky.draw(this._context3D,this.camera3D)}else if(this._sphereSky){this._sphereSky.draw(this._context3D,this.camera3D)}if(this._useShadow){t.RttManager.drawToTexture(e,i,t.ShadowRender.frameBuffer.texture.texture,this._context3D,this._shadowRender,this._scene.collect,this._camera,this.viewPort)}this._context3D.clearDepth(1);this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);this._render.draw(e,i,this._context3D,this._scene.collect,this._camera,this._viewPort)}}else{this._context3D.clearDepth(1);this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);this._render.draw(e,i,this._context3D,this._scene.collect,this._camera,this._viewPort)}for(var r=0;r<this._wireframeList.length;r++){this._wireframeList[r].draw(this._context3D,this.camera3D)}for(var r=0;r<this._hudList.length;r++){this._hudList[r].draw(this._context3D)}this._context3D.gl.finish()};e.prototype.updateViewSizeData=function(){this._camera.aspectRatio=this._aspectRatio;if(this._scissorRectDirty){this._scissorRectDirty=false;this._camera.updateScissorRect(this._scissorRect.x,this._scissorRect.y,this._scissorRect.width,this._scissorRect.height)}if(this._viewportDirty){this._viewportDirty=false;this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height)}};e.prototype.setTags=function(t,e){this._scene.collect.setTags(t,e)};e.prototype.setTagsItem=function(t,e){this._scene.collect.setTagsItem(t,e)};e.prototype.getTagLayer=function(t,e){if(t===void 0){t="default"}if(e===void 0){e="layer_0"}return this._scene.collect.getTagLayer(t,e)};e.prototype.getTag=function(t){if(t===void 0){t="default"}return this._scene.collect.getTag(t)};return e}();t.View3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i,new t.Camera3D(t.CameraType.VR));this.leftViewPort=new t.Rectangle;this.rightViewPort=new t.Rectangle;this.tab=false;this.eyeMatrix=new t.EyesMatrix;this.leftViewPort.x=this.viewPort.x;this.leftViewPort.y=this.viewPort.y;this.leftViewPort.width=this.viewPort.width;this.leftViewPort.height=this.viewPort.height;this.rightViewPort.x=this.leftViewPort.width;this.rightViewPort.y=this.viewPort.y;this.rightViewPort.width=this.viewPort.width*.5;this.rightViewPort.height=this.viewPort.height;this.setupVR()}i.prototype.requestFrameBuffer=function(){};i.prototype.setupVR=function(){if(this._isDeferred){}else{this._leftCanvas=new t.PostCanvas("postCanvas_vertex","warpedImage_fragment");this._rightCanvas=new t.PostCanvas("postCanvas_vertex","warpedImage_fragment");this._leftCanvas.rectangle.x=0;this._leftCanvas.rectangle.y=0;this._leftCanvas.rectangle.width=480;this._leftCanvas.rectangle.height=480/512*this.viewPort.height;this._rightCanvas.rectangle.x=480+30;this._rightCanvas.rectangle.y=0;this._rightCanvas.rectangle.width=480;this._rightCanvas.rectangle.height=480/512*this.viewPort.height;this._leftCanvas.startWarped();this._rightCanvas.startWarped();this._leftFrameBuffer=t.RttManager.creatFrameBuffer(t.FrameBufferType.leftEyeFrameBuffer,this._context3D,1024,1024,t.FrameBufferFormat.UNSIGNED_BYTE_RGB);this._rightFrameBuffer=t.RttManager.creatFrameBuffer(t.FrameBufferType.rightEyeFrameBuffer,this._context3D,1024,1024,t.FrameBufferFormat.UNSIGNED_BYTE_RGB)}};i.prototype.setEyesSpace=function(t){this._leftCanvas.x=75;this._leftCanvas.y=0;this._leftCanvas.width=512;this._leftCanvas.height=512;this._rightCanvas.x=75;this._rightCanvas.y=512+t;this._rightCanvas.width=512;this._rightCanvas.height=512};i.prototype.update=function(i,a){e.prototype.updateViewSizeData.call(this);this._scene.collect.update(this._camera);this._context3D.gl.enable(t.Egret3DDrive.BLEND);this._context3D.gl.enable(t.Egret3DDrive.CULL_FACE);this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);this._context3D.clear(0,0,0,1);this.leftEye(i,a);this.rightEye(i,a);this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);this._leftCanvas.texture=this._leftFrameBuffer.texture;this._rightCanvas.texture=this._leftFrameBuffer.texture;this._leftCanvas.draw(this._context3D,this._viewPort);this._rightCanvas.draw(this._context3D,this._viewPort);for(var r=0;r<this._hudList.length;r++){this._hudList[r].draw(this._context3D)}this._context3D.gl.finish()};i.prototype.leftEye=function(e,i){this._context3D.viewPort(this.leftViewPort.x,this.leftViewPort.y,this.leftViewPort.width,this.leftViewPort.height);this._camera.tap(t.CameraType.VR,t.VRType.left);this._context3D.setRenderToTexture(this._leftFrameBuffer.texture.texture,true,0);if(this._sky){this._sky.draw(this._context3D,this.camera3D)}if(this._sphereSky){this._sphereSky.draw(this._context3D,this.camera3D)}this._context3D.clearDepth(1);this._render.draw(e,i,this._context3D,this._scene.collect,this._camera,this._viewPort);this._context3D.setRenderToBackBuffer()};i.prototype.rightEye=function(e,i){this._context3D.viewPort(this.rightViewPort.x,this.rightViewPort.y,this.rightViewPort.width,this.rightViewPort.height);this._camera.tap(t.CameraType.VR,t.VRType.right);this._context3D.setRenderToTexture(this._rightFrameBuffer.texture.texture,true,0);if(this._sky){this._sky.draw(this._context3D,this.camera3D)}if(this._sphereSky){this._sphereSky.draw(this._context3D,this.camera3D)}this._context3D.clearDepth(1);this._render.draw(e,i,this._context3D,this._scene.collect,this._camera,this._viewPort);this._context3D.setRenderToBackBuffer()};return i}(t.View3D);t.VRView3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["Key_BackSpace"]=8]="Key_BackSpace";t[t["Key_Tab"]=9]="Key_Tab";t[t["Key_Clear"]=10]="Key_Clear";t[t["Key_Enter"]=11]="Key_Enter";t[t["Key_Shift_L"]=12]="Key_Shift_L";t[t["Key_Control_L"]=13]="Key_Control_L";t[t["Key_Alt_L"]=14]="Key_Alt_L";t[t["Key_Pause"]=15]="Key_Pause";t[t["Key_CapsLock"]=16]="Key_CapsLock";t[t["Key_Escape"]=17]="Key_Escape";t[t["Key_Space"]=18]="Key_Space";t[t["Key_Prior"]=19]="Key_Prior";t[t["Key_Next"]=20]="Key_Next";t[t["Key_End"]=21]="Key_End";t[t["Key_Home"]=22]="Key_Home";t[t["Key_Left"]=23]="Key_Left";t[t["Key_Up"]=24]="Key_Up";t[t["Key_Right"]=25]="Key_Right";t[t["Key_Down"]=26]="Key_Down";t[t["Key_Select"]=27]="Key_Select";t[t["Key_Print"]=28]="Key_Print";t[t["Key_Execute"]=29]="Key_Execute";t[t["Key_Insert"]=30]="Key_Insert";t[t["Key_Delete"]=31]="Key_Delete";t[t["Key_Help"]=32]="Key_Help";t[t["Key_0"]=48]="Key_0";t[t["Key_1"]=49]="Key_1";t[t["Key_2"]=50]="Key_2";t[t["Key_3"]=51]="Key_3";t[t["Key_4"]=52]="Key_4";t[t["Key_5"]=53]="Key_5";t[t["Key_6"]=54]="Key_6";t[t["Key_7"]=55]="Key_7";t[t["Key_8"]=56]="Key_8";t[t["Key_9"]=57]="Key_9";t[t["Key_A"]=65]="Key_A";t[t["Key_B"]=66]="Key_B";t[t["Key_C"]=67]="Key_C";t[t["Key_D"]=68]="Key_D";t[t["Key_E"]=69]="Key_E";t[t["Key_F"]=70]="Key_F";t[t["Key_G"]=71]="Key_G";t[t["Key_H"]=72]="Key_H";t[t["Key_I"]=73]="Key_I";t[t["Key_J"]=74]="Key_J";t[t["Key_K"]=75]="Key_K";t[t["Key_L"]=76]="Key_L";t[t["Key_M"]=77]="Key_M";t[t["Key_N"]=78]="Key_N";t[t["Key_O"]=79]="Key_O";t[t["Key_P"]=80]="Key_P";t[t["Key_Q"]=81]="Key_Q";t[t["Key_R"]=82]="Key_R";t[t["Key_S"]=83]="Key_S";t[t["Key_T"]=84]="Key_T";t[t["Key_U"]=85]="Key_U";t[t["Key_V"]=86]="Key_V";t[t["Key_W"]=87]="Key_W";t[t["Key_X"]=88]="Key_X";t[t["Key_Y"]=89]="Key_Y";t[t["Key_Z"]=90]="Key_Z";t[t["Key_KP_0"]=96]="Key_KP_0";t[t["Key_KP_1"]=97]="Key_KP_1";t[t["Key_KP_2"]=98]="Key_KP_2";t[t["Key_KP_3"]=99]="Key_KP_3";t[t["Key_KP_4"]=100]="Key_KP_4";t[t["Key_KP_5"]=101]="Key_KP_5";t[t["Key_KP_6"]=102]="Key_KP_6";t[t["Key_KP_7"]=103]="Key_KP_7";t[t["Key_KP_8"]=104]="Key_KP_8";t[t["Key_KP_9"]=105]="Key_KP_9";t[t["Key_Multiply"]=106]="Key_Multiply";t[t["Key_Add"]=107]="Key_Add";t[t["Key_Separator"]=108]="Key_Separator";t[t["Key_Subtract"]=109]="Key_Subtract";t[t["Key_Decimal"]=110]="Key_Decimal";t[t["Key_Divide"]=111]="Key_Divide";t[t["Key_F1"]=112]="Key_F1";t[t["Key_F2"]=113]="Key_F2";t[t["Key_F3"]=114]="Key_F3";t[t["Key_F4"]=115]="Key_F4";t[t["Key_F5"]=116]="Key_F5";t[t["Key_F6"]=117]="Key_F6";t[t["Key_F7"]=118]="Key_F7";t[t["Key_F8"]=119]="Key_F8";t[t["Key_F9"]=120]="Key_F9";t[t["Key_F10"]=121]="Key_F10";t[t["Key_F11"]=122]="Key_F11";t[t["Key_F12"]=123]="Key_F12";t[t["Key_F13"]=124]="Key_F13";t[t["Key_F14"]=125]="Key_F14";t[t["Key_F15"]=126]="Key_F15";t[t["Key_F16"]=127]="Key_F16";t[t["Key_F17"]=128]="Key_F17";t[t["Key_F18"]=129]="Key_F18";t[t["Key_F19"]=130]="Key_F19";t[t["Key_F20"]=131]="Key_F20";t[t["Key_F21"]=132]="Key_F21";t[t["Key_F22"]=133]="Key_F22";t[t["Key_F23"]=134]="Key_F23";t[t["Key_F24"]=135]="Key_F24";t[t["Key_Num_Lock"]=136]="Key_Num_Lock";t[t["Key_Scroll_Lock"]=137]="Key_Scroll_Lock";t[t["Key_Mouse_Left"]=256]="Key_Mouse_Left";t[t["Key_Mouse_Right"]=257]="Key_Mouse_Right";t[t["Key_Mouse_Mid"]=258]="Key_Mouse_Mid"})(t.KeyCode||(t.KeyCode={}));var e=t.KeyCode;var i=function(){function i(){var e=this;this.mouseX=0;this.mouseY=0;this.wheelDelta=0;this.mouseOffsetX=0;this.mouseOffsetY=0;this.mouseLastX=0;this.mouseLastY=0;this._time=0;this._keyStatus={};this._listenerKeyClick=new Array;this._listenerKeyUp=new Array;this._listenerKeyDown=new Array;this._listenerSwipe=null;this._mouseMoveFunc=new Array;this._mouseWheelFunc=new Array;this._ondeviceorientation=new Array;this._ondevicemotion=new Array;this._listenerGamepadButtons=new Array;this._touchStartCallback=new Array;this._touchEndCallback=new Array;this._touchMoveCallback=new Array;this.onGamepadStick1=null;this.onGamepadStick2=null;this.rotation=new t.Vector3D;this._acceleration=new t.Vector3D;this.gravity=new t.Vector3D;this.quadrant=0;this._gp=false;this._first=true;this._initAngle=new t.Vector3D;this._oldPosition1=null;this._oldPosition2=null;window.onmousewheel=function(t){return e.mouseWheel(t)};window.onmousedown=function(t){return e.mouseStart(t)};window.onmouseup=function(t){return e.mouseEnd(t)};window.onmousemove=function(t){return e.mouseMove(t)};window.onkeydown=function(t){return e.keyDown(t)};window.onkeyup=function(t){return e.keyUp(t)};if(this.canGame()){window.addEventListener("gamepadconnected",function(t){return e.ongamepadconnected(t)});window.addEventListener("gamepaddisconnected",function(t){return e.ongamepaddisconnected(t)})}window.ontouchstart=function(t){return e.touchStart(t)};window.ontouchend=function(t){return e.touchEnd(t)};window.ontouchmove=function(t){return e.touchMove(t)};window.ontouchcancel=function(t){return e.touchEnd(t)};window.addEventListener("deviceorientation",function(t){return e.ondeviceorientation(t)});window.addEventListener("devicemotion",function(t){return e.detectShake(t)})}Object.defineProperty(i,"instance",{get:function(){if(this._instance==null){this._instance=new i}return this._instance},enumerable:true,configurable:true});i.prototype.addTouchStartCallback=function(t){this._touchStartCallback.push(t)};i.prototype.addTouchEndCallback=function(t){this._touchEndCallback.push(t)};i.prototype.addTouchMoveCallback=function(t){this._touchMoveCallback.push(t)};i.prototype.ongamepaddisconnected=function(e){t.Debug.instance.trace("Gamepad disconnected!");this._gp=false};i.prototype.ongamepadconnected=function(e){t.Debug.instance.trace("Gamepad connected!");this._gp=true};i.prototype.getGamepadButtonState=function(t){return navigator.getGamepads()[0].buttons[t].pressed};i.prototype.getGamepadStick1=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[0],navigator.getGamepads()[0].axes[1],0)};i.prototype.getGamepadStick2=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[2],navigator.getGamepads()[0].axes[3],0)};i.prototype.canGame=function(){return"getGamepads"in navigator};i.prototype.reportOnGamepad=function(){if(this.canGame()&&this._gp){if(this.onGamepadStick1!=null){this.onGamepadStick1(this.getGamepadStick1())}if(this.onGamepadStick2!=null){this.onGamepadStick2(this.getGamepadStick2())}for(var t=0;t<this._listenerGamepadButtons.length;++t){this._listenerGamepadButtons[t](this.getGamepadButtonState(t))}}};i.prototype.printout=function(){var e="";e+="id: "+navigator.getGamepads()[0].id+"<br/>";var i=navigator.getGamepads()[0].buttons.length;for(var a=0;a<i;a++){e+="Button "+(a+1)+": ";if(this.getGamepadButtonState(a))e+=" pressed";e+="<br/>"}var r=this.getGamepadStick1();e+="Stick 1"+": "+r.x+","+r.y+"<br/>";r=this.getGamepadStick2();e+="Stick 2"+": "+r.x+","+r.y+"<br/>";t.Debug.instance.trace(e)};i.prototype.detectShake=function(t){var e=t.acceleration;if(e.x>1.5||e.y>1.5||e.z>1.5){}else{}if(this._ondevicemotion&&this._ondevicemotion.length>0){var i=Math.ceil(e.x*1e3)/1e3;var a=Math.ceil(e.y*1e3)/1e3;var r=Math.ceil(e.z*1e3)/1e3;this._ondevicemotion[0](i,a,r)}};i.prototype.ondeviceorientation=function(t){if(this._ondeviceorientation&&this._ondeviceorientation.length>0){var e=Math.round(t.alpha*100)*.01;var i=Math.round(t.beta*100)*.01;var a=Math.round(t.gamma*100)*.01;if(this._first){this._initAngle["x"]=e;this._initAngle["y"]=i;this._initAngle["z"]=a}this._delayX=e-this._caheX;this._delayY=i-this._caheY;this._delayZ=a-this._caheZ;this._caheX=e;this._caheY=i;this._caheZ=a;this._initAngle.x+=this._delayX;this._initAngle.y+=this._delayY;this._initAngle.z+=this._delayZ;this._ondeviceorientation[0](this._initAngle)}};i.prototype.onorientationchange=function(t){};i.prototype.onPinch=function(e,i,a,r){this._oldPosition1=new t.Point(e,i);this._oldPosition2=new t.Point(a,r)};i.prototype.onSwipe=function(t,i){this.mouseX=t;this.mouseY=i;this._oldPosition1=null;this._oldPosition2=null;this._time=(new Date).getTime();for(var a=0;a<this._listenerKeyDown.length;++a){this._listenerKeyDown[a](e.Key_Mouse_Left)}};i.prototype.touchStart=function(e){e.preventDefault();var i=e.targetTouches[0].clientX-t.Egret3DDrive.clientRect.left;var a=e.targetTouches[0].clientY-t.Egret3DDrive.clientRect.top;if(e.targetTouches.length==2){var r=e.targetTouches[1].clientX-t.Egret3DDrive.clientRect.left;var s=e.targetTouches[1].clientY-t.Egret3DDrive.clientRect.top;this.onPinch(i,a,r,s)}else if(e.targetTouches.length==1){this.onSwipe(i,a)}for(var n=0;n<this._touchStartCallback.length;n++){this._touchStartCallback[n](e)}};i.prototype.touchEnd=function(i){if(i.targetTouches.length>1){var a=i.targetTouches[0].clientX-t.Egret3DDrive.clientRect.left;var r=i.targetTouches[0].clientY-t.Egret3DDrive.clientRect.top;var s=i.targetTouches[1].clientX-t.Egret3DDrive.clientRect.left;var n=i.targetTouches[1].clientY-t.Egret3DDrive.clientRect.top;this.onPinch(a,r,s,n)}else if(i.targetTouches.length==1){this.onSwipe(i.targetTouches[0].clientX-t.Egret3DDrive.clientRect.left,i.targetTouches[0].clientY-t.Egret3DDrive.clientRect.top)}else{this._oldPosition1=null;this._oldPosition2=null;this._time=0;for(var o=0;o<this._listenerKeyUp.length;++o){this._listenerKeyUp[o](e.Key_Mouse_Left)}}for(var o=0;o<this._touchEndCallback.length;o++){this._touchEndCallback[o](i)}};i.prototype.touchMove=function(e){this.mouseLastX=this.mouseX;this.mouseLastY=this.mouseY;this.mouseX=e.targetTouches[0].clientX-t.Egret3DDrive.clientRect.left;this.mouseY=e.targetTouches[0].clientY-t.Egret3DDrive.clientRect.top;this.mouseOffsetX=this.mouseX-this.mouseLastX;this.mouseOffsetY=this.mouseY-this.mouseLastY;e.preventDefault();if(e.targetTouches.length>1){var i=new t.Point(this.mouseX,this.mouseY);var a=new t.Point(e.targetTouches[1].clientX-t.Egret3DDrive.clientRect.left,e.targetTouches[1].clientY-t.Egret3DDrive.clientRect.top);if(this._oldPosition1==null)this._oldPosition1=i;if(this._oldPosition2==null)this._oldPosition2=a;if(this.isEnlarge(this._oldPosition1,this._oldPosition2,i,a))this.wheelDelta=120;else this.wheelDelta=-120;this._oldPosition1=i;this._oldPosition2=a;for(var r=0;r<this._mouseWheelFunc.length;++r){this._mouseWheelFunc[r]()}}else{this._listenerSwipe()}for(var r=0;r<this._touchMoveCallback.length;r++){this._touchMoveCallback[r](e)}};i.prototype.addListenerMouseMove=function(t){this._mouseMoveFunc.push(t)};i.prototype.addListenerMouseWheel=function(t){this._mouseWheelFunc.push(t)};i.prototype.addListenerKeyClick=function(t){this._listenerKeyClick.push(t)};i.prototype.addListenerKeyUp=function(t){this._listenerKeyUp.push(t)};i.prototype.addListenerKeyDown=function(t){this._listenerKeyDown.push(t)};i.prototype.addListenerSwipe=function(t){this._listenerSwipe=t};i.prototype.addListenerDeviceorientation=function(t){this._ondeviceorientation.push(t)};i.prototype.addListenerDevicemotion=function(t){this._ondevicemotion.push(t)};i.prototype.addListenerGamePadButtons=function(t){this._listenerGamepadButtons.push(t)};i.prototype.mouseEnd=function(i){this.mouseX=i.clientX-t.Egret3DDrive.clientRect.left;this.mouseY=i.clientY-t.Egret3DDrive.clientRect.top;var a=0;switch(i.button){case 0:a=e.Key_Mouse_Left;break;case 2:a=e.Key_Mouse_Right;break;case 1:a=e.Key_Mouse_Mid;break}if(a!=0){if(this._keyStatus[a]){for(var r=0;r<this._listenerKeyClick.length;++r){
this._listenerKeyClick[r](a)}}this._keyStatus[a]=false;for(var r=0;r<this._listenerKeyUp.length;++r){this._listenerKeyUp[r](a)}}};i.prototype.mouseStart=function(i){this.mouseX=i.clientX-t.Egret3DDrive.clientRect.left;this.mouseY=i.clientY-t.Egret3DDrive.clientRect.top;var a=0;switch(i.button){case 0:a=e.Key_Mouse_Left;break;case 2:a=e.Key_Mouse_Right;break;case 1:a=e.Key_Mouse_Mid;break}if(a!=0){this._keyStatus[a]=true;for(var r=0;r<this._listenerKeyDown.length;++r){this._listenerKeyDown[r](a)}}};i.prototype.mouseMove=function(e){this.mouseLastX=this.mouseX;this.mouseLastY=this.mouseY;this.mouseX=e.clientX-t.Egret3DDrive.clientRect.left;this.mouseY=e.clientY-t.Egret3DDrive.clientRect.top;this.mouseOffsetX=this.mouseX-this.mouseLastX;this.mouseOffsetY=this.mouseY-this.mouseLastY;for(var i=0;i<this._mouseMoveFunc.length;++i){this._mouseMoveFunc[i](e)}};i.prototype.mouseWheel=function(t){this.wheelDelta=t.wheelDelta;for(var e=0;e<this._mouseWheelFunc.length;++e){this._mouseWheelFunc[e]()}};i.prototype.keyDown=function(t){this._keyStatus[t.keyCode]=true;for(var e=0;e<this._listenerKeyDown.length;++e){this._listenerKeyDown[e](t.keyCode)}};i.prototype.keyUp=function(t){if(this._keyStatus[t.keyCode]){for(var e=0;e<this._listenerKeyClick.length;++e){this._listenerKeyClick[e](t.keyCode)}}this._keyStatus[t.keyCode]=false;for(var e=0;e<this._listenerKeyUp.length;++e){this._listenerKeyUp[e](t.keyCode)}};i.prototype.GetSlideAngle=function(t,e){return Math.atan2(e,t)*180/Math.PI};i.prototype.GetSlideDirection=function(t,e,i,a){var r=e-a;var s=i-t;var n=0;if(Math.abs(s)<2&&Math.abs(r)<2){return n}var o=this.GetSlideAngle(s,r);if(o>=-45&&o<45){n=4}else if(o>=45&&o<135){n=1}else if(o>=-135&&o<-45){n=2}else if(o>=135&&o<=180||o>=-180&&o<-135){n=3}return n};i.prototype.isEnlarge=function(t,e,i,a){var r=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y));var s=Math.sqrt((i.x-a.x)*(i.x-a.x)+(i.y-a.y)*(i.y-a.y));if(r<s){return true}else{return false}};i._instance=null;return i}();t.Input=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.orientation=new t.Vector3D;this.screenOrientation=0;this.openDebug=false;this.offsetRotation=new t.Vector3D;this.fixOritation=new t.Vector3D;this.state=-1;this.degtorad=Math.PI/180;this.q=new t.Quaternion;this.q1=new t.Quaternion;this.outQ=new t.Quaternion;this.front=new t.Vector3D(0,0,200);this.test=new t.Vector3D;if(this.openDebug){this.accDiv=document.createElement("div");this.accGravityDiv=document.createElement("div");this.rotationRateDiv=document.createElement("div");this.orientationRateDiv=document.createElement("div");this.stateDiv=document.createElement("div");this.accDiv.style.color="red";this.accGravityDiv.style.color="red";this.rotationRateDiv.style.color="red";this.orientationRateDiv.style.color="red";this.stateDiv.style.color="red";this.stateDiv.style.fontSize="52";document.body.appendChild(this.accDiv);document.body.appendChild(this.accGravityDiv);document.body.appendChild(this.rotationRateDiv);document.body.appendChild(this.orientationRateDiv);document.body.appendChild(this.stateDiv)}}e.prototype.start=function(){var t=this;this.orientationchangeHandler();window.addEventListener("orientationchange",function(){return t.orientationchangeHandler()});window.addEventListener("devicemotion",function(e){return t.motionHandler(e)});window.addEventListener("deviceorientation",function(e){return t.orientationHandler(e)})};e.prototype.stop=function(){var t=this;window.removeEventListener("orientationchange",function(){return t.orientationchangeHandler()});window.removeEventListener("devicemotion",function(e){return t.motionHandler(e)});window.removeEventListener("deviceorientation",function(e){return t.orientationHandler(e)})};e.prototype.orientationchangeHandler=function(){};e.prototype.motionHandler=function(t){this.acc=t.acceleration;this.accGravity=t.accelerationIncludingGravity;this.rotationRate=t.rotationRate};e.prototype.orientationHandler=function(t){this.orientation.x=t.alpha;this.orientation.y=t.beta;this.orientation.z=t.gamma;if(this.openDebug)this.debug()};e.prototype.debug=function(){this.accGravityDiv.innerHTML="<br><br> Gravity-x:"+this.orientation.x*t.Matrix3DUtils.RADIANS_TO_DEGREES+"<br>Gravity-y:"+this.orientation.y+"<br>Gravity-z:"+this.orientation.z;this.orientationRateDiv.innerHTML="<br> orientation-x:"+this.fixOritation.x+"<br>orientation-y:"+this.fixOritation.y+"<br>orientation-z:"+this.fixOritation.z;this.stateDiv.innerHTML="<br> state: "+this.state};e.prototype.getOrientation=function(){switch(window.screen.msOrientation){case"landscape-primary":return-90;case"landscape-secondary":return 90;case"portrait-secondary":return 180;case"portrait-primary":return 0}return 0};e.prototype.getQuaternion=function(e,i,a){var r=i?i*this.degtorad:0;var s=a?a*this.degtorad:0;var n=e?e*this.degtorad:0;var o=-this.getOrientation()*this.degtorad;this.state=this.getOrientation();var h=Math.cos(r/2);var u=Math.cos(s/2);var l=Math.cos(n/2);var f=Math.sin(r/2);var c=Math.sin(s/2);var d=Math.sin(n/2);this.q.w=h*u*l-f*c*d;this.q.x=f*u*l-h*c*d;this.q.y=h*c*l+f*u*d;this.q.z=h*u*d+f*c*l;var p=new t.Vector3D(0,0,1);var g=new t.Quaternion;g.fromAxisAngle(p,o/t.Matrix3DUtils.DEGREES_TO_RADIANS);this.q.multiply(this.q,g);p.setTo(-1,0,0);g.fromAxisAngle(p,90*this.degtorad/t.Matrix3DUtils.DEGREES_TO_RADIANS);this.q.multiply(this.q,g);return this.q};e.prototype.update=function(t){this.getQuaternion(this.orientation.x,this.orientation.y,this.orientation.z);this.q.toEulerAngles(this.fixOritation);t.rotationX=-this.fixOritation.x+this.offsetRotation.x;t.rotationZ=-this.fixOritation.y+this.offsetRotation.z;t.rotationY=-this.fixOritation.z+this.offsetRotation.y};return e}();t.OrientationController=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.volume=1;this.codecs={};if(this.hasAudioContext()){if(typeof AudioContext!=="undefined"){this.context=new AudioContext}}}e.prototype.hasAudio=function(){return typeof Audio!=="undefined"};e.prototype.hasAudioContext=function(){return!!(typeof AudioContext!=="undefined")};e.prototype.isSupported=function(t,e){if(this.codecs==null){if(e==null)e=new Audio;this.codecs={mp3:!!e.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!e.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")}}var i=t.match(/^data:audio\/([^;,]+);/i);if(!i){i=t.split("?",1)[0].match(/\.([^.]+)$/)}if(i){i=i[1].toLowerCase()}return this.codecs[i]};e.prototype.createSound=function(e,i,a){if(i===void 0){i=null}if(a===void 0){a=null}return new t.Sound(e,i,a)};e.prototype.playSound=function(e,i){i=i||{};var a=new t.Channel(e,i);a.play();return a};e.prototype.playSound3d=function(e,i,a){a=a||{};var r=new t.Channel3d(e,a);r.position=i;if(a.volume){r.volume=a.volume}if(a.loop){r.loop=a.loop}if(a.maxDistance){r.maxDistance=a.maxDistance}if(a.minDistance){r.minDistance=a.minDistance}if(a.rollOffFactor){r.rollOffFactor=a.rollOffFactor}r.play();return r};Object.defineProperty(e,"instance",{get:function(){if(this._instance==null){this._instance=new e}return this._instance},enumerable:true,configurable:true});return e}();t.AudioManager=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){this.volume=1;this.loop=false;this.pitch=1;i=i||{};if(i.volume)this.volume=i.volume;if(i.loop)this.loop=i.loop;if(i.pitch)this.pitch=i.pitch;this.sound=e;this.paused=false;if(t.AudioManager.instance.hasAudioContext()){this.context=t.AudioManager.instance.context;this.startTime=0;this.startOffset=0;this.source=null;this.gain=this.context.createGain()}else if(t.AudioManager.instance.hasAudio()){if(this.sound.audio){this.source=this.sound.audio.cloneNode(false);this.source.pause()}}}e.prototype.play=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source){throw new Error("Call stop() before calling play()")}this.createSource();if(!this.source){return}this.startTime=this.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration)}else if(t.AudioManager.instance.hasAudio){this.paused=false;this.source.play()}this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch)};e.prototype.pause=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source){this.startOffset+=this.context.currentTime-this.startTime;this.source.stop(0);this.source=null}}else if(t.AudioManager.instance.hasAudio()){if(this.source){this.source.pause()}}this.paused=true};e.prototype.unpause=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source||!this.paused){throw new Error("Call pause() before unpausing.")}this.createSource();if(!this.source){return}this.startTime=this.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch)}else if(t.AudioManager.instance.hasAudio()){this.source.play()}this.paused=false};e.prototype.stop=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source){this.source.stop(0);this.startOffset=0;this.source=null}}else if(t.AudioManager.instance.hasAudio()){if(this.source){this.source.pause();this.source.currentTime=0}}};e.prototype.setLoop=function(t){if(this.source){this.source.loop=t}};e.prototype.setVolume=function(e){if(this.gain){this.gain.gain.value=e*t.AudioManager.instance.volume}else if(this.source){this.source.volume=e*t.AudioManager.instance.volume}};e.prototype.setPitch=function(e){if(t.AudioManager.instance.hasAudioContext()){if(this.source){this.source.playbackRate.value=e}}else if(t.AudioManager.instance.hasAudio()){if(this.source){this.source.playbackRate=e}}};e.prototype.isPlaying=function(){if(t.AudioManager.instance.hasAudioContext()){return!this.paused}else if(t.AudioManager.instance.hasAudio()){return!this.source.paused}};e.prototype.getDuration=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source){return this.source.buffer.duration}}else if(t.AudioManager.instance.hasAudio()){if(this.source){var e=this.source.duration;if(e===e){return e}}}return 0};e.prototype.createSource=function(){var t=this;if(this.sound.buffer){this.source=this.context.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.gain);this.gain.connect(this.context.destination);if(this.loop){this.source.onended=function(){return t.play()}}}};return e}();t.Channel=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,a){e.call(this,i,a);this._position=new t.Vector3D;this._velocity=new t.Vector3D;if(t.AudioManager.instance.hasAudioContext())this._panner=this.context.createPanner();this._maxDistance=1e4;this._minDistance=1;this._rollOffFactor=1;this._listener=new t.Vector3D}Object.defineProperty(i.prototype,"listener",{get:function(){return this._listener},set:function(t){this._listener.copyFrom(t)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"position",{get:function(){return this._position},set:function(e){this._position.copyFrom(e);if(t.AudioManager.instance.hasAudioContext()){this._panner.setPosition(e.x,e.y,e.z)}if(t.AudioManager.instance.hasAudio()){if(this.source){var i=this.fallOff(this._listener,this.position,this.minDistance,this.maxDistance,this.rollOffFactor);this.source.volume=this.volume*i}}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copyFrom(e);if(t.AudioManager.instance.hasAudioContext())this._panner.setVelocity(e.x,e.y,e.z)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e;if(t.AudioManager.instance.hasAudioContext())this._panner.maxDistance=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"minDistance",{get:function(){return this._minDistance},set:function(e){this._minDistance=e;if(t.AudioManager.instance.hasAudioContext())this._panner.refDistance=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t;if(this._panner)this._panner.rolloffFactor=t},enumerable:true,configurable:true});i.prototype.createSource=function(){this.source=this.context.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this._panner);this._panner.connect(this.gain);this.gain.connect(this.context.destination)};i.prototype.fallOff=function(e,i,a,r,s){var n=t.Vector3D.distance(e,i);if(n<a){return 1}else if(n>r){return 0}else{var o=a+s*(n-a);if(o!==0){return a/o}else{return 1}}};return i}(t.Channel);t.Channel3d=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i,a){var r=this;if(i===void 0){i=null}if(a===void 0){a=null}this.audio=null;this._success=i;this._error=a;this.isLoaded=false;if(t.AudioManager.instance.hasAudioContext()){if(t.AudioManager.instance.isSupported(e,this.audio)){console.warn("Audio format not supported");a(this)}else{if(t.AudioManager.instance.context){this.loadAudioFile(e)}}}else if(t.AudioManager.instance.hasAudio()){try{this.audio=new Audio}catch(s){console.warn("No support for Audio element");if(a)a(this);return}if(t.AudioManager.instance.isSupported(e,this.audio)){console.warn("Audio format not supported");if(a)a(this)}else{this.audio.src=e;this.audio.addEventListener("canplaythrough",function(t){return r.oncanplaythrough(t)});this.audio.addEventListener("ended",function(t){return r.onended(t)});this.audio.load()}}}Object.defineProperty(e.prototype,"buffer",{get:function(){return this._buffer},enumerable:true,configurable:true});e.prototype.loadAudioFile=function(t){var e=this;if(this.xhr==null)this.xhr=new XMLHttpRequest;this.xhr.open("GET",t,true);this.xhr.responseType="arraybuffer";this.xhr.onload=function(t){return e.audioLoadend(t)};this.xhr.send()};e.prototype.audioLoadend=function(e){var i=this;t.AudioManager.instance.context.decodeAudioData(this.xhr.response,function(t){return i.decodeSuccessCallback(t)})};e.prototype.decodeSuccessCallback=function(t){this._buffer=t;if(this._success)this._success(this)};e.prototype.onended=function(t){};e.prototype.oncanplaythrough=function(t){if(!this.isLoaded){this.isLoaded=true;if(this._success)this._success(this)}};return e}();t.Sound=e})(egret3d||(egret3d={}));var egret3d;(function(egret3d){var Egret3DEngine=function(){function Egret3DEngine(){}Egret3DEngine.getXHR=function(){var t=null;if(window["XMLHttpRequest"]){t=new window["XMLHttpRequest"]}else{t=new ActiveXObject("MSXML2.XMLHTTP")}return t};Egret3DEngine.preload=function(t){this._complete=t;if(this._xhr==null){this._xhr=this.getXHR()}if(this._xhr==null){alert("Your browser does not support XMLHTTP.");return}if(this._xhr.readyState>0){this._xhr.abort()}this._xhr.open("GET",this._libUrl,true);this._xhr.addEventListener("progress",function(t){return Egret3DEngine.onProgress(t)},false);this._xhr.addEventListener("readystatechange",function(t){return Egret3DEngine.onReadyStateChange(t)},false);this._xhr.addEventListener("error",function(t){return Egret3DEngine.onError(t)},false);this._xhr.responseType="text";this._xhr.send()};Egret3DEngine.onReadyStateChange=function(t){if(this._xhr.readyState==4){if(this._xhr.status>=400||this._xhr.status==0){console.log(this._libUrl,"load fail")}else{this.loadComplete()}}};Egret3DEngine.loadComplete=function(){var t=this._xhr.responseText;this.applyClass(t)};Egret3DEngine.onProgress=function(t){var e=t.loaded.toString()+t.total;console.log("progress event```"+e)};Egret3DEngine.onError=function(t){console.log("load error",t)};Egret3DEngine.applyClass=function(source){var obj=eval("("+source+")");for(var i=0;i<obj.files.length;++i){this.importList[i]="/js/Egret3D/";this.importList[i]+=obj.files[i];this.importList[i]=this.importList[i].replace(".ts",".js")}this.startLoadScript(null)};Egret3DEngine.startLoadScript=function(t){var e=this;if(this.importList.length>0){var i=document.createElement("script");i.src=this.importList.shift();i.onload=function(t){return e.startLoadScript(t)};i.onerror=function(t){return e.loadScriptError(t)};document.head.appendChild(i)}else{console.log("all complete");this._complete()}};Egret3DEngine.loadScriptError=function(t){var e="load Script Error \r\n no file:"+t.srcElement.src;alert(e);this.startLoadScript(null)};Egret3DEngine.djs="";Egret3DEngine.importList=new Array;Egret3DEngine._libUrl="/Egret3D/tsconfig.json";return Egret3DEngine}();egret3d.Egret3DEngine=Egret3DEngine})(egret3d||(egret3d={}));
